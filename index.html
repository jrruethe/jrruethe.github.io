
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Morning Musings</title>
  <meta name="author" content="Joe Ruether">

  
  <meta name="description" content="PGP and GPG are commonly used to encrypt and sign messages for specified recipients, but OpenSSL is capable of performing the same cryptographic &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jrruethe.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Morning Musings" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
  jQuery.noConflict();
  var rootUrl = "";
</script>
<script src="/javascripts/openlayers/OpenLayers.js" type="text/javascript"></script>
<script src="/javascripts/maps.js" type="text/javascript"></script>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Morning Musings</a></h1>
  
    <h2>I'm not ready to wake up yet...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jrruethe.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/license">License</a></li>
  <li><a href="/blog/about">About</a></li>
  <li><a href="/blog/contact">Contact</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/17/cryptography-using-openssl/">Cryptography Using OpenSSL</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-04-17T13:21:05-04:00" pubdate data-updated="true">Apr 17<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/04/17/cryptography-using-openssl/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2016/04/17/cryptography-using-openssl/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>PGP and GPG are commonly used to encrypt and sign messages for specified recipients, but OpenSSL is capable of performing the same cryptographic operations. The benefit is that more of the magic is exposed to the user, which can be useful for learning more about how cryptographic applications operate.</p>

<p>Below are three bash scripts that can perform the following:</p>

<ul>
<li>Public / private key generation</li>
<li>Hybrid asymmetric encryption and signing</li>
<li>Hybrid asymmetric decryption and verification</li>
</ul>


<p>These operations are a subset of the core functionality provided by GPG, and can be used to securely pass sensitive data between users. Unlike GPG, the user is responsible for managing trusted certificates.</p>

<h2>Generate</h2>

<p>The first script is called <code>generate.sh</code>. It will generate a new public certificate and private key when given a name and optional email address. Run it like so:</p>

<pre><code>$ ./generate.sh 
Usage: generate.sh &lt;"name"&gt; [email]

$ ./generate.sh "Joe Ruether" jrruethe@gmail.com
</code></pre>

<p><img class="center" src="http://jrruethe.github.io/blog/2016/04/17/cryptography-using-openssl/01.png"></p>

<p>As you can see, a certificate and private key were generated, with the proper permissions set. Both files are stored in base64 ASCII for easily sharing or backing them up.</p>

<p>You can also view the human readable output of the certificate with:</p>

<pre><code>openssl x509 -in Joe_Ruether.certificate -text -noout
</code></pre>

<p><img class="center" src="http://jrruethe.github.io/blog/2016/04/17/cryptography-using-openssl/02.png"></p>

<p>The idea here is that two users would generate their own certificates and private keys, then keep the private keys for themselves while sharing the certificates with each other. The sharing of certificates should be done in a way that you can prove the certificate belongs to who you think it does, since anyone can generate a certificate with any name and email.</p>

<p>The script:</p>

<figure class='code'><figcaption><span> (generate.sh)</span><a href='/downloads/code/generate.sh' title='Download code'> download</a></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># generate.sh</span>
</span><span class='line'><span class="c"># Copyright (C) 2016 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c"># (at your option) any later version.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Generates a certificate and private key</span>
</span><span class='line'><span class="c"># generate.sh &lt;&quot;name&quot;&gt; [email]</span>
</span><span class='line'><span class="c"># 1) (Required) Name of user</span>
</span><span class='line'><span class="c"># 2) (Optional) Email of user</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Stop on any error</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -lt 1 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Usage: generate.sh &lt;\&quot;name\&quot;&gt; [email]&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nv">NAME</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">EMAIL</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Replace spaces with underscores</span>
</span><span class='line'><span class="nv">FILE</span><span class="o">=</span><span class="k">${</span><span class="nv">NAME</span><span class="p">// /_</span><span class="k">}</span>
</span><span class='line'><span class="nv">KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">FILE</span><span class="k">}</span>.secret
</span><span class='line'><span class="nv">CERTIFICATE</span><span class="o">=</span><span class="k">${</span><span class="nv">FILE</span><span class="k">}</span>.certificate
</span><span class='line'>
</span><span class='line'><span class="c"># Create a certificate and key pair for the given name and email</span>
</span><span class='line'><span class="nb">echo</span> -e <span class="s2">&quot;NA\nNA\nNA\nNA\nNA\n${NAME}\n${EMAIL}&quot;</span> | openssl req -new -x509 -sha256 -newkey rsa:2048 -nodes -keyout <span class="k">${</span><span class="nv">KEY</span><span class="k">}</span> -out <span class="k">${</span><span class="nv">CERTIFICATE</span><span class="k">}</span>  &gt; /dev/null 2&gt;&amp;1 
</span><span class='line'>
</span><span class='line'><span class="c"># Change permissions</span>
</span><span class='line'>chmod 400 <span class="k">${</span><span class="nv">KEY</span><span class="k">}</span>
</span><span class='line'>chmod 444 <span class="k">${</span><span class="nv">CERTIFICATE</span><span class="k">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Encrypt</h2>

<p>The next script performs file encryption to a specified recipient certificate. It can optionally sign the file with your private key. The order of operations is as follows:</p>

<ol>
<li>The file is first compressed</li>
<li>A random keyfile is generated</li>
<li>The compressed file is symmetrically encrypted with the random keyfile using AES256</li>
<li>The random key is asymmetrically encrypted with the certificate using RSA</li>
<li>(optional) The file is signed using the private key of the sender, and the signature is encrypted symmetrically using the random key</li>
<li>All output files are bundled together into a tarball</li>
</ol>


<p>Run it like so:</p>

<pre><code>$ echo "This is a test" &gt; test.txt
$ ./encrypt.sh 
Usage: encrypt.sh &lt;file&gt; &lt;recipient_certificate&gt; [sender_private_key] [sender_certificate]

$ ./encrypt.sh test.txt Alice.certificate
Encryption Successful
</code></pre>

<p>Optionally the file can be signed by also providing your private key:</p>

<pre><code>$ ./encrypt.sh test.txt Alice.certificate Bob.secret
Encryption Successful
</code></pre>

<p>In this case, the file <code>test.txt</code> was encrypted to Alice and signed by Bob.</p>

<p>Here is the output:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2016/04/17/cryptography-using-openssl/03.png">
<img class="center" src="http://jrruethe.github.io/blog/2016/04/17/cryptography-using-openssl/04.png"></p>

<p>The produced tarball can be safely shared over an insecure channel; only the intended recipient is able to decrypt it.</p>

<p>The tarball will always contain the recipient metadata extracted from the recipient&rsquo;s public certificate. This is so it is easy to identify who is able to decrypt the file. Optionally, the sender can include their certificate metadata when signing a file, to make it easy to determine which certificate is needed to verify the signature. The metadata files contain nothing more than the sha1 fingerprints of the respective certificates:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2016/04/17/cryptography-using-openssl/05.png"></p>

<p>The script:</p>

<figure class='code'><figcaption><span> (encrypt.sh)</span><a href='/downloads/code/encrypt.sh' title='Download code'> download</a></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># encrypt.sh</span>
</span><span class='line'><span class="c"># Copyright (C) 2016 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c"># (at your option) any later version.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Encrypts a file</span>
</span><span class='line'><span class="c"># encrypt.sh &lt;file&gt; &lt;recipient_certificate&gt; [sender_private_key] [sender_certificate]</span>
</span><span class='line'><span class="c"># 1) (Required) File to encrypt</span>
</span><span class='line'><span class="c"># 2) (Required) Certificate of the recipient</span>
</span><span class='line'><span class="c"># 3) (Optional) Private key of the sender</span>
</span><span class='line'><span class="c"># 4) (Optional) Certificate of the sender</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Stop on any error</span>
</span><span class='line'><span class="c"># set -e</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Declare an array of tasks to perform on exit</span>
</span><span class='line'><span class="nb">declare</span> -a on_exit_items
</span><span class='line'>
</span><span class='line'><span class="c"># This function is run on exit</span>
</span><span class='line'><span class="k">function </span>on_exit<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="k">for </span>i in <span class="s2">&quot;${on_exit_items[@]}&quot;</span>
</span><span class='line'>    <span class="k">do</span>
</span><span class='line'><span class="k">        </span><span class="nb">eval</span> <span class="nv">$i</span>
</span><span class='line'>    <span class="k">done</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Add to the list of tasks to run on exit</span>
</span><span class='line'><span class="k">function </span>add_on_exit<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="nb">local </span><span class="nv">n</span><span class="o">=</span><span class="k">${#</span><span class="nv">on_exit_items</span><span class="p">[*]</span><span class="k">}</span>
</span><span class='line'>    on_exit_items<span class="o">[</span><span class="nv">$n</span><span class="o">]=</span><span class="s2">&quot;$*&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$n</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nb">trap </span>on_exit EXIT
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -lt 2 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Usage: encrypt.sh &lt;file&gt; &lt;recipient_certificate&gt; [sender_private_key] [sender_certificate]&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nv">FILE</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">RECIPIENT_CERTIFICATE</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'><span class="nv">SIGNING_KEY</span><span class="o">=</span><span class="nv">$3</span>
</span><span class='line'><span class="nv">SENDER_CERTIFICATE</span><span class="o">=</span><span class="nv">$4</span>
</span><span class='line'>
</span><span class='line'><span class="nv">COMPRESSED_FILE</span><span class="o">=</span><span class="k">${</span><span class="nv">FILE</span><span class="k">}</span>.bz2
</span><span class='line'><span class="nv">ENCRYPTED_FILE</span><span class="o">=</span><span class="k">${</span><span class="nv">COMPRESSED_FILE</span><span class="k">}</span>.encrypted
</span><span class='line'><span class="nv">SYMMETRIC_KEY</span><span class="o">=</span>symmetric_key.bin
</span><span class='line'><span class="nv">ENCRYPTED_KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>.encrypted
</span><span class='line'>
</span><span class='line'><span class="nv">RECIPIENT_PUBLIC_KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">RECIPIENT_CERTIFICATE</span><span class="p">//certificate/public</span><span class="k">}</span>
</span><span class='line'><span class="nv">RECIPIENT_METADATA</span><span class="o">=</span>recipient.txt
</span><span class='line'><span class="nv">SENDER_METADATA</span><span class="o">=</span>sender.txt
</span><span class='line'>
</span><span class='line'><span class="nv">SIGNATURE</span><span class="o">=</span><span class="k">${</span><span class="nv">FILE</span><span class="k">}</span>.signature
</span><span class='line'><span class="nv">ENCRYPTED_SIGNATURE</span><span class="o">=</span><span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span>.encrypted
</span><span class='line'><span class="nv">OUTPUT</span><span class="o">=</span><span class="k">${</span><span class="nv">FILE</span><span class="k">}</span>.tar
</span><span class='line'>
</span><span class='line'><span class="c"># Get the public key from the certificate</span>
</span><span class='line'>openssl x509 -in <span class="k">${</span><span class="nv">RECIPIENT_CERTIFICATE</span><span class="k">}</span> -pubkey -noout &gt; <span class="k">${</span><span class="nv">RECIPIENT_PUBLIC_KEY</span><span class="k">}</span> 2&gt;/dev/null
</span><span class='line'><span class="nv">SUCCESS</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>add_on_exit rm -f <span class="k">${</span><span class="nv">RECIPIENT_PUBLIC_KEY</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">SUCCESS</span><span class="k">}</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Invalid recipient certificate&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Get the recipient fingerprint metadata</span>
</span><span class='line'>openssl x509 -in <span class="k">${</span><span class="nv">RECIPIENT_CERTIFICATE</span><span class="k">}</span> -noout -fingerprint | awk -F <span class="s2">&quot;=&quot;</span> <span class="s1">&#39;{print $2}&#39;</span> &gt; <span class="k">${</span><span class="nv">RECIPIENT_METADATA</span><span class="k">}</span>
</span><span class='line'>add_on_exit rm -f <span class="k">${</span><span class="nv">RECIPIENT_METADATA</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Compress the file</span>
</span><span class='line'>bzip2 -9 -k <span class="k">${</span><span class="nv">FILE</span><span class="k">}</span>
</span><span class='line'>add_on_exit rm -f <span class="k">${</span><span class="nv">COMPRESSED_FILE</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Generate a random key</span>
</span><span class='line'>openssl rand -base64 128 -out <span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>
</span><span class='line'>add_on_exit shred <span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>
</span><span class='line'>add_on_exit rm -f <span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Encrypt the file symmetrically using the random key</span>
</span><span class='line'>openssl enc -aes-256-cbc -salt -in <span class="k">${</span><span class="nv">COMPRESSED_FILE</span><span class="k">}</span> -out <span class="k">${</span><span class="nv">ENCRYPTED_FILE</span><span class="k">}</span> -pass file:<span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>
</span><span class='line'>add_on_exit rm -f <span class="k">${</span><span class="nv">ENCRYPTED_FILE</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Encrypt the symmetric key with the public key of the recipient</span>
</span><span class='line'>openssl rsautl -encrypt -inkey <span class="k">${</span><span class="nv">RECIPIENT_PUBLIC_KEY</span><span class="k">}</span> -pubin -in <span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span> -out <span class="k">${</span><span class="nv">ENCRYPTED_KEY</span><span class="k">}</span>
</span><span class='line'>add_on_exit rm -f <span class="k">${</span><span class="nv">ENCRYPTED_KEY</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># If the file is being signed by the sender</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -z <span class="k">${</span><span class="nv">SIGNING_KEY</span><span class="k">}</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>
</span><span class='line'>   <span class="c"># Sign the file</span>
</span><span class='line'>   openssl dgst -sha256 -sign <span class="k">${</span><span class="nv">SIGNING_KEY</span><span class="k">}</span> -out <span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span> <span class="k">${</span><span class="nv">FILE</span><span class="k">}</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>   <span class="nv">SUCCESS</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>   add_on_exit shred <span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span>
</span><span class='line'>   add_on_exit rm -f <span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">SUCCESS</span><span class="k">}</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;Invalid sender private key&quot;</span>
</span><span class='line'>      <span class="nb">exit </span>1
</span><span class='line'>   <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'>   <span class="c"># Encrypt the signature symmetrically using the random key</span>
</span><span class='line'>   openssl enc -aes-256-cbc -salt -in <span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span> -out <span class="k">${</span><span class="nv">ENCRYPTED_SIGNATURE</span><span class="k">}</span> -pass file:<span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>
</span><span class='line'>   add_on_exit rm -f <span class="k">${</span><span class="nv">ENCRYPTED_SIGNATURE</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>   <span class="c"># Clear the variables for the tar command</span>
</span><span class='line'>   <span class="nv">ENCRYPTED_SIGNATURE</span><span class="o">=</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># If a sender is being specified</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -z <span class="k">${</span><span class="nv">SENDER_CERTIFICATE</span><span class="k">}</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>
</span><span class='line'>   <span class="c"># Get the sender fingerprint metadata</span>
</span><span class='line'>   openssl x509 -in <span class="k">${</span><span class="nv">SENDER_CERTIFICATE</span><span class="k">}</span> -noout -fingerprint 2&gt;/dev/null | awk -F <span class="s2">&quot;=&quot;</span> <span class="s1">&#39;{print $2}&#39;</span> &gt; <span class="k">${</span><span class="nv">SENDER_METADATA</span><span class="k">}</span>
</span><span class='line'>   <span class="nv">SUCCESS</span><span class="o">=</span><span class="k">${</span><span class="nv">PIPESTATUS</span><span class="p">[0]</span><span class="k">}</span>
</span><span class='line'>   add_on_exit rm -f <span class="k">${</span><span class="nv">SENDER_METADATA</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">SUCCESS</span><span class="k">}</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;Invalid sender certificate&quot;</span>
</span><span class='line'>      <span class="nb">exit </span>1
</span><span class='line'>   <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>   <span class="c"># Clear the variable for the tar command</span>
</span><span class='line'>   <span class="nv">SENDER_METADATA</span><span class="o">=</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Bundle the output files together</span>
</span><span class='line'>tar cf <span class="k">${</span><span class="nv">OUTPUT</span><span class="k">}</span> <span class="k">${</span><span class="nv">ENCRYPTED_FILE</span><span class="k">}</span> <span class="k">${</span><span class="nv">ENCRYPTED_KEY</span><span class="k">}</span> <span class="k">${</span><span class="nv">RECIPIENT_METADATA</span><span class="k">}</span> <span class="k">${</span><span class="nv">ENCRYPTED_SIGNATURE</span><span class="k">}</span> <span class="k">${</span><span class="nv">SENDER_METADATA</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Encryption Successful&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Decrypt</h2>

<p>The final script is intended to decrypt bundles created by the above encryption script. It will:</p>

<ol>
<li>Extract the encrypted symmetric key</li>
<li>Decrypt the symmetric key using the given secret key</li>
<li>Extract the encrypted compressed file</li>
<li>Use the decrypted symmetric key to decrypt the compressed file</li>
<li>Decompress the file</li>
<li>(optional) Extract and verify the signature using the supplied certificate</li>
</ol>


<p>Run it like so:</p>

<pre><code>$ ./decrypt.sh 
Usage: decrypt.sh &lt;file&gt; &lt;recipient_private_key&gt; [sender_certificate]

$ ./decrypt.sh test.txt.tar Alice.secret Bob.certificate 
Verified OK
Decryption Successful
</code></pre>

<p>In this case, the file was decrypted by Alice, and verified to be sent by Bob.</p>

<p>Here is the output:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2016/04/17/cryptography-using-openssl/06.png"></p>

<p>The script:</p>

<figure class='code'><figcaption><span> (decrypt.sh)</span><a href='/downloads/code/decrypt.sh' title='Download code'> download</a></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># decrypt.sh</span>
</span><span class='line'><span class="c"># Copyright (C) 2016 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c"># (at your option) any later version.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Decrypts a file</span>
</span><span class='line'><span class="c"># decrypt.sh &lt;file&gt; &lt;recipient_private_key&gt; [sender_certificate]</span>
</span><span class='line'><span class="c"># 1) (Required) File to decrypt</span>
</span><span class='line'><span class="c"># 2) (Required) Private key of the recipient</span>
</span><span class='line'><span class="c"># 3) (Optional) Certificate of the sender</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Stop on any error</span>
</span><span class='line'><span class="c"># set -e</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Declare an array of tasks to perform on exit</span>
</span><span class='line'><span class="nb">declare</span> -a on_exit_items
</span><span class='line'>
</span><span class='line'><span class="c"># This function is run on exit</span>
</span><span class='line'><span class="k">function </span>on_exit<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="k">for </span>i in <span class="s2">&quot;${on_exit_items[@]}&quot;</span>
</span><span class='line'>    <span class="k">do</span>
</span><span class='line'><span class="k">        </span><span class="nb">eval</span> <span class="nv">$i</span>
</span><span class='line'>    <span class="k">done</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Add to the list of tasks to run on exit</span>
</span><span class='line'><span class="k">function </span>add_on_exit<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="nb">local </span><span class="nv">n</span><span class="o">=</span><span class="k">${#</span><span class="nv">on_exit_items</span><span class="p">[*]</span><span class="k">}</span>
</span><span class='line'>    on_exit_items<span class="o">[</span><span class="nv">$n</span><span class="o">]=</span><span class="s2">&quot;$*&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$n</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nb">trap </span>on_exit EXIT
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$#&quot;</span> -lt 2 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Usage: decrypt.sh &lt;file&gt; &lt;recipient_private_key&gt; [sender_certificate]&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nv">FILE</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">RECIPIENT_PRIVATE_KEY</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'><span class="nv">SENDER_CERTIFICATE</span><span class="o">=</span><span class="nv">$3</span>
</span><span class='line'>
</span><span class='line'><span class="nv">OUTPUT</span><span class="o">=</span><span class="k">${</span><span class="nv">FILE</span><span class="p">//.tar/</span><span class="k">}</span>
</span><span class='line'><span class="nv">COMPRESSED_FILE</span><span class="o">=</span><span class="k">${</span><span class="nv">OUTPUT</span><span class="k">}</span>.bz2
</span><span class='line'><span class="nv">ENCRYPTED_FILE</span><span class="o">=</span><span class="k">${</span><span class="nv">COMPRESSED_FILE</span><span class="k">}</span>.encrypted
</span><span class='line'><span class="nv">SYMMETRIC_KEY</span><span class="o">=</span>symmetric_key.bin
</span><span class='line'><span class="nv">ENCRYPTED_KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>.encrypted
</span><span class='line'>
</span><span class='line'><span class="nv">SENDER_PUBLIC_KEY</span><span class="o">=</span><span class="k">${</span><span class="nv">SENDER_CERTIFICATE</span><span class="p">//certificate/public</span><span class="k">}</span>
</span><span class='line'><span class="nv">SIGNATURE</span><span class="o">=</span><span class="k">${</span><span class="nv">OUTPUT</span><span class="k">}</span>.signature
</span><span class='line'><span class="nv">ENCRYPTED_SIGNATURE</span><span class="o">=</span><span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span>.encrypted
</span><span class='line'>
</span><span class='line'><span class="c"># Unpack the encrypted key</span>
</span><span class='line'>tar xf <span class="k">${</span><span class="nv">FILE</span><span class="k">}</span> <span class="k">${</span><span class="nv">ENCRYPTED_KEY</span><span class="k">}</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'><span class="nv">SUCCESS</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>add_on_exit rm -f <span class="k">${</span><span class="nv">ENCRYPTED_KEY</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">SUCCESS</span><span class="k">}</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Not a valid encrypted file&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Decrypt the symmetric key</span>
</span><span class='line'>openssl rsautl -decrypt -inkey <span class="k">${</span><span class="nv">RECIPIENT_PRIVATE_KEY</span><span class="k">}</span> -in <span class="k">${</span><span class="nv">ENCRYPTED_KEY</span><span class="k">}</span> -out <span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'><span class="nv">SUCCESS</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">SUCCESS</span><span class="k">}</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span>add_on_exit rm -f <span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>
</span><span class='line'>   <span class="nb">echo</span> <span class="s2">&quot;Unable to decrypt: Incorrect key&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">   </span>add_on_exit shred <span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>
</span><span class='line'>   add_on_exit rm -f <span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Unpack the encrypted file</span>
</span><span class='line'>tar xf <span class="k">${</span><span class="nv">FILE</span><span class="k">}</span> <span class="k">${</span><span class="nv">ENCRYPTED_FILE</span><span class="k">}</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'><span class="nv">SUCCESS</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>add_on_exit rm -f <span class="k">${</span><span class="nv">ENCRYPTED_FILE</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">SUCCESS</span><span class="k">}</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Not a valid encrypted file&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Decrypt the file</span>
</span><span class='line'>openssl enc -d -aes-256-cbc -in <span class="k">${</span><span class="nv">ENCRYPTED_FILE</span><span class="k">}</span> -out <span class="k">${</span><span class="nv">COMPRESSED_FILE</span><span class="k">}</span> -pass file:<span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Decompress the file</span>
</span><span class='line'>bunzip2 -f <span class="k">${</span><span class="nv">COMPRESSED_FILE</span><span class="k">}</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>
</span><span class='line'><span class="c"># If the file is being verified</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -z <span class="k">${</span><span class="nv">SENDER_CERTIFICATE</span><span class="k">}</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'>
</span><span class='line'>   <span class="c"># Unpack the signature</span>
</span><span class='line'>   tar xf <span class="k">${</span><span class="nv">FILE</span><span class="k">}</span> <span class="k">${</span><span class="nv">ENCRYPTED_SIGNATURE</span><span class="k">}</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>   <span class="nv">SUCCESS</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'>   add_on_exit rm -f <span class="k">${</span><span class="nv">ENCRYPTED_SIGNATURE</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">SUCCESS</span><span class="k">}</span> -ne 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;File is not signed&quot;</span>
</span><span class='line'>   <span class="k">else</span>
</span><span class='line'>      <span class="c"># Get the public key</span>
</span><span class='line'>      add_on_exit rm -f <span class="k">${</span><span class="nv">SENDER_PUBLIC_KEY</span><span class="k">}</span>
</span><span class='line'>      openssl x509 -in <span class="k">${</span><span class="nv">SENDER_CERTIFICATE</span><span class="k">}</span> -pubkey -noout &gt; <span class="k">${</span><span class="nv">SENDER_PUBLIC_KEY</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c"># Decrypt the signature</span>
</span><span class='line'>      openssl enc -d -aes-256-cbc -in <span class="k">${</span><span class="nv">ENCRYPTED_SIGNATURE</span><span class="k">}</span> -out <span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span> -pass file:<span class="k">${</span><span class="nv">SYMMETRIC_KEY</span><span class="k">}</span>
</span><span class='line'>      add_on_exit shred <span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span>
</span><span class='line'>      add_on_exit rm -f <span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c"># Verify the signature</span>
</span><span class='line'>      openssl dgst -sha256 -verify <span class="k">${</span><span class="nv">SENDER_PUBLIC_KEY</span><span class="k">}</span> -signature <span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span> <span class="k">${</span><span class="nv">OUTPUT</span><span class="k">}</span>
</span><span class='line'>      add_on_exit rm -f <span class="k">${</span><span class="nv">SIGNATURE</span><span class="k">}</span>
</span><span class='line'>   <span class="k">fi</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Decryption Successful&quot;</span>
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/04/15/running-docker-in-qubes/">Running Docker in Qubes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-04-15T18:09:15-04:00" pubdate data-updated="true">Apr 15<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/04/15/running-docker-in-qubes/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2016/04/15/running-docker-in-qubes/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a quick post describing how to run Docker inside of a Qubes Appvm.</p>

<h2>Create a new template</h2>

<p>I chose to clone my existing Debian template. This tutorial assumes the template is Debian-based. Ideally your template would be very minimal, only requiring basic packages such as the following:</p>

<ul>
<li>git</li>
<li>gedit</li>
</ul>


<p>If you are also planning on using the dockerfile generator, you will need the following:</p>

<ul>
<li>ruby</li>
<li>ruby-dev</li>
<li>gcc</li>
<li>make</li>
<li>fpm (<code>sudo gem install fpm</code>)</li>
</ul>


<p>Here is my template:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2016/04/15/running-docker-in-qubes/01.png"></p>

<p>Make sure that the update proxy is disabled in the firewall settings:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2016/04/15/running-docker-in-qubes/02.png"></p>

<h2>Install Docker to the template<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></h2>

<p>Run the following commands in the terminal:</p>

<pre><code>sudo apt-get update
sudo apt-get install curl
curl -fsSL https://get.docker.com/ | sh
</code></pre>

<p>Next, enable the default user to use Docker:</p>

<pre><code>sudo usermod -aG docker user
</code></pre>

<h2>Change the default directory<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></h2>

<pre><code>sudo vim /etc/systemd/system/docker.service
</code></pre>

<p>Add the following to the file:</p>

<pre><code>[Service]
ExecStart=
ExecStart=/usr/bin/docker daemon -H fd:// -g /home/user/docker
</code></pre>

<p>Finally, run the following command to apply the configuration:</p>

<pre><code>sudo systemctl daemon-reload
</code></pre>

<h2>Create an Appvm</h2>

<p>First, poweroff the template. Then create an Appvm based on the template. Increase the available disk space, since the docker images are being stored in the persistent private storage.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2016/04/15/running-docker-in-qubes/03.png"></p>

<h2>Test it out</h2>

<p>Run the following command in the Appvm as the normal user:</p>

<pre><code>docker run -it --rm hello-world
</code></pre>

<p>You should see the following:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2016/04/15/running-docker-in-qubes/04.png"></p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="https://docs.docker.com/linux/step_one/">https://docs.docker.com/linux/step_one/</a><a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="https://docs.docker.com/engine/admin/systemd/">https://docs.docker.com/engine/admin/systemd/</a><a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/12/bitcoin-donation-proofs/">Bitcoin Donation Proofs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-12T21:15:49-05:00" pubdate data-updated="true">Jan 12<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/01/12/bitcoin-donation-proofs/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2016/01/12/bitcoin-donation-proofs/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As promised in my <a href="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/">previous post</a>, I made some donations to show my support for open source software projects that accept Bitcoin. Below you will find the proofs.</p>

<p>Thank you all for everything you do, it is greatly appreciated and does not go unnoticed. Keep up the great work!</p>

<blockquote><p>Some sites did not provide static addresses. Donations to sites utilizing dynamic addresses are not listed, to prevent accidential reuse of those temporary addresses.</p></blockquote>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>-----BEGIN PGP SIGNED MESSAGE-----
</span><span class='line'>Hash: SHA1
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/19
</span><span class='line'>   Recipient   : Whonix
</span><span class='line'>   Source      : https://www.whonix.org/wiki/Donate
</span><span class='line'>   Address     : 1JgzCCSox56Sh4NnQJqRiwoxKi8oVSZBEd
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : 186bec9c1ffb9f6aaf30acb029b3640cdb5b3ca64ca8c96e6d3525ee925be13a
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to Whonix on Dec 19th, 2015"
</span><span class='line'>   
</span><span class='line'> - Date        : 2015/12/19
</span><span class='line'>   Recipient   : Rumble
</span><span class='line'>   Source      : http://disruptedsystems.org/
</span><span class='line'>   Address     : 1PXXMinxQgYUPXzZq6BixZpJTFeiCLqDqD
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : 900fe2a9eb4c050d51cdc0c554b0ccb19e9060c6ee74367597ca30156b5bf24d
</span><span class='line'>   Message     : "I, Joe Ruether, donated $5 to Rumble on Dec 19th, 2015"
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/19
</span><span class='line'>   Recipient   : Armory
</span><span class='line'>   Source      : https://bitcoinarmory.com/contact/
</span><span class='line'>   Address     : 1ArmoryXcfq7TnCSuZa9fQjRYwJ4bkRKfv
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : caeb52f8689ab152ba183675882c4a2176dbd95f7c01558905b6c74ed8a1f798
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to Armory on Dec 19th, 2015"
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/18
</span><span class='line'>   Recipient   : Tails
</span><span class='line'>   Source      : https://tails.boum.org/contribute/how/donate/index.en.html
</span><span class='line'>   Address     : 1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : 179c3b282b395ebde1282e5faea23695c3e3deb3eaeb617e1ff65c2720eb60c4
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to Tails on Dec 18th, 2015"
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/18
</span><span class='line'>   Recipient   : Veracrypt
</span><span class='line'>   Source      : https://veracrypt.codeplex.com/wikipage?title=Bitcoin%20Donation
</span><span class='line'>   Address     : 1NRoPQsm8by5iWyMMmHQy3P5takur3kYgG
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : ae1e57806c194a4bd2fd22f9a1c003ec6e82062c0197d18c2c06f5f0a65f2466
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to Veracrypt on Dec 18th, 2015"  
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/18
</span><span class='line'>   Recipient   : KeepassX
</span><span class='line'>   Source      : https://www.keepassx.org/donate
</span><span class='line'>   Address     : 1Lij3AvejBSbP58HM7uRmnuGcUpPWddPGt
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : 727747188f5ac883bb20c3724bef6532b4e0b8663d6ed899ab437c7192d66008
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to KeepassX on Dec 18th, 2015"
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/18
</span><span class='line'>   Recipient   : Free Software Foundation
</span><span class='line'>   Source      : https://my.fsf.org/donate
</span><span class='line'>   Address     : 1PC9aZC4hNX2rmmrt7uHTfYAS3hRbph4UN
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : eb4c3ca8cb2dc255c6e65c97a9528e7140b569b336ddfea190d7a9d8523e26a6
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to the Free Software Foundation on Dec 18th, 2015" 
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/18
</span><span class='line'>   Recipient   : Qubes
</span><span class='line'>   Source      : https://www.qubes-os.org/donate/
</span><span class='line'>   Address     : 14zockMSKKp5MK6X2cHJ3mQwm9MwYsJ39j
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : f1eb94f2a14b33bcd33884da7d9eab314a967b9eb514e599604d518195f05140
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to Qubes on Dec 18th, 2015"
</span><span class='line'>
</span><span class='line'>-----BEGIN PGP SIGNATURE-----
</span><span class='line'>Version: GnuPG v1
</span><span class='line'>
</span><span class='line'>iQEcBAEBAgAGBQJWlbpPAAoJEB7MsgHDevApgdoIAKekXgfkkUdnlV21kgAfSVBp
</span><span class='line'>6RZmSYhsYwPBK968qPLcHiRXHH4U42mRP4PKXcj4ylwED4KQVW432VKrz6/F7EuA
</span><span class='line'>Vm9QOjEAesb7gEfLOfI6eoC20aWRR3Y2DOsSOK1tlXm8jK+gv9RshvfBeLVnvF4s
</span><span class='line'>ZAQ8yUOjHyD77j8TKHF5vNMBf0OVnpJxXjS06/93zTpk16z21O+y2YmFpEOkZdPV
</span><span class='line'>tK4OmXv25DzlSUKIabhCEkYGfrfn0zbjfX+NEnAKxhdX5kdBMaKiL1vlMUAFptLg
</span><span class='line'>i6iZQYArzxFD+rGj64DqBLzPXbgEQWztVG8cJ0tKHWRZ9K/xFXBIsmBnAHIsd3s=
</span><span class='line'>=UnE4
</span><span class='line'>-----END PGP SIGNATURE-----</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/04/bitcoin-donations/">Bitcoin Donations</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-04T20:37:39-05:00" pubdate data-updated="true">Dec 4<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/12/04/bitcoin-donations/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Its that time of year again, and I am reminded by the large banner at the top of Wikipedia. I have some spare change lying around, and I feel like showing my support to fellow programmers who maintain the software I use every day.</p>

<p>I am a strong supporter of Bitcoin and naturally I wanted to use it for donations. I have had my Bitcoin address posted on my blog, and have had a few donations from readers (thank you!). One of the best things about Bitcoin is that anyone can send and receive money without needing to sign up for anything. It is a great way to quickly and convieniently transfer cash, and you can be sure that your transaction reaches the intended person without needing to interact with any middleman.</p>

<p>First, I compiled a list of the major OSS software products I rely on, as well as projects I truely believe in, and found the donation pages for each. I discovered that many of them do provide a way to pay with Bitcoin; however, the methods, formats, and requirements varied greatly. This is a perfect opportunity to provide a review on how easy or difficult it is to donate Bitcoin to websites today. I took my list and trimmed it down to a small subset of different examples. This post will be reviewing the Bitcoin donation methods for the following sites:</p>

<ul>
<li><a href="https://bitcoinarmory.com/contact/">Armory</a></li>
<li><a href="http://www.debian.org/donations">Debian</a></li>
<li><a href="https://www.eclipse.org/donate/">Eclipse</a></li>
<li><a href="https://supporters.eff.org/donate">Electronic Frontier Foundation</a></li>
<li><a href="https://freedom.press/donate">Freedom of the Press Foundation</a></li>
<li><a href="https://my.fsf.org/donate/">Free Software Foundation</a></li>
<li><a href="https://donate.mozilla.org/en-US/give-bitcoin/">Mozilla</a></li>
<li><a href="https://www.qubes-os.org/donate/">Qubes</a></li>
<li><a href="https://www.qubes-os.org/donate/">RiseUp</a></li>
<li><a href="https://veracrypt.codeplex.com/wikipage?title=Bitcoin%20Donation">Veracrypt</a></li>
<li><a href="https://wikimediafoundation.org/wiki/Ways_to_Give#bitcoin">Wikipedia</a></li>
</ul>


<hr />

<h2>Doing it the right way</h2>

<p>I must really commend the Free Software Foundation and Qubes. Of all the sites I reviewed, I feel these sites are the only ones who are doing it &ldquo;right&rdquo;.</p>

<ul>
<li>All additional information is optional</li>
<li>A static Bitcoin address is displayed on the main donation page</li>
<li>With a QR code for easy scanning</li>
<li>And a GPG signed statement verifying ownership of the address</li>
</ul>


<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/01.png"></p>

<p>I want to bring special attention to this last point. Bitcoin addresses are almost impossible to remember and have no identifying features to link them to the owner. Hackers could exploit a website and change the address server-side, or a MitM attack could allow the address to be spoofed on the client side (the latter is especially true if using Tor, where the exit node can replace webpage content). For these reasons, Bitcoin addresses displayed on webpages should have an accompanying GPG signature to prove ownership and eliminate the risk of tampering.</p>

<p>A special mention to the folks at Armory. They have set up a <a href="https://bitcoinarmory.com/donation-match-list/">donation matching program</a>, where they provide <a href="https://s3.amazonaws.com/bitcoinarmory-simulnotes/signed_donation_addresses.txt">signed addresses</a> and a method for <a href="https://bitcoinarmory.com/donation-matching/#verify-donation-addresses">verifying the signatures</a>. Curiously, they do not sign their <a href="https://bitcoinarmory.com/contact/">own address</a> on their website (even though it can be obtained from their software).</p>

<p>Many sites had a static address displayed, but failed to provide a QR code for scanning. In fact, of all the I sites reviewed, only the following had QR codes for their static addreses:</p>

<ul>
<li>Free Software Foundation</li>
<li>Qubes</li>
<li>Veracrypt</li>
</ul>


<p>Many other sites use Bitpay or Coinbase to do dynamic addresses: temporary addresses that &ldquo;timeout&rdquo; after a short amount of time. Bitpay is an indespensible tool for merchants that also makes things very easy for the user; for example, on a webpage a user could specify how much they want to donate, and Bitpay will create a special QR code that tells Bitcoin clients to make a transaction for that amount. This interaction reduces the chance of mistyping an amount (remember, Bitcoin transactions cannot be revoked). Each transaction is isolated to a single address. Cycling addresses increases privacy for both the sender and receiver. It also makes creating a receipt easier, and helps clear up any confusion. In fact, the Bitcoin developers themselves discourage <a href="https://en.bitcoin.it/wiki/Address_reuse">address reuse</a>. Here is an example from the Freedom of the Press Foundation:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/02.png"><br/>
(Note, don&rsquo;t actually use that address, it is expired!)</p>

<p>Bitpay&rsquo;s temporary addresses are a blessing and a curse; You cannot sign a temporary address. This also means I cannot share that address with anyone else if I want to promote that website or service; users are required to visit the page, fill out the form, and get their own temporary address to send to. I can&rsquo;t build up an &ldquo;address book&rdquo; of websites/services and their payment address.</p>

<p>RiseUp was the only site I could find that did dynamic addresses without using a 3rd party service like BitPay or Coinbase. Furthermore, they claim that they maintain the private key for the dynamically generated address, and that it doesn&rsquo;t expire. While the approach is novel, I think it leads to the worst of both worlds; they lost the ability to sign their addresses while at the same time didn&rsquo;t receive the other benefits of temporary addresses granted by a service like BitPay. Furthermore, anyone is able to cause RiseUp to generate a new address, but they must keep and manage each generated address, which could be troublesome. Finally, if you go with the &ldquo;address-book&rdquo; method, the dynamically generated addresses are <em>per-person</em>, which promotes tracking.</p>

<blockquote><p><strong>Address Reuse</strong><br/>
By now you may have noticed that I am making some contradictions. I labeled the display of a static address as the &ldquo;right way&rdquo;, then immediately followed up with the Bitcoin Dev&rsquo;s recommendations against address reuse. Remember that this post is in the context of donations. I think the distinction here is that something like Bitpay is perfect (and correct) for sales transactions where I buy a product or service, and displaying a static address is better for donations where I want to ensure the correct recipient gets the money. If I am buying something online, I typically don&rsquo;t care where the money goes as long as I receive what I bought. For example, Amazon heavily utilizes 3rd party merchants, to the point where I rarely notice whether I am paying Amazon directly or some other store. With donations, I am not receiving anything in return other than the reassurance that I am supporting something I believe in, so it becomes more important to verify that the correct entity is receiving my donation. Signatures on static addresses solve this problem. I&rsquo;m interested in hearing other arguments or solutions!</p></blockquote>

<p>Of all the forms I came across, the one for Eclipse was the by far the mosts intuitive and clear:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/03.png"></p>

<p>The form is short and 100% optional. There is even a little checkbox to stay anonymous. Preselected donation amounts are available, as well as a box to specify your own number. I especially liked how I didn&rsquo;t have to scroll all over the page looking for the Bitcoin option; many of the sites I looked at hide the Bitcoin address at the bottom or side of their donation page instead of integrating that option in with the others. Well done Eclipse!</p>

<hr />

<h2>Doing it the wrong way</h2>

<p>Don&rsquo;t misunderstand, I am very happy that Bitcoin was an option for donations. However, I feel that some of these sites are missing the point; A Bitcoin transaction doesn&rsquo;t need any other information besides an address. If you want to receive a donation, you shouldn&rsquo;t need a name, address, email, phone number, etc required. Just take the money!</p>

<p>For example, the EFF requires my name, email, and <em>shipping address</em> to receive a Bitcoin donation:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/04.png"></p>

<p>Wikipedia also requires a shipping address. Why is this information needed? What are they going to send me? Why can&rsquo;t I opt out?</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/05.png"></p>

<p>Even Mozilla won&rsquo;t let me send them a Bitcoin donation without an email address:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/06.png"></p>

<p>What could they need an email address for? A receipt? No need, the blockchain is a public ledger that replaces the need for a receipt. A thank you message? No need, afterall, I&rsquo;m the one thanking <em>you</em> with my donation! Signing me up on an email list? Most likely, and I don&rsquo;t need more spam.</p>

<p>Sorry guys, but you are missing the point. This tells me you are more interested in my information than my support.</p>

<hr />

<h2>Not doing it at all</h2>

<p>Unfortunately, Bitcoin still hasn&rsquo;t hit critical mass. By now, many people have at least heard of it, but the average person doesn&rsquo;t understand how to use it, how it works, or its benefits. There are still many websites that do not have a Bitcoin donation option. Some of the programs I use every day did not accept Bitcoin, however they did take PayPal.</p>

<p>The surprising one here was Debian. Not only do they not take Bitcoin, they don&rsquo;t even take Paypal. Their <a href="https://www.debian.org/donations">preferred methods</a> of payment are credit card or check. Look at how much stuff I need to fill out to donate:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/07.png"></p>

<p>This right here is a prime example of how amazingly simple Bitcoin is.</p>

<p>However, they do bring up some <a href="https://lists.debian.org/debian-project/2014/08/msg00077.html">very interesting points</a> that offer a unique perspective on why accepting Bitcoin donations can be difficult, especially for a large organization:</p>

<ul>
<li>Keep donations in Bitcoin or convert to USD?</li>
<li>If convert, using who? Need a reliable exchange</li>
<li>If convert, when? Immediately, or try to make profit? Bitcoin is volatile</li>
<li>Poor choices here can affect public perception</li>
<li>Regulations on Bitcoin are still not stable</li>
</ul>


<hr />

<p>As you can see, there is a huge disparity in how different websites accept Bitcoin donations. Hopefully this post can give you ideas on how to accept Bitcoin donations on your own website. As a final note, thank you to all my readers for their support, it is appreciated!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/26/object-pool/">Object Pool</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-26T16:11:06-05:00" pubdate data-updated="true">Nov 26<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/11/26/object-pool/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/26/object-pool/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>An object pool is a specialized allocator that allocates memory in large chunks and deals them out in small slices. Malloc is typically an expensive call, especially for multiple small allocations, so significant performance improvements can be gained by managing memory directly. The object pool presented here is compatible with C++03, supports all standard containers, and offers O(1) amortized allocation and deallocation with configurable growth, limits, and alignment.</p>

<p>The pool works by allocating blocks of memory, partitioning them for the object type and alignment, then pushing all the addresses onto a stack representing available slots. Each allocation pops an address off the stack, each deallocation pushes an allocation onto the stack. When the stack is empty, another block is allocated and added to the linked list of blocks.</p>

<h2>Stack</h2>

<p>The primary component of the object pool is the stack of addresses that represent free memory slots for objects. However, this isn&rsquo;t implemented like a typical stack; rather, the stack itself is interleaved through the free slots of the memory block. This means no additional memory is required; the data structure that manages the free memory is stored <em>within</em> the free memory it is managing! Each free slot, which would normally be zeroed out, instead points to the next free slot. Pushing and popping simply involves overwriting these pointers.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">stack</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">T</span><span class="o">*</span>       <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">pointer</span><span class="o">*</span> <span class="n">metapointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_top</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Store the current pointer at the given address</span>
</span><span class='line'>      <span class="o">*</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">metapointer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span> <span class="o">=</span> <span class="n">_top</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Advance the pointer</span>
</span><span class='line'>      <span class="n">_top</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Increment the size</span>
</span><span class='line'>      <span class="o">++</span><span class="n">_size</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">pop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">empty</span><span class="p">()){</span><span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Pop the top of the stack</span>
</span><span class='line'>      <span class="n">pointer</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">_top</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Step back to the previous address</span>
</span><span class='line'>      <span class="n">_top</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">metapointer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_top</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Decrement the size</span>
</span><span class='line'>      <span class="o">--</span><span class="n">_size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Return the next free address</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">top</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_top</span><span class="p">;}</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_size</span><span class="p">;}</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">empty</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">_top</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">_size</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Node</h2>

<p>If the object pool were statically sized, then only a single memory block would be required, and no linked list would be needed. However, to support growth, each memory block is treated as a node in a linked list, allowing for a dynamic number of blocks (and therefore a dynamic amount of allocated memory).</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">node</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_object</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">node</span><span class="o">*</span> <span class="n">link</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="n">next</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_next</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">node</span><span class="o">*</span> <span class="n">next</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_next</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">node</span><span class="p">(</span><span class="n">U</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">arg</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_object</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_next</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">node</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_object</span><span class="p">(),</span>
</span><span class='line'>      <span class="n">_next</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="n">T</span> <span class="n">_object</span><span class="p">;</span>
</span><span class='line'>  <span class="n">node</span><span class="o">*</span> <span class="n">_next</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Growth</h2>

<p>The growth of the pool can be controlled via a template parameter. This parameter is a functor that takes the current size of the pool and returns the new size that the pool should grow to. I provide functors to do exponential growth (like a vector) or linear growth, but it is easy to add a custom one to fine tune growth for your application.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">growth</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">operator</span><span class="p">()(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">exponential</span> <span class="o">:</span> <span class="k">public</span> <span class="n">growth</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">operator</span><span class="p">()(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">increment</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">linear</span> <span class="o">:</span> <span class="k">public</span> <span class="n">growth</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">operator</span><span class="p">()(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">increment</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Pool</h2>

<p>Finally, the pieces can all be put together to create the object pool. Allocation and deallocation consists of pushing and popping from the stack. If the stack is ever emptied, the pool grows by another block. The pool uses lazy allocation and has an efficient copy constructor to allow for quick rebinding; necessary for the standard containers.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">initial_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">final_size</span> <span class="o">=</span> <span class="n">max_allocations</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>          <span class="k">typename</span> <span class="n">growth</span> <span class="o">=</span> <span class="n">exponential</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pool</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">T</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">boundary</span><span class="o">&lt;</span><span class="n">align</span><span class="o">&gt;</span> <span class="n">alignment</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;</span> <span class="n">padding</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">enum</span><span class="p">{</span><span class="n">unit</span> <span class="o">=</span> <span class="n">padding</span><span class="o">::</span><span class="n">value</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Satisfy the allocator traits</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">type</span>              <span class="n">value_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">*</span>       <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">*</span> <span class="n">const_pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">&amp;</span>       <span class="n">reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">const_reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span>       <span class="n">size_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">ptrdiff_t</span>    <span class="n">difference_type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">pointer</span><span class="o">*</span> <span class="n">metapointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">pool</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">,</span> <span class="n">final_size</span><span class="p">,</span> <span class="n">growth</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">grow</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Update the capacity</span>
</span><span class='line'>      <span class="n">_capacity</span> <span class="o">=</span> <span class="n">_size</span> <span class="o">?</span> <span class="n">_growth</span><span class="p">(</span><span class="n">_size</span><span class="p">)</span> <span class="o">:</span> <span class="n">initial_size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Cap at the final size</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">_size</span> <span class="o">+</span> <span class="n">_capacity</span> <span class="o">&gt;</span> <span class="n">final_size</span><span class="p">)</span> <span class="n">_capacity</span> <span class="o">=</span> <span class="n">final_size</span> <span class="o">-</span> <span class="n">_size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Bail out if we hit the upper limit</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">_capacity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">bad_alloc</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Add this new capacity to our total size</span>
</span><span class='line'>      <span class="n">_size</span> <span class="o">+=</span> <span class="n">_capacity</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Allocate a new block of memory as a linked list node</span>
</span><span class='line'>      <span class="n">_current</span> <span class="o">=</span> <span class="n">_current</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">(</span><span class="k">new</span> <span class="n">node</span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_capacity</span> <span class="o">*</span> <span class="n">unit</span> <span class="o">+</span> <span class="n">alignment</span><span class="o">::</span><span class="n">value</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Access the memory</span>
</span><span class='line'>      <span class="kt">void</span><span class="o">*</span> <span class="n">memory</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_current</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Shift context to the new memory block</span>
</span><span class='line'>      <span class="n">_context</span> <span class="o">=</span> <span class="n">partition</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">_capacity</span> <span class="o">*</span> <span class="n">unit</span> <span class="o">+</span> <span class="n">alignment</span><span class="o">::</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Push the slots to the stack</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_capacity</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">_free</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_context</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">count</span><span class="p">,</span> <span class="n">const_pointer</span> <span class="n">hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// If we are out of slots, add more</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">_free</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="n">grow</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Return the next slot</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_free</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Push this pointer onto the free list</span>
</span><span class='line'>      <span class="n">_free</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// This pool only supports allocating one object at a time</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pool</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_head</span><span class="p">(),</span>
</span><span class='line'>      <span class="n">_current</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_head</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_capacity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">pool</span><span class="p">(</span><span class="n">pool</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">,</span> <span class="n">final_size</span><span class="p">,</span> <span class="n">growth</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_head</span><span class="p">(),</span>
</span><span class='line'>      <span class="n">_current</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_head</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_capacity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">~</span><span class="n">pool</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Start at the initial block</span>
</span><span class='line'>      <span class="n">node</span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;*</span> <span class="n">current</span> <span class="o">=</span> <span class="n">_head</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Iterate through each block</span>
</span><span class='line'>      <span class="k">while</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Get the next block</span>
</span><span class='line'>          <span class="n">node</span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;*</span> <span class="n">next</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Delete the current block</span>
</span><span class='line'>          <span class="k">delete</span> <span class="n">current</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Advance to the next block</span>
</span><span class='line'>          <span class="n">current</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="n">node</span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;</span>  <span class="n">_head</span><span class="p">;</span>
</span><span class='line'>  <span class="n">node</span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;*</span> <span class="n">_current</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">_size</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">_capacity</span><span class="p">;</span>
</span><span class='line'>  <span class="n">partition</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;</span> <span class="n">_context</span><span class="p">;</span>
</span><span class='line'>  <span class="n">stack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">_free</span><span class="p">;</span>
</span><span class='line'>  <span class="n">growth</span> <span class="n">_growth</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Stateless</h2>

<p>C++03 allocators are required to be stateless. The standard containers do not accept an allocator instance, rather they construct one themselves. This means that two <code>std::set</code>s of type T will each maintain their own allocator. Clearly, the above pool is not stateless, however we can emulate that behavior by using a singleton. In this manner, there will only ever be one instance of the pool for each type, and all the containers will share the same pool.</p>

<p>This is implemented using a <code>stateless</code> allocator adapter. Each call to allocate / deallocate is routed through a singleton to the underlying policy.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>          <span class="k">typename</span> <span class="n">Policy</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">stateless</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// Forward typedefs</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">T</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">type</span>              <span class="n">value_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">*</span>       <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">*</span> <span class="n">const_pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">&amp;</span>       <span class="n">reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">const_reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span>       <span class="n">size_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">ptrdiff_t</span>    <span class="n">difference_type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">stateless</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Policy</span><span class="o">::</span><span class="k">template</span> <span class="n">rebind</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">other</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">stateless</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyU</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">stateless</span><span class="p">(</span><span class="n">stateless</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">PolicyU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">count</span><span class="p">,</span> <span class="n">const_pointer</span> <span class="n">hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Policy</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">().</span><span class="n">allocate</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">hint</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Policy</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">().</span><span class="n">deallocate</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Policy</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">().</span><span class="n">max_size</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Hybrid</h2>

<p>One caveat to the object pool is that it only supports the allocation of a single object at a time. This means the object pool will not work for <code>vector</code>s and some implementations of <code>deque</code>, because these data structures allocate multiple contiguous objects at a time. However, the point of the object pool is to alleviate performance issues related to multiple calls of malloc with small sizes. Vectors do this automatically, so the object pool cannot improve their performance.</p>

<p>Rather than trying to remember which data structures and implementations the pool supports, it would be better to allow the pool to support <em>all</em> the containers. To do this, a <code>hybrid</code> allocator adapter is used that forwards all allocations of a single object to the pool, and all allocations of multiple objects to the heap.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>          <span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>          <span class="k">typename</span> <span class="n">M</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">hybrid</span> <span class="o">:</span> <span class="k">public</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>                  <span class="k">public</span> <span class="n">M</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Template parameters</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">T</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">S</span> <span class="n">single</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">M</span> <span class="n">multiple</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Satisfy the allocator traits</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">type</span>              <span class="n">value_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">*</span>       <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">*</span> <span class="n">const_pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">&amp;</span>       <span class="n">reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">const_reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span>       <span class="n">size_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">ptrdiff_t</span>    <span class="n">difference_type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">hybrid</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span>
</span><span class='line'>                          <span class="k">typename</span>   <span class="n">single</span><span class="o">::</span><span class="k">template</span> <span class="n">rebind</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">other</span><span class="p">,</span>
</span><span class='line'>                          <span class="k">typename</span> <span class="n">multiple</span><span class="o">::</span><span class="k">template</span> <span class="n">rebind</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">other</span>
</span><span class='line'>                        <span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">hybrid</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="p">,</span>
</span><span class='line'>              <span class="k">typename</span> <span class="n">SinglePolicyU</span><span class="p">,</span>
</span><span class='line'>              <span class="k">typename</span> <span class="n">MultiplePolicyU</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">hybrid</span><span class="p">(</span><span class="n">hybrid</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">SinglePolicyU</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">MultiplePolicyU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">single</span><span class="p">(</span><span class="n">other</span><span class="p">),</span>
</span><span class='line'>      <span class="n">multiple</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Resolve ambiguities by forwarding allocation / deallocation</span>
</span><span class='line'>  <span class="c1">// requests to the proper policy</span>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">count</span><span class="p">,</span> <span class="n">const_pointer</span> <span class="n">hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">single</span><span class="o">::</span><span class="n">allocate</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">hint</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">multiple</span><span class="o">::</span><span class="n">allocate</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">hint</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">single</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">multiple</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">multiple</span><span class="o">::</span><span class="n">max_size</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Final Result</h2>

<p>The pool and all of it&rsquo;s pieces are very configurable, but a good set of defaults can be selected that will work just fine for most cases. It is best to take all the policies, traits, and adapters, and fold them all together into a single struct or typedef to make it easier to use. Then, it can be simply plugged into the allocator template parameter of any standard container.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">fast_allocator</span> <span class="o">:</span> <span class="k">public</span>
</span><span class='line'>   <span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
</span><span class='line'>               <span class="n">hybrid</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">stateless</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
</span><span class='line'>                                     <span class="n">pool</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
</span><span class='line'>                                        <span class="mi">16</span><span class="p">,</span>
</span><span class='line'>                                        <span class="mi">16</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">max_allocations</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">exponential</span>
</span><span class='line'>                                       <span class="o">&gt;</span>
</span><span class='line'>                                    <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">heap</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
</span><span class='line'>                             <span class="mi">16</span>
</span><span class='line'>                             <span class="o">&gt;</span>
</span><span class='line'>                       <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">object_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="o">&gt;</span>
</span><span class='line'><span class="p">{};</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Foo</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">less</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">fast_allocator</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">PooledFooSet</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/25/memory-blocks/">Memory Blocks</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-25T16:10:58-05:00" pubdate data-updated="true">Nov 25<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/11/25/memory-blocks/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/25/memory-blocks/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Memory pools work by taking a large chunk of memory and dealing out small pieces of it upon allocation requests. Object pools are a specialized version that treat the memory as an array of objects, such that each &ldquo;slot&rdquo; is the same size. In reality, managing an object pool involves more than <em>just</em> an array of objects due to alignment and padding.</p>

<p>When doing 100% of your own memory management, it becomes useful to have a set of tools to assist with organizing memory. You can think of a chunk of memory as being similar to an empty hard drive; the act of aligning, partitioning, and padding the memory is similar to formatting a hard drive with a filesystem.</p>

<p>There are a few different ways to acquire a block of memory. The following lines allocate a block of 32 bytes:</p>

<pre><code>char memory[32];
char* memory = static_cast&lt;char*&gt;(malloc(32));
</code></pre>

<p>Notice how <code>sizeof(memory)</code> for each of those lines will give different results. A contiguous block of memory is represented by a starting address and a size; both values are needed to do anything useful with it. For static and local stack memory, the size is known at compile time, however for dynamic memory allocated on the heap, the size must be maintained separately.</p>

<h3>Memory Block</h3>

<p>A class that acts similar to a smart pointer for memory blocks can do the memory management for us, including holding the size and calling free upon destruction. The following is an implementation of a memory block class:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">block</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Constructor, size in bytes</span>
</span><span class='line'>  <span class="n">block</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">_memory</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Default Constructor</span>
</span><span class='line'>  <span class="n">block</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Destructor</span>
</span><span class='line'>  <span class="o">~</span><span class="n">block</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">_memory</span><span class="p">)</span> <span class="n">free</span><span class="p">(</span><span class="n">_memory</span><span class="p">);}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Access a specific byte of memory</span>
</span><span class='line'>  <span class="n">byte</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">[](</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">){</span><span class="k">return</span> <span class="n">_memory</span><span class="p">[</span><span class="n">i</span><span class="p">];}</span>
</span><span class='line'>  <span class="n">byte</span> <span class="k">const</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">[](</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_memory</span><span class="p">[</span><span class="n">i</span><span class="p">];}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Dereference operator makes the block act like a pointer</span>
</span><span class='line'>  <span class="n">byte</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="o">*</span><span class="n">_memory</span><span class="p">;}</span>
</span><span class='line'>  <span class="n">byte</span> <span class="k">const</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="o">*</span><span class="n">_memory</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Address-of operator returns the address of the memory</span>
</span><span class='line'>  <span class="n">byte</span><span class="o">*</span> <span class="k">operator</span><span class="o">&amp;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="n">_memory</span><span class="p">;}</span>
</span><span class='line'>  <span class="n">byte</span> <span class="k">const</span><span class="o">*</span> <span class="k">operator</span><span class="o">&amp;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_memory</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Size of the memory in bytes</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_size</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="n">byte</span><span class="o">*</span> <span class="n">_memory</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">_size</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using this class is simple:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">block</span> <span class="n">memory</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span class='line'>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">memory</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">memory</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">memory</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">memory</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Outputs:</p>

<pre><code>32
A
A
</code></pre>

<p>As you can see, the memory block class acts just like a pointer to an array of bytes. This is a convienient building block for creating an object pool.</p>

<h3>Padding</h3>

<p>When creating an array of objects, you may need to ensure that each object is properly aligned. If you ensure that the first object is aligned, and that each object is padded properly, then you have the guarantee that <em>all</em> the objects in the array are aligned. Padding the object will result in some excess space being used in order to make sure the next object is properly aligned. Below is a small helper class that can pad any type to the next multiple of <code>X</code> bytes.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">multiple</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pad</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">enum</span><span class="p">{</span><span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">multiple</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">multiple</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiple</span><span class="p">};</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">enum</span><span class="p">{</span><span class="n">value</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)};</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is an example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">Data</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Data</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="mi">16</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Outputs:</p>

<pre><code>17
18
20
24
32
</code></pre>

<h3>Partitioning</h3>

<p>Once you have a raw memory block, it needs to be partitioned before it can be used. The act of partitioning will align and pad the memory block and allow slots to be accessed for object storage. In other words, a partitioned memory block will act just like an array:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">partition</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Pad T for alignment</span>
</span><span class='line'>  <span class="k">enum</span><span class="p">{</span><span class="n">unit</span> <span class="o">=</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Default Constructor</span>
</span><span class='line'>  <span class="n">partition</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Constructor</span>
</span><span class='line'>  <span class="n">partition</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">memory</span><span class="p">,</span>
</span><span class='line'>              <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>     <span class="n">_memory</span><span class="p">(</span><span class="n">boundary</span><span class="o">&lt;</span><span class="n">align</span><span class="o">&gt;::</span><span class="n">next</span><span class="p">(</span><span class="n">memory</span><span class="p">)),</span>
</span><span class='line'>     <span class="n">_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// Return the number of T&#39;s that can fit inside the memory</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">capacity</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">_size</span> <span class="o">-</span> <span class="n">align</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">unit</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Access a specific T</span>
</span><span class='line'>  <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">[](</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">capacity</span><span class="p">()){</span><span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);}</span>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span>
</span><span class='line'>                   <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span>
</span><span class='line'>                      <span class="n">_memory</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">unit</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="kt">void</span><span class="o">*</span> <span class="n">_memory</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">_size</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is some example usage, borrowing the memory dumper from a <a href="http://jrruethe.github.io/blog/2015/08/23/placement-new/">previous blog post</a>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">Data</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>     <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">memory</span><span class="p">[</span><span class="mi">54</span><span class="p">];</span>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">partition</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;</span> <span class="n">array</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dump_memory</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">array</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">();</span>
</span><span class='line'>  <span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">();</span>
</span><span class='line'>  <span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dump_memory</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the output:</p>

<pre><code>-----------------------------------------------------------------------
54 bytes              0  1  2  3   4  5  6  7   8  9  A  B   C  D  E  F
0x00007FFFE9D71680:  CC CC CC CC  CC CC CC CC  CC CC CC CC  CC CC CC CC
0x00007FFFE9D71690:  CC CC CC CC  CC CC CC CC  CC CC CC CC  CC CC CC CC
0x00007FFFE9D716A0:  CC CC CC CC  CC CC CC CC  CC CC CC CC  CC CC CC CC
0x00007FFFE9D716B0:  CC CC CC CC  CC CC
-----------------------------------------------------------------------
5
0x00007FFFE9D71680
0x00007FFFE9D71688
0x00007FFFE9D71690
0x00007FFFE9D71698
-----------------------------------------------------------------------
54 bytes              0  1  2  3   4  5  6  7   8  9  A  B   C  D  E  F
0x00007FFFE9D71680:  CC CC CC CC  CC CC CC CC  AA AA AA AA  AA AA CC CC
0x00007FFFE9D71690:  CC CC CC CC  CC CC CC CC  CC CC CC CC  CC CC CC CC
0x00007FFFE9D716A0:  AA AA AA AA  AA AA CC CC  AA AA AA AA  AA AA CC CC
0x00007FFFE9D716B0:  CC CC CC CC  CC CC
-----------------------------------------------------------------------
</code></pre>

<p>As you can see, the data objects stored inside the partitioned memory are padded and 8 byte aligned. The alignment caveats mentioned in the <a href="http://jrruethe.github.io/blog/2015/08/23/placement-new/">previous post</a> apply, including the wasted space at the beginning of the array.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/24/google-test/">Google Test</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-24T16:10:22-05:00" pubdate data-updated="true">Nov 24<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/11/24/google-test/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/24/google-test/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post is a quick introduction to Google Test and how to use it to test your C++ code. Google Test is a unit testing framework that is easy to use and creates meaningful tests with intuitive output.</p>

<h3>Installing</h3>

<p>On Debian based systems, you will want to install the following packages:</p>

<ul>
<li>libgtest-dev</li>
<li>build-essential</li>
<li>cmake</li>
</ul>


<p>Note that <code>libgtest-dev</code> includes the headers and sources, but not the compiled libraries. Follow the instructions below to compile and install the libraries<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<pre><code>cd /tmp
mkdir build
cd build
cmake -DCMAKE_BUILD_TYPE=RELEASE /usr/src/gtest/
make
sudo mv libgtest* /usr/lib/
</code></pre>

<p>You could also use <code>checkinstall</code> to create a deb package containing the library files.</p>

<h3>Using</h3>

<p>To get started, you will need to:</p>

<ol>
<li>Include the Google Test headers</li>
<li>Write a <code>TEST</code> section</li>
<li>Initiate the unit tests from <code>main()</code></li>
</ol>


<p>Tests are composed of various <code>EXPECT_*</code> statements to ensure that functions return expected values, etc. For a full description of the various types of tests that can be written using Google Test, refer to the documents below:</p>

<ul>
<li><a href="https://github.com/google/googletest/blob/master/googletest/docs/V1_7_Primer.md">Primer</a></li>
<li><a href="https://github.com/google/googletest/blob/master/googletest/docs/V1_7_FAQ.md">FAQ</a></li>
<li><a href="https://github.com/google/googletest/blob/master/googletest/docs/V1_7_AdvancedGuide.md">Advanced Guide</a></li>
<li><a href="https://github.com/google/googletest/blob/master/googlemock/docs/ForDummies.md">Google Mock</a></li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;gtest/gtest.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">TEST</span><span class="p">(</span><span class="n">TestGroup</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">InitGoogleTest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">RUN_ALL_TESTS</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>One thing to remember with the <code>EXPECT_*</code> statements is that the <em>first</em> argument is the hardcoded expected value (ie: the &ldquo;truth&rdquo;), and the <code>second</code> parameter is the variable or function call to be tested.</p>

<p>To compile, you need to link against both the compiled gtest library as well as pthread:</p>

<pre><code>g++ -g -O0 main.cpp -lgtest -pthread
</code></pre>

<p>The output will look something like this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="p">[</span><span class="o">==========</span><span class="p">]</span> <span class="n">Running</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">from</span> <span class="mi">1</span> <span class="n">test</span> <span class="k">case</span><span class="p">.</span>
</span><span class='line'><span class="p">[</span><span class="o">----------</span><span class="p">]</span> <span class="n">Global</span> <span class="n">test</span> <span class="n">environment</span> <span class="n">set</span><span class="o">-</span><span class="n">up</span><span class="p">.</span>
</span><span class='line'><span class="p">[</span><span class="o">----------</span><span class="p">]</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">from</span> <span class="n">TestGroup</span>
</span><span class='line'><span class="p">[</span> <span class="n">RUN</span>      <span class="p">]</span> <span class="n">TestGroup</span><span class="p">.</span><span class="n">TestCase</span>
</span><span class='line'><span class="p">[</span>       <span class="n">OK</span> <span class="p">]</span> <span class="n">TestGroup</span><span class="p">.</span><span class="n">TestCase</span> <span class="p">(</span><span class="mi">0</span> <span class="n">ms</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="o">----------</span><span class="p">]</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">from</span> <span class="n">TestGroup</span> <span class="p">(</span><span class="mi">0</span> <span class="n">ms</span> <span class="n">total</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="o">----------</span><span class="p">]</span> <span class="n">Global</span> <span class="n">test</span> <span class="n">environment</span> <span class="n">tear</span><span class="o">-</span><span class="n">down</span>
</span><span class='line'><span class="p">[</span><span class="o">==========</span><span class="p">]</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">from</span> <span class="mi">1</span> <span class="n">test</span> <span class="k">case</span> <span class="n">ran</span><span class="p">.</span> <span class="p">(</span><span class="mi">0</span> <span class="n">ms</span> <span class="n">total</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span>  <span class="n">PASSED</span>  <span class="p">]</span> <span class="mi">1</span> <span class="n">test</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Google Test is a great way to ensure that your code is working properly. I often use Google Test with a relaxed form of <em>Test Driven Development</em><sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="http://askubuntu.com/questions/145887/why-no-library-files-installed-for-google-test">Why no library files installed for google test?</a> &ndash; Wojciech Migda <a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="https://en.wikipedia.org/wiki/Test-driven_development">Test Driven Development</a><a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/23/aligned-heap/">Aligned Heap</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-23T18:01:02-05:00" pubdate data-updated="true">Nov 23<span>rd</span>, 2015</time>
        
           | <a href="/blog/2015/11/23/aligned-heap/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/23/aligned-heap/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the <a href="http://jrruethe.github.io/blog/2015/11/22/allocators/">previous post</a>, I introduced an allocator framework that supports pluggable policies. An example heap policy was given. This post will expand on the heap to give it alignment abilities. You may want to refer to <a href="http://jrruethe.github.io/blog/2015/08/23/placement-new/">another previous post</a> on alignment.</p>

<p>The code modifications are simple; allocate a little more data, align the pointer when allocating, then unalign it before deallocating:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>         <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">heap</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ALLOCATOR_TRAITS</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Default Constructor</span>
</span><span class='line'>  <span class="n">heap</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Copy Constructor</span>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">heap</span><span class="p">(</span><span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Allocate memory</span>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">count</span><span class="p">,</span> <span class="n">const_pointer</span> <span class="n">hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Request additional memory to perform alignment</span>
</span><span class='line'>      <span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="o">::</span><span class="k">operator</span> <span class="k">new</span><span class="p">((</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="o">+</span> <span class="n">boundary</span><span class="o">&lt;</span><span class="n">align</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">nothrow</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Align the pointer</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">pointer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boundary</span><span class="o">&lt;</span><span class="n">align</span><span class="o">&gt;::</span><span class="n">align</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Deallocate memory</span>
</span><span class='line'>  <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Unalign the pointer and delete the memory</span>
</span><span class='line'>      <span class="o">::</span><span class="k">operator</span> <span class="k">delete</span><span class="p">(</span><span class="n">boundary</span><span class="o">&lt;</span><span class="n">align</span><span class="o">&gt;::</span><span class="n">unalign</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Max number of objects that can be allocated in one call</span>
</span><span class='line'>  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">max_allocations</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the aligned heap no different than the previous version. If you leave out the alignment template parameter, it will act the same as before.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number marked'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;set&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Example</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Example</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Example</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">other</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// Increase scope</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line marked start end'>     <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Example</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">less</span><span class="o">&lt;</span><span class="n">Example</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="n">Example</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">Example</span><span class="p">,</span> <span class="mi">16</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// Leaving scope</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/22/allocators/">C++ Allocators</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-22T16:10:49-05:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2015</time>
        
           | <a href="/blog/2015/11/22/allocators/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/22/allocators/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post will discuss how to make a STL compliant allocator.</p>

<p>All of the standard containers support a 2nd (or 3rd) template parameter to specify the allocator that should be used. Each container allocates memory to store the objects it contains, and it uses the allocator to obtain the memory required for this storage. By using a custom allocator, you can remain in control of how memory is managed.</p>

<p>Custom allocators are useful for a variety of cases:</p>

<ul>
<li>Reducing system call overhead when requesting multiple small memory blocks</li>
<li>Improving cache efficiency by keeping memory contiguous</li>
<li>Using standard containers with memory-mapped io, or a memory-mapped file for persistent containers</li>
<li>Maintaining 100% control of memory for embedded systems or game development</li>
</ul>


<p>Wikipedia summarizes it well<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<blockquote><p>One of the main reasons for writing a custom allocator is performance. Utilizing a specialized custom allocator may substantially improve the performance or memory usage, or both, of the program. The default allocator uses operator new to allocate memory. This is often implemented as a thin layer around the C heap allocation functions, which are usually optimized for infrequent allocation of large memory blocks. This approach may work well with containers that mostly allocate large chunks of memory, like vector and deque. However, for containers that require frequent allocations of small objects, such as map and list, using the default allocator is generally slow. Other common problems with a malloc-based allocator include poor locality of reference, and excessive memory fragmentation.</p></blockquote>

<p>The allocators discussed in this post are meant to be used with C++03. C++11 adds more support for custom allocators, and makes them easier to implement. Furthermore, C++03 allocators are compatible with C++11, but not the other way around.</p>

<p>Creating a custom allocator may seem difficult, but the core concept is pretty simple. Here are the basic rules:</p>

<ul>
<li>Cannot have state (C++03 only)</li>
<li>Must support certain typedefs and methods</li>
<li>Must support type rebinding</li>
<li>Allocators of the same type must compare equally</li>
</ul>


<p>No state also means no virtual functions, as the vtable can be considered state. Normal inheritance is okay, however it is generally considered bad practice to derive from std::allocator. Instead, we will create our own allocator using policies and traits. The methods that need to be implemented can be separated into two categories: those that are related to the allocator, and those that are related to the object being allocated. This distinction defines the policy and traits we will implement.<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<blockquote><p><strong>Policies and Traits</strong><sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup><br/>
Policies are classes (or class templates) to inject behavior into a parent class, typically through inheritance. By decomposing a parent interface into orthogonal (independent) dimensions, policy classes form the building blocks of more complex interfaces. Traits are class templates to extract properties from a generic type. Traits are often used in template-metaprogramming and SFINAE tricks to overload a function template based on a type condition.</p></blockquote>

<h3>Object Traits</h3>

<p>The first thing to define is the object traits. This structure is responsible for creating and destroying objects, as well as returning the address of an object. Note that classes support overriding the &ldquo;address-of&rdquo; operator, so the object traits will need to be specialized for those classes. The object traits can also be specialized for a type to keep track of the number of instantiations using the allocator, much like the object counter works.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">object_traits</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">object_traits</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Constructor</span>
</span><span class='line'>   <span class="n">object_traits</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Copy Constructor</span>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">object_traits</span><span class="p">(</span><span class="n">object_traits</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Address of object</span>
</span><span class='line'>   <span class="n">type</span><span class="o">*</span>       <span class="n">address</span><span class="p">(</span><span class="n">type</span><span class="o">&amp;</span>       <span class="n">obj</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="o">&amp;</span><span class="n">obj</span><span class="p">;}</span>
</span><span class='line'>   <span class="n">type</span> <span class="k">const</span><span class="o">*</span> <span class="n">address</span><span class="p">(</span><span class="n">type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="o">&amp;</span><span class="n">obj</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Construct object</span>
</span><span class='line'>   <span class="kt">void</span> <span class="n">construct</span><span class="p">(</span><span class="n">type</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">ref</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// In-place copy construct</span>
</span><span class='line'>      <span class="k">new</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="n">type</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Destroy object</span>
</span><span class='line'>   <span class="kt">void</span> <span class="n">destroy</span><span class="p">(</span><span class="n">type</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Call destructor</span>
</span><span class='line'>      <span class="n">ptr</span><span class="o">-&gt;~</span><span class="n">type</span><span class="p">();</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Rebinding</h3>

<p>Notice the special <code>rebind</code> struct in the above code. This is a convention used by the STL to allow for chainging the type of the allocator. For example, when you make a <code>std::list&lt;T&gt;</code>, internally the type is being rebound to <code>std::list&lt;Node&lt;T&gt; &gt;</code>, because lists store nodes that contain a T, not the T itself. To support this, the allocator itself must support rebinding such that memory is allocated for the node, not just T.</p>

<h3>Allocator Traits</h3>

<p>The allocator policies require a certain set of typedefs to be present. In most cases, they can all be derived from the type of the allocator, so it makes sense to use a macro:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#define ALLOCATOR_TRAITS(T)                \</span>
</span><span class='line'><span class="cp">typedef T                 type;            \</span>
</span><span class='line'><span class="cp">typedef type              value_type;      \</span>
</span><span class='line'><span class="cp">typedef value_type*       pointer;         \</span>
</span><span class='line'><span class="cp">typedef value_type const* const_pointer;   \</span>
</span><span class='line'><span class="cp">typedef value_type&amp;       reference;       \</span>
</span><span class='line'><span class="cp">typedef value_type const&amp; const_reference; \</span>
</span><span class='line'><span class="cp">typedef std::size_t       size_type;       \</span>
</span><span class='line'><span class="cp">typedef std::ptrdiff_t    difference_type; \</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Allocator Policy</h3>

<p>Next, the actual allocator policy needs to be defined. The allocator policy is responsible for allocating and deallocating memory. For this example, a simple heap allocator will work. The functionality will mimic that of the standard allocator:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">max_allocations</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">enum</span><span class="p">{</span><span class="n">value</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)};</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">heap</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ALLOCATOR_TRAITS</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Default Constructor</span>
</span><span class='line'>  <span class="n">heap</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Copy Constructor</span>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">heap</span><span class="p">(</span><span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Allocate memory</span>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">count</span><span class="p">,</span> <span class="n">const_pointer</span> <span class="cm">/* hint */</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">()){</span><span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">bad_alloc</span><span class="p">();}</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">pointer</span><span class="o">&gt;</span><span class="p">(</span><span class="o">::</span><span class="k">operator</span> <span class="k">new</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">),</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">nothrow</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Delete memory</span>
</span><span class='line'>  <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_type</span> <span class="cm">/* count */</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="o">::</span><span class="k">operator</span> <span class="k">delete</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Max number of objects that can be allocated in one call</span>
</span><span class='line'>  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">max_allocations</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Allocator</h3>

<p>Now that we have all the pieces, it is time to bring them all together. The actual allocator class is nothing more than a wrapper to combine the above into one common place. The key to the allocator wrapper is that it inherits from the allocator policy and object traits, thus the combination satisfies all the requirements for a compliant allocator.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#define FORWARD_ALLOCATOR_TRAITS(C)                  \</span>
</span><span class='line'><span class="cp">typedef typename C::value_type      value_type;      \</span>
</span><span class='line'><span class="cp">typedef typename C::pointer         pointer;         \</span>
</span><span class='line'><span class="cp">typedef typename C::const_pointer   const_pointer;   \</span>
</span><span class='line'><span class="cp">typedef typename C::reference       reference;       \</span>
</span><span class='line'><span class="cp">typedef typename C::const_reference const_reference; \</span>
</span><span class='line'><span class="cp">typedef typename C::size_type       size_type;       \</span>
</span><span class='line'><span class="cp">typedef typename C::difference_type difference_type; \</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">PolicyT</span> <span class="o">=</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">TraitsT</span> <span class="o">=</span> <span class="n">object_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">allocator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PolicyT</span><span class="p">,</span>
</span><span class='line'>                  <span class="k">public</span> <span class="n">TraitsT</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Template parameters</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">PolicyT</span> <span class="n">Policy</span><span class="p">;</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">TraitsT</span> <span class="n">Traits</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">FORWARD_ALLOCATOR_TRAITS</span><span class="p">(</span><span class="n">Policy</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span>
</span><span class='line'>                         <span class="k">typename</span> <span class="n">Policy</span><span class="o">::</span><span class="k">template</span> <span class="n">rebind</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">other</span><span class="p">,</span>
</span><span class='line'>                         <span class="k">typename</span> <span class="n">Traits</span><span class="o">::</span><span class="k">template</span> <span class="n">rebind</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">other</span>
</span><span class='line'>                        <span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Constructor</span>
</span><span class='line'>    <span class="n">allocator</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Copy Constructor</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="p">,</span>
</span><span class='line'>             <span class="k">typename</span> <span class="n">PolicyU</span><span class="p">,</span>
</span><span class='line'>             <span class="k">typename</span> <span class="n">TraitsU</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">allocator</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">PolicyU</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">TraitsU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>       <span class="n">Policy</span><span class="p">(</span><span class="n">other</span><span class="p">),</span>
</span><span class='line'>       <span class="n">Traits</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how the rebinding structure works here; the policy and traits classes are both rebound to the new type when the overall allocator is rebound.</p>

<h3>Equality operators</h3>

<p>The STL uses the equality operator to determine if memory allocated by one allocator can be deallocated with another. Normally, a heap allocator can be used interchangably between types, so the equality operator would return true. However, with this allocator framework, different policies can be plugged in, and some policies may not be interchangable. Therefore, the equality operator will default to false. Specializations of the equality operators can be made for specific policies to register equality, such as he heap policy:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Two allocators are not equal unless a specialization says so</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyU</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsU</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">PolicyU</span><span class="p">,</span> <span class="n">TraitsU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Also implement inequality</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyU</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsU</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">PolicyU</span><span class="p">,</span> <span class="n">TraitsU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Comparing an allocator to anything else should not show equality</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">OtherAllocator</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">OtherAllocator</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Also implement inequality</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">OtherAllocator</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">OtherAllocator</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Specialize for the heap policy</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsU</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">TraitsU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Also implement inequality</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsU</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">TraitsU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Using the Allocator</h3>

<p>Using the allocator is simple, just pass it into the 2nd (or 3rd) template parameter of a container. Remember that some containers (like <code>set</code>) have a second template parameter that accepts a comparator.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;set&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Example</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Example</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Example</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">other</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// Increase scope</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Example</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">less</span><span class="o">&lt;</span><span class="n">Example</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="n">Example</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">Example</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// Leaving scope</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that is how to make an allocator! A future blog post will discuss different policies that can be created.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="http://stackoverflow.com/questions/14718055/what-is-the-difference-between-a-trait-and-a-policy/14723986#14723986">What is the difference between a trait and a policy?</a> &ndash; TemplateRex<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="http://www.codeproject.com/Articles/4795/C-Standard-Allocator-An-Introduction-and-Implement">C++ Standard Allocator, An Introduction and Implementation</a> &ndash; Lai Shiaw San Kent<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p><a href="https://en.wikipedia.org/wiki/Allocator_%28C%2B%2B%29#Custom_allocators">Allocator (C++)</a><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/14/stopwatch/">Stopwatch</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-14T11:37:52-05:00" pubdate data-updated="true">Nov 14<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/11/14/stopwatch/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/14/stopwatch/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Object counters and memory pools are great ways to monitor the memory usage of your program from within. It can also be useful to monitor the amount of time being spent executing from within your program. This post presents a stopwatch that can provide statistics on how long something takes to run.</p>

<p>This project will require the following libraries to compile:</p>

<ul>
<li>libboost-chrono-dev</li>
<li>libboost-thread-dev</li>
<li>libboost-system-dev</li>
</ul>


<p>The idea with the stopwatch is to provide simple <code>start</code> and <code>stop</code> methods to monitor execution time, and store statistics that can be programatically accessed. Two stopwatch types will be presented: a static stopwatch and an instantiatable stopwatch. Each has its uses, with advantages and disadvantages:</p>

<ul>
<li>Static stopwatches can be differentiated using tags, and can be accessed anywhere</li>
<li>Object stopwatches can be managed at runtime, but must be passed around to be effective</li>
</ul>


<p>First, we must define the statistics that will be managed:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">Statistics</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">last</span><span class="p">;</span>    <span class="c1">// Last measured difference</span>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">min</span><span class="p">;</span>     <span class="c1">// Minimum measured difference</span>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">max</span><span class="p">;</span>     <span class="c1">// Maximum measured difference</span>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">samples</span><span class="p">;</span> <span class="c1">// Number of samples taken</span>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">total</span><span class="p">;</span>   <span class="c1">// Total measured difference</span>
</span><span class='line'>   <span class="kt">double</span> <span class="n">average</span><span class="p">;</span> <span class="c1">// Average measured difference</span>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">mark</span><span class="p">;</span>    <span class="c1">// Time when started</span>
</span><span class='line'>   <span class="kt">bool</span>   <span class="n">running</span><span class="p">;</span> <span class="c1">// Flag indicating that the stopwatch is running</span>
</span><span class='line'>   <span class="kt">bool</span>   <span class="n">cleared</span><span class="p">;</span> <span class="c1">// Flag indicating that the stopwatch is cleared</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Statistics</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">last</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">samples</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">total</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">average</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">mark</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">running</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>
</span><span class='line'>      <span class="n">cleared</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">friend</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">Statistics</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - Last    : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">last</span>    <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot; - Min     : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">min</span>     <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot; - Max     : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">max</span>     <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot; - Average : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">average</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot; - Total   : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">total</span>   <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot; - Samples : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">samples</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">os</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need the actual implementation to track those statistics. It will provide <code>start</code>, <code>stop</code>, and <code>reset</code>, and will utilize a clock to get the timestamps to measure. Both the static and object types will utilize this implementation:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">ClockT</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">StopwatchImplementation</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">ClockT</span> <span class="n">Clock</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">_start</span><span class="p">(</span><span class="n">Statistics</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">mark</span> <span class="o">=</span> <span class="n">_clock</span><span class="p">();</span> <span class="c1">// Get the current time</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">// Stopwatch is now running</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">_stop</span><span class="p">(</span><span class="n">Statistics</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Only update the statistics if the stopwatch was running</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">running</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// No longer running</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Grab the current time</span>
</span><span class='line'>         <span class="n">Count</span> <span class="n">now</span> <span class="o">=</span> <span class="n">_clock</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Calculate the difference while avoiding overflow</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">mark</span>
</span><span class='line'>                      <span class="o">?</span> <span class="n">now</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">mark</span>
</span><span class='line'>                      <span class="o">:</span> <span class="n">stats</span><span class="p">.</span><span class="n">mark</span> <span class="o">-</span> <span class="n">now</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Keep track of the total and samples</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">total</span> <span class="o">+=</span> <span class="n">stats</span><span class="p">.</span><span class="n">last</span><span class="p">;</span>
</span><span class='line'>         <span class="o">++</span><span class="n">stats</span><span class="p">.</span><span class="n">samples</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Do not take a min from a cleared state, or it will be zero</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">cleared</span>
</span><span class='line'>                     <span class="o">?</span> <span class="n">stats</span><span class="p">.</span><span class="n">last</span>
</span><span class='line'>                     <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Get the max</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">max</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Calculate the average</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">average</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">total</span><span class="p">)</span> <span class="o">/</span>
</span><span class='line'>                         <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">samples</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// No longer cleared</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">cleared</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">_reset</span><span class="p">(</span><span class="n">Statistics</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">last</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">min</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">max</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">total</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">average</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">mark</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">cleared</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">_print</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">Statistics</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">Clock</span> <span class="n">_clock</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will notice that the clock has been completely abstracted away from the stopwatch implementation, allowing any functor to be plugged in. By default, we will use <code>boost::chrono::high_resolution_clock</code> with configurable units. Here is the clock implementation:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Resolution</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Clock</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="c1">// Initialize the reference to creation time</span>
</span><span class='line'>      <span class="n">_duration_reference</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">())</span>
</span><span class='line'>   <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Count</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Return the difference between now and the reference in the resolution units</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Count</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">Resolution</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">_duration_reference</span><span class="p">).</span><span class="n">count</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>   <span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">time_point</span> <span class="n">_duration_reference</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are many different configurations that the clock can use:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">hours</span><span class="o">&gt;</span>        <span class="n">HourClock</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">minutes</span><span class="o">&gt;</span>      <span class="n">MinuteClock</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="o">&gt;</span>      <span class="n">SecondClock</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span> <span class="n">MillisecondClock</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span> <span class="n">MicrosecondClock</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">&gt;</span>  <span class="n">NanosecondClock</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have all the pieces, time to make the static and object stopwatch types. First, the static one. It is a static class with a template parameter that allows static instantiations to be differentiated. All methods are static and forwarded to the base class:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">TagT</span>   <span class="o">=</span> <span class="kt">void</span><span class="p">,</span>             <span class="c1">// Specify a tag for &quot;compile-time&quot; instances</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">ClockT</span> <span class="o">=</span> <span class="n">MicrosecondClock</span><span class="o">&gt;</span> <span class="c1">// Default to the microsecond clock</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Stopwatch</span> <span class="o">:</span> <span class="k">public</span> <span class="n">detail</span><span class="o">::</span><span class="n">StopwatchImplementation</span><span class="o">&lt;</span><span class="n">ClockT</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">TagT</span>   <span class="n">Tag</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">ClockT</span> <span class="n">Clock</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">Stopwatch</span><span class="o">&lt;</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Clock</span><span class="o">&gt;</span> <span class="n">Self</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">StopwatchImplementation</span><span class="o">&lt;</span><span class="n">Clock</span><span class="o">&gt;</span> <span class="n">Base</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Forward to the base implementation</span>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">start</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">Base</span><span class="o">::</span><span class="n">_start</span> <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">stop</span>  <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">Base</span><span class="o">::</span><span class="n">_stop</span>  <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">reset</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">Base</span><span class="o">::</span><span class="n">_reset</span> <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">print</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">Base</span><span class="o">::</span><span class="n">_print</span><span class="p">(</span><span class="n">name</span><span class="p">(),</span> <span class="n">_statistics</span><span class="p">,</span> <span class="n">os</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Accessors</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">last</span>    <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">last</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">min</span>     <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">min</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">max</span>     <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">max</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">samples</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">samples</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">total</span>   <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">total</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">double</span> <span class="n">average</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">average</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">detail</span><span class="o">::</span><span class="n">Statistics</span> <span class="n">_statistics</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Return the name of the tag as a string</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">units</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="n">Tag</span><span class="p">).</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Prevent this class from being instantiated</span>
</span><span class='line'>   <span class="n">Stopwatch</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how the tag type defaults to <code>void</code>. We want to specialize the stopwatch for the void type and allow the specialization to act as the object stopwatch. This allows us to omit the tag type to instantiate an object:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Specialize on the void tag to allow creating instances</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">ClockT</span> <span class="o">=</span> <span class="n">MicrosecondClock</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Stopwatch</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">,</span> <span class="n">ClockT</span><span class="o">&gt;</span> <span class="o">:</span> <span class="k">public</span> <span class="n">detail</span><span class="o">::</span><span class="n">StopwatchImplementation</span><span class="o">&lt;</span><span class="n">ClockT</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">ClockT</span>                                 <span class="n">Clock</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">Stopwatch</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">,</span> <span class="n">Clock</span><span class="o">&gt;</span>                 <span class="n">Self</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">StopwatchImplementation</span><span class="o">&lt;</span><span class="n">Clock</span><span class="o">&gt;</span> <span class="n">Base</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>                     <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Stopwatch</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">tag</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Forward to the base implementation</span>
</span><span class='line'>   <span class="kt">void</span> <span class="n">start</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="n">Base</span><span class="o">::</span><span class="n">_start</span> <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>   <span class="kt">void</span> <span class="n">stop</span>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="n">Base</span><span class="o">::</span><span class="n">_stop</span>  <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>   <span class="kt">void</span> <span class="n">reset</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="n">Base</span><span class="o">::</span><span class="n">_reset</span> <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>
</span><span class='line'>   <span class="kt">void</span> <span class="n">print</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">Base</span><span class="o">::</span><span class="n">_print</span><span class="p">(</span><span class="n">_tag</span><span class="p">,</span> <span class="n">_statistics</span><span class="p">,</span> <span class="n">os</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">friend</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">Self</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">obj</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">os</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">os</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Accessors</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">last</span>    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">last</span><span class="p">;}</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">min</span>     <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">min</span><span class="p">;}</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">max</span>     <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">max</span><span class="p">;}</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">samples</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">samples</span><span class="p">;}</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">total</span>   <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">total</span><span class="p">;}</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="kt">double</span> <span class="n">average</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">average</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// The tag for this object</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">_tag</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// A statistics object specifically for this stopwatch instance</span>
</span><span class='line'>   <span class="n">detail</span><span class="o">::</span><span class="n">Statistics</span> <span class="n">_statistics</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>We are all set! Time to test it out:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Define a tag</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Static</span><span class="p">{};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="k">namespace</span> <span class="n">stopwatch</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">Stopwatch</span><span class="o">&lt;</span><span class="n">Static</span><span class="p">,</span> <span class="n">MillisecondClock</span><span class="o">&gt;</span> <span class="n">static_stopwatch</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Stopwatch</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">,</span> <span class="n">MillisecondClock</span><span class="o">&gt;</span> <span class="n">object_stopwatch</span><span class="p">(</span><span class="s">&quot;Object&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">static_stopwatch</span><span class="o">::</span><span class="n">start</span><span class="p">();</span>
</span><span class='line'>      <span class="n">object_stopwatch</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">boost</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">posix_time</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">static_stopwatch</span><span class="o">::</span><span class="n">stop</span><span class="p">();</span>
</span><span class='line'>      <span class="n">object_stopwatch</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">static_stopwatch</span><span class="o">::</span><span class="n">print</span><span class="p">();</span>
</span><span class='line'>  <span class="n">object_stopwatch</span><span class="p">.</span><span class="n">print</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To compile this, run the following command:</p>

<pre><code>g++ stopwatch.cpp -l boost_chrono -l boost_system -l boost_thread
</code></pre>

<p>The output I get is:</p>

<pre><code>Static:
 - Last    : 10
 - Min     : 10
 - Max     : 11
 - Average : 10.19
 - Total   : 1019
 - Samples : 100
Object:
 - Last    : 10
 - Min     : 10
 - Max     : 11
 - Average : 10.19
 - Total   : 1019
 - Samples : 100
</code></pre>

<p>As you can see, both types give the same results.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <img class="center borderless" src="/blog/contact/avatar.png" width="128" height="128">
  <h1>Contact</h1>
  <p>
  <a href="mailto:jrruethe@gmail.com">jrruethe@gmail.com</a><br>
  <a href="https://keybase.io/jrruethe">keybase.io/jrruethe</a><br>
  <a href="https://onename.io/jrruethe">onename.io/jrruethe</a><br>
  <br>Public Key:<br>
  <a href="http://jrruethe.github.io/downloads/code/jrruethe-public.asc">4F40 99F8 276B DBA5 475A<br>8446 4630 BEDC 40B9 35FE</a>
  </p>
</section>
<section>
<a href="https://twitter.com/jrruethe" class="twitter-follow-button" data-show-count="true">Follow @jrruethe</a><br>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jrruethe.github.io/index.html" data-via="jrruethe" data-counturl="http://jrruethe.github.io/index.html" >Tweet</a>
</section>
<section>
<h1>Link to this page</h1>
<br>
<center>
<a href="http://jrruethe.github.io/index.html"><img src="http://chart.apis.google.com/chart?chs=150x150&cht=qr&chld=|0&chco=000000&chl=http://jrruethe.github.io/index.html" alt="post-qrcode"></a>
</center>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/04/17/cryptography-using-openssl/">Cryptography Using OpenSSL</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/04/15/running-docker-in-qubes/">Running Docker in Qubes</a>
      </li>
    
      <li class="post">
        <a href="/blog/2016/01/12/bitcoin-donation-proofs/">Bitcoin Donation Proofs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/04/bitcoin-donations/">Bitcoin Donations</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/26/object-pool/">Object Pool</a>
      </li>
    
  </ul>
</section>
<section>
   <h1>Related Posts</h1>
   <ul class="posts">
   
   </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jrruethe">@jrruethe</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jrruethe',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
	<h1>Bitcoin Donations</h1>
	<br>
	<center>
	<a href="bitcoin:187gRAhdyD2KaAhMND92RQMqQQMQtW678m"><img src="http://blockchain.info/qr?data=187gRAhdyD2KaAhMND92RQMqQQMQtW678m&size=150" alt="Bitcoin"></a><br>
	<a class="small, monospace" href="bitcoin:187gRAhdyD2KaAhMND92RQMqQQMQtW678m">187gRAhdyD2KaAhMN</a><br>
	<a class="small, monospace" href="bitcoin:187gRAhdyD2KaAhMND92RQMqQQMQtW678m">D92RQMqQQMQtW678m</a>
	<br>
	<a href="/downloads/code/bitcoin.txt.asc">Proof</a>
	<br><br>
   <div id="coindesk-widget" data-align="center"></div>
   <script type="text/javascript" src="//widget.coindesk.com/bpiticker/coindesk-widget.min.js?aa4aca"></script>
	</center>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  <span class="license">
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
   - Copyright &copy; 2016 - Joe Ruether - All rights reserved with the following exceptions:
  <br>
   - All embedded code on this page licensed under
    <a href="/blog/downloads/code/gpl-3.0.txt">GPLv3</a>
    or a later version unless otherwise noted
  <br>
   - All non-code text/image content on this page licensed under
    <a href="/blog/downloads/code/cc-by-nc-sa-4.0.txt">CC BY-NC-SA 4.0</a>
    or a later version unless otherwise noted
  </span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jrruethe';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
