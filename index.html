
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Morning Musings</title>
  <meta name="author" content="Joe Ruether">

  
  <meta name="description" content="As promised in my previous post, I made some donations to show my support for open source software projects that accept Bitcoin. Below you will find &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jrruethe.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Morning Musings" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
  jQuery.noConflict();
  var rootUrl = "";
</script>
<script src="/javascripts/openlayers/OpenLayers.js" type="text/javascript"></script>
<script src="/javascripts/maps.js" type="text/javascript"></script>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Morning Musings</a></h1>
  
    <h2>I'm not ready to wake up yet...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jrruethe.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/license">License</a></li>
  <li><a href="/blog/about">About</a></li>
  <li><a href="/blog/contact">Contact</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2016/01/12/bitcoin-donation-proofs/">Bitcoin Donation Proofs</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2016-01-12T21:15:49-05:00" pubdate data-updated="true">Jan 12<span>th</span>, 2016</time>
        
           | <a href="/blog/2016/01/12/bitcoin-donation-proofs/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2016/01/12/bitcoin-donation-proofs/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>As promised in my <a href="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/">previous post</a>, I made some donations to show my support for open source software projects that accept Bitcoin. Below you will find the proofs.</p>

<p>Thank you all for everything you do, it is greatly appreciated and does not go unnoticed. Keep up the great work!</p>

<blockquote><p>Some sites did not provide static addresses. Donations to sites utilizing dynamic addresses are not listed, to prevent accidential reuse of those temporary addresses.</p></blockquote>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>-----BEGIN PGP SIGNED MESSAGE-----
</span><span class='line'>Hash: SHA1
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/19
</span><span class='line'>   Recipient   : Whonix
</span><span class='line'>   Source      : https://www.whonix.org/wiki/Donate
</span><span class='line'>   Address     : 1JgzCCSox56Sh4NnQJqRiwoxKi8oVSZBEd
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : 186bec9c1ffb9f6aaf30acb029b3640cdb5b3ca64ca8c96e6d3525ee925be13a
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to Whonix on Dec 19th, 2015"
</span><span class='line'>   
</span><span class='line'> - Date        : 2015/12/19
</span><span class='line'>   Recipient   : Rumble
</span><span class='line'>   Source      : http://disruptedsystems.org/
</span><span class='line'>   Address     : 1PXXMinxQgYUPXzZq6BixZpJTFeiCLqDqD
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : 900fe2a9eb4c050d51cdc0c554b0ccb19e9060c6ee74367597ca30156b5bf24d
</span><span class='line'>   Message     : "I, Joe Ruether, donated $5 to Rumble on Dec 19th, 2015"
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/19
</span><span class='line'>   Recipient   : Armory
</span><span class='line'>   Source      : https://bitcoinarmory.com/contact/
</span><span class='line'>   Address     : 1ArmoryXcfq7TnCSuZa9fQjRYwJ4bkRKfv
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : caeb52f8689ab152ba183675882c4a2176dbd95f7c01558905b6c74ed8a1f798
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to Armory on Dec 19th, 2015"
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/18
</span><span class='line'>   Recipient   : Tails
</span><span class='line'>   Source      : https://tails.boum.org/contribute/how/donate/index.en.html
</span><span class='line'>   Address     : 1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : 179c3b282b395ebde1282e5faea23695c3e3deb3eaeb617e1ff65c2720eb60c4
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to Tails on Dec 18th, 2015"
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/18
</span><span class='line'>   Recipient   : Veracrypt
</span><span class='line'>   Source      : https://veracrypt.codeplex.com/wikipage?title=Bitcoin%20Donation
</span><span class='line'>   Address     : 1NRoPQsm8by5iWyMMmHQy3P5takur3kYgG
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : ae1e57806c194a4bd2fd22f9a1c003ec6e82062c0197d18c2c06f5f0a65f2466
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to Veracrypt on Dec 18th, 2015"  
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/18
</span><span class='line'>   Recipient   : KeepassX
</span><span class='line'>   Source      : https://www.keepassx.org/donate
</span><span class='line'>   Address     : 1Lij3AvejBSbP58HM7uRmnuGcUpPWddPGt
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : 727747188f5ac883bb20c3724bef6532b4e0b8663d6ed899ab437c7192d66008
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to KeepassX on Dec 18th, 2015"
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/18
</span><span class='line'>   Recipient   : Free Software Foundation
</span><span class='line'>   Source      : https://my.fsf.org/donate
</span><span class='line'>   Address     : 1PC9aZC4hNX2rmmrt7uHTfYAS3hRbph4UN
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : eb4c3ca8cb2dc255c6e65c97a9528e7140b569b336ddfea190d7a9d8523e26a6
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to the Free Software Foundation on Dec 18th, 2015" 
</span><span class='line'>
</span><span class='line'> - Date        : 2015/12/18
</span><span class='line'>   Recipient   : Qubes
</span><span class='line'>   Source      : https://www.qubes-os.org/donate/
</span><span class='line'>   Address     : 14zockMSKKp5MK6X2cHJ3mQwm9MwYsJ39j
</span><span class='line'>   Amount      : 0.021
</span><span class='line'>   Transaction : f1eb94f2a14b33bcd33884da7d9eab314a967b9eb514e599604d518195f05140
</span><span class='line'>   Message     : "I, Joe Ruether, donated $10 to Qubes on Dec 18th, 2015"
</span><span class='line'>
</span><span class='line'>-----BEGIN PGP SIGNATURE-----
</span><span class='line'>Version: GnuPG v1
</span><span class='line'>
</span><span class='line'>iQEcBAEBAgAGBQJWlbpPAAoJEB7MsgHDevApgdoIAKekXgfkkUdnlV21kgAfSVBp
</span><span class='line'>6RZmSYhsYwPBK968qPLcHiRXHH4U42mRP4PKXcj4ylwED4KQVW432VKrz6/F7EuA
</span><span class='line'>Vm9QOjEAesb7gEfLOfI6eoC20aWRR3Y2DOsSOK1tlXm8jK+gv9RshvfBeLVnvF4s
</span><span class='line'>ZAQ8yUOjHyD77j8TKHF5vNMBf0OVnpJxXjS06/93zTpk16z21O+y2YmFpEOkZdPV
</span><span class='line'>tK4OmXv25DzlSUKIabhCEkYGfrfn0zbjfX+NEnAKxhdX5kdBMaKiL1vlMUAFptLg
</span><span class='line'>i6iZQYArzxFD+rGj64DqBLzPXbgEQWztVG8cJ0tKHWRZ9K/xFXBIsmBnAHIsd3s=
</span><span class='line'>=UnE4
</span><span class='line'>-----END PGP SIGNATURE-----</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/12/04/bitcoin-donations/">Bitcoin Donations</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-12-04T20:37:39-05:00" pubdate data-updated="true">Dec 4<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/12/04/bitcoin-donations/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Its that time of year again, and I am reminded by the large banner at the top of Wikipedia. I have some spare change lying around, and I feel like showing my support to fellow programmers who maintain the software I use every day.</p>

<p>I am a strong supporter of Bitcoin and naturally I wanted to use it for donations. I have had my Bitcoin address posted on my blog, and have had a few donations from readers (thank you!). One of the best things about Bitcoin is that anyone can send and receive money without needing to sign up for anything. It is a great way to quickly and convieniently transfer cash, and you can be sure that your transaction reaches the intended person without needing to interact with any middleman.</p>

<p>First, I compiled a list of the major OSS software products I rely on, as well as projects I truely believe in, and found the donation pages for each. I discovered that many of them do provide a way to pay with Bitcoin; however, the methods, formats, and requirements varied greatly. This is a perfect opportunity to provide a review on how easy or difficult it is to donate Bitcoin to websites today. I took my list and trimmed it down to a small subset of different examples. This post will be reviewing the Bitcoin donation methods for the following sites:</p>

<ul>
<li><a href="https://bitcoinarmory.com/contact/">Armory</a></li>
<li><a href="http://www.debian.org/donations">Debian</a></li>
<li><a href="https://www.eclipse.org/donate/">Eclipse</a></li>
<li><a href="https://supporters.eff.org/donate">Electronic Frontier Foundation</a></li>
<li><a href="https://freedom.press/donate">Freedom of the Press Foundation</a></li>
<li><a href="https://my.fsf.org/donate/">Free Software Foundation</a></li>
<li><a href="https://donate.mozilla.org/en-US/give-bitcoin/">Mozilla</a></li>
<li><a href="https://www.qubes-os.org/donate/">Qubes</a></li>
<li><a href="https://www.qubes-os.org/donate/">RiseUp</a></li>
<li><a href="https://veracrypt.codeplex.com/wikipage?title=Bitcoin%20Donation">Veracrypt</a></li>
<li><a href="https://wikimediafoundation.org/wiki/Ways_to_Give#bitcoin">Wikipedia</a></li>
</ul>


<hr />

<h2>Doing it the right way</h2>

<p>I must really commend the Free Software Foundation and Qubes. Of all the sites I reviewed, I feel these sites are the only ones who are doing it &ldquo;right&rdquo;.</p>

<ul>
<li>All additional information is optional</li>
<li>A static Bitcoin address is displayed on the main donation page</li>
<li>With a QR code for easy scanning</li>
<li>And a GPG signed statement verifying ownership of the address</li>
</ul>


<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/01.png"></p>

<p>I want to bring special attention to this last point. Bitcoin addresses are almost impossible to remember and have no identifying features to link them to the owner. Hackers could exploit a website and change the address server-side, or a MitM attack could allow the address to be spoofed on the client side (the latter is especially true if using Tor, where the exit node can replace webpage content). For these reasons, Bitcoin addresses displayed on webpages should have an accompanying GPG signature to prove ownership and eliminate the risk of tampering.</p>

<p>A special mention to the folks at Armory. They have set up a <a href="https://bitcoinarmory.com/donation-match-list/">donation matching program</a>, where they provide <a href="https://s3.amazonaws.com/bitcoinarmory-simulnotes/signed_donation_addresses.txt">signed addresses</a> and a method for <a href="https://bitcoinarmory.com/donation-matching/#verify-donation-addresses">verifying the signatures</a>. Curiously, they do not sign their <a href="https://bitcoinarmory.com/contact/">own address</a> on their website (even though it can be obtained from their software).</p>

<p>Many sites had a static address displayed, but failed to provide a QR code for scanning. In fact, of all the I sites reviewed, only the following had QR codes for their static addreses:</p>

<ul>
<li>Free Software Foundation</li>
<li>Qubes</li>
<li>Veracrypt</li>
</ul>


<p>Many other sites use Bitpay or Coinbase to do dynamic addresses: temporary addresses that &ldquo;timeout&rdquo; after a short amount of time. Bitpay is an indespensible tool for merchants that also makes things very easy for the user; for example, on a webpage a user could specify how much they want to donate, and Bitpay will create a special QR code that tells Bitcoin clients to make a transaction for that amount. This interaction reduces the chance of mistyping an amount (remember, Bitcoin transactions cannot be revoked). Each transaction is isolated to a single address. Cycling addresses increases privacy for both the sender and receiver. It also makes creating a receipt easier, and helps clear up any confusion. In fact, the Bitcoin developers themselves discourage <a href="https://en.bitcoin.it/wiki/Address_reuse">address reuse</a>. Here is an example from the Freedom of the Press Foundation:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/02.png"><br/>
(Note, don&rsquo;t actually use that address, it is expired!)</p>

<p>Bitpay&rsquo;s temporary addresses are a blessing and a curse; You cannot sign a temporary address. This also means I cannot share that address with anyone else if I want to promote that website or service; users are required to visit the page, fill out the form, and get their own temporary address to send to. I can&rsquo;t build up an &ldquo;address book&rdquo; of websites/services and their payment address.</p>

<p>RiseUp was the only site I could find that did dynamic addresses without using a 3rd party service like BitPay or Coinbase. Furthermore, they claim that they maintain the private key for the dynamically generated address, and that it doesn&rsquo;t expire. While the approach is novel, I think it leads to the worst of both worlds; they lost the ability to sign their addresses while at the same time didn&rsquo;t receive the other benefits of temporary addresses granted by a service like BitPay. Furthermore, anyone is able to cause RiseUp to generate a new address, but they must keep and manage each generated address, which could be troublesome. Finally, if you go with the &ldquo;address-book&rdquo; method, the dynamically generated addresses are <em>per-person</em>, which promotes tracking.</p>

<blockquote><p><strong>Address Reuse</strong><br/>
By now you may have noticed that I am making some contradictions. I labeled the display of a static address as the &ldquo;right way&rdquo;, then immediately followed up with the Bitcoin Dev&rsquo;s recommendations against address reuse. Remember that this post is in the context of donations. I think the distinction here is that something like Bitpay is perfect (and correct) for sales transactions where I buy a product or service, and displaying a static address is better for donations where I want to ensure the correct recipient gets the money. If I am buying something online, I typically don&rsquo;t care where the money goes as long as I receive what I bought. For example, Amazon heavily utilizes 3rd party merchants, to the point where I rarely notice whether I am paying Amazon directly or some other store. With donations, I am not receiving anything in return other than the reassurance that I am supporting something I believe in, so it becomes more important to verify that the correct entity is receiving my donation. Signatures on static addresses solve this problem. I&rsquo;m interested in hearing other arguments or solutions!</p></blockquote>

<p>Of all the forms I came across, the one for Eclipse was the by far the mosts intuitive and clear:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/03.png"></p>

<p>The form is short and 100% optional. There is even a little checkbox to stay anonymous. Preselected donation amounts are available, as well as a box to specify your own number. I especially liked how I didn&rsquo;t have to scroll all over the page looking for the Bitcoin option; many of the sites I looked at hide the Bitcoin address at the bottom or side of their donation page instead of integrating that option in with the others. Well done Eclipse!</p>

<hr />

<h2>Doing it the wrong way</h2>

<p>Don&rsquo;t misunderstand, I am very happy that Bitcoin was an option for donations. However, I feel that some of these sites are missing the point; A Bitcoin transaction doesn&rsquo;t need any other information besides an address. If you want to receive a donation, you shouldn&rsquo;t need a name, address, email, phone number, etc required. Just take the money!</p>

<p>For example, the EFF requires my name, email, and <em>shipping address</em> to receive a Bitcoin donation:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/04.png"></p>

<p>Wikipedia also requires a shipping address. Why is this information needed? What are they going to send me? Why can&rsquo;t I opt out?</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/05.png"></p>

<p>Even Mozilla won&rsquo;t let me send them a Bitcoin donation without an email address:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/06.png"></p>

<p>What could they need an email address for? A receipt? No need, the blockchain is a public ledger that replaces the need for a receipt. A thank you message? No need, afterall, I&rsquo;m the one thanking <em>you</em> with my donation! Signing me up on an email list? Most likely, and I don&rsquo;t need more spam.</p>

<p>Sorry guys, but you are missing the point. This tells me you are more interested in my information than my support.</p>

<hr />

<h2>Not doing it at all</h2>

<p>Unfortunately, Bitcoin still hasn&rsquo;t hit critical mass. By now, many people have at least heard of it, but the average person doesn&rsquo;t understand how to use it, how it works, or its benefits. There are still many websites that do not have a Bitcoin donation option. Some of the programs I use every day did not accept Bitcoin, however they did take PayPal.</p>

<p>The surprising one here was Debian. Not only do they not take Bitcoin, they don&rsquo;t even take Paypal. Their <a href="https://www.debian.org/donations">preferred methods</a> of payment are credit card or check. Look at how much stuff I need to fill out to donate:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/12/04/bitcoin-donations/07.png"></p>

<p>This right here is a prime example of how amazingly simple Bitcoin is.</p>

<p>However, they do bring up some <a href="https://lists.debian.org/debian-project/2014/08/msg00077.html">very interesting points</a> that offer a unique perspective on why accepting Bitcoin donations can be difficult, especially for a large organization:</p>

<ul>
<li>Keep donations in Bitcoin or convert to USD?</li>
<li>If convert, using who? Need a reliable exchange</li>
<li>If convert, when? Immediately, or try to make profit? Bitcoin is volatile</li>
<li>Poor choices here can affect public perception</li>
<li>Regulations on Bitcoin are still not stable</li>
</ul>


<hr />

<p>As you can see, there is a huge disparity in how different websites accept Bitcoin donations. Hopefully this post can give you ideas on how to accept Bitcoin donations on your own website. As a final note, thank you to all my readers for their support, it is appreciated!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/26/object-pool/">Object Pool</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-26T16:11:06-05:00" pubdate data-updated="true">Nov 26<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/11/26/object-pool/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/26/object-pool/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>An object pool is a specialized allocator that allocates memory in large chunks and deals them out in small slices. Malloc is typically an expensive call, especially for multiple small allocations, so significant performance improvements can be gained by managing memory directly. The object pool presented here is compatible with C++03, supports all standard containers, and offers O(1) amortized allocation and deallocation with configurable growth, limits, and alignment.</p>

<p>The pool works by allocating blocks of memory, partitioning them for the object type and alignment, then pushing all the addresses onto a stack representing available slots. Each allocation pops an address off the stack, each deallocation pushes an allocation onto the stack. When the stack is empty, another block is allocated and added to the linked list of blocks.</p>

<h2>Stack</h2>

<p>The primary component of the object pool is the stack of addresses that represent free memory slots for objects. However, this isn&rsquo;t implemented like a typical stack; rather, the stack itself is interleaved through the free slots of the memory block. This means no additional memory is required; the data structure that manages the free memory is stored <em>within</em> the free memory it is managing! Each free slot, which would normally be zeroed out, instead points to the next free slot. Pushing and popping simply involves overwriting these pointers.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">stack</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">T</span><span class="o">*</span>       <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">pointer</span><span class="o">*</span> <span class="n">metapointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">stack</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_top</span><span class="p">(</span><span class="nb">NULL</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">push</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Store the current pointer at the given address</span>
</span><span class='line'>      <span class="o">*</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">metapointer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">))</span> <span class="o">=</span> <span class="n">_top</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Advance the pointer</span>
</span><span class='line'>      <span class="n">_top</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Increment the size</span>
</span><span class='line'>      <span class="o">++</span><span class="n">_size</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">pop</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">empty</span><span class="p">()){</span><span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Pop the top of the stack</span>
</span><span class='line'>      <span class="n">pointer</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">_top</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Step back to the previous address</span>
</span><span class='line'>      <span class="n">_top</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">metapointer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_top</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Decrement the size</span>
</span><span class='line'>      <span class="o">--</span><span class="n">_size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Return the next free address</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">top</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_top</span><span class="p">;}</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_size</span><span class="p">;}</span>
</span><span class='line'>  <span class="kt">bool</span> <span class="n">empty</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">_top</span><span class="p">;</span>
</span><span class='line'>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">_size</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Node</h2>

<p>If the object pool were statically sized, then only a single memory block would be required, and no linked list would be needed. However, to support growth, each memory block is treated as a node in a linked list, allowing for a dynamic number of blocks (and therefore a dynamic amount of allocated memory).</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">node</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">T</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_object</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">node</span><span class="o">*</span> <span class="n">link</span><span class="p">(</span><span class="n">node</span><span class="o">*</span> <span class="n">next</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">_next</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_next</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">node</span><span class="o">*</span> <span class="n">next</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_next</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">node</span><span class="p">(</span><span class="n">U</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">arg</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_object</span><span class="p">(</span><span class="n">arg</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_next</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">node</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_object</span><span class="p">(),</span>
</span><span class='line'>      <span class="n">_next</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="n">T</span> <span class="n">_object</span><span class="p">;</span>
</span><span class='line'>  <span class="n">node</span><span class="o">*</span> <span class="n">_next</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Growth</h2>

<p>The growth of the pool can be controlled via a template parameter. This parameter is a functor that takes the current size of the pool and returns the new size that the pool should grow to. I provide functors to do exponential growth (like a vector) or linear growth, but it is easy to add a custom one to fine tune growth for your application.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">growth</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">virtual</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">operator</span><span class="p">()(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="k">const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">exponential</span> <span class="o">:</span> <span class="k">public</span> <span class="n">growth</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">operator</span><span class="p">()(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">increment</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">linear</span> <span class="o">:</span> <span class="k">public</span> <span class="n">growth</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">operator</span><span class="p">()(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">value</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">increment</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Pool</h2>

<p>Finally, the pieces can all be put together to create the object pool. Allocation and deallocation consists of pushing and popping from the stack. If the stack is ever emptied, the pool grows by another block. The pool uses lazy allocation and has an efficient copy constructor to allow for quick rebinding; necessary for the standard containers.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">initial_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">final_size</span> <span class="o">=</span> <span class="n">max_allocations</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>          <span class="k">typename</span> <span class="n">growth</span> <span class="o">=</span> <span class="n">exponential</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pool</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">T</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">boundary</span><span class="o">&lt;</span><span class="n">align</span><span class="o">&gt;</span> <span class="n">alignment</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;</span> <span class="n">padding</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">enum</span><span class="p">{</span><span class="n">unit</span> <span class="o">=</span> <span class="n">padding</span><span class="o">::</span><span class="n">value</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Satisfy the allocator traits</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">type</span>              <span class="n">value_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">*</span>       <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">*</span> <span class="n">const_pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">&amp;</span>       <span class="n">reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">const_reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span>       <span class="n">size_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">ptrdiff_t</span>    <span class="n">difference_type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">pointer</span><span class="o">*</span> <span class="n">metapointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">pool</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">,</span> <span class="n">final_size</span><span class="p">,</span> <span class="n">growth</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">grow</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Update the capacity</span>
</span><span class='line'>      <span class="n">_capacity</span> <span class="o">=</span> <span class="n">_size</span> <span class="o">?</span> <span class="n">_growth</span><span class="p">(</span><span class="n">_size</span><span class="p">)</span> <span class="o">:</span> <span class="n">initial_size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Cap at the final size</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">_size</span> <span class="o">+</span> <span class="n">_capacity</span> <span class="o">&gt;</span> <span class="n">final_size</span><span class="p">)</span> <span class="n">_capacity</span> <span class="o">=</span> <span class="n">final_size</span> <span class="o">-</span> <span class="n">_size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Bail out if we hit the upper limit</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">_capacity</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">bad_alloc</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Add this new capacity to our total size</span>
</span><span class='line'>      <span class="n">_size</span> <span class="o">+=</span> <span class="n">_capacity</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Allocate a new block of memory as a linked list node</span>
</span><span class='line'>      <span class="n">_current</span> <span class="o">=</span> <span class="n">_current</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">(</span><span class="k">new</span> <span class="n">node</span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;</span><span class="p">(</span><span class="n">_capacity</span> <span class="o">*</span> <span class="n">unit</span> <span class="o">+</span> <span class="n">alignment</span><span class="o">::</span><span class="n">value</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Access the memory</span>
</span><span class='line'>      <span class="kt">void</span><span class="o">*</span> <span class="n">memory</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_current</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Shift context to the new memory block</span>
</span><span class='line'>      <span class="n">_context</span> <span class="o">=</span> <span class="n">partition</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="n">_capacity</span> <span class="o">*</span> <span class="n">unit</span> <span class="o">+</span> <span class="n">alignment</span><span class="o">::</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Push the slots to the stack</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">_capacity</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">_free</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_context</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">count</span><span class="p">,</span> <span class="n">const_pointer</span> <span class="n">hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// If we are out of slots, add more</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">_free</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="n">grow</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Return the next slot</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_free</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Push this pointer onto the free list</span>
</span><span class='line'>      <span class="n">_free</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// This pool only supports allocating one object at a time</span>
</span><span class='line'>      <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">pool</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_head</span><span class="p">(),</span>
</span><span class='line'>      <span class="n">_current</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_head</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_capacity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">pool</span><span class="p">(</span><span class="n">pool</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">align</span><span class="p">,</span> <span class="n">initial_size</span><span class="p">,</span> <span class="n">final_size</span><span class="p">,</span> <span class="n">growth</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_head</span><span class="p">(),</span>
</span><span class='line'>      <span class="n">_current</span><span class="p">(</span><span class="o">&amp;</span><span class="n">_head</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_capacity</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">~</span><span class="n">pool</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Start at the initial block</span>
</span><span class='line'>      <span class="n">node</span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;*</span> <span class="n">current</span> <span class="o">=</span> <span class="n">_head</span><span class="p">.</span><span class="n">next</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Iterate through each block</span>
</span><span class='line'>      <span class="k">while</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Get the next block</span>
</span><span class='line'>          <span class="n">node</span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;*</span> <span class="n">next</span> <span class="o">=</span> <span class="n">current</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Delete the current block</span>
</span><span class='line'>          <span class="k">delete</span> <span class="n">current</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Advance to the next block</span>
</span><span class='line'>          <span class="n">current</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="n">node</span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;</span>  <span class="n">_head</span><span class="p">;</span>
</span><span class='line'>  <span class="n">node</span><span class="o">&lt;</span><span class="n">block</span><span class="o">&gt;*</span> <span class="n">_current</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">_size</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">_capacity</span><span class="p">;</span>
</span><span class='line'>  <span class="n">partition</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;</span> <span class="n">_context</span><span class="p">;</span>
</span><span class='line'>  <span class="n">stack</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">_free</span><span class="p">;</span>
</span><span class='line'>  <span class="n">growth</span> <span class="n">_growth</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Stateless</h2>

<p>C++03 allocators are required to be stateless. The standard containers do not accept an allocator instance, rather they construct one themselves. This means that two <code>std::set</code>s of type T will each maintain their own allocator. Clearly, the above pool is not stateless, however we can emulate that behavior by using a singleton. In this manner, there will only ever be one instance of the pool for each type, and all the containers will share the same pool.</p>

<p>This is implemented using a <code>stateless</code> allocator adapter. Each call to allocate / deallocate is routed through a singleton to the underlying policy.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>          <span class="k">typename</span> <span class="n">Policy</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">stateless</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// Forward typedefs</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">T</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">type</span>              <span class="n">value_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">*</span>       <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">*</span> <span class="n">const_pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">&amp;</span>       <span class="n">reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">const_reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span>       <span class="n">size_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">ptrdiff_t</span>    <span class="n">difference_type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">stateless</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">Policy</span><span class="o">::</span><span class="k">template</span> <span class="n">rebind</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">other</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">stateless</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyU</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">stateless</span><span class="p">(</span><span class="n">stateless</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">PolicyU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">count</span><span class="p">,</span> <span class="n">const_pointer</span> <span class="n">hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Policy</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">().</span><span class="n">allocate</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">hint</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Policy</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">().</span><span class="n">deallocate</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Policy</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">().</span><span class="n">max_size</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Hybrid</h2>

<p>One caveat to the object pool is that it only supports the allocation of a single object at a time. This means the object pool will not work for <code>vector</code>s and some implementations of <code>deque</code>, because these data structures allocate multiple contiguous objects at a time. However, the point of the object pool is to alleviate performance issues related to multiple calls of malloc with small sizes. Vectors do this automatically, so the object pool cannot improve their performance.</p>

<p>Rather than trying to remember which data structures and implementations the pool supports, it would be better to allow the pool to support <em>all</em> the containers. To do this, a <code>hybrid</code> allocator adapter is used that forwards all allocations of a single object to the pool, and all allocations of multiple objects to the heap.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>          <span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>          <span class="k">typename</span> <span class="n">M</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">hybrid</span> <span class="o">:</span> <span class="k">public</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>                  <span class="k">public</span> <span class="n">M</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Template parameters</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">T</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">S</span> <span class="n">single</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">M</span> <span class="n">multiple</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Satisfy the allocator traits</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">type</span>              <span class="n">value_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">*</span>       <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">*</span> <span class="n">const_pointer</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span><span class="o">&amp;</span>       <span class="n">reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">const_reference</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span>       <span class="n">size_type</span><span class="p">;</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">ptrdiff_t</span>    <span class="n">difference_type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">hybrid</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span>
</span><span class='line'>                          <span class="k">typename</span>   <span class="n">single</span><span class="o">::</span><span class="k">template</span> <span class="n">rebind</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">other</span><span class="p">,</span>
</span><span class='line'>                          <span class="k">typename</span> <span class="n">multiple</span><span class="o">::</span><span class="k">template</span> <span class="n">rebind</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">other</span>
</span><span class='line'>                        <span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">hybrid</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="p">,</span>
</span><span class='line'>              <span class="k">typename</span> <span class="n">SinglePolicyU</span><span class="p">,</span>
</span><span class='line'>              <span class="k">typename</span> <span class="n">MultiplePolicyU</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">hybrid</span><span class="p">(</span><span class="n">hybrid</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">SinglePolicyU</span><span class="p">,</span>
</span><span class='line'>                    <span class="n">MultiplePolicyU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">single</span><span class="p">(</span><span class="n">other</span><span class="p">),</span>
</span><span class='line'>      <span class="n">multiple</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Resolve ambiguities by forwarding allocation / deallocation</span>
</span><span class='line'>  <span class="c1">// requests to the proper policy</span>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">count</span><span class="p">,</span> <span class="n">const_pointer</span> <span class="n">hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">single</span><span class="o">::</span><span class="n">allocate</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">hint</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">multiple</span><span class="o">::</span><span class="n">allocate</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">hint</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">single</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>          <span class="n">multiple</span><span class="o">::</span><span class="n">deallocate</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">multiple</span><span class="o">::</span><span class="n">max_size</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Final Result</h2>

<p>The pool and all of it&rsquo;s pieces are very configurable, but a good set of defaults can be selected that will work just fine for most cases. It is best to take all the policies, traits, and adapters, and fold them all together into a single struct or typedef to make it easier to use. Then, it can be simply plugged into the allocator template parameter of any standard container.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">fast_allocator</span> <span class="o">:</span> <span class="k">public</span>
</span><span class='line'>   <span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
</span><span class='line'>               <span class="n">hybrid</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">stateless</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
</span><span class='line'>                                     <span class="n">pool</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
</span><span class='line'>                                        <span class="mi">16</span><span class="p">,</span>
</span><span class='line'>                                        <span class="mi">16</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">max_allocations</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span>
</span><span class='line'>                                        <span class="n">exponential</span>
</span><span class='line'>                                       <span class="o">&gt;</span>
</span><span class='line'>                                    <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">heap</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span>
</span><span class='line'>                             <span class="mi">16</span>
</span><span class='line'>                             <span class="o">&gt;</span>
</span><span class='line'>                       <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>              <span class="n">object_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>              <span class="o">&gt;</span>
</span><span class='line'><span class="p">{};</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Foo</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">less</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">fast_allocator</span><span class="o">&lt;</span><span class="n">Foo</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">PooledFooSet</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/25/memory-blocks/">Memory Blocks</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-25T16:10:58-05:00" pubdate data-updated="true">Nov 25<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/11/25/memory-blocks/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/25/memory-blocks/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Memory pools work by taking a large chunk of memory and dealing out small pieces of it upon allocation requests. Object pools are a specialized version that treat the memory as an array of objects, such that each &ldquo;slot&rdquo; is the same size. In reality, managing an object pool involves more than <em>just</em> an array of objects due to alignment and padding.</p>

<p>When doing 100% of your own memory management, it becomes useful to have a set of tools to assist with organizing memory. You can think of a chunk of memory as being similar to an empty hard drive; the act of aligning, partitioning, and padding the memory is similar to formatting a hard drive with a filesystem.</p>

<p>There are a few different ways to acquire a block of memory. The following lines allocate a block of 32 bytes:</p>

<pre><code>char memory[32];
char* memory = static_cast&lt;char*&gt;(malloc(32));
</code></pre>

<p>Notice how <code>sizeof(memory)</code> for each of those lines will give different results. A contiguous block of memory is represented by a starting address and a size; both values are needed to do anything useful with it. For static and local stack memory, the size is known at compile time, however for dynamic memory allocated on the heap, the size must be maintained separately.</p>

<h3>Memory Block</h3>

<p>A class that acts similar to a smart pointer for memory blocks can do the memory management for us, including holding the size and calling free upon destruction. The following is an implementation of a memory block class:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">block</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">typedef</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Constructor, size in bytes</span>
</span><span class='line'>  <span class="n">block</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">_memory</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Default Constructor</span>
</span><span class='line'>  <span class="n">block</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Destructor</span>
</span><span class='line'>  <span class="o">~</span><span class="n">block</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="k">if</span><span class="p">(</span><span class="n">_memory</span><span class="p">)</span> <span class="n">free</span><span class="p">(</span><span class="n">_memory</span><span class="p">);}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Access a specific byte of memory</span>
</span><span class='line'>  <span class="n">byte</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">[](</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">){</span><span class="k">return</span> <span class="n">_memory</span><span class="p">[</span><span class="n">i</span><span class="p">];}</span>
</span><span class='line'>  <span class="n">byte</span> <span class="k">const</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">[](</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_memory</span><span class="p">[</span><span class="n">i</span><span class="p">];}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Dereference operator makes the block act like a pointer</span>
</span><span class='line'>  <span class="n">byte</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="o">*</span><span class="n">_memory</span><span class="p">;}</span>
</span><span class='line'>  <span class="n">byte</span> <span class="k">const</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">*</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="o">*</span><span class="n">_memory</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Address-of operator returns the address of the memory</span>
</span><span class='line'>  <span class="n">byte</span><span class="o">*</span> <span class="k">operator</span><span class="o">&amp;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="k">return</span> <span class="n">_memory</span><span class="p">;}</span>
</span><span class='line'>  <span class="n">byte</span> <span class="k">const</span><span class="o">*</span> <span class="k">operator</span><span class="o">&amp;</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_memory</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Size of the memory in bytes</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_size</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="n">byte</span><span class="o">*</span> <span class="n">_memory</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">_size</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using this class is simple:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">block</span> <span class="n">memory</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
</span><span class='line'>  <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="n">memory</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">memory</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">*</span><span class="n">memory</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">memory</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Outputs:</p>

<pre><code>32
A
A
</code></pre>

<p>As you can see, the memory block class acts just like a pointer to an array of bytes. This is a convienient building block for creating an object pool.</p>

<h3>Padding</h3>

<p>When creating an array of objects, you may need to ensure that each object is properly aligned. If you ensure that the first object is aligned, and that each object is padded properly, then you have the guarantee that <em>all</em> the objects in the array are aligned. Padding the object will result in some excess space being used in order to make sure the next object is properly aligned. Below is a small helper class that can pad any type to the next multiple of <code>X</code> bytes.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">multiple</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pad</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">enum</span><span class="p">{</span><span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">multiple</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">multiple</span><span class="p">)</span> <span class="o">*</span> <span class="n">multiple</span><span class="p">};</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">enum</span><span class="p">{</span><span class="n">value</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)};</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is an example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">Data</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Data</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="mi">2</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="mi">4</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="mi">16</span><span class="o">&gt;::</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Outputs:</p>

<pre><code>17
18
20
24
32
</code></pre>

<h3>Partitioning</h3>

<p>Once you have a raw memory block, it needs to be partitioned before it can be used. The act of partitioning will align and pad the memory block and allow slots to be accessed for object storage. In other words, a partitioned memory block will act just like an array:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">partition</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Pad T for alignment</span>
</span><span class='line'>  <span class="k">enum</span><span class="p">{</span><span class="n">unit</span> <span class="o">=</span> <span class="n">pad</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Default Constructor</span>
</span><span class='line'>  <span class="n">partition</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_memory</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">_size</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Constructor</span>
</span><span class='line'>  <span class="n">partition</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">memory</span><span class="p">,</span>
</span><span class='line'>              <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>     <span class="n">_memory</span><span class="p">(</span><span class="n">boundary</span><span class="o">&lt;</span><span class="n">align</span><span class="o">&gt;::</span><span class="n">next</span><span class="p">(</span><span class="n">memory</span><span class="p">)),</span>
</span><span class='line'>     <span class="n">_size</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>  
</span><span class='line'>  <span class="c1">// Return the number of T&#39;s that can fit inside the memory</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">capacity</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">_size</span> <span class="o">-</span> <span class="n">align</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">/</span> <span class="n">unit</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Access a specific T</span>
</span><span class='line'>  <span class="n">T</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">[](</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">capacity</span><span class="p">()){</span><span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">out_of_range</span><span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">);}</span>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="p">(</span>
</span><span class='line'>                   <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span>
</span><span class='line'>                      <span class="n">_memory</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">unit</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>  <span class="kt">void</span><span class="o">*</span> <span class="n">_memory</span><span class="p">;</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">_size</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is some example usage, borrowing the memory dumper from a <a href="http://jrruethe.github.io/blog/2015/08/23/placement-new/">previous blog post</a>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">Data</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">Data</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>     <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">char</span> <span class="n">memory</span><span class="p">[</span><span class="mi">54</span><span class="p">];</span>
</span><span class='line'>    <span class="n">memset</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">partition</span><span class="o">&lt;</span><span class="n">Data</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;</span> <span class="n">array</span><span class="p">(</span><span class="o">&amp;</span><span class="n">memory</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dump_memory</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">array</span><span class="p">.</span><span class="n">capacity</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">memory</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
</span><span class='line'>  <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">array</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">();</span>
</span><span class='line'>  <span class="n">array</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">();</span>
</span><span class='line'>  <span class="n">array</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">dump_memory</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the output:</p>

<pre><code>-----------------------------------------------------------------------
54 bytes              0  1  2  3   4  5  6  7   8  9  A  B   C  D  E  F
0x00007FFFE9D71680:  CC CC CC CC  CC CC CC CC  CC CC CC CC  CC CC CC CC
0x00007FFFE9D71690:  CC CC CC CC  CC CC CC CC  CC CC CC CC  CC CC CC CC
0x00007FFFE9D716A0:  CC CC CC CC  CC CC CC CC  CC CC CC CC  CC CC CC CC
0x00007FFFE9D716B0:  CC CC CC CC  CC CC
-----------------------------------------------------------------------
5
0x00007FFFE9D71680
0x00007FFFE9D71688
0x00007FFFE9D71690
0x00007FFFE9D71698
-----------------------------------------------------------------------
54 bytes              0  1  2  3   4  5  6  7   8  9  A  B   C  D  E  F
0x00007FFFE9D71680:  CC CC CC CC  CC CC CC CC  AA AA AA AA  AA AA CC CC
0x00007FFFE9D71690:  CC CC CC CC  CC CC CC CC  CC CC CC CC  CC CC CC CC
0x00007FFFE9D716A0:  AA AA AA AA  AA AA CC CC  AA AA AA AA  AA AA CC CC
0x00007FFFE9D716B0:  CC CC CC CC  CC CC
-----------------------------------------------------------------------
</code></pre>

<p>As you can see, the data objects stored inside the partitioned memory are padded and 8 byte aligned. The alignment caveats mentioned in the <a href="http://jrruethe.github.io/blog/2015/08/23/placement-new/">previous post</a> apply, including the wasted space at the beginning of the array.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/24/google-test/">Google Test</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-24T16:10:22-05:00" pubdate data-updated="true">Nov 24<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/11/24/google-test/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/24/google-test/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post is a quick introduction to Google Test and how to use it to test your C++ code. Google Test is a unit testing framework that is easy to use and creates meaningful tests with intuitive output.</p>

<h3>Installing</h3>

<p>On Debian based systems, you will want to install the following packages:</p>

<ul>
<li>libgtest-dev</li>
<li>build-essential</li>
<li>cmake</li>
</ul>


<p>Note that <code>libgtest-dev</code> includes the headers and sources, but not the compiled libraries. Follow the instructions below to compile and install the libraries<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<pre><code>cd /tmp
mkdir build
cd build
cmake -DCMAKE_BUILD_TYPE=RELEASE /usr/src/gtest/
make
sudo mv libgtest* /usr/lib/
</code></pre>

<p>You could also use <code>checkinstall</code> to create a deb package containing the library files.</p>

<h3>Using</h3>

<p>To get started, you will need to:</p>

<ol>
<li>Include the Google Test headers</li>
<li>Write a <code>TEST</code> section</li>
<li>Initiate the unit tests from <code>main()</code></li>
</ol>


<p>Tests are composed of various <code>EXPECT_*</code> statements to ensure that functions return expected values, etc. For a full description of the various types of tests that can be written using Google Test, refer to the documents below:</p>

<ul>
<li><a href="https://github.com/google/googletest/blob/master/googletest/docs/V1_7_Primer.md">Primer</a></li>
<li><a href="https://github.com/google/googletest/blob/master/googletest/docs/V1_7_FAQ.md">FAQ</a></li>
<li><a href="https://github.com/google/googletest/blob/master/googletest/docs/V1_7_AdvancedGuide.md">Advanced Guide</a></li>
<li><a href="https://github.com/google/googletest/blob/master/googlemock/docs/ForDummies.md">Google Mock</a></li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;gtest/gtest.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="n">TEST</span><span class="p">(</span><span class="n">TestGroup</span><span class="p">,</span> <span class="n">TestCase</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">EXPECT_EQ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="o">::</span><span class="n">testing</span><span class="o">::</span><span class="n">InitGoogleTest</span><span class="p">(</span><span class="o">&amp;</span><span class="n">argc</span><span class="p">,</span> <span class="n">argv</span><span class="p">);</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">RUN_ALL_TESTS</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>One thing to remember with the <code>EXPECT_*</code> statements is that the <em>first</em> argument is the hardcoded expected value (ie: the &ldquo;truth&rdquo;), and the <code>second</code> parameter is the variable or function call to be tested.</p>

<p>To compile, you need to link against both the compiled gtest library as well as pthread:</p>

<pre><code>g++ -g -O0 main.cpp -lgtest -pthread
</code></pre>

<p>The output will look something like this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="p">[</span><span class="o">==========</span><span class="p">]</span> <span class="n">Running</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">from</span> <span class="mi">1</span> <span class="n">test</span> <span class="k">case</span><span class="p">.</span>
</span><span class='line'><span class="p">[</span><span class="o">----------</span><span class="p">]</span> <span class="n">Global</span> <span class="n">test</span> <span class="n">environment</span> <span class="n">set</span><span class="o">-</span><span class="n">up</span><span class="p">.</span>
</span><span class='line'><span class="p">[</span><span class="o">----------</span><span class="p">]</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">from</span> <span class="n">TestGroup</span>
</span><span class='line'><span class="p">[</span> <span class="n">RUN</span>      <span class="p">]</span> <span class="n">TestGroup</span><span class="p">.</span><span class="n">TestCase</span>
</span><span class='line'><span class="p">[</span>       <span class="n">OK</span> <span class="p">]</span> <span class="n">TestGroup</span><span class="p">.</span><span class="n">TestCase</span> <span class="p">(</span><span class="mi">0</span> <span class="n">ms</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span><span class="o">----------</span><span class="p">]</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">from</span> <span class="n">TestGroup</span> <span class="p">(</span><span class="mi">0</span> <span class="n">ms</span> <span class="n">total</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="p">[</span><span class="o">----------</span><span class="p">]</span> <span class="n">Global</span> <span class="n">test</span> <span class="n">environment</span> <span class="n">tear</span><span class="o">-</span><span class="n">down</span>
</span><span class='line'><span class="p">[</span><span class="o">==========</span><span class="p">]</span> <span class="mi">1</span> <span class="n">test</span> <span class="n">from</span> <span class="mi">1</span> <span class="n">test</span> <span class="k">case</span> <span class="n">ran</span><span class="p">.</span> <span class="p">(</span><span class="mi">0</span> <span class="n">ms</span> <span class="n">total</span><span class="p">)</span>
</span><span class='line'><span class="p">[</span>  <span class="n">PASSED</span>  <span class="p">]</span> <span class="mi">1</span> <span class="n">test</span><span class="p">.</span>
</span></code></pre></td></tr></table></div></figure>


<p>Google Test is a great way to ensure that your code is working properly. I often use Google Test with a relaxed form of <em>Test Driven Development</em><sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="http://askubuntu.com/questions/145887/why-no-library-files-installed-for-google-test">Why no library files installed for google test?</a> &ndash; Wojciech Migda <a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="https://en.wikipedia.org/wiki/Test-driven_development">Test Driven Development</a><a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/23/aligned-heap/">Aligned Heap</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-23T18:01:02-05:00" pubdate data-updated="true">Nov 23<span>rd</span>, 2015</time>
        
           | <a href="/blog/2015/11/23/aligned-heap/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/23/aligned-heap/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In the <a href="http://jrruethe.github.io/blog/2015/11/22/allocators/">previous post</a>, I introduced an allocator framework that supports pluggable policies. An example heap policy was given. This post will expand on the heap to give it alignment abilities. You may want to refer to <a href="http://jrruethe.github.io/blog/2015/08/23/placement-new/">another previous post</a> on alignment.</p>

<p>The code modifications are simple; allocate a little more data, align the pointer when allocating, then unalign it before deallocating:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>         <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">align</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">heap</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ALLOCATOR_TRAITS</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Default Constructor</span>
</span><span class='line'>  <span class="n">heap</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Copy Constructor</span>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">heap</span><span class="p">(</span><span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">align</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Allocate memory</span>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">count</span><span class="p">,</span> <span class="n">const_pointer</span> <span class="n">hint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Request additional memory to perform alignment</span>
</span><span class='line'>      <span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="o">::</span><span class="k">operator</span> <span class="k">new</span><span class="p">((</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">))</span> <span class="o">+</span> <span class="n">boundary</span><span class="o">&lt;</span><span class="n">align</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">,</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">nothrow</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Align the pointer</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">pointer</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boundary</span><span class="o">&lt;</span><span class="n">align</span><span class="o">&gt;::</span><span class="n">align</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Deallocate memory</span>
</span><span class='line'>  <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_type</span> <span class="n">count</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Unalign the pointer and delete the memory</span>
</span><span class='line'>      <span class="o">::</span><span class="k">operator</span> <span class="k">delete</span><span class="p">(</span><span class="n">boundary</span><span class="o">&lt;</span><span class="n">align</span><span class="o">&gt;::</span><span class="n">unalign</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Max number of objects that can be allocated in one call</span>
</span><span class='line'>  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">max_allocations</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the aligned heap no different than the previous version. If you leave out the alignment template parameter, it will act the same as before.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number marked'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;set&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Example</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Example</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Example</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">other</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// Increase scope</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line marked start end'>     <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Example</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">less</span><span class="o">&lt;</span><span class="n">Example</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="n">Example</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">Example</span><span class="p">,</span> <span class="mi">16</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// Leaving scope</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/22/allocators/">C++ Allocators</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-22T16:10:49-05:00" pubdate data-updated="true">Nov 22<span>nd</span>, 2015</time>
        
           | <a href="/blog/2015/11/22/allocators/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/22/allocators/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post will discuss how to make a STL compliant allocator.</p>

<p>All of the standard containers support a 2nd (or 3rd) template parameter to specify the allocator that should be used. Each container allocates memory to store the objects it contains, and it uses the allocator to obtain the memory required for this storage. By using a custom allocator, you can remain in control of how memory is managed.</p>

<p>Custom allocators are useful for a variety of cases:</p>

<ul>
<li>Reducing system call overhead when requesting multiple small memory blocks</li>
<li>Improving cache efficiency by keeping memory contiguous</li>
<li>Using standard containers with memory-mapped io, or a memory-mapped file for persistent containers</li>
<li>Maintaining 100% control of memory for embedded systems or game development</li>
</ul>


<p>Wikipedia summarizes it well<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>:</p>

<blockquote><p>One of the main reasons for writing a custom allocator is performance. Utilizing a specialized custom allocator may substantially improve the performance or memory usage, or both, of the program. The default allocator uses operator new to allocate memory. This is often implemented as a thin layer around the C heap allocation functions, which are usually optimized for infrequent allocation of large memory blocks. This approach may work well with containers that mostly allocate large chunks of memory, like vector and deque. However, for containers that require frequent allocations of small objects, such as map and list, using the default allocator is generally slow. Other common problems with a malloc-based allocator include poor locality of reference, and excessive memory fragmentation.</p></blockquote>

<p>The allocators discussed in this post are meant to be used with C++03. C++11 adds more support for custom allocators, and makes them easier to implement. Furthermore, C++03 allocators are compatible with C++11, but not the other way around.</p>

<p>Creating a custom allocator may seem difficult, but the core concept is pretty simple. Here are the basic rules:</p>

<ul>
<li>Cannot have state (C++03 only)</li>
<li>Must support certain typedefs and methods</li>
<li>Must support type rebinding</li>
<li>Allocators of the same type must compare equally</li>
</ul>


<p>No state also means no virtual functions, as the vtable can be considered state. Normal inheritance is okay, however it is generally considered bad practice to derive from std::allocator. Instead, we will create our own allocator using policies and traits. The methods that need to be implemented can be separated into two categories: those that are related to the allocator, and those that are related to the object being allocated. This distinction defines the policy and traits we will implement.<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p>

<blockquote><p><strong>Policies and Traits</strong><sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup><br/>
Policies are classes (or class templates) to inject behavior into a parent class, typically through inheritance. By decomposing a parent interface into orthogonal (independent) dimensions, policy classes form the building blocks of more complex interfaces. Traits are class templates to extract properties from a generic type. Traits are often used in template-metaprogramming and SFINAE tricks to overload a function template based on a type condition.</p></blockquote>

<h3>Object Traits</h3>

<p>The first thing to define is the object traits. This structure is responsible for creating and destroying objects, as well as returning the address of an object. Note that classes support overriding the &ldquo;address-of&rdquo; operator, so the object traits will need to be specialized for those classes. The object traits can also be specialized for a type to keep track of the number of instantiations using the allocator, much like the object counter works.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">object_traits</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">object_traits</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Constructor</span>
</span><span class='line'>   <span class="n">object_traits</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Copy Constructor</span>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">object_traits</span><span class="p">(</span><span class="n">object_traits</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Address of object</span>
</span><span class='line'>   <span class="n">type</span><span class="o">*</span>       <span class="n">address</span><span class="p">(</span><span class="n">type</span><span class="o">&amp;</span>       <span class="n">obj</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="o">&amp;</span><span class="n">obj</span><span class="p">;}</span>
</span><span class='line'>   <span class="n">type</span> <span class="k">const</span><span class="o">*</span> <span class="n">address</span><span class="p">(</span><span class="n">type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="o">&amp;</span><span class="n">obj</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Construct object</span>
</span><span class='line'>   <span class="kt">void</span> <span class="n">construct</span><span class="p">(</span><span class="n">type</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">ref</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// In-place copy construct</span>
</span><span class='line'>      <span class="k">new</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="n">type</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Destroy object</span>
</span><span class='line'>   <span class="kt">void</span> <span class="n">destroy</span><span class="p">(</span><span class="n">type</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Call destructor</span>
</span><span class='line'>      <span class="n">ptr</span><span class="o">-&gt;~</span><span class="n">type</span><span class="p">();</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Rebinding</h3>

<p>Notice the special <code>rebind</code> struct in the above code. This is a convention used by the STL to allow for chainging the type of the allocator. For example, when you make a <code>std::list&lt;T&gt;</code>, internally the type is being rebound to <code>std::list&lt;Node&lt;T&gt; &gt;</code>, because lists store nodes that contain a T, not the T itself. To support this, the allocator itself must support rebinding such that memory is allocated for the node, not just T.</p>

<h3>Allocator Traits</h3>

<p>The allocator policies require a certain set of typedefs to be present. In most cases, they can all be derived from the type of the allocator, so it makes sense to use a macro:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#define ALLOCATOR_TRAITS(T)                \</span>
</span><span class='line'><span class="cp">typedef T                 type;            \</span>
</span><span class='line'><span class="cp">typedef type              value_type;      \</span>
</span><span class='line'><span class="cp">typedef value_type*       pointer;         \</span>
</span><span class='line'><span class="cp">typedef value_type const* const_pointer;   \</span>
</span><span class='line'><span class="cp">typedef value_type&amp;       reference;       \</span>
</span><span class='line'><span class="cp">typedef value_type const&amp; const_reference; \</span>
</span><span class='line'><span class="cp">typedef std::size_t       size_type;       \</span>
</span><span class='line'><span class="cp">typedef std::ptrdiff_t    difference_type; \</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Allocator Policy</h3>

<p>Next, the actual allocator policy needs to be defined. The allocator policy is responsible for allocating and deallocating memory. For this example, a simple heap allocator will work. The functionality will mimic that of the standard allocator:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">max_allocations</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">enum</span><span class="p">{</span><span class="n">value</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)};</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">heap</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">ALLOCATOR_TRAITS</span><span class="p">(</span><span class="n">T</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>  <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Default Constructor</span>
</span><span class='line'>  <span class="n">heap</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Copy Constructor</span>
</span><span class='line'>  <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>  <span class="n">heap</span><span class="p">(</span><span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Allocate memory</span>
</span><span class='line'>  <span class="n">pointer</span> <span class="n">allocate</span><span class="p">(</span><span class="n">size_type</span> <span class="n">count</span><span class="p">,</span> <span class="n">const_pointer</span> <span class="cm">/* hint */</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">max_size</span><span class="p">()){</span><span class="k">throw</span> <span class="n">std</span><span class="o">::</span><span class="n">bad_alloc</span><span class="p">();}</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">pointer</span><span class="o">&gt;</span><span class="p">(</span><span class="o">::</span><span class="k">operator</span> <span class="k">new</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">type</span><span class="p">),</span> <span class="o">::</span><span class="n">std</span><span class="o">::</span><span class="n">nothrow</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Delete memory</span>
</span><span class='line'>  <span class="kt">void</span> <span class="n">deallocate</span><span class="p">(</span><span class="n">pointer</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">size_type</span> <span class="cm">/* count */</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="o">::</span><span class="k">operator</span> <span class="k">delete</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Max number of objects that can be allocated in one call</span>
</span><span class='line'>  <span class="n">size_type</span> <span class="n">max_size</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">max_allocations</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">value</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Allocator</h3>

<p>Now that we have all the pieces, it is time to bring them all together. The actual allocator class is nothing more than a wrapper to combine the above into one common place. The key to the allocator wrapper is that it inherits from the allocator policy and object traits, thus the combination satisfies all the requirements for a compliant allocator.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#define FORWARD_ALLOCATOR_TRAITS(C)                  \</span>
</span><span class='line'><span class="cp">typedef typename C::value_type      value_type;      \</span>
</span><span class='line'><span class="cp">typedef typename C::pointer         pointer;         \</span>
</span><span class='line'><span class="cp">typedef typename C::const_pointer   const_pointer;   \</span>
</span><span class='line'><span class="cp">typedef typename C::reference       reference;       \</span>
</span><span class='line'><span class="cp">typedef typename C::const_reference const_reference; \</span>
</span><span class='line'><span class="cp">typedef typename C::size_type       size_type;       \</span>
</span><span class='line'><span class="cp">typedef typename C::difference_type difference_type; \</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">PolicyT</span> <span class="o">=</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">TraitsT</span> <span class="o">=</span> <span class="n">object_traits</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">allocator</span> <span class="o">:</span> <span class="k">public</span> <span class="n">PolicyT</span><span class="p">,</span>
</span><span class='line'>                  <span class="k">public</span> <span class="n">TraitsT</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Template parameters</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">PolicyT</span> <span class="n">Policy</span><span class="p">;</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">TraitsT</span> <span class="n">Traits</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">FORWARD_ALLOCATOR_TRAITS</span><span class="p">(</span><span class="n">Policy</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">rebind</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span>
</span><span class='line'>                         <span class="k">typename</span> <span class="n">Policy</span><span class="o">::</span><span class="k">template</span> <span class="n">rebind</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">other</span><span class="p">,</span>
</span><span class='line'>                         <span class="k">typename</span> <span class="n">Traits</span><span class="o">::</span><span class="k">template</span> <span class="n">rebind</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;::</span><span class="n">other</span>
</span><span class='line'>                        <span class="o">&gt;</span> <span class="n">other</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Constructor</span>
</span><span class='line'>    <span class="n">allocator</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Copy Constructor</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="p">,</span>
</span><span class='line'>             <span class="k">typename</span> <span class="n">PolicyU</span><span class="p">,</span>
</span><span class='line'>             <span class="k">typename</span> <span class="n">TraitsU</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="n">allocator</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">PolicyU</span><span class="p">,</span>
</span><span class='line'>                        <span class="n">TraitsU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>       <span class="n">Policy</span><span class="p">(</span><span class="n">other</span><span class="p">),</span>
</span><span class='line'>       <span class="n">Traits</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how the rebinding structure works here; the policy and traits classes are both rebound to the new type when the overall allocator is rebound.</p>

<h3>Equality operators</h3>

<p>The STL uses the equality operator to determine if memory allocated by one allocator can be deallocated with another. Normally, a heap allocator can be used interchangably between types, so the equality operator would return true. However, with this allocator framework, different policies can be plugged in, and some policies may not be interchangable. Therefore, the equality operator will default to false. Specializations of the equality operators can be made for specific policies to register equality, such as he heap policy:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Two allocators are not equal unless a specialization says so</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyU</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsU</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">PolicyU</span><span class="p">,</span> <span class="n">TraitsU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Also implement inequality</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyU</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsU</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">PolicyU</span><span class="p">,</span> <span class="n">TraitsU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Comparing an allocator to anything else should not show equality</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">OtherAllocator</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">OtherAllocator</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Also implement inequality</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">OtherAllocator</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">PolicyT</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">OtherAllocator</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Specialize for the heap policy</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsU</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">TraitsU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Also implement inequality</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsT</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">U</span><span class="p">,</span> <span class="k">typename</span> <span class="n">TraitsU</span><span class="o">&gt;</span>
</span><span class='line'><span class="kt">bool</span> <span class="k">operator</span><span class="o">!=</span><span class="p">(</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">TraitsT</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">left</span><span class="p">,</span>
</span><span class='line'>                <span class="n">allocator</span><span class="o">&lt;</span><span class="n">U</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">U</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">TraitsU</span><span class="o">&gt;</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">right</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">return</span> <span class="o">!</span><span class="p">(</span><span class="n">left</span> <span class="o">==</span> <span class="n">right</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Using the Allocator</h3>

<p>Using the allocator is simple, just pass it into the 2nd (or 3rd) template parameter of a container. Remember that some containers (like <code>set</code>) have a second template parameter that accepts a comparator.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;set&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Example</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">Example</span><span class="p">(</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>  <span class="kt">bool</span> <span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="n">Example</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="n">other</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="c1">// Increase scope</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">Example</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">less</span><span class="o">&lt;</span><span class="n">Example</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">allocator</span><span class="o">&lt;</span><span class="n">Example</span><span class="p">,</span> <span class="n">heap</span><span class="o">&lt;</span><span class="n">Example</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">foo</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">4</span><span class="p">));</span>
</span><span class='line'>      <span class="n">foo</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Example</span><span class="p">(</span><span class="mi">2</span><span class="p">));</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>  <span class="c1">// Leaving scope</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And that is how to make an allocator! A future blog post will discuss different policies that can be created.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="http://stackoverflow.com/questions/14718055/what-is-the-difference-between-a-trait-and-a-policy/14723986#14723986">What is the difference between a trait and a policy?</a> &ndash; TemplateRex<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="http://www.codeproject.com/Articles/4795/C-Standard-Allocator-An-Introduction-and-Implement">C++ Standard Allocator, An Introduction and Implementation</a> &ndash; Lai Shiaw San Kent<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p><a href="https://en.wikipedia.org/wiki/Allocator_%28C%2B%2B%29#Custom_allocators">Allocator (C++)</a><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/11/14/stopwatch/">Stopwatch</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-11-14T11:37:52-05:00" pubdate data-updated="true">Nov 14<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/11/14/stopwatch/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/11/14/stopwatch/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Object counters and memory pools are great ways to monitor the memory usage of your program from within. It can also be useful to monitor the amount of time being spent executing from within your program. This post presents a stopwatch that can provide statistics on how long something takes to run.</p>

<p>This project will require the following libraries to compile:</p>

<ul>
<li>libboost-chrono-dev</li>
<li>libboost-thread-dev</li>
<li>libboost-system-dev</li>
</ul>


<p>The idea with the stopwatch is to provide simple <code>start</code> and <code>stop</code> methods to monitor execution time, and store statistics that can be programatically accessed. Two stopwatch types will be presented: a static stopwatch and an instantiatable stopwatch. Each has its uses, with advantages and disadvantages:</p>

<ul>
<li>Static stopwatches can be differentiated using tags, and can be accessed anywhere</li>
<li>Object stopwatches can be managed at runtime, but must be passed around to be effective</li>
</ul>


<p>First, we must define the statistics that will be managed:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">Statistics</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">last</span><span class="p">;</span>    <span class="c1">// Last measured difference</span>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">min</span><span class="p">;</span>     <span class="c1">// Minimum measured difference</span>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">max</span><span class="p">;</span>     <span class="c1">// Maximum measured difference</span>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">samples</span><span class="p">;</span> <span class="c1">// Number of samples taken</span>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">total</span><span class="p">;</span>   <span class="c1">// Total measured difference</span>
</span><span class='line'>   <span class="kt">double</span> <span class="n">average</span><span class="p">;</span> <span class="c1">// Average measured difference</span>
</span><span class='line'>   <span class="n">Count</span>  <span class="n">mark</span><span class="p">;</span>    <span class="c1">// Time when started</span>
</span><span class='line'>   <span class="kt">bool</span>   <span class="n">running</span><span class="p">;</span> <span class="c1">// Flag indicating that the stopwatch is running</span>
</span><span class='line'>   <span class="kt">bool</span>   <span class="n">cleared</span><span class="p">;</span> <span class="c1">// Flag indicating that the stopwatch is cleared</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Statistics</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">last</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">min</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">samples</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">total</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">average</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">mark</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>      <span class="n">running</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>
</span><span class='line'>      <span class="n">cleared</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">friend</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">Statistics</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; - Last    : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">last</span>    <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot; - Min     : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">min</span>     <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot; - Max     : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">max</span>     <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot; - Average : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">average</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot; - Total   : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">total</span>   <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot; - Samples : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">samples</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">os</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we need the actual implementation to track those statistics. It will provide <code>start</code>, <code>stop</code>, and <code>reset</code>, and will utilize a clock to get the timestamps to measure. Both the static and object types will utilize this implementation:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">ClockT</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">StopwatchImplementation</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">ClockT</span> <span class="n">Clock</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">_start</span><span class="p">(</span><span class="n">Statistics</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">mark</span> <span class="o">=</span> <span class="n">_clock</span><span class="p">();</span> <span class="c1">// Get the current time</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>  <span class="c1">// Stopwatch is now running</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">_stop</span><span class="p">(</span><span class="n">Statistics</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Only update the statistics if the stopwatch was running</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">running</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// No longer running</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Grab the current time</span>
</span><span class='line'>         <span class="n">Count</span> <span class="n">now</span> <span class="o">=</span> <span class="n">_clock</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Calculate the difference while avoiding overflow</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">last</span> <span class="o">=</span> <span class="n">now</span> <span class="o">&gt;</span> <span class="n">stats</span><span class="p">.</span><span class="n">mark</span>
</span><span class='line'>                      <span class="o">?</span> <span class="n">now</span> <span class="o">-</span> <span class="n">stats</span><span class="p">.</span><span class="n">mark</span>
</span><span class='line'>                      <span class="o">:</span> <span class="n">stats</span><span class="p">.</span><span class="n">mark</span> <span class="o">-</span> <span class="n">now</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Keep track of the total and samples</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">total</span> <span class="o">+=</span> <span class="n">stats</span><span class="p">.</span><span class="n">last</span><span class="p">;</span>
</span><span class='line'>         <span class="o">++</span><span class="n">stats</span><span class="p">.</span><span class="n">samples</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Do not take a min from a cleared state, or it will be zero</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">stats</span><span class="p">.</span><span class="n">cleared</span>
</span><span class='line'>                     <span class="o">?</span> <span class="n">stats</span><span class="p">.</span><span class="n">last</span>
</span><span class='line'>                     <span class="o">:</span> <span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Get the max</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">max</span><span class="p">,</span> <span class="n">stats</span><span class="p">.</span><span class="n">last</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Calculate the average</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">average</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">total</span><span class="p">)</span> <span class="o">/</span>
</span><span class='line'>                         <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">stats</span><span class="p">.</span><span class="n">samples</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// No longer cleared</span>
</span><span class='line'>         <span class="n">stats</span><span class="p">.</span><span class="n">cleared</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">_reset</span><span class="p">(</span><span class="n">Statistics</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">last</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">min</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">max</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">total</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">average</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">mark</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">running</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>      <span class="n">stats</span><span class="p">.</span><span class="n">cleared</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">_print</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">name</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">Statistics</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">stats</span><span class="p">,</span>
</span><span class='line'>                      <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">stats</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">Clock</span> <span class="n">_clock</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will notice that the clock has been completely abstracted away from the stopwatch implementation, allowing any functor to be plugged in. By default, we will use <code>boost::chrono::high_resolution_clock</code> with configurable units. Here is the clock implementation:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Resolution</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Clock</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Clock</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="c1">// Initialize the reference to creation time</span>
</span><span class='line'>      <span class="n">_duration_reference</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">())</span>
</span><span class='line'>   <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Count</span> <span class="k">operator</span><span class="p">()(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Return the difference between now and the reference in the resolution units</span>
</span><span class='line'>      <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Count</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">Resolution</span><span class="o">&gt;</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">_duration_reference</span><span class="p">).</span><span class="n">count</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>   <span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">time_point</span> <span class="n">_duration_reference</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>There are many different configurations that the clock can use:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">hours</span><span class="o">&gt;</span>        <span class="n">HourClock</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">minutes</span><span class="o">&gt;</span>      <span class="n">MinuteClock</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="o">&gt;</span>      <span class="n">SecondClock</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="o">&gt;</span> <span class="n">MillisecondClock</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span> <span class="n">MicrosecondClock</span><span class="p">;</span>
</span><span class='line'><span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">Clock</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">nanoseconds</span><span class="o">&gt;</span>  <span class="n">NanosecondClock</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that we have all the pieces, time to make the static and object stopwatch types. First, the static one. It is a static class with a template parameter that allows static instantiations to be differentiated. All methods are static and forwarded to the base class:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">TagT</span>   <span class="o">=</span> <span class="kt">void</span><span class="p">,</span>             <span class="c1">// Specify a tag for &quot;compile-time&quot; instances</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">ClockT</span> <span class="o">=</span> <span class="n">MicrosecondClock</span><span class="o">&gt;</span> <span class="c1">// Default to the microsecond clock</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Stopwatch</span> <span class="o">:</span> <span class="k">public</span> <span class="n">detail</span><span class="o">::</span><span class="n">StopwatchImplementation</span><span class="o">&lt;</span><span class="n">ClockT</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">TagT</span>   <span class="n">Tag</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">ClockT</span> <span class="n">Clock</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">Stopwatch</span><span class="o">&lt;</span><span class="n">Tag</span><span class="p">,</span> <span class="n">Clock</span><span class="o">&gt;</span> <span class="n">Self</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">StopwatchImplementation</span><span class="o">&lt;</span><span class="n">Clock</span><span class="o">&gt;</span> <span class="n">Base</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Forward to the base implementation</span>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">start</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">Base</span><span class="o">::</span><span class="n">_start</span> <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">stop</span>  <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">Base</span><span class="o">::</span><span class="n">_stop</span>  <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">reset</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">Base</span><span class="o">::</span><span class="n">_reset</span> <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">print</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">Base</span><span class="o">::</span><span class="n">_print</span><span class="p">(</span><span class="n">name</span><span class="p">(),</span> <span class="n">_statistics</span><span class="p">,</span> <span class="n">os</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Accessors</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">last</span>    <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">last</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">min</span>     <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">min</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">max</span>     <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">max</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">samples</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">samples</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">total</span>   <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">total</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">double</span> <span class="n">average</span> <span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">average</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">detail</span><span class="o">::</span><span class="n">Statistics</span> <span class="n">_statistics</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Return the name of the tag as a string</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">units</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="n">Tag</span><span class="p">).</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Prevent this class from being instantiated</span>
</span><span class='line'>   <span class="n">Stopwatch</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how the tag type defaults to <code>void</code>. We want to specialize the stopwatch for the void type and allow the specialization to act as the object stopwatch. This allows us to omit the tag type to instantiate an object:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Specialize on the void tag to allow creating instances</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">ClockT</span> <span class="o">=</span> <span class="n">MicrosecondClock</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Stopwatch</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">,</span> <span class="n">ClockT</span><span class="o">&gt;</span> <span class="o">:</span> <span class="k">public</span> <span class="n">detail</span><span class="o">::</span><span class="n">StopwatchImplementation</span><span class="o">&lt;</span><span class="n">ClockT</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">ClockT</span>                                 <span class="n">Clock</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">Stopwatch</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">,</span> <span class="n">Clock</span><span class="o">&gt;</span>                 <span class="n">Self</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">detail</span><span class="o">::</span><span class="n">StopwatchImplementation</span><span class="o">&lt;</span><span class="n">Clock</span><span class="o">&gt;</span> <span class="n">Base</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span>                     <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Stopwatch</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">tag</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_tag</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Forward to the base implementation</span>
</span><span class='line'>   <span class="kt">void</span> <span class="n">start</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="n">Base</span><span class="o">::</span><span class="n">_start</span> <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>   <span class="kt">void</span> <span class="n">stop</span>  <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="n">Base</span><span class="o">::</span><span class="n">_stop</span>  <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>   <span class="kt">void</span> <span class="n">reset</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span><span class="n">Base</span><span class="o">::</span><span class="n">_reset</span> <span class="p">(</span><span class="n">_statistics</span><span class="p">);}</span>
</span><span class='line'>
</span><span class='line'>   <span class="kt">void</span> <span class="n">print</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">Base</span><span class="o">::</span><span class="n">_print</span><span class="p">(</span><span class="n">_tag</span><span class="p">,</span> <span class="n">_statistics</span><span class="p">,</span> <span class="n">os</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">friend</span> <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="k">operator</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">Self</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">obj</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">obj</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">os</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">os</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Accessors</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">last</span>    <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">last</span><span class="p">;}</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">min</span>     <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">min</span><span class="p">;}</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">max</span>     <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">max</span><span class="p">;}</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">samples</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">samples</span><span class="p">;}</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="n">Count</span>  <span class="n">total</span>   <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">total</span><span class="p">;}</span>
</span><span class='line'>   <span class="kr">inline</span> <span class="kt">double</span> <span class="n">average</span> <span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span><span class="k">return</span> <span class="n">_statistics</span><span class="p">.</span><span class="n">average</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// The tag for this object</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">_tag</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// A statistics object specifically for this stopwatch instance</span>
</span><span class='line'>   <span class="n">detail</span><span class="o">::</span><span class="n">Statistics</span> <span class="n">_statistics</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>We are all set! Time to test it out:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Define a tag</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Static</span><span class="p">{};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">using</span> <span class="k">namespace</span> <span class="n">stopwatch</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">typedef</span> <span class="n">Stopwatch</span><span class="o">&lt;</span><span class="n">Static</span><span class="p">,</span> <span class="n">MillisecondClock</span><span class="o">&gt;</span> <span class="n">static_stopwatch</span><span class="p">;</span>
</span><span class='line'>  <span class="n">Stopwatch</span><span class="o">&lt;</span><span class="kt">void</span><span class="p">,</span> <span class="n">MillisecondClock</span><span class="o">&gt;</span> <span class="n">object_stopwatch</span><span class="p">(</span><span class="s">&quot;Object&quot;</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>  <span class="p">{</span>
</span><span class='line'>      <span class="n">static_stopwatch</span><span class="o">::</span><span class="n">start</span><span class="p">();</span>
</span><span class='line'>      <span class="n">object_stopwatch</span><span class="p">.</span><span class="n">start</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">boost</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">posix_time</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">static_stopwatch</span><span class="o">::</span><span class="n">stop</span><span class="p">();</span>
</span><span class='line'>      <span class="n">object_stopwatch</span><span class="p">.</span><span class="n">stop</span><span class="p">();</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">static_stopwatch</span><span class="o">::</span><span class="n">print</span><span class="p">();</span>
</span><span class='line'>  <span class="n">object_stopwatch</span><span class="p">.</span><span class="n">print</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>To compile this, run the following command:</p>

<pre><code>g++ stopwatch.cpp -l boost_chrono -l boost_system -l boost_thread
</code></pre>

<p>The output I get is:</p>

<pre><code>Static:
 - Last    : 10
 - Min     : 10
 - Max     : 11
 - Average : 10.19
 - Total   : 1019
 - Samples : 100
Object:
 - Last    : 10
 - Min     : 10
 - Max     : 11
 - Average : 10.19
 - Total   : 1019
 - Samples : 100
</code></pre>

<p>As you can see, both types give the same results.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/09/20/dockerfile-generator/">Dockerfile Generator</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-20T15:19:17-04:00" pubdate data-updated="true">Sep 20<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/09/20/dockerfile-generator/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/09/20/dockerfile-generator/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A lot of the Dockerfiles I write use the same template and tricks. I decided to write a ruby script to generate my Dockerfiles for me based on a minimal amount of input. I did this for a couple reasons:</p>

<ul>
<li>I wanted my images to be as small as possible</li>
<li>I wanted consistent and readable Dockerfiles</li>
<li>I wanted to make it easy to update my images</li>
<li>I wanted all my images to be easy to port to the Raspberry Pi</li>
</ul>


<h2>Dockerfile Tricks</h2>

<h3>Keeping the image small</h3>

<p>Every command in a Dockerfile causes a layer to be committed. Once a layer is committed, files on that layer can be hidden, but not deleted. For that reason, it becomes advantageous to run multiple commands at a time. For example, don&rsquo;t do this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>RUN apt-get update
</span><span class='line'>RUN apt-get install -y build_essential
</span><span class='line'>RUN apt-get clean
</span></code></pre></td></tr></table></div></figure>


<p>Line 2 will download a bunch of packages and install them. Line 3 attempts to clean up the packages that were downloaded, but it&rsquo;s too late; they were already committed to the layer and can only be hidden. The overall image will be large because that layer still needs to be downloaded.</p>

<p>A better approach is:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>RUN apt-get update <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    apt-get install -y build_essential <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    apt-get clean
</span></code></pre></td></tr></table></div></figure>


<p>This will run all three commands and apply the end result to a single layer, greatly reducing the image size.</p>

<h4>The ADD command</h4>

<p>The <code>ADD</code> command hinders our ability to keep the image small, because it will commit files to a layer without giving a chance to delete those files later. This is fine for files that are supposed to be permanently in the image, but what about temporary files? For example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>ADD some_package.deb /
</span><span class='line'>
</span><span class='line'>RUN dpkg -i /some_package.deb <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    rm -f /some_package.deb
</span></code></pre></td></tr></table></div></figure>


<p>The package removal will only hide the file; the image still contains the data on a lower layer.</p>

<p>Instead, a better approach is to run a web server and download temporary files to your image, allowing the same <code>RUN</code> statement to later delete the temporary files. To do this, start a server before building your image:</p>

<pre><code>python -m SimpleHTTPServer 8888
</code></pre>

<p>Then do the following in your Dockerfile:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>RUN wget http://&lt;ip_address&gt;:8888/package.deb <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    <span class="o">(</span>dpkg -i package.deb <span class="o">||</span> <span class="nb">true</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>    apt-get -y -f install --no-install-recommends <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span></code></pre></td></tr></table></div></figure>


<p>Replace <code>&lt;ip_address&gt;</code> with your <em>internal</em> ip address. To get that, use the following command:</p>

<pre><code>ip route get 8.8.8.8 | awk '{print $NF; exit}'
</code></pre>

<h3>Keeping the Dockerfile readable</h3>

<p>From the previous section, it stands to reason that putting all the commands on a single <code>RUN</code> statement will yield the smallest image (assuming you clean up after yourself). If there are a lot of commands, it can be difficult to read what is going on.</p>

<p>One trick is to interleave comments into the <code>RUN</code> statement by using backticks. Another common thing to do is add blank lines using backslashes, and align all the backslashes to the right:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>RUN <span class="sb">`</span><span class="c"># Update package list`             &amp;&amp; \</span>
</span><span class='line'>     apt-get update                     <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                           <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Install development tools`       &amp;&amp; \</span>
</span><span class='line'>     apt-get install -y build_essential <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                           <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Delete cached packages`          &amp;&amp; \</span>
</span><span class='line'>     apt-get clean
</span></code></pre></td></tr></table></div></figure>


<p>The result is much more readable, but it is tedious to make sure all the spacing is correct.</p>

<h2>Dockerfile Generator</h2>

<p>Incorporating the above tricks, I wrote a Dockerfile generator to quickly create Dockerfiles for simple projects:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
</pre></td><td class='code'><pre><code class='ruby'><span class='line'><span class="c1">#!/usr/bin/env ruby</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># dockerfile-generator.rb</span>
</span><span class='line'><span class="c1"># Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c1"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c1"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c1"># (at your option) any later version.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c1"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c1"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c1"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c1">#</span>
</span><span class='line'><span class="c1"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c1"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;set&quot;</span>
</span><span class='line'><span class="nb">require</span> <span class="s2">&quot;yaml&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Dockerfile</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="nf">initialize</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@from</span>       <span class="o">=</span> <span class="s2">&quot;phusion/baseimage:0.9.16&quot;</span>
</span><span class='line'>    <span class="vi">@maintainer</span> <span class="o">=</span> <span class="s2">&quot;Joe Ruether&quot;</span>
</span><span class='line'>    <span class="vi">@user</span>       <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
</span><span class='line'>    <span class="vi">@service</span>    <span class="o">=</span> <span class="kp">nil</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@requirements</span> <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@packages</span>     <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@volumes</span>      <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>    <span class="vi">@ports</span>        <span class="o">=</span> <span class="no">Set</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Files to add before and after the run command</span>
</span><span class='line'>    <span class="vi">@adds</span>       <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@configures</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Command lists for the run section</span>
</span><span class='line'>    <span class="vi">@begin_commands</span>        <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@pre_install_commands</span>  <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@install_commands</span>      <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@post_install_commands</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@run_commands</span>          <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="vi">@end_commands</span>          <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Set if deb packages need dependencies to be resolved</span>
</span><span class='line'>    <span class="vi">@deb_flag</span> <span class="o">=</span> <span class="kp">false</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Used to download deb files from the host  </span>
</span><span class='line'>    <span class="vi">@ip_address</span> <span class="o">=</span> <span class="sb">`ip route get 8.8.8.8 | awk &#39;{print $NF; exit}&#39;`</span><span class="o">.</span><span class="n">chomp</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##############################################################################</span>
</span><span class='line'>  <span class="kp">public</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># string ()</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">finalize</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;FROM </span><span class="si">#{</span><span class="vi">@from</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;MAINTAINER </span><span class="si">#{</span><span class="vi">@maintainer</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="vi">@ports</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="nb">p</span><span class="o">|</span> <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;EXPOSE </span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="vi">@ports</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">+=</span> <span class="vi">@adds</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="vi">@adds</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">build_run_command</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">+=</span> <span class="vi">@configures</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="vi">@configures</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>    <span class="vi">@volumes</span><span class="o">.</span><span class="n">each</span><span class="p">{</span><span class="o">|</span><span class="n">v</span><span class="o">|</span> <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;VOLUME </span><span class="si">#{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;&quot;</span> <span class="k">if</span> <span class="o">!</span><span class="vi">@volumes</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;ENTRYPOINT [</span><span class="se">\&quot;</span><span class="s2">/sbin/my_init</span><span class="se">\&quot;</span><span class="s2">]&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_user</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@user</span> <span class="o">=</span> <span class="n">user</span>
</span><span class='line'>    <span class="n">add_begin_command</span> <span class="n">comment</span> <span class="s2">&quot;Adjusting user permissions&quot;</span>
</span><span class='line'>    <span class="n">add_begin_command</span> <span class="s2">&quot;usermod -u 1000 </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2"> &amp;&amp; groupmod -g 1000 </span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">add_begin_command</span> <span class="n">blank</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">set_service</span><span class="p">(</span><span class="n">service</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@service</span> <span class="o">=</span> <span class="n">service</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (string, string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@adds</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;ADD </span><span class="si">#{</span><span class="n">source</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">destination</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (string, string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">destination</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@configures</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;ADD </span><span class="si">#{</span><span class="n">source</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">destination</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (int)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">expose</span><span class="p">(</span><span class="n">port</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@ports</span><span class="o">.</span><span class="n">add</span> <span class="n">port</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (string, string, string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add_repository</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">deb</span><span class="p">,</span> <span class="n">key</span> <span class="o">=</span> <span class="kp">nil</span><span class="p">)</span>
</span><span class='line'>    <span class="n">add_pre_install_command</span> <span class="n">comment</span> <span class="s2">&quot;Adding </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> repository&quot;</span>
</span><span class='line'>    <span class="n">add_pre_install_command</span> <span class="s2">&quot;wget -O - </span><span class="si">#{</span><span class="n">key</span><span class="si">}</span><span class="s2"> | apt-key add -&quot;</span> <span class="k">if</span> <span class="n">key</span>
</span><span class='line'>    <span class="n">add_pre_install_command</span> <span class="s2">&quot;echo &#39;</span><span class="si">#{</span><span class="n">deb</span><span class="si">}</span><span class="s2">&#39; &gt;&gt; /etc/apt/sources.list.d/</span><span class="si">#{</span><span class="nb">name</span><span class="o">.</span><span class="n">downcase</span><span class="si">}</span><span class="s2">.list&quot;</span>
</span><span class='line'>    <span class="n">add_pre_install_command</span> <span class="n">blank</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@requirements</span><span class="o">.</span><span class="n">add</span> <span class="s2">&quot;wget&quot;</span>
</span><span class='line'>    <span class="vi">@requirements</span><span class="o">.</span><span class="n">add</span> <span class="s2">&quot;ssl-cert&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (string, string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add_ppa</span><span class="p">(</span><span class="nb">name</span><span class="p">,</span> <span class="n">ppa</span><span class="p">)</span>
</span><span class='line'>    <span class="n">add_pre_install_command</span> <span class="n">comment</span> <span class="s2">&quot;Adding </span><span class="si">#{</span><span class="nb">name</span><span class="si">}</span><span class="s2"> PPA&quot;</span>
</span><span class='line'>    <span class="n">add_pre_install_command</span> <span class="s2">&quot;add-apt-repository -y </span><span class="si">#{</span><span class="n">ppa</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">add_pre_install_command</span> <span class="n">blank</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@requirements</span><span class="o">.</span><span class="n">add</span> <span class="s2">&quot;software-properties-common&quot;</span>
</span><span class='line'>    <span class="vi">@requirements</span><span class="o">.</span><span class="n">add</span> <span class="s2">&quot;python-software-properties&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">install_package</span><span class="p">(</span><span class="n">package</span><span class="p">)</span>
</span><span class='line'>    <span class="vi">@packages</span><span class="o">.</span><span class="n">add</span> <span class="n">package</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">install_deb</span><span class="p">(</span><span class="n">deb</span><span class="p">)</span>
</span><span class='line'>    <span class="n">add_install_command</span> <span class="n">comment</span> <span class="s2">&quot;Installing deb package&quot;</span>
</span><span class='line'>    <span class="n">add_install_command</span> <span class="s2">&quot;wget http://</span><span class="si">#{</span><span class="vi">@ip_address</span><span class="si">}</span><span class="s2">:8888/</span><span class="si">#{</span><span class="n">deb</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">add_install_command</span> <span class="s2">&quot;(dpkg -i </span><span class="si">#{</span><span class="n">deb</span><span class="si">}</span><span class="s2"> || true)&quot;</span>
</span><span class='line'>    <span class="n">add_install_command</span> <span class="n">blank</span>
</span><span class='line'>    <span class="n">add_post_install_command</span> <span class="s2">&quot;rm -f </span><span class="si">#{</span><span class="n">deb</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@packages</span><span class="o">.</span><span class="n">add</span> <span class="s2">&quot;wget&quot;</span>
</span><span class='line'>    <span class="vi">@deb_flag</span> <span class="o">=</span> <span class="kp">true</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
</span><span class='line'>    <span class="n">command</span><span class="o">.</span><span class="n">strip!</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">command</span><span class="o">.</span><span class="n">start_with?</span> <span class="s2">&quot;#&quot;</span>
</span><span class='line'>      <span class="n">add_run_command</span> <span class="n">comment</span> <span class="n">command</span><span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="o">].</span><span class="n">strip</span>
</span><span class='line'>    <span class="k">elsif</span> <span class="n">command</span><span class="o">.</span><span class="n">match</span> <span class="sr">/^\s*$/</span>
</span><span class='line'>      <span class="n">add_run_command</span> <span class="n">blank</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'>      <span class="n">add_run_command</span> <span class="n">command</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># void (string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">add_volume</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
</span><span class='line'>    <span class="n">add_end_command</span> <span class="n">comment</span> <span class="s2">&quot;Fixing permission errors for volume&quot;</span>
</span><span class='line'>    <span class="n">add_end_command</span> <span class="s2">&quot;chown -R </span><span class="si">#{</span><span class="vi">@user</span><span class="si">}</span><span class="s2">:</span><span class="si">#{</span><span class="vi">@user</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">volume</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span class='line'>    <span class="n">add_end_command</span> <span class="n">blank</span>
</span><span class='line'>
</span><span class='line'>    <span class="vi">@volumes</span><span class="o">.</span><span class="n">add</span> <span class="n">volume</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##############################################################################</span>
</span><span class='line'>  <span class="kp">private</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># string (string)</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">comment</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
</span><span class='line'>    <span class="s2">&quot;`</span><span class="se">\#</span><span class="s2"> </span><span class="si">#{</span><span class="n">string</span><span class="si">}</span><span class="s2">`&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># string ()</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">blank</span>
</span><span class='line'>    <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># [string] ([string])</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_install_command</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Convert the set to an array</span>
</span><span class='line'>    <span class="n">packages</span> <span class="o">=</span> <span class="n">packages</span><span class="o">.</span><span class="n">to_a</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Specify the command</span>
</span><span class='line'>    <span class="n">command</span> <span class="o">=</span> <span class="s2">&quot;apt-get install -y --no-install-recommends&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Make an array of paddings</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">command</span><span class="o">.</span><span class="n">length</span><span class="p">()</span><span class="o">]</span> <span class="o">*</span> <span class="n">packages</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Overwrite the first line with the command</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="n">command</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Append the packages and backslashes to each line</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">zip</span><span class="p">(</span><span class="n">packages</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">{</span><span class="o">|</span><span class="n">l</span><span class="p">,</span> <span class="nb">p</span><span class="o">|</span> <span class="n">l</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">#{</span><span class="nb">p</span><span class="si">}</span><span class="s2"> </span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Convert the backslash on the last line to &quot;&amp;&amp; \&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">[-</span><span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="n">lines</span><span class="o">[-</span><span class="mi">1</span><span class="o">][</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">2</span><span class="o">]</span> <span class="o">+</span> <span class="s2">&quot;&amp;&amp; </span><span class="se">\\</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Add comment and blank</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">comment</span><span class="p">(</span><span class="s2">&quot;Installing packages&quot;</span><span class="p">))</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">blank</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># string ()</span>
</span><span class='line'>  <span class="k">def</span> <span class="nf">build_run_command</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lines</span> <span class="o">=</span> <span class="o">[]</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Any packages that were requirements can be removed from the packages list</span>
</span><span class='line'>    <span class="vi">@packages</span> <span class="o">=</span> <span class="vi">@packages</span><span class="o">.</span><span class="n">difference</span> <span class="vi">@requirements</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">lines</span> <span class="o">+=</span> <span class="n">begin_commands</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># If required packages were specified</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">!</span><span class="vi">@requirements</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="c1"># Update the package list</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">comment</span> <span class="s2">&quot;Updating Package List&quot;</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;apt-get update&quot;</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">blank</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Install requirements</span>
</span><span class='line'>      <span class="n">lines</span> <span class="o">+=</span> <span class="n">build_install_command</span> <span class="vi">@requirements</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Run pre-install commands</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">+=</span> <span class="n">pre_install_commands</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Add apt-cacher proxy</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">comment</span> <span class="s2">&quot;Adding apt-cacher-ng proxy&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;echo &#39;Acquire::http { Proxy </span><span class="se">\&quot;</span><span class="s2">http://172.17.42.1:3142</span><span class="se">\&quot;</span><span class="s2">; };&#39; &gt; /etc/apt/apt.conf.d/01proxy&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">blank</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Update</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">comment</span> <span class="s2">&quot;Updating Package List&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;apt-get update&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">blank</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Install packages</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">+=</span> <span class="n">build_install_command</span> <span class="vi">@packages</span> <span class="k">unless</span> <span class="vi">@packages</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Run install commands</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">+=</span> <span class="n">install_commands</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># If manual deb packages were specified</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@deb_flag</span>
</span><span class='line'>      <span class="c1"># Resolve their dependencies</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">comment</span> <span class="s2">&quot;Installing deb package dependencies&quot;</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;apt-get -y -f install --no-install-recommends&quot;</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">blank</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Run post-install commands</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">!</span><span class="vi">@post_install_commands</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">comment</span> <span class="s2">&quot;Removing temporary files&quot;</span>
</span><span class='line'>      <span class="n">lines</span> <span class="o">+=</span> <span class="n">post_install_commands</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">blank</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Clean up</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">comment</span> <span class="s2">&quot;Cleaning up after installation&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;apt-get clean &amp;&amp; rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">blank</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Remove apt-cacher proxy</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">comment</span> <span class="s2">&quot;Removing apt-cacher-ng proxy&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;rm -f /etc/apt/apt.conf.d/01proxy&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">blank</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Run commands</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">+=</span> <span class="n">run_commands</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">blank</span> <span class="k">if</span> <span class="o">!</span><span class="vi">@run_commands</span><span class="o">.</span><span class="n">empty?</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Enable service on startup</span>
</span><span class='line'>    <span class="k">if</span> <span class="vi">@service</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">comment</span> <span class="s2">&quot;Enable service on startup&quot;</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="s2">&quot;sed -i </span><span class="se">\&quot;</span><span class="s2">s@exit 0@service </span><span class="si">#{</span><span class="vi">@service</span><span class="si">}</span><span class="s2"> start@g</span><span class="se">\&quot;</span><span class="s2"> /etc/rc.local&quot;</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">push</span> <span class="n">blank</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># End commands</span>
</span><span class='line'>    <span class="n">lines</span> <span class="o">+=</span> <span class="n">end_commands</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Determine the longest line</span>
</span><span class='line'>    <span class="n">longest_length</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">max_by</span><span class="p">(</span><span class="o">&amp;</span><span class="ss">:length</span><span class="p">)</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># For each line</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">collect</span> <span class="k">do</span> <span class="o">|</span><span class="n">l</span><span class="o">|</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Determine how many spaces needed to indent</span>
</span><span class='line'>      <span class="n">length_to_extend</span> <span class="o">=</span> <span class="n">longest_length</span> <span class="o">-</span> <span class="n">l</span><span class="o">.</span><span class="n">length</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Indent the line</span>
</span><span class='line'>      <span class="n">length_to_extend</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">start_with?</span> <span class="s2">&quot;`&quot;</span>
</span><span class='line'>      <span class="n">l</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">start_with?</span><span class="p">(</span><span class="s2">&quot;`&quot;</span><span class="p">)</span> <span class="p">?</span> <span class="mi">4</span> <span class="p">:</span> <span class="mi">5</span><span class="p">))</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Add or Extend end markers </span>
</span><span class='line'>      <span class="k">if</span> <span class="n">l</span><span class="o">.</span><span class="n">end_with?</span> <span class="s2">&quot; &amp;&amp; </span><span class="se">\\</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">length_to_extend</span> <span class="o">+=</span> <span class="mi">5</span>
</span><span class='line'>        <span class="n">l</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">length_to_extend</span><span class="p">)</span>
</span><span class='line'>      <span class="k">elsif</span> <span class="n">l</span><span class="o">.</span><span class="n">end_with?</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span>
</span><span class='line'>        <span class="n">length_to_extend</span> <span class="o">+=</span> <span class="mi">5</span>
</span><span class='line'>        <span class="n">l</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">length_to_extend</span><span class="p">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="n">l</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">length_to_extend</span><span class="p">)</span>
</span><span class='line'>        <span class="n">l</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot; &amp;&amp; </span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">)</span>
</span><span class='line'>      <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># First line should start with &quot;RUN&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="mi">2</span><span class="o">]</span> <span class="o">=</span> <span class="s2">&quot;RUN&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Last line should not end with marker</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">[-</span><span class="mi">1</span><span class="o">].</span><span class="n">gsub!</span> <span class="s2">&quot; &amp;&amp; </span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">[-</span><span class="mi">1</span><span class="o">].</span><span class="n">gsub!</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Last line might be blank now, do it again</span>
</span><span class='line'>    <span class="k">if</span> <span class="n">lines</span><span class="o">[-</span><span class="mi">1</span><span class="o">].</span><span class="n">match</span> <span class="sr">/^\s*$/</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">.</span><span class="n">delete_at</span> <span class="o">-</span><span class="mi">1</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1"># Last line should not end with marker</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">[-</span><span class="mi">1</span><span class="o">].</span><span class="n">gsub!</span> <span class="s2">&quot; &amp;&amp; </span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>      <span class="n">lines</span><span class="o">[-</span><span class="mi">1</span><span class="o">].</span><span class="n">gsub!</span> <span class="s2">&quot; </span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
</span><span class='line'>    <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1"># Make a string</span>
</span><span class='line'>    <span class="n">lines</span><span class="o">.</span><span class="n">join</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">##############################################################################</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1"># Some metaprogramming to handle the various command lists</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">handle</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">class_eval</span><span class="p">(</span><span class="s2">&quot;def </span><span class="si">#{</span><span class="n">arg</span><span class="si">}</span><span class="s2">;@</span><span class="si">#{</span><span class="n">arg</span><span class="si">}</span><span class="s2">;end&quot;</span><span class="p">)</span>
</span><span class='line'>    <span class="nb">self</span><span class="o">.</span><span class="n">class_eval</span><span class="p">(</span><span class="s2">&quot;def add_</span><span class="si">#{</span><span class="n">arg</span><span class="o">[</span><span class="mi">0</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">2</span><span class="o">]</span><span class="si">}</span><span class="s2">(val);@</span><span class="si">#{</span><span class="n">arg</span><span class="si">}</span><span class="s2">.push val;end&quot;</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">handle</span> <span class="ss">:begin_commands</span>
</span><span class='line'>  <span class="n">handle</span> <span class="ss">:pre_install_commands</span>
</span><span class='line'>  <span class="n">handle</span> <span class="ss">:install_commands</span>
</span><span class='line'>  <span class="n">handle</span> <span class="ss">:post_install_commands</span>
</span><span class='line'>  <span class="n">handle</span> <span class="ss">:run_commands</span>
</span><span class='line'>  <span class="n">handle</span> <span class="ss">:end_commands</span>
</span><span class='line'>
</span><span class='line'><span class="k">end</span>
</span><span class='line'>
</span><span class='line'><span class="c1">################################################################################</span>
</span><span class='line'><span class="c1"># Parse Dockerfile.yml</span>
</span><span class='line'>
</span><span class='line'><span class="n">dockerfile</span> <span class="o">=</span> <span class="no">Dockerfile</span><span class="o">.</span><span class="n">new</span>
</span><span class='line'><span class="n">yaml</span> <span class="o">=</span> <span class="ss">YAML</span><span class="p">:</span><span class="ss">:load_file</span><span class="p">(</span><span class="s2">&quot;Dockerfile.yml&quot;</span><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Parse User tag</span>
</span><span class='line'><span class="n">dockerfile</span><span class="o">.</span><span class="n">set_user</span> <span class="n">yaml</span><span class="o">[</span><span class="s2">&quot;User&quot;</span><span class="o">]</span> <span class="k">if</span> <span class="n">yaml</span><span class="o">.</span><span class="n">has_key?</span> <span class="s2">&quot;User&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Parse Service tag</span>
</span><span class='line'><span class="n">dockerfile</span><span class="o">.</span><span class="n">set_service</span> <span class="n">yaml</span><span class="o">[</span><span class="s2">&quot;Service&quot;</span><span class="o">]</span> <span class="k">if</span> <span class="n">yaml</span><span class="o">.</span><span class="n">has_key?</span> <span class="s2">&quot;Service&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Parse Add tag</span>
</span><span class='line'><span class="n">yaml</span><span class="o">[</span><span class="s2">&quot;Add&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Hash</span>
</span><span class='line'>    <span class="n">dockerfile</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span><span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">dockerfile</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span> <span class="k">if</span> <span class="n">yaml</span><span class="o">.</span><span class="n">has_key?</span> <span class="s2">&quot;Add&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Parse Repositories tag</span>
</span><span class='line'><span class="n">yaml</span><span class="o">[</span><span class="s2">&quot;Repositories&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">r</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;URL&quot;</span><span class="o">].</span><span class="n">start_with?</span> <span class="s2">&quot;deb &quot;</span>
</span><span class='line'>    <span class="n">dockerfile</span><span class="o">.</span><span class="n">add_repository</span><span class="p">(</span><span class="n">r</span><span class="o">[</span><span class="s2">&quot;Name&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;URL&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;Key&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">elsif</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;URL&quot;</span><span class="o">].</span><span class="n">start_with?</span> <span class="s2">&quot;ppa:&quot;</span>
</span><span class='line'>    <span class="n">dockerfile</span><span class="o">.</span><span class="n">add_ppa</span><span class="p">(</span><span class="n">r</span><span class="o">[</span><span class="s2">&quot;Name&quot;</span><span class="o">]</span><span class="p">,</span> <span class="n">r</span><span class="o">[</span><span class="s2">&quot;URL&quot;</span><span class="o">]</span><span class="p">)</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span> <span class="k">if</span> <span class="n">yaml</span><span class="o">.</span><span class="n">has_key?</span> <span class="s2">&quot;Repositories&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Parse Install tag</span>
</span><span class='line'><span class="n">yaml</span><span class="o">[</span><span class="s2">&quot;Install&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">package</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">package</span><span class="o">.</span><span class="n">end_with?</span> <span class="s2">&quot;.deb&quot;</span>
</span><span class='line'>    <span class="n">dockerfile</span><span class="o">.</span><span class="n">install_deb</span> <span class="n">package</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">dockerfile</span><span class="o">.</span><span class="n">install_package</span> <span class="n">package</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span> <span class="k">if</span> <span class="n">yaml</span><span class="o">.</span><span class="n">has_key?</span> <span class="s2">&quot;Install&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Parse Run tag</span>
</span><span class='line'><span class="n">yaml</span><span class="o">[</span><span class="s2">&quot;Run&quot;</span><span class="o">].</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
</span><span class='line'>  <span class="n">dockerfile</span><span class="o">.</span><span class="n">run</span> <span class="n">line</span>
</span><span class='line'><span class="k">end</span> <span class="k">if</span> <span class="n">yaml</span><span class="o">.</span><span class="n">has_key?</span> <span class="s2">&quot;Run&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Parse Configure tag</span>
</span><span class='line'><span class="n">yaml</span><span class="o">[</span><span class="s2">&quot;Configure&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span>
</span><span class='line'>  <span class="k">if</span> <span class="n">i</span><span class="o">.</span><span class="n">is_a?</span> <span class="no">Hash</span>
</span><span class='line'>    <span class="n">dockerfile</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span><span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span><span class="p">,</span> <span class="n">i</span><span class="o">.</span><span class="n">first</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'>    <span class="n">dockerfile</span><span class="o">.</span><span class="n">add</span> <span class="n">i</span>
</span><span class='line'>  <span class="k">end</span>
</span><span class='line'><span class="k">end</span> <span class="k">if</span> <span class="n">yaml</span><span class="o">.</span><span class="n">has_key?</span> <span class="s2">&quot;Configure&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Parse Expose tag</span>
</span><span class='line'><span class="n">yaml</span><span class="o">[</span><span class="s2">&quot;Expose&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">port</span><span class="o">|</span>
</span><span class='line'>  <span class="n">dockerfile</span><span class="o">.</span><span class="n">expose</span> <span class="n">port</span>
</span><span class='line'><span class="k">end</span> <span class="k">if</span> <span class="n">yaml</span><span class="o">.</span><span class="n">has_key?</span> <span class="s2">&quot;Expose&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Parse Volumes tag</span>
</span><span class='line'><span class="n">yaml</span><span class="o">[</span><span class="s2">&quot;Volumes&quot;</span><span class="o">].</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">volume</span><span class="o">|</span>
</span><span class='line'>  <span class="n">dockerfile</span><span class="o">.</span><span class="n">add_volume</span> <span class="n">volume</span>
</span><span class='line'><span class="k">end</span> <span class="k">if</span> <span class="n">yaml</span><span class="o">.</span><span class="n">has_key?</span> <span class="s2">&quot;Volumes&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Output Dockerfile</span>
</span><span class='line'><span class="nb">puts</span> <span class="n">dockerfile</span><span class="o">.</span><span class="n">finalize</span>
</span></code></pre></td></tr></table></div></figure>


<p>Run it from a directory that contains a <code>Dockerfile.yml</code> and it will print out a Dockerfile:</p>

<pre><code>ruby dockerfile-generator.rb &gt; Dockerfile
</code></pre>

<h3>Dockerfile.yml Specifications</h3>

<p>A simplified Dockerfile specification can be put into <code>Dockerfile.yml</code>. The supported items are explained below. All items are optional.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="c1"># Specify a user that the service will run as, used for fixing permissions on volumes.</span>
</span><span class='line'><span class="l-Scalar-Plain">User</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">www-data</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Specify the service that will run on startup.</span>
</span><span class='line'><span class="l-Scalar-Plain">Service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apache2</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Adds a file to / or the specified destination.</span>
</span><span class='line'><span class="c1"># Tar files are automatically unpacked.</span>
</span><span class='line'><span class="c1"># Remote files are allowed.</span>
</span><span class='line'><span class="c1"># Files are added before any commands are run.</span>
</span><span class='line'><span class="l-Scalar-Plain">Add</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">root_filesystem.tar</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Foo.txt</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/user/</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">http://www.foo.com/Foo.txt</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/user/bar.txt</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Add Repositories and PPAs.</span>
</span><span class='line'><span class="c1"># URLs are either a complete deb line in sources.list format or a PPA.</span>
</span><span class='line'><span class="c1"># Keys are optional.</span>
</span><span class='line'><span class="l-Scalar-Plain">Repositories</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Owncloud</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deb http://download.opensuse.org/repositories/isv:/ownCloud:/community/xUbuntu_14.04/ /</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Key</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://download.opensuse.org/repositories/isv:ownCloud:community/xUbuntu_14.04/Release.key</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Bitcoin</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ppa:bitcoin/bitcoin</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Install packages or deb files.</span>
</span><span class='line'><span class="l-Scalar-Plain">Install</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">build_essential</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">some_package.deb</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Run commands verbatim in bash format. Note the pipe character.</span>
</span><span class='line'><span class="l-Scalar-Plain">Run</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'> <span class="no"># This is a comment</span>
</span><span class='line'> <span class="no">echo Hello</span>
</span><span class='line'>
</span><span class='line'> <span class="no"># Another comment</span>
</span><span class='line'> <span class="no">rm -rf /</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Exactly the same as Add, however files are added AFTER commands are run.</span>
</span><span class='line'><span class="l-Scalar-Plain">Configure</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">root_filesystem.tar</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Foo.txt</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/user/</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">http://www.foo.com/Foo.txt</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/home/user/bar.txt</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Ports to expose.</span>
</span><span class='line'><span class="l-Scalar-Plain">Expose</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">80</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># Volumes to expose to the host.</span>
</span><span class='line'><span class="l-Scalar-Plain">Volumes</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/www/owncloud</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/mnt</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Examples</h3>

<p>Making a Dockerfile is really easy with this generator. The generated Dockerfile will automatically use an <code>apt-cacher-ng</code> container for downloading packages, which is handy if you are making a lot of images or rebuilding often. Therefore, remember to run the <code>apt-cacher-ng</code> container before building other images. Also remember to run the python web server if you are installing deb packages manually.</p>

<h4>Apt-cacher-ng</h4>

<p>First step is to create the <code>apt-cacher-ng</code> image so it can be used to build other images. Below is the <code>Dockerfile.yml</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">User</span>   <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apt-cacher-ng</span>
</span><span class='line'><span class="l-Scalar-Plain">Service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apt-cacher-ng</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Install</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">apt-cacher-ng</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Expose</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">3142</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Volumes</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/cache/apt-cacher-ng</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thats it! Generating the Dockerfile yields (scroll to the right to see the <code>&amp;&amp; \</code> markers):</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FROM phusion/baseimage:0.9.16
</span><span class='line'>MAINTAINER Joe Ruether
</span><span class='line'>
</span><span class='line'>EXPOSE 3142
</span><span class='line'>
</span><span class='line'>RUN <span class="sb">`</span><span class="c"># Adjusting user permissions`                                                            &amp;&amp; \</span>
</span><span class='line'>     usermod -u 1000 apt-cacher-ng <span class="o">&amp;&amp;</span> groupmod -g 1000 apt-cacher-ng                          <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Adding apt-cacher-ng proxy`                                                            &amp;&amp; \</span>
</span><span class='line'>     <span class="nb">echo</span> <span class="s1">&#39;Acquire::http { Proxy &quot;http://172.17.42.1:3142&quot;; };&#39;</span> &gt; /etc/apt/apt.conf.d/01proxy <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Updating Package List`                                                                 &amp;&amp; \</span>
</span><span class='line'>     apt-get update                                                                           <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Installing packages`                                                                   &amp;&amp; \</span>
</span><span class='line'>     apt-get install -y --no-install-recommends apt-cacher-ng                                 <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Cleaning up after installation`                                                        &amp;&amp; \</span>
</span><span class='line'>     apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*                           <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Removing apt-cacher-ng proxy`                                                          &amp;&amp; \</span>
</span><span class='line'>     rm -f /etc/apt/apt.conf.d/01proxy                                                        <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Enable service on startup`                                                             &amp;&amp; \</span>
</span><span class='line'>     sed -i <span class="s2">&quot;s@exit 0@service apt-cacher-ng start@g&quot;</span> /etc/rc.local                            <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Fixing permission errors for volume`                                                   &amp;&amp; \</span>
</span><span class='line'>     chown -R apt-cacher-ng:apt-cacher-ng /var/cache/apt-cacher-ng
</span><span class='line'>
</span><span class='line'>VOLUME /var/cache/apt-cacher-ng
</span><span class='line'>
</span><span class='line'>ENTRYPOINT <span class="o">[</span><span class="s2">&quot;/sbin/my_init&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Since it obviously cannot use <code>apt-cacher-ng</code> to build itself, simply remove those lines for this image:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FROM phusion/baseimage:0.9.16
</span><span class='line'>MAINTAINER Joe Ruether
</span><span class='line'>
</span><span class='line'>EXPOSE 3142
</span><span class='line'>
</span><span class='line'>RUN <span class="sb">`</span><span class="c"># Updating Package List`                                                                 &amp;&amp; \</span>
</span><span class='line'>     apt-get update                                                                           <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Installing packages`                                                                   &amp;&amp; \</span>
</span><span class='line'>     apt-get install -y --no-install-recommends apt-cacher-ng                                 <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Cleaning up after installation`                                                        &amp;&amp; \</span>
</span><span class='line'>     apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*                           <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Enable service on startup`                                                             &amp;&amp; \</span>
</span><span class='line'>     sed -i <span class="s2">&quot;s@exit 0@service apt-cacher-ng start@g&quot;</span> /etc/rc.local                            <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Fixing permission errors for volume`                                                   &amp;&amp; \</span>
</span><span class='line'>     chown -R apt-cacher-ng:apt-cacher-ng /var/cache/apt-cacher-ng
</span><span class='line'>
</span><span class='line'>VOLUME /var/cache/apt-cacher-ng
</span><span class='line'>
</span><span class='line'>ENTRYPOINT <span class="o">[</span><span class="s2">&quot;/sbin/my_init&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Owncloud</h4>

<p>Lets try something a little more complicated. Here, I present two Owncloud images. The first one is built using the latest code in the repository, while the second is built with specifically downloaded versions of deb files.</p>

<h5>Latest From Repository</h5>

<p>Dockerfile.yml:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">User</span>   <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">www-data</span>
</span><span class='line'><span class="l-Scalar-Plain">Service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apache2</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Repositories</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Owncloud</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">deb http://download.opensuse.org/repositories/isv:/ownCloud:/community/xUbuntu_14.04/ /</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Key</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://download.opensuse.org/repositories/isv:ownCloud:community/xUbuntu_14.04/Release.key</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Install</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">owncloud</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Run</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'> <span class="no"># Enable SSL</span>
</span><span class='line'> <span class="no">a2enmod ssl &amp;&amp; a2ensite default-ssl</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Expose</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Volumes</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/www/owncloud</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/mnt</span>
</span></code></pre></td></tr></table></div></figure>


<p>Generated Dockerfile:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FROM phusion/baseimage:0.9.16
</span><span class='line'>MAINTAINER Joe Ruether
</span><span class='line'>
</span><span class='line'>EXPOSE 443
</span><span class='line'>
</span><span class='line'>RUN <span class="sb">`</span><span class="c"># Updating Package List`                                                                                                                &amp;&amp; \</span>
</span><span class='line'>     apt-get update                                                                                                                          <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Installing packages`                                                                                                                  &amp;&amp; \</span>
</span><span class='line'>     apt-get install -y --no-install-recommends wget                                                                                            <span class="se">\</span>
</span><span class='line'>                                                ssl-cert                                                                                     <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Adding Owncloud repository`                                                                                                           &amp;&amp; \</span>
</span><span class='line'>     wget -O - http://download.opensuse.org/repositories/isv:ownCloud:community/xUbuntu_14.04/Release.key | apt-key add -                    <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>     <span class="nb">echo</span> <span class="s1">&#39;deb http://download.opensuse.org/repositories/isv:/ownCloud:/community/xUbuntu_14.04/ /&#39;</span> &gt;&gt; /etc/apt/sources.list.d/owncloud.list <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Adding apt-cacher-ng proxy`                                                                                                           &amp;&amp; \</span>
</span><span class='line'>     <span class="nb">echo</span> <span class="s1">&#39;Acquire::http { Proxy &quot;http://172.17.42.1:3142&quot;; };&#39;</span> &gt; /etc/apt/apt.conf.d/01proxy                                                <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Updating Package List`                                                                                                                &amp;&amp; \</span>
</span><span class='line'>     apt-get update                                                                                                                          <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Installing packages`                                                                                                                  &amp;&amp; \</span>
</span><span class='line'>     apt-get install -y --no-install-recommends owncloud                                                                                     <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Cleaning up after installation`                                                                                                       &amp;&amp; \</span>
</span><span class='line'>     apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*                                                                          <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Removing apt-cacher-ng proxy`                                                                                                         &amp;&amp; \</span>
</span><span class='line'>     rm -f /etc/apt/apt.conf.d/01proxy                                                                                                       <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Enable SSL`                                                                                                                           &amp;&amp; \</span>
</span><span class='line'>     a2enmod ssl <span class="o">&amp;&amp;</span> a2ensite default-ssl                                                                                                     <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Enable service on startup`                                                                                                            &amp;&amp; \</span>
</span><span class='line'>     sed -i <span class="s2">&quot;s@exit 0@service apache2 start@g&quot;</span> /etc/rc.local                                                                                 <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Fixing permission errors for volume`                                                                                                  &amp;&amp; \</span>
</span><span class='line'>     chown -R www-data:www-data /var/www/owncloud                                                                                            <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                                                                <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Fixing permission errors for volume`                                                                                                  &amp;&amp; \</span>
</span><span class='line'>     chown -R www-data:www-data /mnt
</span><span class='line'>
</span><span class='line'>VOLUME /var/www/owncloud
</span><span class='line'>VOLUME /mnt
</span><span class='line'>
</span><span class='line'>ENTRYPOINT <span class="o">[</span><span class="s2">&quot;/sbin/my_init&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h5>Specific Version</h5>

<p>Dockerfile.yml:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">User</span>   <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">www-data</span>
</span><span class='line'><span class="l-Scalar-Plain">Service</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">apache2</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Install</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">owncloud_8.1.3-13.1_all.deb</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">owncloud-server_8.1.3-13.1_all.deb</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">owncloud-config-apache_8.1.3-13.1_all.deb</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Run</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
</span><span class='line'> <span class="no"># Enable SSL</span>
</span><span class='line'> <span class="no">a2enmod ssl &amp;&amp; a2ensite default-ssl</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Expose</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">443</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Volumes</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/var/www/owncloud</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">/mnt</span>
</span></code></pre></td></tr></table></div></figure>


<p>Generated Dockerfile:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'>FROM phusion/baseimage:0.9.16
</span><span class='line'>MAINTAINER Joe Ruether
</span><span class='line'>
</span><span class='line'>EXPOSE 443
</span><span class='line'>
</span><span class='line'>RUN <span class="sb">`</span><span class="c"># Adding apt-cacher-ng proxy`                                                            &amp;&amp; \</span>
</span><span class='line'>     <span class="nb">echo</span> <span class="s1">&#39;Acquire::http { Proxy &quot;http://172.17.42.1:3142&quot;; };&#39;</span> &gt; /etc/apt/apt.conf.d/01proxy <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Updating Package List`                                                                 &amp;&amp; \</span>
</span><span class='line'>     apt-get update                                                                           <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Installing packages`                                                                   &amp;&amp; \</span>
</span><span class='line'>     apt-get install -y --no-install-recommends wget                                          <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Installing deb package`                                                                &amp;&amp; \</span>
</span><span class='line'>     wget http://192.168.1.106:8888/owncloud_8.1.3-13.1_all.deb                               <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>     <span class="o">(</span>dpkg -i owncloud_8.1.3-13.1_all.deb <span class="o">||</span> <span class="nb">true</span><span class="o">)</span>                                            <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Installing deb package`                                                                &amp;&amp; \</span>
</span><span class='line'>     wget http://192.168.1.106:8888/owncloud-server_8.1.3-13.1_all.deb                        <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>     <span class="o">(</span>dpkg -i owncloud-server_8.1.3-13.1_all.deb <span class="o">||</span> <span class="nb">true</span><span class="o">)</span>                                     <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Installing deb package`                                                                &amp;&amp; \</span>
</span><span class='line'>     wget http://192.168.1.106:8888/owncloud-config-apache_8.1.3-13.1_all.deb                 <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>     <span class="o">(</span>dpkg -i owncloud-config-apache_8.1.3-13.1_all.deb <span class="o">||</span> <span class="nb">true</span><span class="o">)</span>                              <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Installing deb package dependencies`                                                   &amp;&amp; \</span>
</span><span class='line'>     apt-get -y -f install --no-install-recommends                                            <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Removing temporary files`                                                              &amp;&amp; \</span>
</span><span class='line'>     rm -f owncloud_8.1.3-13.1_all.deb                                                        <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>     rm -f owncloud-server_8.1.3-13.1_all.deb                                                 <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>     rm -f owncloud-config-apache_8.1.3-13.1_all.deb                                          <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Cleaning up after installation`                                                        &amp;&amp; \</span>
</span><span class='line'>     apt-get clean <span class="o">&amp;&amp;</span> rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*                           <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Removing apt-cacher-ng proxy`                                                          &amp;&amp; \</span>
</span><span class='line'>     rm -f /etc/apt/apt.conf.d/01proxy                                                        <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Enable SSL`                                                                            &amp;&amp; \</span>
</span><span class='line'>     a2enmod ssl <span class="o">&amp;&amp;</span> a2ensite default-ssl                                                      <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Enable service on startup`                                                             &amp;&amp; \</span>
</span><span class='line'>     sed -i <span class="s2">&quot;s@exit 0@service apache2 start@g&quot;</span> /etc/rc.local                                  <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Fixing permission errors for volume`                                                   &amp;&amp; \</span>
</span><span class='line'>     chown -R www-data:www-data /var/www/owncloud                                             <span class="o">&amp;&amp;</span> <span class="se">\</span>
</span><span class='line'>                                                                                                 <span class="se">\</span>
</span><span class='line'>    <span class="sb">`</span><span class="c"># Fixing permission errors for volume`                                                   &amp;&amp; \</span>
</span><span class='line'>     chown -R www-data:www-data /mnt
</span><span class='line'>
</span><span class='line'>VOLUME /var/www/owncloud
</span><span class='line'>VOLUME /mnt
</span><span class='line'>
</span><span class='line'>ENTRYPOINT <span class="o">[</span><span class="s2">&quot;/sbin/my_init&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, this script is pretty handy for quickly creating Docker images that are consistent and readable while maintaining a small image size.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/09/17/screenshots-in-qubes/">Screenshots in Qubes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-09-17T18:51:55-04:00" pubdate data-updated="true">Sep 17<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/09/17/screenshots-in-qubes/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/09/17/screenshots-in-qubes/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One of the security concepts of Qubes is that all work is done in separate VMs. The &ldquo;admin console&rdquo; for the Xen hypervisor is known as <code>dom0</code> and is responsible for managing the desktop environment. <code>dom0</code> is never supposed to interact with the other VMs, usb devices, or the network.</p>

<p>However, when taking a screenshot, they are inevitably stored inside <code>dom0</code>. What can be done about this?</p>

<p>Laurent Ghugonis<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> shared a very handy script for taking a screenshot and sending it to a VM<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>. You can find that script below. I have a few minor edits, but Laurent gets all the credit:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Take screenshot(s) in Qubes Dom0 and copy to AppVM</span>
</span><span class='line'><span class="c"># Dependencies: scrot (sudo qubes-dom0-update scrot)</span>
</span><span class='line'><span class="c"># My KDE shortcuts:</span>
</span><span class='line'><span class="c"># Meta-C       : qvm-screenshot.sh -s -n</span>
</span><span class='line'><span class="c"># Meta-Shift-C : qvm-screenshot.sh -s -n -m</span>
</span><span class='line'><span class="c"># Meta-Alt-C   : qvm-screenshot.sh -s -q</span>
</span><span class='line'><span class="c"># 2013, Laurent Ghigonis &lt;laurent@p1sec.com&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Modified 2015, Joe Ruether &lt;jrruethe@gmail.com&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nv">DOM0_SHOTS_DIR</span><span class="o">=</span><span class="nv">$HOME</span>/Pictures
</span><span class='line'><span class="nv">APPVM_SHOTS_DIR</span><span class="o">=</span>/home/user/Pictures
</span><span class='line'><span class="nv">QUBES_DOM0_APPVMS</span><span class="o">=</span>/var/lib/qubes/appvms/
</span><span class='line'>
</span><span class='line'>usage<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>   <span class="nb">echo</span> <span class="s2">&quot;$program [-hlmqs]&quot;</span>
</span><span class='line'>   <span class="nb">echo</span> -e <span class="s2">&quot;\t-m : take multiple shots&quot;</span>
</span><span class='line'>   <span class="nb">echo</span> -e <span class="s2">&quot;\t-n : after screenshot, run nautilus in AppVM&quot;</span>
</span><span class='line'>   <span class="nb">echo</span> -e <span class="s2">&quot;\t-q : only take screenshot, no blabla&quot;</span>
</span><span class='line'>   <span class="nb">echo</span> -e <span class="s2">&quot;\t-s : select window&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="nv">program</span><span class="o">=</span><span class="s2">&quot;`basename $0`&quot;</span>
</span><span class='line'><span class="nv">mode_multi</span><span class="o">=</span>0
</span><span class='line'><span class="nv">mode_nautilus</span><span class="o">=</span>0
</span><span class='line'><span class="nv">mode_select</span><span class="o">=</span>0
</span><span class='line'><span class="nv">opts</span><span class="o">=</span><span class="s2">&quot;$(getopt -o hmnqs -n &quot;</span><span class="nv">$program</span><span class="s2">&quot; -- &quot;</span><span class="nv">$@</span><span class="s2">&quot;)&quot;</span>
</span><span class='line'><span class="nv">err</span><span class="o">=</span><span class="nv">$?</span>
</span><span class='line'><span class="nb">eval set</span> -- <span class="s2">&quot;$opts&quot;</span>
</span><span class='line'><span class="k">while </span><span class="nb">true</span>; <span class="k">do case</span> <span class="nv">$1</span> in
</span><span class='line'>   -h<span class="o">)</span> usage; <span class="nb">exit </span>1 ;;
</span><span class='line'>   -q<span class="o">)</span> <span class="nv">mode_quick</span><span class="o">=</span>1; <span class="nb">shift</span> ;;
</span><span class='line'>   -m<span class="o">)</span> <span class="nv">mode_multi</span><span class="o">=</span>1; <span class="nb">shift</span> ;;
</span><span class='line'>   -n<span class="o">)</span> <span class="nv">mode_nautilus</span><span class="o">=</span>1; <span class="nb">shift</span> ;;
</span><span class='line'>   -s<span class="o">)</span> <span class="nv">mode_select</span><span class="o">=</span>1; <span class="nb">shift</span> ;;
</span><span class='line'>   --<span class="o">)</span> <span class="nb">shift</span>; <span class="nb">break</span> ;;
</span><span class='line'><span class="k">esac done</span>
</span><span class='line'><span class="o">[[</span> <span class="nv">$err</span> -ne 0 <span class="o">]]</span> <span class="o">&amp;&amp;</span> usage <span class="o">&amp;&amp;</span> <span class="nb">exit </span>1
</span><span class='line'>
</span><span class='line'><span class="nv">shotslist</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
</span><span class='line'>mkdir -p <span class="nv">$DOM0_SHOTS_DIR</span> <span class="o">||</span><span class="nb">exit </span>1
</span><span class='line'><span class="k">while </span><span class="nb">true</span>; <span class="k">do</span>
</span><span class='line'><span class="k">   </span><span class="nv">d</span><span class="o">=</span><span class="sb">`</span>date +<span class="s2">&quot;%Y%m%d%H%M%S&quot;</span><span class="sb">`</span>
</span><span class='line'>   <span class="nv">shotname</span><span class="o">=</span><span class="nv">$d</span>.png
</span><span class='line'>   <span class="k">if</span> <span class="o">[</span> <span class="nv">$mode_select</span> -eq 1 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;[-] making shot, click on a window&quot;</span>
</span><span class='line'>      scrot <span class="nv">$@</span> -s -b <span class="nv">$DOM0_SHOTS_DIR</span>/<span class="nv">$shotname</span> <span class="o">||</span><span class="nb">break</span>
</span><span class='line'><span class="nb">   </span><span class="k">else</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;[-] making shot of root window&quot;</span>
</span><span class='line'>      scrot <span class="nv">$@</span> <span class="nv">$DOM0_SHOTS_DIR</span>/<span class="nv">$shotname</span> <span class="o">||</span><span class="nb">break</span>
</span><span class='line'><span class="nb">   </span><span class="k">fi</span>
</span><span class='line'>   <span class="o">[[</span> <span class="nv">$mode_quick</span> -eq 1 <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nb">exit </span>1
</span><span class='line'>
</span><span class='line'>   <span class="nb">echo</span> <span class="s2">&quot;[-] saving $DOM0_SHOTS_DIR/$shotname&quot;</span>
</span><span class='line'>   mv <span class="nv">$DOM0_SHOTS_DIR</span>/<span class="nv">$tmpname</span> <span class="nv">$DOM0_SHOTS_DIR</span>/<span class="nv">$shotname</span>
</span><span class='line'>
</span><span class='line'>   <span class="nv">shotslist</span><span class="o">=</span><span class="s2">&quot;${shotslist}${shotname}:&quot;</span>
</span><span class='line'>
</span><span class='line'>   <span class="o">[[</span> <span class="nv">$mode_multi</span> -eq 1 <span class="o">]]</span> <span class="o">&amp;&amp;</span> kdialog --yesno <span class="s2">&quot;Other shot ?&quot;</span> <span class="o">||</span> <span class="nb">break</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="nv">choice</span><span class="o">=</span><span class="sb">`</span>ls <span class="nv">$QUBES_DOM0_APPVMS</span> |sed <span class="s1">&#39;s/\([^ ]*\)/\1 \1/g&#39;</span><span class="sb">`</span>
</span><span class='line'><span class="nv">appvm</span><span class="o">=</span><span class="sb">`</span>kdialog --menu <span class="s2">&quot;Select destination AppVM&quot;</span> <span class="nv">$choice</span> --title <span class="s2">&quot;$program&quot;</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> X<span class="s2">&quot;$appvm&quot;</span> !<span class="o">=</span> X<span class="s2">&quot;&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   if</span> <span class="o">[</span> <span class="nv">$mode_nautilus</span> -eq 1 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;[-] running nautilus in AppVM&quot;</span>
</span><span class='line'>      qvm-run <span class="nv">$appvm</span> <span class="s2">&quot;nautilus $APPVM_SHOTS_DIR&quot;</span>
</span><span class='line'>   <span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;[-] copy to AppVM $appvm&quot;</span>
</span><span class='line'>   qvm-run <span class="nv">$appvm</span> <span class="s2">&quot;mkdir -p $APPVM_SHOTS_DIR&quot;</span>
</span><span class='line'>   <span class="nv">IFS</span><span class="o">=</span><span class="s2">&quot;:&quot;</span>; <span class="k">for </span>shot in <span class="nv">$shotslist</span>; <span class="k">do</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;[-] copying $APPVM_SHOTS_DIR/$shot&quot;</span>
</span><span class='line'>      cat <span class="nv">$DOM0_SHOTS_DIR</span>/<span class="nv">$shot</span> <span class="se">\</span>
</span><span class='line'>         |qvm-run --pass-io <span class="nv">$appvm</span> <span class="s2">&quot;cat &gt; $APPVM_SHOTS_DIR/$shot&quot;</span>
</span><span class='line'>      rm -f <span class="nv">$DOM0_SHOTS_DIR</span>/<span class="nv">$shot</span>
</span><span class='line'>   <span class="k">done</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;no AppVM name provided&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;[*] done&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Save this script in the home directory of <code>dom0</code> as <code>qvm-screenshot.sh</code>. You can run the following commands in a <code>dom0</code> terminal, assuming the script was downloaded inside a VM named <code>Work</code>:</p>

<pre><code>qvm-run --pass-io Work 'cat ~/Downloads/qvm-screenshot.sh' &gt; ~/qvm-screenshot.sh
chmod 755 ~/qvm-screenshot.sh
</code></pre>

<p>Next, open up Start &ndash;> System Tools &ndash;> System Settings, and select &ldquo;Shortcuts and Gestures&rdquo;</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/09/17/screenshots-in-qubes/01.png"></p>

<p>I use &ldquo;Print Screen&rdquo; and &ldquo;Print Window&rdquo;, tied to the <code>PrtSc</code> and <code>Ctrl+PrtSc</code> keys respectively. Print Screen simply takes a screenshot of the entire desktop, while Print Window only captures the window that is clicked on after the keypress. You can see my setup at the bottom of this post.</p>

<p>Activating the keypress will yield the following window:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/09/17/screenshots-in-qubes/02.png"></p>

<p>Simply select the VM you want the screenshot saved to, and it will appear in that VM&rsquo;s Pictures folder.</p>

<p>Also, if you are interested, Laurent also shared a script for recording video of the desktop<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/09/17/screenshots-in-qubes/03.png">
<img class="center" src="http://jrruethe.github.io/blog/2015/09/17/screenshots-in-qubes/04.png">
<img class="center" src="http://jrruethe.github.io/blog/2015/09/17/screenshots-in-qubes/05.png">
<img class="center" src="http://jrruethe.github.io/blog/2015/09/17/screenshots-in-qubes/06.png"></p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="https://groups.google.com/forum/#!msg/qubes-devel/CwSPqtPYTRQ/7Dp7Tw28adUJ">https://groups.google.com/forum/#!msg/qubes-devel/CwSPqtPYTRQ/7Dp7Tw28adUJ</a><a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="http://git.zx2c4.com/laurent-tools/tree/tools/qvm-screenshot.sh">http://git.zx2c4.com/laurent-tools/tree/tools/qvm-screenshot.sh</a><a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p><a href="http://git.zx2c4.com/laurent-tools/tree/tools/qvm-screenrecord.sh">http://git.zx2c4.com/laurent-tools/tree/tools/qvm-screenrecord.sh</a><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <img class="center borderless" src="/blog/contact/avatar.png" width="128" height="128">
  <h1>Contact</h1>
  <p>
  <a href="mailto:jrruethe@gmail.com">jrruethe@gmail.com</a><br>
  <a href="https://keybase.io/jrruethe">keybase.io/jrruethe</a><br>
  <a href="https://onename.io/jrruethe">onename.io/jrruethe</a><br>
  <br>Public Key:<br>
  <a href="http://jrruethe.github.io/downloads/code/jrruethe-public.asc">4F40 99F8 276B DBA5 475A<br>8446 4630 BEDC 40B9 35FE</a>
  </p>
</section>
<section>
<a href="https://twitter.com/jrruethe" class="twitter-follow-button" data-show-count="true">Follow @jrruethe</a><br>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jrruethe.github.io/index.html" data-via="jrruethe" data-counturl="http://jrruethe.github.io/index.html" >Tweet</a>
</section>
<section>
<h1>Link to this page</h1>
<br>
<center>
<a href="http://jrruethe.github.io/index.html"><img src="http://chart.apis.google.com/chart?chs=150x150&cht=qr&chld=|0&chco=000000&chl=http://jrruethe.github.io/index.html" alt="post-qrcode"></a>
</center>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2016/01/12/bitcoin-donation-proofs/">Bitcoin Donation Proofs</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/12/04/bitcoin-donations/">Bitcoin Donations</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/26/object-pool/">Object Pool</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/25/memory-blocks/">Memory Blocks</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/11/24/google-test/">Google Test</a>
      </li>
    
  </ul>
</section>
<section>
   <h1>Related Posts</h1>
   <ul class="posts">
   
   </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jrruethe">@jrruethe</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jrruethe',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
	<h1>Bitcoin Donations</h1>
	<br>
	<center>
	<a href="bitcoin:187gRAhdyD2KaAhMND92RQMqQQMQtW678m"><img src="http://blockchain.info/qr?data=187gRAhdyD2KaAhMND92RQMqQQMQtW678m&size=150" alt="Bitcoin"></a><br>
	<a class="small, monospace" href="bitcoin:187gRAhdyD2KaAhMND92RQMqQQMQtW678m">187gRAhdyD2KaAhMN</a><br>
	<a class="small, monospace" href="bitcoin:187gRAhdyD2KaAhMND92RQMqQQMQtW678m">D92RQMqQQMQtW678m</a>
	<br>
	<a href="/downloads/code/bitcoin.txt.asc">Proof</a>
	<br><br>
   <div id="coindesk-widget" data-align="center"></div>
   <script type="text/javascript" src="//widget.coindesk.com/bpiticker/coindesk-widget.min.js?aa4aca"></script>
	</center>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  <span class="license">
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
   - Copyright &copy; 2016 - Joe Ruether - All rights reserved with the following exceptions:
  <br>
   - All embedded code on this page licensed under
    <a href="/blog/downloads/code/gpl-3.0.txt">GPLv3</a>
    or a later version unless otherwise noted
  <br>
   - All non-code text/image content on this page licensed under
    <a href="/blog/downloads/code/cc-by-nc-sa-4.0.txt">CC BY-NC-SA 4.0</a>
    or a later version unless otherwise noted
  </span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jrruethe';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
