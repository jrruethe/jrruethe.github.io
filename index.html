
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Morning Musings</title>
  <meta name="author" content="Joe Ruether">

  
  <meta name="description" content="Generally, in C++ there are three places you can store your data: On the stack (local variables)
On the heap (new / delete)
In the static data &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jrruethe.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Morning Musings" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
  jQuery.noConflict();
  var rootUrl = "";
</script>
<script src="/javascripts/openlayers/OpenLayers.js" type="text/javascript"></script>
<script src="/javascripts/maps.js" type="text/javascript"></script>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Morning Musings</a></h1>
  
    <h2>I'm not ready to wake up yet...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jrruethe.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/about">About</a></li>
  <li><a href="/blog/license">License</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/23/placement-new/">Placement New, Memory Dumps, and Alignment</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-08-23T14:11:27-04:00" pubdate data-updated="true">Aug 23<span>rd</span>, 2015</time>
        
           | <a href="/blog/2015/08/23/placement-new/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/08/23/placement-new/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Generally, in C++ there are three places you can store your data:</p>

<ol>
<li>On the stack (local variables)</li>
<li>On the heap (new / delete)</li>
<li>In the static data section (static variables)</li>
</ol>


<p>Normally, when using the heap, you would use the following command:</p>

<pre><code>Foo* foo_ptr = new Foo();
</code></pre>

<p>This would invoke the following actions behind the scenes:</p>

<ol>
<li>Make an operating system call to allocate a chunk of memory of size <code>sizeof(Foo)</code></li>
<li>Manage that memory with the heap</li>
<li>Call the constructor of Foo to build an object at that memory location</li>
<li>Initialize <code>foo_ptr</code> with the address of the object</li>
</ol>


<p>Later on, you would call:</p>

<pre><code>delete foo_ptr;
</code></pre>

<p>This would:</p>

<ol>
<li>Call the destructor of Foo</li>
<li>Have the heap give the memory back to the operating system</li>
</ol>


<p>This is how <code>new</code> and <code>delete</code> work, and most C++ programmers should be familiar with them.</p>

<blockquote><p><strong>New and Malloc</strong><br/>
You should never <code>delete</code> memory allocated with <code>malloc</code>, and you should never <code>free</code> memory allocated with <code>new</code>. <code>malloc</code> and <code>free</code> do raw memory allocations, while <code>new</code> and <code>delete</code> are also responsible for calling constructors and destructors.</p></blockquote>

<h2>Placement New</h2>

<p>C++ offers a different &ldquo;flavor&rdquo; of <code>new</code> called &ldquo;placement new&rdquo;. Placement new gives the user finer control about where the object gets constructed by allowing the object to be &ldquo;placed&rdquo; at a specified memory address; in other words, the heap allocation step is bypassed.</p>

<p>Placement new has a few specialized uses. One is memory mapped I/O for embedded systems. This is used when an object must exist at a specific memory address in order for its members to be mapped to external sensors or control pins. Another use case is for memory pools, when the application is responsible for managing its memory instead of relying on the heap.</p>

<p>The syntax for placement new is:</p>

<pre><code>unsigned char memory[sizeof(Foo)];
Foo* foo_ptr = new (memory) Foo();
</code></pre>

<p>In this example, <code>Foo</code> was constructed into the <code>memory</code> on the stack, instead of on the heap. It is important to understand that using placement new requires the developer to do its own memory management. <code>memory</code> must be large enough to contain a <code>Foo</code>, and you should never call <code>delete</code> on the pointer returned by placement new.</p>

<blockquote><p><strong>Delete</strong><br/>
Remember that <code>delete</code> calls the destructor, and has the heap give memory back to the operating system. However, the <code>memory</code> here isn&rsquo;t on the heap! Calling <code>delete</code> on <code>foo_ptr</code> will cause a crash.</p></blockquote>

<p>If you think of placement new as simply a constructor call, then it follows that a &ldquo;placement delete&rdquo; would simply be a destructor call. And an explicit destructor call is exactly how to clean up after a placement new:</p>

<pre><code>foo_ptr-&gt;~Foo();
</code></pre>

<p>You must not forget this step; it isn&rsquo;t a memory leak, but it would be a resource leak.</p>

<p>Here is a more detailed (runnable) example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;new&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;cstdio&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Foo</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span> <span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Constructor&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="o">~</span><span class="n">Foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Destructor&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Increase scope</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Allocate memory on the stack</span>
</span><span class='line'>      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">memory</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Foo</span><span class="p">)];</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Construct a Foo inside that memory</span>
</span><span class='line'>      <span class="n">Foo</span><span class="o">*</span> <span class="n">foo_ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="n">Foo</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Show that the memory addresses are the same</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="p">);</span>
</span><span class='line'>      <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">foo_ptr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Call the destructor explicitly</span>
</span><span class='line'>      <span class="n">foo_ptr</span><span class="o">-&gt;~</span><span class="n">Foo</span><span class="p">();</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Memory has been deallocated from the stack</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This outputs:</p>

<pre><code>Constructor
0x00007FFFFFFFE280
0x00007FFFFFFFE280
Destructor
</code></pre>

<p>Note that the memory isn&rsquo;t required to be allocated on the stack; you can just as easily allocate the memory using malloc, and later deallocate the memory with free. In fact, you can think of the regular <code>new</code> call as performing the following actions:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;new&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;cstdio&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Foo</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span> <span class="n">value</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Constructor&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="o">~</span><span class="n">Foo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Destructor&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Allocate memory on the heap</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">memory</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Foo</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Construct a Foo inside that memory</span>
</span><span class='line'>   <span class="n">Foo</span><span class="o">*</span> <span class="n">foo_ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="n">Foo</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Show that the memory addresses are the same</span>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="p">);</span>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">foo_ptr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Call the destructor explicitly</span>
</span><span class='line'>   <span class="n">foo_ptr</span><span class="o">-&gt;~</span><span class="n">Foo</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Deallocate the memory from the heap</span>
</span><span class='line'>   <span class="k">delete</span> <span class="n">memory</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This outputs:</p>

<pre><code>Constructor
0x0000000000664370
0x0000000000664370
Destructor
</code></pre>

<h2>Dumping Memory</h2>

<p>As I said earlier, placement new requires the developer to manage their own memory even more than usual. When working with memory on a low level like this, it becomes very useful to see a hex dump similar to the one created by GDB. With some inspiration<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, I created a function that would pretty-print memory to an output stream:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">void</span> <span class="n">dump_memory</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
</span><span class='line'>                 <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">uint</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Allow direct arithmetic on the pointer</span>
</span><span class='line'>   <span class="n">uint</span> <span class="n">iptr</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">uint</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;-----------------------------------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;%d bytes&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Get number of digits</span>
</span><span class='line'>   <span class="n">uint</span> <span class="n">indent</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">log10</span><span class="p">(</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Write the address offsets along the top row</span>
</span><span class='line'>   <span class="c1">// Account for the indent of &quot;X bytes&quot;</span>
</span><span class='line'>   <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">(</span><span class="mi">13</span> <span class="o">-</span> <span class="n">indent</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">);</span>
</span><span class='line'>   <span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span>  <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span><span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;}</span>        <span class="c1">// Spaces between every 4 bytes</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot; %2hhX&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">i</span><span class="p">;</span> <span class="c1">// Write the address offset</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// If the object is not aligned</span>
</span><span class='line'>   <span class="k">if</span><span class="p">(</span><span class="n">iptr</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Print the first address</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">0x%016lX:&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">iptr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Indent to the offset</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">iptr</span> <span class="o">%</span> <span class="mi">16</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;   &quot;</span><span class="p">;</span>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span><span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Dump the memory</span>
</span><span class='line'>   <span class="k">for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">iptr</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// New line and address every 16 bytes, spaces every 4 bytes</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">iptr</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span><span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">0x%016lX:&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="n">iptr</span><span class="p">;}</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">iptr</span> <span class="o">%</span>  <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">){</span><span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span><span class="p">;}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Write the address contents</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&quot; %02hhX&quot;</span><span class="p">)</span>
</span><span class='line'>            <span class="o">%</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">uint</span><span class="o">&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">byte</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">iptr</span><span class="p">));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">-----------------------------------------------------------------------&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is an example of how to use it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">Test</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">char</span>  <span class="n">a</span><span class="p">;</span> <span class="c1">// 1 byte</span>
</span><span class='line'>   <span class="kt">int</span>   <span class="n">b</span><span class="p">;</span> <span class="c1">// 4 bytes</span>
</span><span class='line'>   <span class="kt">short</span> <span class="n">c</span><span class="p">;</span> <span class="c1">// 2 bytes</span>
</span><span class='line'>   <span class="kt">long</span>  <span class="n">d</span><span class="p">;</span> <span class="c1">// 8 bytes</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Test</span><span class="p">()</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">a</span><span class="p">(</span><span class="mh">0x11</span><span class="p">),</span>
</span><span class='line'>      <span class="n">b</span><span class="p">(</span><span class="mh">0x22222222</span><span class="p">),</span>
</span><span class='line'>      <span class="n">c</span><span class="p">(</span><span class="mh">0x3333</span><span class="p">),</span>
</span><span class='line'>      <span class="n">d</span><span class="p">(</span><span class="mh">0x4444444444444444</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">memory</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">Test</span><span class="p">)];</span>
</span><span class='line'>   <span class="n">Test</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">memory</span><span class="p">)</span> <span class="n">Test</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">dump_memory</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Test</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">ptr</span><span class="o">-&gt;~</span><span class="n">Test</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And here is the output:</p>

<pre><code>-----------------------------------------------------------------------
24 bytes              0  1  2  3   4  5  6  7   8  9  A  B   C  D  E  F
0x00007FFFFFFFE270:  11 FF FF FF  22 22 22 22  33 33 00 00  00 00 00 00
0x00007FFFFFFFE280:  44 44 44 44  44 44 44 44
-----------------------------------------------------------------------
</code></pre>

<blockquote><p><strong>Padding</strong><br/>
If you are surprised by the output above, you may not be aware of padding. The compiler will add padding bytes between members in a structure to ensure that each member starts on a proper byte boundary. This means structures may take up more space than if they were packed tightly.</p>

<p>Primitive types in a structure will be padded such that they are aligned on byte boundaries that match their size<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup>:</p>

<ul>
<li>A char (one byte) will be 1-byte aligned.</li>
<li>A short (two bytes) will be 2-byte aligned.</li>
<li>An int (four bytes) will be 4-byte aligned.</li>
<li>A long (eight bytes) will be 8-byte aligned.</li>
<li>A float (four bytes) will be 4-byte aligned.</li>
<li>A double (eight bytes) will be 8-byte aligned.</li>
</ul>
</blockquote>

<p>When working with memory pools, the allocated memory will typically be larger than the object itself. It becomes useful to &ldquo;mark&rdquo; the memory with special byte patterns for ease of debugging. I like to use:</p>

<ul>
<li>0xCC for &ldquo;Clear&rdquo;</li>
<li>0xAA for &ldquo;Allocated&rdquo;</li>
<li>0xDD for &ldquo;Deallocated&rdquo;</li>
</ul>


<p>For example, lets allocate more memory than we need, and construct the object in the middle of the array. The markers will indicate what is happening:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Get the size of our structure</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Test</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Reserve more memory than we need</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">memory</span><span class="p">[</span><span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Fill that memory up with &quot;C&quot; for &quot;Cleared&quot;</span>
</span><span class='line'>   <span class="n">memset</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Determine where to construct the object</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Mark that area as &quot;Allocated&quot;</span>
</span><span class='line'>   <span class="n">memset</span><span class="p">(</span><span class="n">memory</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Construct an object offset into memory</span>
</span><span class='line'>   <span class="n">Test</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">memory</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="n">Test</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Lets see what it looks like</span>
</span><span class='line'>   <span class="n">dump_memory</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Test</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Destroy the object</span>
</span><span class='line'>   <span class="n">ptr</span><span class="o">-&gt;~</span><span class="n">Test</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Outputs:</p>

<pre><code>-----------------------------------------------------------------------
24 bytes              0  1  2  3   4  5  6  7   8  9  A  B   C  D  E  F
0x00007FFFFFFFE220:                                         11 AA AA AA
0x00007FFFFFFFE230:  22 22 22 22  33 33 AA AA  AA AA AA AA  44 44 44 44
0x00007FFFFFFFE240:  44 44 44 44
-----------------------------------------------------------------------
</code></pre>

<p>A couple things to notice here:</p>

<ul>
<li>Only the memory for the object is printed, that is why we don&rsquo;t see any <code>0xCC</code></li>
<li>The object was offset 12 bytes into the memory</li>
<li>The padding bytes are filled with <code>0xAA</code> as expected</li>
</ul>


<p>It would be kind of nice to see the memory around the object, to give us some context. One solution is to dump the <code>memory</code> variable instead of the <code>ptr</code> variable, but with large memory pools this can be too much to look at. Instead, lets just print some additional local context:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number marked'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">void</span> <span class="n">dump_memory_with_context</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&amp;</span> <span class="n">os</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Allow direct arithmetic on the pointer</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sptr</span> <span class="o">=</span> <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span> <span class="c1">// Start pointer</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">eptr</span> <span class="o">=</span> <span class="n">sptr</span> <span class="o">+</span> <span class="n">size</span><span class="p">;</span>                          <span class="c1">// End pointer</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">sptr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span> <span class="c1">// Round down to the last multiple of 16</span>
</span><span class='line'>   <span class="n">sptr</span> <span class="o">-=</span>  <span class="mi">16</span><span class="p">;</span> <span class="c1">// Step back one line for context</span>
</span><span class='line'>   <span class="n">eptr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span> <span class="c1">// Round down to the last multiple of 16</span>
</span><span class='line'>   <span class="n">eptr</span> <span class="o">+=</span>  <span class="mi">32</span><span class="p">;</span> <span class="c1">// Step forward one line for context</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Dump memory</span>
</span><span class='line'>   <span class="n">dump_memory</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">sptr</span><span class="p">),</span> <span class="n">eptr</span> <span class="o">-</span> <span class="n">sptr</span><span class="p">,</span> <span class="n">os</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Get the size of our structure</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Test</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Reserve more memory than we need</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">memory</span><span class="p">[</span><span class="n">size</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Fill that memory up with &quot;C&quot; for &quot;Cleared&quot;</span>
</span><span class='line'>   <span class="n">memset</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Determine where to construct the object</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">size</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Mark that area as &quot;Allocated&quot;</span>
</span><span class='line'>   <span class="n">memset</span><span class="p">(</span><span class="n">memory</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Construct an object offset into memory</span>
</span><span class='line'>   <span class="n">Test</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">memory</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="n">Test</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Lets see what it looks like</span>
</span><span class='line marked start end'>   <span class="n">dump_memory_with_context</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Test</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Destroy the object</span>
</span><span class='line'>   <span class="n">ptr</span><span class="o">-&gt;~</span><span class="n">Test</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we get:</p>

<pre><code>-----------------------------------------------------------------------
80 bytes              0  1  2  3   4  5  6  7   8  9  A  B   C  D  E  F
0x00007FFFFFFFE210:  A0 E2 FF FF  FF 7F 00 00  6C 6B 40 00  00 00 00 00
0x00007FFFFFFFE220:  CC CC CC CC  CC CC CC CC  CC CC CC CC  11 AA AA AA
0x00007FFFFFFFE230:  22 22 22 22  33 33 AA AA  AA AA AA AA  44 44 44 44
0x00007FFFFFFFE240:  44 44 44 44  CC CC CC CC  CC CC CC CC  CC CC CC CC
0x00007FFFFFFFE250:  88 E3 FF FF  FF 7F 00 00  75 94 42 00  01 00 00 00
-----------------------------------------------------------------------
</code></pre>

<p>This shows a local context memory dump that includes our object and the memory around it. Our markers can be clearly seen, as well as the object itself. In addition, we see some other garbage from the stack.</p>

<h2>Alignment</h2>

<p>In the last section, we constructed an object offset into our memory area, and the result was misaligned in the stack. This situation is not ideal.</p>

<p>Memory alignment is important because while programmers think in terms of bytes, CPUs think in terms of words. On a 64-bit system, this means the CPU will load 8 bytes at a time from memory. If you have an unaligned member that straddles two words, the CPU needs to make twice as many memory accesses as it would have if the memory was properly aligned.<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup></p>

<p>GCC will typically handle memory alignment for you when allocating from the heap, but in the case of a memory pool it is up to the developer to handle it properly. There are two rules to follow when aligning memory addresses:</p>

<ul>
<li>The alignment boundary must be greater or equal to the size of a pointer</li>
<li>The alignment boundary must be a power of 2</li>
</ul>


<p>One fast and generic method for aligning memory is to allocate a little bit more than needed in order to get to the next boundary, then store the original pointer in the space that was skipped over. It is important to keep the original pointer around because it will be needed when it is time to free that memory.</p>

<p>Below is a modification of an alignment algorithm found in the Eigen<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup> library. The following enhancements were made:</p>

<ul>
<li>Allow for user specified alignment</li>
<li>Add compile time checks for alignment rules</li>
<li>Provide a method for accessing the unaligned pointer</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/mpl/assert.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/int.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/comparison.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/bitwise.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/arithmetic.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Alignment</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// If an alignment is specified, it must be greater than or equal to</span>
</span><span class='line'>   <span class="c1">// the size of a pointer.</span>
</span><span class='line'>   <span class="n">BOOST_MPL_ASSERT</span><span class="p">((</span>
</span><span class='line'>      <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">greater_equal</span><span class="o">&lt;</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="n">bytes</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&gt;</span>
</span><span class='line'>   <span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// The alignment bytes must be a power of two</span>
</span><span class='line'>   <span class="c1">// (n &amp; (n-1)) == 0</span>
</span><span class='line'>   <span class="n">BOOST_MPL_ASSERT</span><span class="p">((</span>
</span><span class='line'>      <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">equal_to</span><span class="o">&lt;</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">bitand_</span><span class="o">&lt;</span>
</span><span class='line'>            <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="n">bytes</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>            <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">minus</span><span class="o">&lt;</span>
</span><span class='line'>               <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="n">bytes</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>               <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span>
</span><span class='line'>            <span class="o">&gt;</span>
</span><span class='line'>         <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">&gt;</span>
</span><span class='line'>   <span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// In order for this to work, must allocate additional bytes</span>
</span><span class='line'>   <span class="k">enum</span><span class="p">{</span><span class="n">alignment</span> <span class="o">=</span> <span class="n">bytes</span><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Return an aligned pointer</span>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="n">align</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Round down to the previous multiple of X,</span>
</span><span class='line'>      <span class="c1">// then move to the next multiple of X.</span>
</span><span class='line'>      <span class="kt">void</span><span class="o">*</span> <span class="n">aligned_ptr</span> <span class="o">=</span>
</span><span class='line'>         <span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span>
</span><span class='line'>            <span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
</span><span class='line'>               <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span><span class="p">(</span><span class="n">alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span>
</span><span class='line'>            <span class="o">+</span> <span class="n">alignment</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Save the original pointer in the space we skipped over</span>
</span><span class='line'>      <span class="o">*</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">**&gt;</span><span class="p">(</span><span class="n">aligned_ptr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">aligned_ptr</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Retrieve the original pointer</span>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="n">unalign</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">**&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Specialize to not attempt alignment</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Alignment</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">enum</span><span class="p">{</span><span class="n">alignment</span> <span class="o">=</span> <span class="mi">0</span><span class="p">};</span>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="n">align</span>  <span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">){</span><span class="k">return</span> <span class="n">ptr</span><span class="p">;}</span>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span><span class="o">*</span> <span class="n">unalign</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">){</span><span class="k">return</span> <span class="n">ptr</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using it is simple: Any pointer can be aligned, and any aligned pointer can be unaligned. However, it is important to remember that extra space must be allocated before attempting to align the pointer. The following example will show how to align a structure on a 16 byte boundary:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Get the size of our structure</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Test</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Purposely offset the object by 8 bytes</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Reserve size for our structure</span>
</span><span class='line'>   <span class="c1">// plus alignment overhead</span>
</span><span class='line'>   <span class="c1">// plus our test offset</span>
</span><span class='line'>   <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">memory</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="n">Alignment</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;::</span><span class="n">alignment</span> <span class="o">+</span> <span class="n">offset</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Print out the address of the malloc&#39;d memory pointer</span>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Memory:          0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">memory</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Fill that memory up with &quot;C&quot; for &quot;Cleared&quot;</span>
</span><span class='line'>   <span class="n">memset</span><span class="p">(</span><span class="n">memory</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">memory</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Mark the object area as &quot;Allocated&quot;</span>
</span><span class='line'>   <span class="n">memset</span><span class="p">(</span><span class="n">memory</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="n">Alignment</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;::</span><span class="n">alignment</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Print out the address of where we will construct the object</span>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Memory + Offset: 0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">memory</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Construct an object offset into memory,</span>
</span><span class='line'>   <span class="c1">// but use pointer alignment to realign it</span>
</span><span class='line'>   <span class="n">Test</span><span class="o">*</span> <span class="n">ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="p">(</span><span class="n">Alignment</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;::</span><span class="n">align</span><span class="p">(</span><span class="n">memory</span> <span class="o">+</span> <span class="n">offset</span><span class="p">))</span> <span class="n">Test</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Print out the address of the aligned pointer</span>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Ptr:             0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Print out the address of the unaligned pointer</span>
</span><span class='line'>   <span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unaligned Ptr:   0x%016lX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Alignment</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;::</span><span class="n">unalign</span><span class="p">(</span><span class="n">ptr</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Lets see what it looks like</span>
</span><span class='line'>   <span class="n">dump_memory_with_context</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Test</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Destroy the object</span>
</span><span class='line'>   <span class="n">ptr</span><span class="o">-&gt;~</span><span class="n">Test</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Unalign the aligned pointer to get the original pointer back</span>
</span><span class='line'>   <span class="c1">// then remove the offset to properly free</span>
</span><span class='line'>   <span class="n">free</span><span class="p">(</span><span class="n">Alignment</span><span class="o">&lt;</span><span class="mi">16</span><span class="o">&gt;::</span><span class="n">unalign</span><span class="p">(</span><span class="n">ptr</span><span class="p">)</span> <span class="o">-</span> <span class="n">offset</span><span class="p">);</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This outputs:</p>

<pre><code>Memory:          0x00000000006648F0
Memory + Offset: 0x00000000006648F8
Ptr:             0x0000000000664900
Unaligned Ptr:   0x00000000006648F8
-----------------------------------------------------------------------
64 bytes              0  1  2  3   4  5  6  7   8  9  A  B   C  D  E  F
0x00000000006648F0:  CC CC CC CC  CC CC CC CC  F8 48 66 00  00 00 00 00
0x0000000000664900:  11 AA AA AA  22 22 22 22  33 33 AA AA  AA AA AA AA
0x0000000000664910:  44 44 44 44  44 44 44 44  AA AA AA AA  AA AA AA AA
0x0000000000664920:  4B 00 00 00  00 00 00 00  31 00 00 00  00 00 00 00
-----------------------------------------------------------------------
</code></pre>

<p>So what happened here? Here is the output color-coded:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/08/23/placement-new/01.png"></p>

<ul>
<li>Red: The debug markers</li>
<li>Orange: The 16-byte aligned pointer address</li>
<li>Yellow: The test object</li>
<li>Green: The original unaligned / offset pointer address</li>
<li>Blue: The beginning of the memory</li>
</ul>


<p>Now, remember that we offset the object 8 bytes into the beginning of the memory, which would be <code>0x006648F8</code>. The object was then aligned to the next 16-byte boundary, starting at <code>0x00664900</code> (16-byte aligned addresses always end in 0). In order to do this, an extra 16 bytes needed to be allocated, which can be seen with the red <code>0xAA</code> markers. Finally, the original pointer of <code>0x006648F8</code> was saved immediately before the aligned pointer in little endian (which in this case happens to have the same address as itself).</p>

<blockquote><p><strong>Endianness</strong><br/>
Endianness is the ordering of bytes in a word (On a 64-bit machine, there are 8 bytes in a word)<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup>. The bytes can be ordered in one of two directions:</p>

<ul>
<li>Big Endian: The most significant byte is stored at the smallest memory address (the &ldquo;Big End&rdquo; first)</li>
<li>Little Endian: The least significant byte is stored at the smallest memory address (the &ldquo;Little End&rdquo; first)</li>
</ul>


<p>Big Endian is the more intuitive method, as it matches reading left to right. It is chosen as the standard for transmitting words over a network, and is also known as &ldquo;Network Byte Order&rdquo;.</p>

<p>Little Endian is more difficult for a human to read, but it has performance advantages and desirable properties. For example, a 32-bit memory location with content <code>4A 00 00 00</code> can be read at the same address as either 8-bit (value = <code>0x4A</code>), 16-bit (<code>0x004A</code>), or 32-bit (<code>0x0000004A</code>), all of which retain the same numeric value. Intel&rsquo;s x86/x64 architecture is little endian.</p>

<p>It is important to be aware that endianness doesn&rsquo;t affect byte arrays or strings.</p></blockquote>

<p>Here is what the memory would look like if we did the alignment without the forced 8 byte offset:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/08/23/placement-new/02.png"></p>

<p>As you can see, even though the memory was already aligned, 16 bytes were wasted in order to get to the next aligned address. You can also see the original pointer address stored immediately before the aligned address. If we were doing 8 byte alignment, the extra 8 bytes that are wasted to align on the next boundary would contain the original address. Attempting to perform an alignment less than 8 means that there wouldn&rsquo;t be enough space for the original pointer; however, one of the rules of alignment states that the alignment must be greater than or equal to the size of a pointer, so we don&rsquo;t need to worry about that case.</p>

<p>What about larger alignments? Here is what it would look like if we were doing 32-byte alignment with an 8 byte offset:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/08/23/placement-new/03.png"></p>

<p>Generally, 32-byte alignment is unnecessary. There are cases where 16-byte alignment is needed though, such as when dealing with the SSE instructions on the CPU (for example, matrix multiplication with the Eigen library).</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="http://www.codinglabs.net/tutorial_memory_pool.aspx">Memory Pool Tutorial</a> &ndash; Marco Alamia<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="https://en.wikipedia.org/wiki/Data_structure_alignment">Data Structure Alignment</a><a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p><a href="http://stackoverflow.com/questions/381244/purpose-of-memory-alignment">Purpose of Memory Alignment</a><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p><a href="https://github.com/RLovelett/eigen/blob/master/Eigen/src/Core/util/Memory.h">Eigen Handmade Aligned Malloc</a> &ndash; Benoit Jacob<a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
<li id="fn:5">
<p><a href="https://en.wikipedia.org/wiki/Endianness">Endianness</a><a href="#fnref:5" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/17/yaml-de-slash-serialization-with-boost-fusion/">Yaml De/Serialization With Boost Fusion</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-08-17T20:17:35-04:00" pubdate data-updated="true">Aug 17<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/08/17/yaml-de-slash-serialization-with-boost-fusion/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/08/17/yaml-de-slash-serialization-with-boost-fusion/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In a <a href="">previous post</a> I did a rather lengthy walkthrough of how to create a Json pretty printer for any object using Boost Fusion. This time I will be doing the same thing, only with Yaml.</p>

<p>This method relies on a third party library<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup>, but the end result is much cleaner. This method supports both serialization and deserialization. As a bonus, it can also work with Json!</p>

<p>To run the following code, you will need these libraries installed:</p>

<ul>
<li>libboost-all-dev</li>
<li>libyaml-cpp-dev</li>
</ul>


<p>I am using yaml-cpp version 0.5.1, and some internals are exposed. There is a possibility that this method would not work with a future version.</p>

<p>The first part is similar to before; creating some wrappers around the Boost Fusion / MPL calls for ease of use. Hopefully the comments and names are straightforward:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">sequence</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Point to the first element</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">begin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Point to the element after the last element in the sequence</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">end</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Point to the first element</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">first</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Point to the second element (for pairs)</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">second</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Point to the last element in the sequence</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">end</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">last</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Number of elements in the sequence</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Get a range representing the size of the structure</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">range_c</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="n">indices</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">element_at</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Type of the element at this index</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">value_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Previous element</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">previous</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Next element</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">next</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Member name of the element at this index</span>
</span><span class='line'>    <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">extension</span><span class="o">::</span><span class="n">struct_member_name</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;::</span><span class="n">call</span><span class="p">();</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Type name of the element at this index</span>
</span><span class='line'>    <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type_name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">units</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="n">type</span><span class="p">).</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Access the element</span>
</span><span class='line'>    <span class="k">static</span> <span class="kr">inline</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">S</span> <span class="k">const</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">get</span><span class="p">(</span><span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">type</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="c1">// Return the string name of the type</span>
</span><span class='line'>    <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">units</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need two functors:</p>

<ul>
<li>One to insert items into a Yaml node</li>
<li>One to extract items from a Yaml node</li>
</ul>


<p>Lets do the inserter first. The constructor will take in a Yaml node to insert into, and <code>operator()</code> will take in a Zip element. A Zip element is a tuple created by boost::fusion::for_each that is used to zip together two lists. The concept is the same as in Python:</p>

<figure class='code'><figcaption><span></span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="o">&gt;</span> <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span> <span class="nb">zip</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span class='line'><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">)]</span>
</span></code></pre></td></tr></table></div></figure>


<p>The code performs the following operations:</p>

<ol>
<li>Grabs the index from the zip</li>
<li>Gets the name of that field using reflection</li>
<li>Gets the type of that field</li>
<li>Aliases the member for convenience</li>
<li>Stores the member under its name in the Yaml node</li>
</ol>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number marked'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">inserter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">inserter</span><span class="p">(</span><span class="n">YAML</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span> <span class="n">subroot</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">mSubroot</span><span class="p">(</span><span class="n">subroot</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Zip</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">Zip</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">zip</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_const</span><span class="o">&lt;</span>
</span><span class='line'>                 <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_reference</span><span class="o">&lt;</span>
</span><span class='line'>                    <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="n">Zip</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>                 <span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>              <span class="o">&gt;::</span><span class="n">type</span> <span class="n">Index</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Get the field name as a string using reflection</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">field_name</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">Index</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Get the field type</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">BOOST_TYPEOF</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">zip</span><span class="p">))</span> <span class="n">FieldType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Alias the member</span>
</span><span class='line'>      <span class="n">FieldType</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">member</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">zip</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Store this field in the yaml node</span>
</span><span class='line marked start end'>      <span class="n">mSubroot</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">member</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>   <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span> <span class="n">mSubroot</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The extractor is the same concept, but it is slightly more difficult for three reasons:</p>

<ol>
<li>Parsing a file can fail, and <code>yaml-cpp</code> is not very good at reporting useful errors.</li>
<li><code>boost::fusion::for_each</code> requires the zip and <code>operator()</code> to be const.</li>
<li><code>boost::fusion::for_each</code> requires <code>operator()</code> to return void.</li>
</ol>


<p>To solve these issues, we use the reflection capabilities to identify the field we are trying to load, and can report that on failure. Maintaining an item count also provides useful information for the error reporting. Using <code>const_cast</code> gets around the const requirements in an ugly manner. Finally, instead of returning <code>false</code> on error, we throw an exception that needs to be caught later.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number marked'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">extractor</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">extractor</span><span class="p">(</span><span class="n">YAML</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span> <span class="n">subroot</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">mSubroot</span><span class="p">(</span><span class="n">subroot</span><span class="p">),</span>
</span><span class='line'>      <span class="n">mItem</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Zip</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">Zip</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">zip</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_const</span><span class="o">&lt;</span>
</span><span class='line'>                 <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_reference</span><span class="o">&lt;</span>
</span><span class='line'>                    <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="n">Zip</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>                 <span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>              <span class="o">&gt;::</span><span class="n">type</span> <span class="n">Index</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Get the field name as a string using reflection</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">field_name</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">Index</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Get the field native type</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">BOOST_TYPEOF</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">zip</span><span class="p">))</span> <span class="n">FieldType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Alias the member</span>
</span><span class='line'>      <span class="c1">// We need to const cast this because &quot;boost::fusion::for_each&quot;</span>
</span><span class='line'>      <span class="c1">// requires that zip be const, however we want to modify it.</span>
</span><span class='line'>      <span class="n">FieldType</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">const_member</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">zip</span><span class="p">);</span>
</span><span class='line'>      <span class="n">FieldType</span><span class="o">&amp;</span> <span class="n">member</span> <span class="o">=</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">FieldType</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">const_member</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// We need to const cast this because &quot;boost::fusion::for_each&quot;</span>
</span><span class='line'>      <span class="c1">// requires that operator() be const, however we want to modify</span>
</span><span class='line'>      <span class="c1">// the object. This item number is used for error reporting.</span>
</span><span class='line'>      <span class="kt">int</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">const_item</span> <span class="o">=</span> <span class="n">mItem</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">int</span><span class="o">&amp;</span> <span class="n">item</span> <span class="o">=</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">const_item</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Try to load the value from the file</span>
</span><span class='line'>      <span class="k">try</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Extract this field from the yaml node</span>
</span><span class='line marked start end'>         <span class="n">member</span> <span class="o">=</span> <span class="n">mSubroot</span><span class="p">[</span><span class="n">field_name</span><span class="p">].</span><span class="n">as</span><span class="o">&lt;</span><span class="n">FieldType</span><span class="o">&gt;</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// This item number helps us find issues when loading incomplete yaml files</span>
</span><span class='line'>         <span class="o">++</span><span class="n">item</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="c1">// Catch any exceptions</span>
</span><span class='line'>      <span class="k">catch</span><span class="p">(</span><span class="n">YAML</span><span class="o">::</span><span class="n">Exception</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Print out some helpful information to find the error in the yaml file</span>
</span><span class='line'>         <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type_name</span> <span class="o">=</span> <span class="n">type</span><span class="o">&lt;</span><span class="n">FieldType</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>         <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Error loading item &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">item</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">type_name</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">field_name</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// &quot;boost::fusion::for_each&quot; requires operator() to return void,</span>
</span><span class='line'>         <span class="c1">// so the only way to signal that an error occurred is to throw</span>
</span><span class='line'>         <span class="c1">// an exception.</span>
</span><span class='line'>         <span class="k">throw</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>   <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span> <span class="n">mSubroot</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">mItem</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Pay attention to the highlighted lines in the above <code>inserter</code> and <code>extractor</code>.<br/>
The call to <code>operator=</code> in the inserter leads to this code being run inside the <code>yaml-cpp</code> library:</p>

<figure class='code'><figcaption><span>&#8220;yaml-cpp/node/impl.h&#8221; </span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number marked'>208</span>
<span class='line-number'>209</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="kr">inline</span> <span class="kt">void</span> <span class="n">Node</span><span class="o">::</span><span class="n">Assign</span><span class="p">(</span><span class="k">const</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">m_isValid</span><span class="p">)</span>
</span><span class='line'>        <span class="k">throw</span> <span class="n">InvalidNode</span><span class="p">();</span>
</span><span class='line marked start end'>    <span class="n">AssignData</span><span class="p">(</span><span class="n">convert</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">encode</span><span class="p">(</span><span class="n">rhs</span><span class="p">));</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The call to <code>as</code> in the extractor leads to this code being run inside the <code>yaml-cpp</code> library:</p>

<figure class='code'><figcaption><span>&#8220;yaml-cpp/node/impl.h&#8221; </span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number marked'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// template helpers</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">as_if</span> <span class="p">{</span>
</span><span class='line'>    <span class="k">explicit</span> <span class="n">as_if</span><span class="p">(</span><span class="k">const</span> <span class="n">Node</span><span class="o">&amp;</span> <span class="n">node_</span><span class="p">)</span><span class="o">:</span> <span class="n">node</span><span class="p">(</span><span class="n">node_</span><span class="p">)</span> <span class="p">{}</span>
</span><span class='line'>    <span class="k">const</span> <span class="n">Node</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">const</span> <span class="n">T</span> <span class="k">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">S</span><span class="o">&amp;</span> <span class="n">fallback</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">node</span><span class="p">.</span><span class="n">m_pNode</span><span class="p">)</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">fallback</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">T</span> <span class="n">t</span><span class="p">;</span>
</span><span class='line marked start end'>        <span class="k">if</span><span class="p">(</span><span class="n">convert</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">decode</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">t</span><span class="p">))</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
</span><span class='line'>        <span class="k">return</span> <span class="n">fallback</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The documentation states that user specified data types can specialize the <code>YAML::convert&lt;&gt;</code> class to handle encoding and decoding properly. Below is a screenshot of the documentation about this:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/08/17/yaml-de-slash-serialization-with-boost-fusion/01.png"></p>

<p>However, there is a small obstacle when trying to specialize the <code>convert</code> structure for our fusion sequence:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number marked'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">namespace</span> <span class="n">YAML</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;&gt;</span>
</span><span class='line marked start end'>   <span class="k">struct</span> <span class="n">convert</span><span class="o">&lt;???&gt;</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">static</span> <span class="n">Node</span> <span class="n">encode</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">static</span> <span class="kt">bool</span> <span class="n">decode</span><span class="p">(</span><span class="n">Node</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">,</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can&rsquo;t specialize in a general sense because <code>???</code> would either have to be a template parameter, or we would need one of these for every <code>BOOST_FUSION_ADAPT_STRUCT</code> we create.
Normally in this type of situation, we could use partial specialization if there was a second template parameter, even if it was a dummy variable that allowed us to use <code>boost::enable_if</code>.</p>

<p>Digging around the source a little more, we find this gem, and the answer to our problems:</p>

<figure class='code'><figcaption><span>&#8220;yaml-cpp/node/node.h&#8221; </span></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>112</span>
<span class='line-number'>113</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">convert</span><span class="p">;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Thats right! The convert structure is only forward declared, it is never actually defined! This means <em>we</em> can define it to be whatever we want!</p>

<p>Time to use some <code>boost::enable_if</code> magic. We add a dummy variable to both <code>encode</code> and <code>decode</code> that only enable those functions if the template parameter is a <code>boost::fusion</code> sequence. This allows the signatures of everything to match. Whenever a type <code>T</code> is not specialized by the library, the compiler will try to use our definition, which will only take effect if the type is a sequence. Otherwise, a compiler error will be thrown just as it would have before. In addition, this method still allows one to specialize for their type if they need extra functionality.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">namespace</span> <span class="n">YAML</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">struct</span> <span class="n">convert</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// This function will only be available if the template parameter is a boost fusion sequence</span>
</span><span class='line'>      <span class="k">static</span> <span class="n">Node</span> <span class="n">encode</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">,</span>
</span><span class='line'>                         <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_if</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">is_sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// This function will only be available if the template parameter is a boost fusion sequence</span>
</span><span class='line'>      <span class="k">static</span> <span class="kt">bool</span> <span class="n">decode</span><span class="p">(</span><span class="n">Node</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">,</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">,</span>
</span><span class='line'>                         <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_if</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">is_sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>For the <code>encode</code> method, we iterate over every field in the sequence using the inserter, which will recurse through all the sub-sequences until we hit the &ldquo;bottom&rdquo;. Every sequence is made up of primitive at some level, so eventually the recursion will stop as specializations of <code>encode</code> get called instead of the one we defined.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// This function will only be available if the template parameter is a boost fusion sequence</span>
</span><span class='line'><span class="k">static</span> <span class="n">Node</span> <span class="n">encode</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">,</span>
</span><span class='line'>                   <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_if</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">is_sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// For each item in T</span>
</span><span class='line'>   <span class="c1">// Call inserter recursively</span>
</span><span class='line'>   <span class="c1">// Every sequence is made up of primitives at some level</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Get a range representing the size of the structure</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">yaml</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">indices</span> <span class="n">indices</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Make a root node to insert into</span>
</span><span class='line'>   <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">root</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Create an inserter for the root node</span>
</span><span class='line'>   <span class="n">yaml</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">inserter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">inserter</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Insert each member of the structure</span>
</span><span class='line'>   <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">),</span> <span class="n">inserter</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">return</span> <span class="n">root</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>decode</code> method works the same way, using the <code>extractor</code>. Remember that the extractor throws on error, so the exception needs to be caught.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// This function will only be available if the template parameter is a boost fusion sequence</span>
</span><span class='line'><span class="k">static</span> <span class="kt">bool</span> <span class="n">decode</span><span class="p">(</span><span class="n">Node</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">,</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">,</span>
</span><span class='line'>                   <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_if</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">is_sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// For each item in T</span>
</span><span class='line'>   <span class="c1">// Call extractor recursively</span>
</span><span class='line'>   <span class="c1">// Every sequence is made up of primitives at some level</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Get a range representing the size of the structure</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">yaml</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">indices</span> <span class="n">indices</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Create an extractor for the root node</span>
</span><span class='line'>   <span class="c1">// Yaml-cpp requires node to be const&amp;, but the extractor makes</span>
</span><span class='line'>   <span class="c1">// non-const calls to it.</span>
</span><span class='line'>   <span class="n">Node</span><span class="o">&amp;</span> <span class="n">writable_node</span> <span class="o">=</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
</span><span class='line'>   <span class="n">yaml</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">extractor</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">extractor</span><span class="p">(</span><span class="n">writable_node</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Extract each member of the structure</span>
</span><span class='line'>   <span class="k">try</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// An exception is thrown if any item in the loop cannot be read</span>
</span><span class='line'>      <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">),</span> <span class="n">extractor</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="c1">// Catch all exceptions and prevent them from propagating</span>
</span><span class='line'>   <span class="k">catch</span><span class="p">(...)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// If we made it here, all fields were read correctly</span>
</span><span class='line'>   <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok! All the pieces and parts are completed. Time to make a mixin to wrap it all up. We want objects to have method to convert to and from Yaml and Json (remember that Json is a subset of Yaml, so the yaml parser gives us both abilities for free!). All we need to do is kickstart the recursion using the <code>inserter</code> and <code>extractor</code>.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">namespace</span> <span class="n">yaml</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">class</span> <span class="nc">Yaml</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>   <span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">T</span> <span class="n">Base</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Convert this object to yaml</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_yaml</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Create an emitter</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Emitter</span> <span class="n">emitter</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Emit yaml</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">emit</span><span class="p">(</span><span class="n">emitter</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Convert this object to json</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_json</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Create an emitter</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Emitter</span> <span class="n">emitter</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Set the emitter manipulators for json</span>
</span><span class='line'>         <span class="n">emitter</span> <span class="o">&lt;&lt;</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Flow</span><span class="p">;</span>
</span><span class='line'>         <span class="n">emitter</span> <span class="o">&lt;&lt;</span> <span class="n">YAML</span><span class="o">::</span><span class="n">DoubleQuoted</span><span class="p">;</span>
</span><span class='line'>         <span class="n">emitter</span> <span class="o">&lt;&lt;</span> <span class="n">YAML</span><span class="o">::</span><span class="n">TrueFalseBool</span><span class="p">;</span>
</span><span class='line'>         <span class="n">emitter</span> <span class="o">&lt;&lt;</span> <span class="n">YAML</span><span class="o">::</span><span class="n">EscapeNonAscii</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Emit json</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">emit</span><span class="p">(</span><span class="n">emitter</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Load yaml into this object</span>
</span><span class='line'>      <span class="kt">bool</span> <span class="n">from_yaml</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">yaml_string</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Create a root node to load into</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">root</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">try</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Try loading the root node</span>
</span><span class='line'>            <span class="n">root</span> <span class="o">=</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Load</span><span class="p">(</span><span class="n">yaml_string</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>         <span class="k">catch</span><span class="p">(...)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="c1">// The yaml couldn&#39;t be parsed</span>
</span><span class='line'>            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Invalid yaml&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Get a range representing the size of the structure</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">detail</span><span class="o">::</span><span class="n">sequence</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;::</span><span class="n">indices</span> <span class="n">indices</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Create an extractor for the root node</span>
</span><span class='line'>         <span class="n">detail</span><span class="o">::</span><span class="n">extractor</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;</span> <span class="n">extractor</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Extract each member of the structure</span>
</span><span class='line'>         <span class="k">try</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="c1">// An exception is thrown if any item in the loop cannot be read</span>
</span><span class='line'>            <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">(),</span> <span class="n">self</span><span class="p">()),</span> <span class="n">extractor</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>         <span class="c1">// Catch all exceptions and prevent them from propagating</span>
</span><span class='line'>         <span class="k">catch</span><span class="p">(...)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// If we made it here, all fields were read correctly</span>
</span><span class='line'>         <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// The yaml parser can also parse json</span>
</span><span class='line'>      <span class="kr">inline</span> <span class="kt">bool</span> <span class="n">from_json</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">json_string</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">from_yaml</span><span class="p">(</span><span class="n">json_string</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">emit</span><span class="p">(</span><span class="n">YAML</span><span class="o">::</span><span class="n">Emitter</span><span class="o">&amp;</span> <span class="n">emitter</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Get a range representing the size of the structure</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">detail</span><span class="o">::</span><span class="n">sequence</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;::</span><span class="n">indices</span> <span class="n">indices</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Make a root node to insert into</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">root</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Create an inserter for the root node</span>
</span><span class='line'>         <span class="n">detail</span><span class="o">::</span><span class="n">inserter</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;</span> <span class="n">inserter</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Insert each member of the structure</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">(),</span> <span class="n">self</span><span class="p">()),</span> <span class="n">inserter</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Emit yaml</span>
</span><span class='line'>         <span class="n">emitter</span> <span class="o">&lt;&lt;</span> <span class="n">root</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Return string representation</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">emitter</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Cast ourselves to our CRTP base</span>
</span><span class='line'>      <span class="n">Base</span><span class="o">&amp;</span> <span class="n">self</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Time to test it. First we create some test structures with different types and containers, and adapt them into sequences:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number marked'>13</span>
<span class='line-number'>14</span>
<span class='line-number marked'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number marked'>30</span>
<span class='line-number marked'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number marked'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;string&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sstream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;map&gt;</span>
</span><span class='line'><span class="cp">#include &lt;vector&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">yaml</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="n">test</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">struct</span> <span class="n">One</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line marked start end'>      <span class="k">friend</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">extension</span><span class="o">::</span><span class="n">access</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line marked start end'>      <span class="n">One</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>         <span class="n">two</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>         <span class="n">three</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
</span><span class='line'>         <span class="n">four</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">One</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">b</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">c</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>         <span class="n">two</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
</span><span class='line'>         <span class="n">three</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
</span><span class='line'>         <span class="n">four</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">int</span> <span class="n">two</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">double</span> <span class="n">three</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line marked start'>   <span class="k">private</span><span class="o">:</span>
</span><span class='line marked end'>      <span class="kt">bool</span> <span class="n">four</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'>
</span><span class='line marked start end'>   <span class="k">struct</span> <span class="n">Five</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Yaml</span><span class="o">&lt;</span><span class="n">Five</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">One</span><span class="o">&gt;</span> <span class="n">Map_t</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Map_t</span> <span class="n">six</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">One</span><span class="o">&gt;</span> <span class="n">Vector_t</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Vector_t</span> <span class="n">seven</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">eight</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Matrix_t</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Matrix_t</span> <span class="n">nine</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>   <span class="n">test</span><span class="o">::</span><span class="n">One</span><span class="p">,</span>
</span><span class='line'>   <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="kt">double</span><span class="p">,</span> <span class="n">three</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="n">four</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>   <span class="n">test</span><span class="o">::</span><span class="n">Five</span><span class="p">,</span>
</span><span class='line'>   <span class="p">(</span><span class="n">test</span><span class="o">::</span><span class="n">Five</span><span class="o">::</span><span class="n">Map_t</span><span class="p">,</span> <span class="n">six</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="n">test</span><span class="o">::</span><span class="n">Five</span><span class="o">::</span><span class="n">Vector_t</span><span class="p">,</span> <span class="n">seven</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">eight</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="n">test</span><span class="o">::</span><span class="n">Five</span><span class="o">::</span><span class="n">Matrix_t</span><span class="p">,</span> <span class="n">nine</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>A couple things to note here. First off, a default constructor is required for decoding. Secondly, if you want to adapt private or protected members, your class must befriend the <code>boost::fusion::extension::access</code> class. Finally, the top-level structure that you want to serialize / deserialize must inherit from the <code>Yaml&lt;&gt;</code> mixin.</p>

<p>To try it out, populate the structure and output it as Yaml and Json. Then try parsing a different Yaml string and make sure the structure was populated accordingly:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Five</span> <span class="n">v</span><span class="p">;</span>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">six</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="n">One</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">6.6</span><span class="p">,</span> <span class="kc">true</span><span class="p">)));</span>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">six</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="mi">456</span><span class="p">,</span> <span class="n">One</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">8.8</span><span class="p">,</span> <span class="kc">false</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">seven</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">One</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">seven</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">One</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">eight</span> <span class="o">=</span> <span class="s">&quot;eight&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">temp</span><span class="p">;</span>
</span><span class='line'>   <span class="n">temp</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">2.3</span><span class="p">);</span>
</span><span class='line'>   <span class="n">temp</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">4.5</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">nine</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">nine</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">to_yaml</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">to_json</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">///////////////////////////////////////////</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;==============&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;six:            </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  234:          </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    two: 4      </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    three: 5.5  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    four: true  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  345:          </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    two: 6      </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    three: 7.7  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    four: false </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;seven:          </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  - two: 8      </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    three: 9.9  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    four: true  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  - two: 2      </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    three: 3.3  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    four: true  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;eight: nine     </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;nine:           </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  -             </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    - 3.4       </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    - 5.6       </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  -             </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    - 7.8       </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    - 9.0       </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">to_yaml</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The output is:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
</pre></td><td class='code'><pre><code class='python'><span class='line'><span class="n">six</span><span class="p">:</span>
</span><span class='line'>  <span class="mi">123</span><span class="p">:</span>
</span><span class='line'>    <span class="n">two</span><span class="p">:</span> <span class="mi">3</span>
</span><span class='line'>    <span class="n">three</span><span class="p">:</span> <span class="mf">6.6</span>
</span><span class='line'>    <span class="n">four</span><span class="p">:</span> <span class="n">true</span>
</span><span class='line'>  <span class="mi">456</span><span class="p">:</span>
</span><span class='line'>    <span class="n">two</span><span class="p">:</span> <span class="mi">4</span>
</span><span class='line'>    <span class="n">three</span><span class="p">:</span> <span class="mf">8.800000000000001</span>
</span><span class='line'>    <span class="n">four</span><span class="p">:</span> <span class="n">false</span>
</span><span class='line'><span class="n">seven</span><span class="p">:</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">two</span><span class="p">:</span> <span class="mi">5</span>
</span><span class='line'>    <span class="n">three</span><span class="p">:</span> <span class="mf">1.1</span>
</span><span class='line'>    <span class="n">four</span><span class="p">:</span> <span class="n">true</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">two</span><span class="p">:</span> <span class="mi">5</span>
</span><span class='line'>    <span class="n">three</span><span class="p">:</span> <span class="mf">2.2</span>
</span><span class='line'>    <span class="n">four</span><span class="p">:</span> <span class="n">true</span>
</span><span class='line'><span class="n">eight</span><span class="p">:</span> <span class="n">eight</span>
</span><span class='line'><span class="n">nine</span><span class="p">:</span>
</span><span class='line'>  <span class="o">-</span>
</span><span class='line'>    <span class="o">-</span> <span class="mf">2.3</span>
</span><span class='line'>    <span class="o">-</span> <span class="mf">4.5</span>
</span><span class='line'>  <span class="o">-</span>
</span><span class='line'>    <span class="o">-</span> <span class="mf">2.3</span>
</span><span class='line'>    <span class="o">-</span> <span class="mf">4.5</span>
</span><span class='line'><span class="p">{</span><span class="s">&quot;six&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;456&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;two&quot;</span><span class="p">:</span> <span class="s">&quot;4&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span><span class="p">:</span> <span class="s">&quot;8.800000000000001&quot;</span><span class="p">,</span> <span class="s">&quot;four&quot;</span><span class="p">:</span> <span class="s">&quot;false&quot;</span><span class="p">},</span> <span class="s">&quot;123&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;three&quot;</span><span class="p">:</span> <span class="s">&quot;6.6&quot;</span><span class="p">,</span> <span class="s">&quot;four&quot;</span><span class="p">:</span> <span class="s">&quot;true&quot;</span><span class="p">,</span> <span class="s">&quot;two&quot;</span><span class="p">:</span> <span class="s">&quot;3&quot;</span><span class="p">}},</span> <span class="s">&quot;seven&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s">&quot;two&quot;</span><span class="p">:</span> <span class="s">&quot;5&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span><span class="p">:</span> <span class="s">&quot;1.1&quot;</span><span class="p">,</span> <span class="s">&quot;four&quot;</span><span class="p">:</span> <span class="s">&quot;true&quot;</span><span class="p">},</span> <span class="p">{</span><span class="s">&quot;two&quot;</span><span class="p">:</span> <span class="s">&quot;5&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span><span class="p">:</span> <span class="s">&quot;2.2&quot;</span><span class="p">,</span> <span class="s">&quot;four&quot;</span><span class="p">:</span> <span class="s">&quot;true&quot;</span><span class="p">}],</span> <span class="s">&quot;eight&quot;</span><span class="p">:</span> <span class="s">&quot;eight&quot;</span><span class="p">,</span> <span class="s">&quot;nine&quot;</span><span class="p">:</span> <span class="p">[[</span><span class="s">&quot;2.3&quot;</span><span class="p">,</span> <span class="s">&quot;4.5&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s">&quot;2.3&quot;</span><span class="p">,</span> <span class="s">&quot;4.5&quot;</span><span class="p">]]}</span>
</span><span class='line'><span class="o">==============</span>
</span><span class='line'><span class="n">eight</span><span class="p">:</span> <span class="n">nine</span>
</span><span class='line'><span class="n">six</span><span class="p">:</span>
</span><span class='line'>  <span class="mi">234</span><span class="p">:</span>
</span><span class='line'>    <span class="n">three</span><span class="p">:</span> <span class="mf">5.5</span>
</span><span class='line'>    <span class="n">four</span><span class="p">:</span> <span class="n">true</span>
</span><span class='line'>    <span class="n">two</span><span class="p">:</span> <span class="mi">4</span>
</span><span class='line'>  <span class="mi">345</span><span class="p">:</span>
</span><span class='line'>    <span class="n">two</span><span class="p">:</span> <span class="mi">6</span>
</span><span class='line'>    <span class="n">three</span><span class="p">:</span> <span class="mf">7.7</span>
</span><span class='line'>    <span class="n">four</span><span class="p">:</span> <span class="n">false</span>
</span><span class='line'><span class="n">seven</span><span class="p">:</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">three</span><span class="p">:</span> <span class="mf">9.9</span>
</span><span class='line'>    <span class="n">two</span><span class="p">:</span> <span class="mi">8</span>
</span><span class='line'>    <span class="n">four</span><span class="p">:</span> <span class="n">true</span>
</span><span class='line'>  <span class="o">-</span> <span class="n">three</span><span class="p">:</span> <span class="mf">3.3</span>
</span><span class='line'>    <span class="n">two</span><span class="p">:</span> <span class="mi">2</span>
</span><span class='line'>    <span class="n">four</span><span class="p">:</span> <span class="n">true</span>
</span><span class='line'><span class="n">nine</span><span class="p">:</span>
</span><span class='line'>  <span class="o">-</span>
</span><span class='line'>    <span class="o">-</span> <span class="mf">3.4</span>
</span><span class='line'>    <span class="o">-</span> <span class="mf">5.6</span>
</span><span class='line'>  <span class="o">-</span>
</span><span class='line'>    <span class="o">-</span> <span class="mf">7.8</span>
</span><span class='line'>    <span class="o">-</span> <span class="mi">9</span>
</span></code></pre></td></tr></table></div></figure>


<p>Below is a full copy of the above code that you can compile and run:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
<span class='line-number'>457</span>
<span class='line-number'>458</span>
<span class='line-number'>459</span>
<span class='line-number'>460</span>
<span class='line-number'>461</span>
<span class='line-number'>462</span>
<span class='line-number'>463</span>
<span class='line-number'>464</span>
<span class='line-number'>465</span>
<span class='line-number'>466</span>
<span class='line-number'>467</span>
<span class='line-number'>468</span>
<span class='line-number'>469</span>
<span class='line-number'>470</span>
<span class='line-number'>471</span>
<span class='line-number'>472</span>
<span class='line-number'>473</span>
<span class='line-number'>474</span>
<span class='line-number'>475</span>
<span class='line-number'>476</span>
<span class='line-number'>477</span>
<span class='line-number'>478</span>
<span class='line-number'>479</span>
<span class='line-number'>480</span>
<span class='line-number'>481</span>
<span class='line-number'>482</span>
<span class='line-number'>483</span>
<span class='line-number'>484</span>
<span class='line-number'>485</span>
<span class='line-number'>486</span>
<span class='line-number'>487</span>
<span class='line-number'>488</span>
<span class='line-number'>489</span>
<span class='line-number'>490</span>
<span class='line-number'>491</span>
<span class='line-number'>492</span>
<span class='line-number'>493</span>
<span class='line-number'>494</span>
<span class='line-number'>495</span>
<span class='line-number'>496</span>
<span class='line-number'>497</span>
<span class='line-number'>498</span>
<span class='line-number'>499</span>
<span class='line-number'>500</span>
<span class='line-number'>501</span>
<span class='line-number'>502</span>
<span class='line-number'>503</span>
<span class='line-number'>504</span>
<span class='line-number'>505</span>
<span class='line-number'>506</span>
<span class='line-number'>507</span>
<span class='line-number'>508</span>
<span class='line-number'>509</span>
<span class='line-number'>510</span>
<span class='line-number'>511</span>
<span class='line-number'>512</span>
<span class='line-number'>513</span>
<span class='line-number'>514</span>
<span class='line-number'>515</span>
<span class='line-number'>516</span>
<span class='line-number'>517</span>
<span class='line-number'>518</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// yaml.cpp</span>
</span><span class='line'><span class="c1">// Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c1">// it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c1">// the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c1">// (at your option) any later version.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c1">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c1">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c1">// GNU General Public License for more details.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c1">// along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;string&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/foreach.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/adapted.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/at_c.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/at.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/for_each.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/size.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/value_at.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/zip.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/mpl.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/sequence.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/support.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/eval_if.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/identity.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/next_prior.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/range_c.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/type_traits.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/typeof/typeof.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/units/detail/utility.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/utility/enable_if.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;yaml-cpp/yaml.h&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="n">yaml</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">namespace</span> <span class="n">detail</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">sequence</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Point to the first element</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">begin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Point to the element after the last element in the sequence</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">end</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Point to the first element</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">first</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Point to the second element (for pairs)</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">second</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Point to the last element in the sequence</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">end</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">last</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Number of elements in the sequence</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Get a range representing the size of the structure</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">range_c</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">value</span><span class="o">&gt;</span> <span class="n">indices</span><span class="p">;</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>               <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">element_at</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Type of the element at this index</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">value_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Previous element</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">previous</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Next element</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">next</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Member name of the element at this index</span>
</span><span class='line'>         <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>           <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">extension</span><span class="o">::</span><span class="n">struct_member_name</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;::</span><span class="n">call</span><span class="p">();</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Type name of the element at this index</span>
</span><span class='line'>         <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type_name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>           <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">units</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="n">type</span><span class="p">).</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Access the element</span>
</span><span class='line'>         <span class="k">static</span> <span class="kr">inline</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">S</span> <span class="k">const</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">get</span><span class="p">(</span><span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>           <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">type</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Return the string name of the type</span>
</span><span class='line'>         <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">units</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="n">T</span><span class="p">).</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">inserter</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">inserter</span><span class="p">(</span><span class="n">YAML</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span> <span class="n">subroot</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>            <span class="n">mSubroot</span><span class="p">(</span><span class="n">subroot</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Zip</span><span class="o">&gt;</span>
</span><span class='line'>         <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">Zip</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">zip</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_const</span><span class="o">&lt;</span>
</span><span class='line'>                       <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_reference</span><span class="o">&lt;</span>
</span><span class='line'>                          <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="n">Zip</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>                       <span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>                    <span class="o">&gt;::</span><span class="n">type</span> <span class="n">Index</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Get the field name as a string using reflection</span>
</span><span class='line'>            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">field_name</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">Index</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Get the field type</span>
</span><span class='line'>            <span class="k">typedef</span> <span class="n">BOOST_TYPEOF</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">zip</span><span class="p">))</span> <span class="n">FieldType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Alias the member</span>
</span><span class='line'>            <span class="n">FieldType</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">member</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">zip</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Store this field in the yaml node</span>
</span><span class='line'>            <span class="n">mSubroot</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">member</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">protected</span><span class="o">:</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span> <span class="n">mSubroot</span><span class="p">;</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="k">struct</span> <span class="n">extractor</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">extractor</span><span class="p">(</span><span class="n">YAML</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span> <span class="n">subroot</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>            <span class="n">mSubroot</span><span class="p">(</span><span class="n">subroot</span><span class="p">),</span>
</span><span class='line'>            <span class="n">mItem</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Zip</span><span class="o">&gt;</span>
</span><span class='line'>         <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">Zip</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">zip</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_const</span><span class="o">&lt;</span>
</span><span class='line'>                       <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_reference</span><span class="o">&lt;</span>
</span><span class='line'>                          <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="n">Zip</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>                       <span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>                    <span class="o">&gt;::</span><span class="n">type</span> <span class="n">Index</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Get the field name as a string using reflection</span>
</span><span class='line'>            <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">field_name</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">Type</span><span class="p">,</span> <span class="n">Index</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Get the field native type</span>
</span><span class='line'>            <span class="k">typedef</span> <span class="n">BOOST_TYPEOF</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">zip</span><span class="p">))</span> <span class="n">FieldType</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Alias the member</span>
</span><span class='line'>            <span class="c1">// We need to const cast this because &quot;boost::fusion::for_each&quot;</span>
</span><span class='line'>            <span class="c1">// requires that zip be const, however we want to modify it.</span>
</span><span class='line'>            <span class="n">FieldType</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">const_member</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at_c</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">zip</span><span class="p">);</span>
</span><span class='line'>            <span class="n">FieldType</span><span class="o">&amp;</span> <span class="n">member</span> <span class="o">=</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">FieldType</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">const_member</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// We need to const cast this because &quot;boost::fusion::for_each&quot;</span>
</span><span class='line'>            <span class="c1">// requires that operator() be const, however we want to modify</span>
</span><span class='line'>            <span class="c1">// the object. This item number is used for error reporting.</span>
</span><span class='line'>            <span class="kt">int</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">const_item</span> <span class="o">=</span> <span class="n">mItem</span><span class="p">;</span>
</span><span class='line'>            <span class="kt">int</span><span class="o">&amp;</span> <span class="n">item</span> <span class="o">=</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">const_item</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>            <span class="c1">// Try to load the value from the file</span>
</span><span class='line'>            <span class="k">try</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>               <span class="c1">// Extract this field from the yaml node</span>
</span><span class='line'>               <span class="n">member</span> <span class="o">=</span> <span class="n">mSubroot</span><span class="p">[</span><span class="n">field_name</span><span class="p">].</span><span class="n">as</span><span class="o">&lt;</span><span class="n">FieldType</span><span class="o">&gt;</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>               <span class="c1">// This item number helps us find issues when loading incomplete yaml files</span>
</span><span class='line'>               <span class="o">++</span><span class="n">item</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>            <span class="c1">// Catch any exceptions</span>
</span><span class='line'>            <span class="k">catch</span><span class="p">(</span><span class="n">YAML</span><span class="o">::</span><span class="n">Exception</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">e</span><span class="p">)</span>
</span><span class='line'>            <span class="p">{</span>
</span><span class='line'>               <span class="c1">// Print out some helpful information to find the error in the yaml file</span>
</span><span class='line'>               <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type_name</span> <span class="o">=</span> <span class="n">type</span><span class="o">&lt;</span><span class="n">FieldType</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>               <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Error loading item &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">item</span>  <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">type_name</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">field_name</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>               <span class="c1">// &quot;boost::fusion::for_each&quot; requires operator() to return void,</span>
</span><span class='line'>               <span class="c1">// so the only way to signal that an error occurred is to throw</span>
</span><span class='line'>               <span class="c1">// an exception.</span>
</span><span class='line'>               <span class="k">throw</span><span class="p">;</span>
</span><span class='line'>            <span class="p">}</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">protected</span><span class="o">:</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span><span class="o">&amp;</span> <span class="n">mSubroot</span><span class="p">;</span>
</span><span class='line'>         <span class="kt">int</span> <span class="n">mItem</span><span class="p">;</span>
</span><span class='line'>      <span class="p">};</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// We are going to inject some stuff into the 3rd party Yaml-cpp namespace</span>
</span><span class='line'><span class="k">namespace</span> <span class="n">YAML</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Normally, a second template parameter would be used as an enabler and default to void.</span>
</span><span class='line'>   <span class="c1">// Then we could use boost::enable_if to enable specific specializations.</span>
</span><span class='line'>   <span class="c1">// Unfortunately, we are specializing an already-declared structure in a 3rd party namespace.</span>
</span><span class='line'>   <span class="c1">// On the plus side, the struct was only forward declared; it hasn&#39;t been defined.</span>
</span><span class='line'>   <span class="c1">// Therefore, we have the freedom to define it!</span>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">struct</span> <span class="n">convert</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// This function will only be available if the template parameter is a boost fusion sequence</span>
</span><span class='line'>      <span class="k">static</span> <span class="n">Node</span> <span class="n">encode</span><span class="p">(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">,</span>
</span><span class='line'>                         <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_if</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">is_sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// For each item in T</span>
</span><span class='line'>         <span class="c1">// Call inserter recursively</span>
</span><span class='line'>         <span class="c1">// Every sequence is made up of primitives at some level</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Get a range representing the size of the structure</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">yaml</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">indices</span> <span class="n">indices</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Make a root node to insert into</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">root</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Create an inserter for the root node</span>
</span><span class='line'>         <span class="n">yaml</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">inserter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">inserter</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Insert each member of the structure</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">),</span> <span class="n">inserter</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">return</span> <span class="n">root</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// This function will only be available if the template parameter is a boost fusion sequence</span>
</span><span class='line'>      <span class="k">static</span> <span class="kt">bool</span> <span class="n">decode</span><span class="p">(</span><span class="n">Node</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">node</span><span class="p">,</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">rhs</span><span class="p">,</span>
</span><span class='line'>                         <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">enable_if</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">is_sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">&gt;::</span><span class="n">type</span><span class="o">*</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// For each item in T</span>
</span><span class='line'>         <span class="c1">// Call extractor recursively</span>
</span><span class='line'>         <span class="c1">// Every sequence is made up of primitives at some level</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Get a range representing the size of the structure</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">yaml</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">indices</span> <span class="n">indices</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Create an extractor for the root node</span>
</span><span class='line'>         <span class="c1">// Yaml-cpp requires node to be const&amp;, but the extractor makes</span>
</span><span class='line'>         <span class="c1">// non-const calls to it.</span>
</span><span class='line'>         <span class="n">Node</span><span class="o">&amp;</span> <span class="n">writable_node</span> <span class="o">=</span> <span class="k">const_cast</span><span class="o">&lt;</span><span class="n">Node</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
</span><span class='line'>         <span class="n">yaml</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">extractor</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">extractor</span><span class="p">(</span><span class="n">writable_node</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Extract each member of the structure</span>
</span><span class='line'>         <span class="k">try</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="c1">// An exception is thrown if any item in the loop cannot be read</span>
</span><span class='line'>            <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">(),</span> <span class="n">rhs</span><span class="p">),</span> <span class="n">extractor</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>         <span class="c1">// Catch all exceptions and prevent them from propagating</span>
</span><span class='line'>         <span class="k">catch</span><span class="p">(...)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// If we made it here, all fields were read correctly</span>
</span><span class='line'>         <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="n">yaml</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">class</span> <span class="nc">Yaml</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>   <span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">T</span> <span class="n">Base</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Convert this object to yaml</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_yaml</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Create an emitter</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Emitter</span> <span class="n">emitter</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Emit yaml</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">emit</span><span class="p">(</span><span class="n">emitter</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Convert this object to json</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_json</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Create an emitter</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Emitter</span> <span class="n">emitter</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Set the emitter manipulators for json</span>
</span><span class='line'>         <span class="n">emitter</span> <span class="o">&lt;&lt;</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Flow</span><span class="p">;</span>
</span><span class='line'>         <span class="n">emitter</span> <span class="o">&lt;&lt;</span> <span class="n">YAML</span><span class="o">::</span><span class="n">DoubleQuoted</span><span class="p">;</span>
</span><span class='line'>         <span class="n">emitter</span> <span class="o">&lt;&lt;</span> <span class="n">YAML</span><span class="o">::</span><span class="n">TrueFalseBool</span><span class="p">;</span>
</span><span class='line'>         <span class="n">emitter</span> <span class="o">&lt;&lt;</span> <span class="n">YAML</span><span class="o">::</span><span class="n">EscapeNonAscii</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Emit json</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">emit</span><span class="p">(</span><span class="n">emitter</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Load yaml into this object</span>
</span><span class='line'>      <span class="kt">bool</span> <span class="n">from_yaml</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">yaml_string</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Create a root node to load into</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">root</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">try</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="c1">// Try loading the root node</span>
</span><span class='line'>            <span class="n">root</span> <span class="o">=</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Load</span><span class="p">(</span><span class="n">yaml_string</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>         <span class="k">catch</span><span class="p">(...)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="c1">// The yaml couldn&#39;t be parsed</span>
</span><span class='line'>            <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Invalid yaml&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Get a range representing the size of the structure</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">detail</span><span class="o">::</span><span class="n">sequence</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;::</span><span class="n">indices</span> <span class="n">indices</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Create an extractor for the root node</span>
</span><span class='line'>         <span class="n">detail</span><span class="o">::</span><span class="n">extractor</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;</span> <span class="n">extractor</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Extract each member of the structure</span>
</span><span class='line'>         <span class="k">try</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="c1">// An exception is thrown if any item in the loop cannot be read</span>
</span><span class='line'>            <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">(),</span> <span class="n">self</span><span class="p">()),</span> <span class="n">extractor</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>         <span class="c1">// Catch all exceptions and prevent them from propagating</span>
</span><span class='line'>         <span class="k">catch</span><span class="p">(...)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// If we made it here, all fields were read correctly</span>
</span><span class='line'>         <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// The yaml parser can also parse json</span>
</span><span class='line'>      <span class="kr">inline</span> <span class="kt">bool</span> <span class="n">from_json</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">json_string</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">from_yaml</span><span class="p">(</span><span class="n">json_string</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">emit</span><span class="p">(</span><span class="n">YAML</span><span class="o">::</span><span class="n">Emitter</span><span class="o">&amp;</span> <span class="n">emitter</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="c1">// Get a range representing the size of the structure</span>
</span><span class='line'>         <span class="k">typedef</span> <span class="k">typename</span> <span class="n">detail</span><span class="o">::</span><span class="n">sequence</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;::</span><span class="n">indices</span> <span class="n">indices</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Make a root node to insert into</span>
</span><span class='line'>         <span class="n">YAML</span><span class="o">::</span><span class="n">Node</span> <span class="n">root</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Create an inserter for the root node</span>
</span><span class='line'>         <span class="n">detail</span><span class="o">::</span><span class="n">inserter</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&gt;</span> <span class="n">inserter</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Insert each member of the structure</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">for_each</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">(),</span> <span class="n">self</span><span class="p">()),</span> <span class="n">inserter</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Emit yaml</span>
</span><span class='line'>         <span class="n">emitter</span> <span class="o">&lt;&lt;</span> <span class="n">root</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>         <span class="c1">// Return string representation</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">emitter</span><span class="p">.</span><span class="n">c_str</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Cast ourselves to our CRTP base</span>
</span><span class='line'>      <span class="n">Base</span><span class="o">&amp;</span> <span class="n">self</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="n">Base</span><span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;string&gt;</span>
</span><span class='line'><span class="cp">#include &lt;sstream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;map&gt;</span>
</span><span class='line'><span class="cp">#include &lt;vector&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">yaml</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="n">test</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">struct</span> <span class="n">One</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">friend</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">extension</span><span class="o">::</span><span class="n">access</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">One</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>         <span class="n">two</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
</span><span class='line'>         <span class="n">three</span><span class="p">(</span><span class="mf">0.0</span><span class="p">),</span>
</span><span class='line'>         <span class="n">four</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">One</span><span class="p">(</span><span class="kt">int</span> <span class="n">a</span><span class="p">,</span> <span class="kt">double</span> <span class="n">b</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">c</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>         <span class="n">two</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
</span><span class='line'>         <span class="n">three</span><span class="p">(</span><span class="n">b</span><span class="p">),</span>
</span><span class='line'>         <span class="n">four</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">int</span> <span class="n">two</span><span class="p">;</span>
</span><span class='line'>      <span class="kt">double</span> <span class="n">three</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">private</span><span class="o">:</span>
</span><span class='line'>      <span class="kt">bool</span> <span class="n">four</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">struct</span> <span class="n">Five</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Yaml</span><span class="o">&lt;</span><span class="n">Five</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">One</span><span class="o">&gt;</span> <span class="n">Map_t</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Map_t</span> <span class="n">six</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">One</span><span class="o">&gt;</span> <span class="n">Vector_t</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Vector_t</span> <span class="n">seven</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">eight</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="n">Matrix_t</span><span class="p">;</span>
</span><span class='line'>      <span class="n">Matrix_t</span> <span class="n">nine</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>   <span class="n">test</span><span class="o">::</span><span class="n">One</span><span class="p">,</span>
</span><span class='line'>   <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="kt">double</span><span class="p">,</span> <span class="n">three</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="n">four</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>   <span class="n">test</span><span class="o">::</span><span class="n">Five</span><span class="p">,</span>
</span><span class='line'>   <span class="p">(</span><span class="n">test</span><span class="o">::</span><span class="n">Five</span><span class="o">::</span><span class="n">Map_t</span><span class="p">,</span> <span class="n">six</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="n">test</span><span class="o">::</span><span class="n">Five</span><span class="o">::</span><span class="n">Vector_t</span><span class="p">,</span> <span class="n">seven</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span> <span class="n">eight</span><span class="p">)</span>
</span><span class='line'>   <span class="p">(</span><span class="n">test</span><span class="o">::</span><span class="n">Five</span><span class="o">::</span><span class="n">Matrix_t</span><span class="p">,</span> <span class="n">nine</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">using</span> <span class="k">namespace</span> <span class="n">test</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Five</span> <span class="n">v</span><span class="p">;</span>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">six</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="mi">123</span><span class="p">,</span> <span class="n">One</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mf">6.6</span><span class="p">,</span> <span class="kc">true</span><span class="p">)));</span>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">six</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_pair</span><span class="p">(</span><span class="mi">456</span><span class="p">,</span> <span class="n">One</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mf">8.8</span><span class="p">,</span> <span class="kc">false</span><span class="p">)));</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">seven</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">One</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">seven</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">One</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="kc">true</span><span class="p">));</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">eight</span> <span class="o">=</span> <span class="s">&quot;eight&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span> <span class="n">temp</span><span class="p">;</span>
</span><span class='line'>   <span class="n">temp</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">2.3</span><span class="p">);</span>
</span><span class='line'>   <span class="n">temp</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mf">4.5</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">nine</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">nine</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">to_yaml</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">to_json</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">///////////////////////////////////////////</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;==============&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;six:            </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  234:          </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    two: 4      </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    three: 5.5  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    four: true  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  345:          </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    two: 6      </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    three: 7.7  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    four: false </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;seven:          </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  - two: 8      </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    three: 9.9  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    four: true  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  - two: 2      </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    three: 3.3  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    four: true  </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;eight: nine     </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;nine:           </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  -             </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    - 3.4       </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    - 5.6       </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;  -             </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    - 7.8       </span><span class="se">\n</span><span class="s">&quot;</span>
</span><span class='line'>      <span class="o">&lt;&lt;</span> <span class="s">&quot;    - 9.0       </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">v</span><span class="p">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">.</span><span class="n">to_yaml</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>



<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="https://github.com/jbeder/yaml-cpp">Yaml-cpp</a> &ndash; Jesse Beder<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/08/02/singletons/">Singletons</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-08-02T15:55:58-04:00" pubdate data-updated="true">Aug 2<span>nd</span>, 2015</time>
        
           | <a href="/blog/2015/08/02/singletons/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/08/02/singletons/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The Singleton pattern is a design pattern that restricts the instantiation of a class to one object. It is typically used for solving the problem of resource contention, such that you need to manage a single instance of a resource. Singletons are misunderstood and difficult to implement correctly, hopefully this post can clear things up.</p>

<p>It is known as an anti-pattern in that it is often misused or abused to the point where it can have a negative effect on a code base. Opponents to Singletons compare them to global variables, but that is not entirely true; As an object-oriented pattern, they can implement interfaces and be subclassed, which gives them more useful properties than a normal global. That said, Singletons are considered harmful<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> for a variety of reasons:</p>

<ul>
<li>Singletons make code hard to follow</li>
<li>Singletons make code hard to test</li>
<li>Singletons make code hard to maintain</li>
<li>Singletons make code hard to secure</li>
</ul>


<p>The reason for this is because the use of a Singleton hides the dependency from the interface, giving program flow a path that is not easily visible.</p>

<blockquote><p>Singletons are nothing more than global state. Global state makes it so your objects can secretly get hold of things which are not declared in their APIs, and, as a result, Singletons make your APIs into pathological liars. If you are the person who built the code originally, you know the true dependencies, but anyone who comes after you is baffled.<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup></p></blockquote>

<p>Note that there is a difference between having a single object and having a Singleton. Passing around a single instance to share among your classes via constructor references is known as dependency injection, and is a cleaner solution for most problems that a Singleton can solve. Take the following for example:</p>

<pre><code>// Singleton approach
Constructor(void)
{
    this-&gt;single_instance = Singleton::instance()
}

// Dependency Injection approach
Constructor(SingleInstance&amp; instance) :
    single_instance(instance)
{

}
</code></pre>

<p>With the second approach, it becomes very clear from the interface that the object depends on SingleInstance. This dependency is hidden with the first approach. The second approach can also be tested easier by subclassing the SingleInstance to make a testable version.</p>

<p>Still, there are cases where Singletons are very useful:</p>

<ul>
<li>Debug Logging</li>
<li>Memory Pools</li>
<li>Factories

<ul>
<li><a href="https://sourcemaking.com/design_patterns/abstract_factory">Abstract Factory</a></li>
<li><a href="https://sourcemaking.com/design_patterns/builder">Builder</a></li>
<li><a href="https://sourcemaking.com/design_patterns/prototype">Prototype</a></li>
</ul>
</li>
</ul>


<p>In these types of situations, there is one object that has a single responsibility and must be accessible from anywhere. In particular, a memory pool using a Singleton is not very different from allocating memory from the heap using the global <code>::operator new</code>.</p>

<p>Configuration is sometimes done with Singletons, however this isn&rsquo;t considered a good practice. Dependency injection is typically a better way to handle passing configuration through your program.</p>

<h2>Creating a Singleton</h2>

<p>Singletons conform to the following conditions<sup id="fnref:3"><a href="#fn:3" rel="footnote">3</a></sup>:</p>

<ul>
<li>Private static attribute in the class.</li>
<li>Public static accessor function in the class.</li>
<li>Perform creation on first use in the accessor function.</li>
<li>All constructors are protected or private.</li>
<li>Clients may only use the accessor function to manipulate the Singleton.</li>
</ul>


<p>Creating a Singleton is much harder than it appears, and there are very subtle considerations that are easy to miss or implement incorrectly. A few examples are:</p>

<ul>
<li>Lazy instantiation</li>
<li>Proper destruction</li>
<li>Thread safety</li>
<li>Instruction reordering</li>
</ul>


<p>A first cut at a Singleton may look something like this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Singleton</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pointer</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">pointer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Singleton</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">T</span><span class="o">*</span> <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span><span class="o">*</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Hello</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'>   <span class="o">~</span><span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Goodbye!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning of main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Running this produces the following output:</p>

<pre><code>Beginning of main
Hello!
0x1e2a370 : 0x1e2a370
</code></pre>

<p>Notice the following:</p>

<ul>
<li>The constructor was only called once</li>
<li>The addresses are the same, meaning there is only one object</li>
<li>The destructor was never called</li>
<li>The object was created lazily (on first request)</li>
</ul>


<blockquote><p><strong>Return a pointer or reference?</strong><br/>
The advantage to returning a reference instead of a pointer is:</p>

<ul>
<li>You can be assured that there won&rsquo;t be a null pointer</li>
<li>The user will be unable to delete the pointer</li>
<li>No need to dereference to use overloaded operators</li>
</ul>
</blockquote>

<p>This falls apart when multi-threading is introduced. Consider the following events:</p>

<ol>
<li>Thread 1 may get through line 8</li>
<li>Thread 2 could pass all the way through to line 14</li>
<li>Thread 1 then performs line 10 again</li>
</ol>


<p>This situation causes two <code>T</code>&rsquo;s plus a memory leak. Furthermore, both threads are now pointing at different objects.</p>

<p>To make it thread safe, a mutex can be used:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number marked'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number marked'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number marked'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='cpp'><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/thread/mutex.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Singleton</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line marked start end'>      <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span><span class="o">::</span><span class="n">scoped_lock</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pointer</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">pointer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Singleton</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">T</span><span class="o">*</span> <span class="n">pointer</span><span class="p">;</span>
</span><span class='line marked start end'>   <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span><span class="o">*</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line marked start end'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">mutex</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Hello</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'>   <span class="o">~</span><span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Goodbye!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning of main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, only one thread is able to pass line 10 at a time, making the logic that follows thread safe. However, mutexes are expensive to acquire, and every call to <code>instance</code> requires locking the mutex, even though it really only needs to be locked when the object needs to be created the very first time. So a common thing to do is check whether the instance needs to be created before locking the mutex:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number marked'>11</span>
<span class='line-number marked'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number marked'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line marked start'>   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pointer</span><span class="p">)</span>
</span><span class='line marked end'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span><span class="o">::</span><span class="n">scoped_lock</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pointer</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">pointer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line marked start end'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">return</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This approach is called the Double-Checked Locking Pattern, or DCLP.</p>

<h2>The Double-Checked Locking Pattern is Unsafe</h2>

<p>Scott Meyers and Andrei Alexandrescu have discussed<sup id="fnref:4"><a href="#fn:4" rel="footnote">4</a></sup> the subtle issues with DCLP. Their paper as an interesting read; the problems boil down to the fact that the compiler may reorder instructions or the hardware may reorder memory accesses, and there was no way to express these constraints using the C++ language at the time (C++11 fixes these issues, as we will see later).</p>

<p>For example, the compiler may do the following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number marked'>17</span>
<span class='line-number marked'>18</span>
<span class='line-number marked'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pointer</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span><span class="o">::</span><span class="n">scoped_lock</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pointer</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line marked start'>         <span class="n">pointer</span> <span class="o">=</span>                     <span class="c1">// 3</span>
</span><span class='line marked'>            <span class="o">::</span><span class="k">operator</span> <span class="k">new</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span> <span class="c1">// 1</span>
</span><span class='line marked end'>         <span class="k">new</span> <span class="p">(</span><span class="n">pointer</span><span class="p">)</span> <span class="n">T</span><span class="p">();</span>            <span class="c1">// 2</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="k">return</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here, the actual construction is broken down into three steps:</p>

<ol>
<li>Allocating memory for the object</li>
<li>Constructing the object</li>
<li>Assigning the pointer to the memory</li>
</ol>


<p>The paper claims that DCLP can only work if steps 1 and 2 are completed before step 3, however the compiler&rsquo;s optimizer is free to perform step 3 after step 1. This means there could be a brief moment where the pointer is pointing to allocated memory, but an unconstructed object. Imagine the following scenario:</p>

<ol>
<li>Thread 1 may get through line 10 (completing steps 1 and 3, but not 2)</li>
<li>Thread 2 gets to line 3, passes the check, and skips to line 15, returning an unconstructed object</li>
</ol>


<p>This type of bug is very subtle and not obvious to the developer. Furthermore, these types of crashes are virtually impossible to track down.</p>

<h2>Fixing the Double-Checked Locking Pattern</h2>

<p>One way to get around the multi-threaded issues is to have one object for each thread, instead of one object globally. A per-thread Singleton<sup id="fnref:5"><a href="#fn:5" rel="footnote">5</a></sup> can be implemented like this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/thread.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ThreadSingleton</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">thread_specific_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pointer</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>           <span class="n">pointer</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">T</span><span class="p">());</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">return</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">ThreadSingleton</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Hello</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'>   <span class="o">~</span><span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Goodbye!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">run</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">ThreadSingleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">ThreadSingleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Thread 2: &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning of main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">boost</span><span class="o">::</span><span class="kr">thread</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">run</span><span class="p">);</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">ThreadSingleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">ThreadSingleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Thread 1: &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="kr">thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice how this method is closer to what we initially started with: A single check with no mutex. Because the thread specific pointer will never be accessed concurrently by multiple threads, this solution is inherently thread safe. Here are there results of running this code:</p>

<pre><code>Beginning of main
Hello!
Thread 1: 0x17d96e0 : 0x17d96e0
Hello!
Thread 2: 0x7f7c500008c0 : 0x7f7c500008c0
Goodbye!
Goodbye!
</code></pre>

<p>As you can see, each thread creates (and destroys) its per-thread Singleton. You can see that each Singleton has a different address as well.</p>

<blockquote><p><strong>Warning</strong><br/>
Thread specific pointers should always be static. They use their address as the key to establish uniqueness. A program storing their thread specific pointer on the stack will have issues when two threads reach the same point in the program, because their addresses on the stack will match (remember that each thread has its own stack). This will cause the two pointers to believe they are pointing at the same<sup id="fnref:6"><a href="#fn:6" rel="footnote">6</a></sup>.</p></blockquote>

<p>In some cases, this solution is acceptable. Most times, a true global Singleton is desired.</p>

<p>The paper claims that the DCLP can be made safe with the addition of memory fences. These provide guarantees that reads will not be reordered before writes.
The C++11 standard includes this capability, and Boost has made it available to C++03.
In fact, Boost provides a solution in their documentation<sup id="fnref:7"><a href="#fn:7" rel="footnote">7</a></sup> (modified to match the templated format used earlier):</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number marked'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number marked'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number marked'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number marked'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number marked'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/atomic.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/thread/mutex.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Singleton</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line marked start end'>      <span class="n">T</span><span class="o">*</span> <span class="n">pointer</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">memory_order_consume</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pointer</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span><span class="o">::</span><span class="n">scoped_lock</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line marked start end'>         <span class="n">pointer</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">memory_order_consume</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">pointer</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="n">pointer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line marked start end'>            <span class="n">storage</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Singleton</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line marked start end'>   <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span> <span class="n">storage</span><span class="p">;</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line marked start end'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">storage</span><span class="p">;</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">mutex</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Hello</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'>   <span class="o">~</span><span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Goodbye!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning of main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Enhancing the Singleton</h2>

<p>We still have the problem that the destructor is never called. The solution to this is to convert the raw pointer into a scoped_ptr. However, the atomics can only be used with primitive types. We need to apply some<sup id="fnref:8"><a href="#fn:8" rel="footnote">8</a></sup> transformations<sup id="fnref:9"><a href="#fn:9" rel="footnote">9</a></sup> to the code to decouple the atomic from the pointer:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/atomic.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/thread/mutex.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Singleton</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="kt">bool</span> <span class="n">created</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">memory_order_consume</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">created</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span><span class="o">::</span><span class="n">scoped_lock</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">created</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">memory_order_consume</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">created</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="n">pointer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">T</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">storage</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Singleton</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">T</span><span class="o">*</span> <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">storage</span><span class="p">;</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">T</span><span class="o">*</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">storage</span><span class="p">;</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">mutex</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Hello</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'>   <span class="o">~</span><span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Goodbye!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning of main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that the pointer is separated from the atomic, we can replace the pointer with the scoped pointer to get the following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number marked'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number marked'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number marked'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// dclp.cpp</span>
</span><span class='line'><span class="c1">// Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c1">// it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c1">// the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c1">// (at your option) any later version.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c1">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c1">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c1">// GNU General Public License for more details.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c1">// along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/atomic.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/thread/mutex.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/scoped_ptr.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Singleton</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="kt">bool</span> <span class="n">created</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">memory_order_consume</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">created</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span><span class="o">::</span><span class="n">scoped_lock</span> <span class="n">lock</span><span class="p">(</span><span class="n">mutex</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="n">created</span> <span class="o">=</span> <span class="n">storage</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">memory_order_consume</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">created</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line marked start end'>            <span class="n">pointer</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">T</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>            <span class="n">storage</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Singleton</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line marked start end'>   <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">storage</span><span class="p">;</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line marked start end'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">storage</span><span class="p">;</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="n">boost</span><span class="o">::</span><span class="n">mutex</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">mutex</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Hello</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'>   <span class="o">~</span><span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Goodbye!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning of main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>At this point we have a flexible and safe implementation of the DCLP. The output is:</p>

<pre><code>Beginning of main
Hello!
0x19626e0 : 0x19626e0
Goodbye!
</code></pre>

<h2>Boost Pool Method</h2>

<p>As I mentioned, I needed a Singleton for a memory pool. Naturally, I decided to see how Boost handles this for their own pool. I searched for all the boost include files with Singleton in their name:</p>

<pre><code>$ find /usr/include/boost/ -name '*singleton*' -type f

/usr/include/boost/log/detail/singleton.hpp
/usr/include/boost/test/utils/trivial_singleton.hpp
/usr/include/boost/accumulators/numeric/detail/pod_singleton.hpp
/usr/include/boost/thread/detail/singleton.hpp
/usr/include/boost/pool/singleton_pool.hpp
/usr/include/boost/serialization/singleton.hpp
/usr/include/boost/interprocess/detail/windows_intermodule_singleton.hpp
/usr/include/boost/interprocess/detail/intermodule_singleton.hpp
/usr/include/boost/interprocess/detail/intermodule_singleton_common.hpp
/usr/include/boost/interprocess/detail/portable_intermodule_singleton.hpp
</code></pre>

<p>Then I used my IDE to dive into each one and see how it was implemented:</p>

<pre><code>#include &lt;boost/log/detail/singleton.hpp&gt;                      // Call once method
#include &lt;boost/test/utils/trivial_singleton.hpp&gt;              // Meyer's method
#include &lt;boost/accumulators/numeric/detail/pod_singleton.hpp&gt; // Static method
#include &lt;boost/thread/detail/singleton.hpp&gt;                   // Meyer's method
#include &lt;boost/pool/singleton_pool.hpp&gt;                       // Pool method
#include &lt;boost/serialization/singleton.hpp&gt;                   // Meyer's method
</code></pre>

<p>The Meyer&rsquo;s method and the call once method will be discussed later. The static method is simply a wrapper to make something static and isn&rsquo;t particularly interesting:</p>

<pre><code>template&lt;typename T&gt;
struct pod_singleton
{
    static T instance;
};

template&lt;typename T&gt; 
T pod_singleton&lt;T&gt;::instance;
</code></pre>

<p>The real interesting method, that I haven&rsquo;t seen anywhere else yet, is the Boost Pool method. The code included in the later versions of Boost (~1.55) is more difficult to read, however a version from 1.39<sup id="fnref:10"><a href="#fn:10" rel="footnote">10</a></sup> is very clear and well commented. The code is repeated below with some minor adjustments:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Copyright (C) 2000 Stephen Cleary</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// Distributed under the Boost Software License, Version 1.0. (See</span>
</span><span class='line'><span class="c1">// accompanying file LICENSE_1_0.txt or copy at</span>
</span><span class='line'><span class="c1">// http://www.boost.org/LICENSE_1_0.txt)</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// See http://www.boost.org for updates, documentation, and revision history.</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The following helper classes are placeholders for a generic &quot;singleton&quot;</span>
</span><span class='line'><span class="c1">//  class.  The classes below support usage of singletons, including use in</span>
</span><span class='line'><span class="c1">//  program startup/shutdown code, AS LONG AS there is only one thread</span>
</span><span class='line'><span class="c1">//  running before main() begins, and only one thread running after main()</span>
</span><span class='line'><span class="c1">//  exits.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This class is also limited in that it can only provide singleton usage for</span>
</span><span class='line'><span class="c1">//  classes with default constructors.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The design of this class is somewhat twisted, but can be followed by the</span>
</span><span class='line'><span class="c1">//  calling inheritance.  Let us assume that there is some user code that</span>
</span><span class='line'><span class="c1">//  calls &quot;singleton_default&lt;T&gt;::instance()&quot;.  The following (convoluted)</span>
</span><span class='line'><span class="c1">//  sequence ensures that the same function will be called before main():</span>
</span><span class='line'><span class="c1">//    instance() contains a call to create_object.do_nothing()</span>
</span><span class='line'><span class="c1">//    Thus, object_creator is implicitly instantiated, and create_object</span>
</span><span class='line'><span class="c1">//      must exist.</span>
</span><span class='line'><span class="c1">//    Since create_object is a static member, its constructor must be</span>
</span><span class='line'><span class="c1">//      called before main().</span>
</span><span class='line'><span class="c1">//    The constructor contains a call to instance(), thus ensuring that</span>
</span><span class='line'><span class="c1">//      instance() will be called before main().</span>
</span><span class='line'><span class="c1">//    The first time instance() is called (i.e., before main()) is the</span>
</span><span class='line'><span class="c1">//      latest point in program execution where the object of type T</span>
</span><span class='line'><span class="c1">//      can be created.</span>
</span><span class='line'><span class="c1">//    Thus, any call to instance() will auto-magically result in a call to</span>
</span><span class='line'><span class="c1">//      instance() before main(), unless already present.</span>
</span><span class='line'><span class="c1">//  Furthermore, since the instance() function contains the object, instead</span>
</span><span class='line'><span class="c1">//  of the singleton_default class containing a static instance of the</span>
</span><span class='line'><span class="c1">//  object, that object is guaranteed to be constructed (at the latest) in</span>
</span><span class='line'><span class="c1">//  the first call to instance().  This permits calls to instance() from</span>
</span><span class='line'><span class="c1">//  static code, even if that code is called before the file-scope objects</span>
</span><span class='line'><span class="c1">//  in this file have been initialized.</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// T must be: no-throw default constructible and no-throw destructible</span>
</span><span class='line'><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Singleton</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">struct</span> <span class="n">object_creator</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="c1">// This constructor does nothing more than ensure that instance()</span>
</span><span class='line'>      <span class="c1">//  is called before main() begins, thus creating the static</span>
</span><span class='line'>      <span class="c1">//  T object before multithreading race issues can come up.</span>
</span><span class='line'>      <span class="n">object_creator</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kr">inline</span> <span class="kt">void</span> <span class="n">do_nothing</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span> <span class="p">{}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">object_creator</span> <span class="n">create_object</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">Singleton</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">typedef</span> <span class="n">T</span> <span class="n">object_type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// If, at any point (in user code), singleton_default&lt;T&gt;::instance()</span>
</span><span class='line'>    <span class="c1">//  is called, then the following function is instantiated.</span>
</span><span class='line'>    <span class="k">static</span> <span class="n">object_type</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="c1">// This is the object that we return a reference to.</span>
</span><span class='line'>      <span class="c1">// It is guaranteed to be created before main() begins because of</span>
</span><span class='line'>      <span class="c1">//  the next line.</span>
</span><span class='line'>      <span class="k">static</span> <span class="n">object_type</span> <span class="n">obj</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// The following line does nothing else than force the instantiation</span>
</span><span class='line'>      <span class="c1">//  of singleton_default&lt;T&gt;::create_object, whose constructor is</span>
</span><span class='line'>      <span class="c1">//  called before main() begins.</span>
</span><span class='line'>      <span class="n">create_object</span><span class="p">.</span><span class="n">do_nothing</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="n">obj</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">typename</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">object_creator</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">create_object</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Hello</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'>   <span class="o">~</span><span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Goodbye!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning of main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>And the output:</p>

<pre><code>Hello!
Beginning of main
0x64dc88 : 0x64dc88
Goodbye!
</code></pre>

<p>Notice that this method does not use lazy instantiation, but rather it uses <em>eager instantiation</em>, meaning the Singleton is created before <code>main</code> is called. In addition, it properly calls the destructor and is thread safe without any locks or atomics. Despite the author describing this method as &ldquo;twisted&rdquo;, I think it is rather elegant. Unfortunately, it lacks the ability to do per-thread singletons, and its eager instantiation is a drawback.</p>

<h2>Meyer&rsquo;s Method (C++11)</h2>

<p>Things get much easier in C++11. Scott Meyers introduced a very simple and elegant Singleton back in 1996<sup id="fnref:11"><a href="#fn:11" rel="footnote">11</a></sup>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Singleton</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">static</span> <span class="n">T</span> <span class="n">singleton</span><span class="p">;</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">singleton</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>   <span class="n">Singleton</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Hello</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'>   <span class="o">~</span><span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Goodbye!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning of main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Outputs:</p>

<pre><code>Beginning of main
Hello!
0x64dc78 : 0x64dc78
Goodbye!
</code></pre>

<p>This method is only thread safe with C++11 and up. It uses lazy instantiation, properly calls the destructor, and doesn&rsquo;t use any mutexes or atomics. With C++11, it is now considered the correct way to implement a Singleton.</p>

<h2>Boost Call Once Method</h2>

<p>Meyer&rsquo;s Singleton cannot be used in C++03, but we can get pretty close to it using Boost&rsquo;s <code>call_once</code> capabilities.</p>

<blockquote><p><strong>boost::call_once</strong><br/>
The call_once function and once_flag type (statically initialized to BOOST_ONCE_INIT) can be used to run a routine exactly once. This can be used to initialize data in a thread-safe manner.<sup id="fnref:12"><a href="#fn:12" rel="footnote">12</a></sup></p></blockquote>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/scoped_ptr.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/thread/once.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/noncopyable.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Singleton</span> <span class="o">:</span> <span class="k">private</span> <span class="n">boost</span><span class="o">::</span><span class="n">noncopyable</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">boost</span><span class="o">::</span><span class="n">call_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Singleton</span><span class="o">::</span><span class="n">create</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Singleton</span><span class="p">(</span><span class="kt">void</span><span class="p">){}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">pointer</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">T</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">once_flag</span> <span class="n">flag</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="n">boost</span><span class="o">::</span><span class="n">once_flag</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">flag</span> <span class="o">=</span> <span class="n">BOOST_ONCE_INIT</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Hello</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'>   <span class="o">~</span><span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Goodbye!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning of main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Output:</p>

<pre><code>Beginning of main
Hello!
0x1d20370 : 0x1d20370
Goodbye!
</code></pre>

<h2>My Method</h2>

<p>I&rsquo;m a pretty big fan of the <code>call_once</code> method:</p>

<ul>
<li>Avoids the complications of DCLP</li>
<li>Aligns with the preferred C++11 standard method of achieving a Singleton</li>
<li>Works with C++03</li>
<li>Properly handles destruction</li>
<li>Properly handles multi-threading</li>
<li>Employs lazy instantiation</li>
</ul>


<p>With some clever manipulations, we can also get this to work as a per-thread singleton:</p>

<ol>
<li>Template the pointer type</li>
<li>Store the once flag inside a pointer</li>
<li>Move the code to a base class</li>
<li>Specialize an implementation for each supported pointer type</li>
<li>Thread specific pointers should check if their flag is null when getting an instance</li>
</ol>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// singleton.cpp</span>
</span><span class='line'><span class="c1">// Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c1">// it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c1">// the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c1">// (at your option) any later version.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c1">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c1">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c1">// GNU General Public License for more details.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c1">// along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;boost/scoped_ptr.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/thread/once.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/thread/tss.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/noncopyable.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">namespace</span> <span class="n">detail</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">P</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">class</span> <span class="nc">SingletonImpl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span>
</span><span class='line'>            <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">pointer_type</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">class</span> <span class="nc">SingletonBase</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>   <span class="k">protected</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">reference</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">once_flag</span><span class="o">&amp;</span> <span class="n">flag</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">boost</span><span class="o">::</span><span class="n">call_once</span><span class="p">(</span><span class="o">&amp;</span><span class="n">SingletonBase</span><span class="o">::</span><span class="n">create</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
</span><span class='line'>         <span class="k">return</span> <span class="o">*</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">static</span> <span class="kt">void</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">pointer</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">T</span><span class="p">());</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="p">,</span> <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">U</span><span class="o">&gt;</span> <span class="k">class</span> <span class="nc">P</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">SingletonBase</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">P</span><span class="o">&gt;::</span><span class="n">pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">class</span> <span class="nc">SingletonImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">:</span> <span class="k">public</span> <span class="n">SingletonBase</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>   <span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="k">return</span> <span class="n">SingletonImpl</span><span class="o">::</span><span class="n">reference</span><span class="p">(</span><span class="o">*</span><span class="n">once_flag_ptr</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">protected</span><span class="o">:</span>
</span><span class='line'>      <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">once_flag</span><span class="o">&gt;</span> <span class="n">once_flag_ptr</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">once_flag</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">SingletonImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&gt;::</span><span class="n">once_flag_ptr</span><span class="p">(</span><span class="k">new</span> <span class="n">boost</span><span class="o">::</span><span class="n">once_flag</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">class</span> <span class="nc">SingletonImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">thread_specific_ptr</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="o">:</span> <span class="k">public</span> <span class="n">SingletonBase</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">thread_specific_ptr</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>   <span class="k">public</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">static</span> <span class="n">T</span><span class="o">&amp;</span> <span class="n">instance</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">once_flag_ptr</span><span class="p">.</span><span class="n">get</span><span class="p">())</span>
</span><span class='line'>            <span class="n">once_flag_ptr</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span> <span class="n">boost</span><span class="o">::</span><span class="n">once_flag</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">return</span> <span class="n">SingletonImpl</span><span class="o">::</span><span class="n">reference</span><span class="p">(</span><span class="o">*</span><span class="n">once_flag_ptr</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">protected</span><span class="o">:</span>
</span><span class='line'>      <span class="k">static</span> <span class="n">boost</span><span class="o">::</span><span class="n">thread_specific_ptr</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">once_flag</span><span class="o">&gt;</span> <span class="n">once_flag_ptr</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">boost</span><span class="o">::</span><span class="n">thread_specific_ptr</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">once_flag</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">SingletonImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">thread_specific_ptr</span><span class="o">&gt;::</span><span class="n">once_flag_ptr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Singleton</span> <span class="o">:</span> <span class="k">public</span> <span class="n">detail</span><span class="o">::</span><span class="n">SingletonImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">scoped_ptr</span><span class="o">&gt;</span><span class="p">{};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">class</span> <span class="nc">ThreadSingleton</span> <span class="o">:</span> <span class="k">public</span> <span class="n">detail</span><span class="o">::</span><span class="n">SingletonImpl</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">thread_specific_ptr</span><span class="o">&gt;</span><span class="p">{};</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/thread.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Hello</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Hello!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'>   <span class="o">~</span><span class="n">Hello</span><span class="p">(</span><span class="kt">void</span><span class="p">){</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Goodbye!&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">void</span> <span class="n">run</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">ThreadSingleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">ThreadSingleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Thread 2: &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Beginning of main&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="n">boost</span><span class="o">::</span><span class="kr">thread</span> <span class="kr">thread</span> <span class="o">=</span> <span class="n">boost</span><span class="o">::</span><span class="kr">thread</span><span class="p">(</span><span class="o">&amp;</span><span class="n">run</span><span class="p">);</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">Hello</span><span class="o">&amp;</span> <span class="n">hello2</span> <span class="o">=</span> <span class="n">Singleton</span><span class="o">&lt;</span><span class="n">Hello</span><span class="o">&gt;::</span><span class="n">instance</span><span class="p">();</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Thread 1: &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello</span> <span class="o">&lt;&lt;</span> <span class="s">&quot; : &quot;</span> <span class="o">&lt;&lt;</span> <span class="o">&amp;</span><span class="n">hello2</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="kr">thread</span><span class="p">.</span><span class="n">join</span><span class="p">();</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Outputs:</p>

<pre><code>Beginning of main
Hello!
Thread 1: 0x109a700 : 0x109a700
Hello!
Thread 2: 0x7f9528000930 : 0x7f9528000930
Goodbye!
Goodbye!
</code></pre>

<p>And there you have it. Sometimes Singletons are good, sometimes they are evil, and sometimes they are difficult to implement correctly. Hopefully now you understand a little more about this pattern.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="http://www.object-oriented-security.org/lets-argue/singletons">Singletons Considered Harmful</a> &ndash; Kenton Varda<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="http://misko.hevery.com/2008/08/17/singletons-are-pathological-liars/">Singletons are Pathological Liars</a> &ndash; Misko Hevery<a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
<li id="fn:3">
<p><a href="https://sourcemaking.com/design_patterns/singleton">Singleton Design Pattern</a><a href="#fnref:3" rev="footnote">&#8617;</a></p></li>
<li id="fn:4">
<p><a href="http://www.aristeia.com/Papers/DDJ_Jul_Aug_2004_revised.pdf">C++ and the Perils of Double-Checked Locking</a> &ndash; Scott Meyers and Andrei Alexandrescu<a href="#fnref:4" rev="footnote">&#8617;</a></p></li>
<li id="fn:5">
<p><a href="http://www.gameafar.com/gaffer/singletons">Two Useful Singleton Templates</a> &ndash; Lachlan Orr<a href="#fnref:5" rev="footnote">&#8617;</a></p></li>
<li id="fn:6">
<p><a href="http://www.mr-edd.co.uk/blog/thread_specific_ptr_problem">A problem with boost::thread_specific_ptr</a> &ndash; Edd Dawson<a href="#fnref:6" rev="footnote">&#8617;</a></p></li>
<li id="fn:7">
<p><a href="http://www.boost.org/doc/libs/1_58_0/doc/html/atomic/usage_examples.html#boost_atomic.usage_examples.singleton">Boost Atomic Usage Examples</a><a href="#fnref:7" rev="footnote">&#8617;</a></p></li>
<li id="fn:8">
<p><a href="http://preshing.com/20130922/acquire-and-release-fences/">Acquire and Release Fences</a> &ndash; Jeff Preshing<a href="#fnref:8" rev="footnote">&#8617;</a></p></li>
<li id="fn:9">
<p><a href="http://stackoverflow.com/questions/30587666/is-this-implementation-of-double-checked-lock-pattern-dclp-in-c11-is-correct">Is this implementation of DCLP in C++11 correct?</a> &ndash; User TCS<a href="#fnref:9" rev="footnote">&#8617;</a></p></li>
<li id="fn:10">
<p><a href="http://www.boost.org/doc/libs/1_39_0/boost/pool/detail/singleton.hpp">Boost Pool Singleton</a> &ndash; Stephen Cleary<a href="#fnref:10" rev="footnote">&#8617;</a></p></li>
<li id="fn:11">
<p><a href="http://www.devarticles.com/c/a/Cplusplus/C-plus-plus-In-Theory-The-Singleton-Pattern-Part-I/4/">The Meyers Singleton</a> &ndash; Scott Meyers<a href="#fnref:11" rev="footnote">&#8617;</a></p></li>
<li id="fn:12">
<p><a href="http://www.boost.org/doc/libs/1_32_0/doc/html/call_once.html">Boost Call Once</a><a href="#fnref:12" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/07/01/object-counter/">Object Counter</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-07-01T17:47:47-04:00" pubdate data-updated="true">Jul 1<span>st</span>, 2015</time>
        
           | <a href="/blog/2015/07/01/object-counter/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/07/01/object-counter/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post presents a lightweight generic object counter in C++. Object counters count the number of objects that have been created, as well as how many bytes they are utilizing. They are a handy way to get a sense of application health programatically as well as detect memory leaks with unit tests.</p>

<p>The code itself doesn&rsquo;t have any dependencies (not even Boost!). The example however uses Boost smart pointers, so you need the following installed to run it:</p>

<ul>
<li>libboost-dev</li>
</ul>


<p>This object counter is loosely modeled after Scott Meyer&rsquo;s<sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup> counter, with the following differences:</p>

<ul>
<li>Tracks creations as well as active objects, useful for determining if lots of copies are happening.</li>
<li>Tracks allocations on the heap</li>
<li>Tracks number of bytes allocated for the object</li>
</ul>


<p>The code itself is pretty straightforward:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;cstddef&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">ObjectCounter</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">Count</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">Count</span> <span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">Count</span> <span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">Count</span> <span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">Count</span> <span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="n">Count</span> <span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>   <span class="k">static</span> <span class="n">Count</span> <span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">ObjectCounter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="o">++</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>      <span class="o">++</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>      <span class="n">bytes_allocated</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Type</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">ObjectCounter</span><span class="p">(</span><span class="n">ObjectCounter</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">other</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="o">++</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>      <span class="o">++</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>      <span class="n">bytes_allocated</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Type</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="o">~</span><span class="n">ObjectCounter</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="o">--</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>      <span class="n">bytes_allocated</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Type</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="kt">void</span><span class="o">*</span> <span class="k">operator</span> <span class="k">new</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">bytes</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="o">++</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="o">++</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">bytes_allocated_on_heap</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Type</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="o">::</span><span class="k">operator</span> <span class="k">new</span><span class="p">(</span><span class="n">bytes</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="kt">void</span> <span class="k">operator</span> <span class="k">delete</span><span class="p">(</span><span class="kt">void</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="o">--</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">bytes_allocated_on_heap</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Type</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">return</span> <span class="o">::</span><span class="k">operator</span> <span class="k">delete</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="kt">void</span> <span class="n">reset</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">objects_created</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">objects_created_on_heap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">objects_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">objects_active_on_heap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">bytes_allocated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>      <span class="n">bytes_allocated_on_heap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">typename</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">Count</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">typename</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">Count</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">typename</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">Count</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">typename</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">Count</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">typename</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">Count</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span> <span class="k">typename</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">Count</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the object counter is simple: just inherit from it, and everything else happens automatically.</p>

<p>One very nice thing about this class is that it doesn&rsquo;t have any non-static data members. That means that inheriting from it allows the compiler to perform the <em>empty base optimization</em>, which means the inheriting object does not increase in size at all!</p>

<blockquote><p><strong>No Virtual Destructor?</strong><br/>
Technically, classes that are intended to be inherited are supposed to define a virtual destructor to ensure that the derived class&#8217; memory gets cleaned up if it is deleted through a pointer to the base class. Doing this causes the object counter to no longer be empty, and I don&rsquo;t want to give that up. The object counter has one purpose, and developers should by convention not pass around object counter pointers.</p></blockquote>

<p>Time to test it out. Before that, I&rsquo;m going to introduce a little trick I learned from Evan Wallace<sup id="fnref:2"><a href="#fn:2" rel="footnote">2</a></sup> that gives us a nice Python-style print command to avoid all the <code>cout</code> boilerplate:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">namespace</span> <span class="n">__hidden__</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">struct</span> <span class="n">print</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">print</span><span class="p">()</span> <span class="o">:</span>
</span><span class='line'>         <span class="n">space</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="o">~</span><span class="n">print</span><span class="p">()</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>      <span class="n">print</span><span class="o">&amp;</span> <span class="k">operator</span><span class="p">,(</span><span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">space</span><span class="p">)</span> <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="sc">&#39; &#39;</span><span class="p">;</span>
</span><span class='line'>         <span class="k">else</span> <span class="n">space</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>         <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">t</span><span class="p">;</span>
</span><span class='line'>         <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="kt">bool</span> <span class="n">space</span><span class="p">;</span>
</span><span class='line'>   <span class="p">};</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#define print __hidden__::print(),</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is a really clever trick that I would like to expand upon in a future post. Back to our test code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">TestObject</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
</span><span class='line'>   <span class="n">byte</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// Store 4 bytes</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">Object</span> <span class="o">:</span> <span class="k">public</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="kt">char</span> <span class="n">byte</span><span class="p">;</span>
</span><span class='line'>   <span class="n">byte</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span> <span class="c1">// Store 4 bytes</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;Object size  :&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">TestObject</span><span class="p">)</span>           <span class="p">,</span> <span class="s">&quot;bytes&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;Counter size :&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span><span class="p">),</span> <span class="s">&quot;bytes&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;Total size   :&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">Object</span><span class="p">)</span>               <span class="p">,</span> <span class="s">&quot;bytes&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Increase scope</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// Create an object on the stack</span>
</span><span class='line'>      <span class="n">Object</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot;Single:&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects created         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects created on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects active          :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects active on heap  :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Bytes allocated         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Bytes allocated on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Create an array of objects on the stack</span>
</span><span class='line'>      <span class="n">Object</span> <span class="n">b</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot;Array:&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects created         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects created on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects active          :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects active on heap  :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Bytes allocated         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Bytes allocated on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Create a vector of objects on the stack</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>      <span class="n">c</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">Object</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot;Vector:&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects created         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects created on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects active          :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects active on heap  :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Bytes allocated         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Bytes allocated on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// Copy an object</span>
</span><span class='line'>      <span class="n">Object</span> <span class="n">d</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot;Copy:&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects created         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects created on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects active          :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects active on heap  :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Bytes allocated         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Bytes allocated on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="c1">// Objects are now gone</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;Out of Scope:&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects created         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects created on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects active          :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects active on heap  :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Bytes allocated         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Bytes allocated on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">reset</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;Reset:&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects created         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects created on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects active          :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects active on heap  :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Bytes allocated         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Bytes allocated on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Create an object on the heap</span>
</span><span class='line'>   <span class="n">Object</span><span class="o">*</span> <span class="n">a_ptr</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Object</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;New:&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects created         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects created on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects active          :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects active on heap  :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Bytes allocated         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Bytes allocated on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Delete an object from the heap</span>
</span><span class='line'>   <span class="k">delete</span> <span class="n">a_ptr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;Delete:&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects created         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects created on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects active          :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects active on heap  :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Bytes allocated         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Bytes allocated on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Create a smart pointer</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">b_ptr</span><span class="p">(</span><span class="k">new</span> <span class="n">Object</span><span class="p">());</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot;Smart Pointer:&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects created         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects created on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects active          :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Objects active on heap  :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Bytes allocated         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot; - Bytes allocated on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>      <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>   <span class="c1">// Smart pointer destroyed</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;Smart Pointer Destroyed:&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects created         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects created on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_created_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects active          :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Objects active on heap  :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">objects_active_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Bytes allocated         :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot; - Bytes allocated on heap :&quot;</span><span class="p">,</span> <span class="n">ObjectCounter</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;::</span><span class="n">bytes_allocated_on_heap</span><span class="p">;</span>
</span><span class='line'>   <span class="n">print</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This gives the following output:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">Object size</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4 bytes</span>
</span><span class='line'><span class="l-Scalar-Plain">Counter size</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1 bytes</span>
</span><span class='line'><span class="l-Scalar-Plain">Total size</span>   <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4 bytes</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Single</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active</span>          <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active on heap</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Array</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active</span>          <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active on heap</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">12</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Vector</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active</span>          <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active on heap</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">16</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Copy</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">6</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active</span>          <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">5</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active on heap</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">20</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Out of Scope</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">6</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active</span>          <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active on heap</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Reset</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active</span>          <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active on heap</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">New</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active</span>          <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active on heap</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Delete</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active</span>          <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active on heap</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Smart Pointer</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active</span>          <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active on heap</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">Smart Pointer Destroyed</span><span class="p-Indicator">:</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects created on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active</span>          <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Objects active on heap</span>  <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated</span>         <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Bytes allocated on heap</span> <span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Everything looks correct, but take a look at line 22 of the output. This is a case where a temporary copy happened when loading the object into the vector. These are cases where C++11&rsquo;s move semantics are able to help. The object counter&rsquo;s copy constructor could be modified to also track copies being made, that is left as an exercise for the reader.</p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="http://ptgmedia.pearsoncmg.com/imprint_downloads/informit/aw/meyerscddemo/demo/MAGAZINE/CO_FRAME.HTM">Counting Objects in C++ by Scott Meyers</a><a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
<li id="fn:2">
<p><a href="http://madebyevan.com/obscure-cpp-features/">Obscure C++ Features by Evan Wallace</a><a href="#fnref:2" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/30/parameter-forwarding/">Parameter Forwarding</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-30T17:41:55-04:00" pubdate data-updated="true">Jun 30<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/06/30/parameter-forwarding/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/06/30/parameter-forwarding/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>C++11 introduced the possibility of &ldquo;perfect forwarding&rdquo; and &ldquo;variadic templates&rdquo;. This allows a function to pass all of its parameters to another function seamlessly. Such abilities are very useful for wrapper classes and factories.</p>

<p>Fortunately, this ability can be emulated in C++03 with the power of Boost and the preprocessor. This post is a guide on how to do parameter forwarding. This concept will be used as a tool in a future post about creating a generic factory class.</p>

<p>For this walkthrough, you will need the following installed:</p>

<ul>
<li>libboost-dev</li>
</ul>


<p>To start, let&rsquo;s define a simplistic factory class as an example. Our factory for this example will not do much, except return the built object as a smart pointer.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/smart_ptr.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The problem with this is that it only supports building objects with the default constructor. Hence, we want to use parameter forwarding to pass parameters from the <code>create</code> method to the constructor of the object.</p>

<p>We can make a manual attempt at this first:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/smart_ptr.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">A0</span> <span class="n">a0</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">a0</span><span class="p">));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typename</span> <span class="n">A1</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">A0</span> <span class="n">a0</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">A1</span> <span class="n">a1</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">a1</span><span class="p">));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can see how this gets repetitive for constructors with many parameters. Likewise, you should also be able to see the pattern. Patterns mean we can let the machine do the work for us!</p>

<p>Before that, lets test what we have so far:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/smart_ptr.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">A0</span> <span class="n">a0</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">a0</span><span class="p">));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typename</span> <span class="n">A1</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">A0</span> <span class="n">a0</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">A1</span> <span class="n">a1</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">a1</span><span class="p">));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Default constructor</span>
</span><span class='line'><span class="k">struct</span> <span class="n">A</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">A</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A Constructor&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">APtr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Non-default constructor</span>
</span><span class='line'><span class="k">struct</span> <span class="n">B</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">B</span><span class="p">(</span><span class="kt">int</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;B Constructor: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">_value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="kt">int</span> <span class="n">value</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_value</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>   <span class="kt">int</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">_value</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">BPtr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Factory</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">factory_a</span><span class="p">;</span>
</span><span class='line'>   <span class="n">Factory</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">factory_b</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">APtr</span> <span class="n">a_ptr</span> <span class="o">=</span> <span class="n">factory_a</span><span class="p">.</span><span class="n">create</span><span class="p">();</span>
</span><span class='line'>   <span class="n">BPtr</span> <span class="n">b_ptr</span> <span class="o">=</span> <span class="n">factory_b</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This outputs:</p>

<pre><code>A Constructor
B Constructor: 3
3
0
</code></pre>

<p>Notice how the reference to <code>value</code> wasn&rsquo;t maintained. Boost addresses this issue in the <a href="http://www.boost.org/doc/libs/1_58_0/doc/html/move/construct_forwarding.html">Boost::Move</a> library by using <code>BOOST_FWD_REF</code> and <code>boost::forward</code>. Lets incorporate these utilities:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/smart_ptr.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/move/utility.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">BOOST_FWD_REF</span><span class="p">(</span><span class="n">A0</span><span class="p">)</span> <span class="n">a0</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a0</span><span class="p">)));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typename</span> <span class="n">A1</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">BOOST_FWD_REF</span><span class="p">(</span><span class="n">A0</span><span class="p">)</span> <span class="n">a0</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">BOOST_FWD_REF</span><span class="p">(</span><span class="n">A1</span><span class="p">)</span> <span class="n">a1</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a0</span><span class="p">),</span>
</span><span class='line'>                              <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a1</span><span class="p">)));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we get the output:</p>

<pre><code>A Constructor
B Constructor: 3
3
5
</code></pre>

<p>Thats better! Now that we know our code works, we can start to condense the pattern and let the preprocessor expand it out for us.</p>

<p><a href="http://www.boost.org/doc/libs/1_58_0/libs/preprocessor/doc/index.html">Boost::Preprocessor</a> is a handy library that makes interacting with the preprocessor much easier. It introduces a bunch of macros and conventions that we can build upon to emulate features like variadic templates. And despite how it sounds, the final result is rather compact and readable.</p>

<p>First, lets identify the patterns we want to condense. The first is the template parameter list:</p>

<pre><code>template&lt;typename A0, typename A1&gt;
</code></pre>

<p>Boost has a macro specifically designed for this purpose: <code>BOOST_PP_ENUM_PARAMS</code>. It takes in a number and some text, and replicates the text by appending increasing numbers. For example:</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
BOOST_PP_ENUM_PARAMS(3, typename A)
</code></pre>

<p>Outputs (using the preprocessor <code>cpp main.cpp</code>):</p>

<pre><code>typename A0 , typename A1 , typename A2
</code></pre>

<p>Simply wrap the template brackets around this to achieve our first piece:</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
template&lt;BOOST_PP_ENUM_PARAMS(3, typename A)&gt;
</code></pre>

<p>Outputs:</p>

<pre><code>template&lt; typename A0 , typename A1 , typename A2&gt;
</code></pre>

<p>Remember that C++ does not care about whitespace. The preprocessor macros will tend to insert whitespace in odd places. Likewise, the preprocessor will output everything on one line without line breaks.</p>

<p>The second pattern we see is the function parameters:</p>

<pre><code>BOOST_FWD_REF(A0) a0, BOOST_FWD_REF(A1) a1
</code></pre>

<p>This one is slightly trickier, because it doesn&rsquo;t fit the above enumeration pattern. For this case, we will use a different macro: <code>BOOST_PP_REPEAT</code>. This macro operates by convention; it will repeat a specified macro N times as long as that macro takes arguments in a certain way. In addition, we will use <code>BOOST_PP_CAT</code> to concatenate strings together. By treating N as one of the strings, we can create an enumeration with the freedom of controlling the output format.</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
#define PARAMETERS(Z, N, D) BOOST_PP_CAT(A,N) BOOST_PP_CAT(a,N)
BOOST_PP_REPEAT(3, PARAMETERS, ~)
</code></pre>

<p>Outputs:</p>

<pre><code>A0 a0 A1 a1 A2 a2
</code></pre>

<p>What is going on here? The <code>(Z, N, D)</code> represents state, number, and data, respectively. Boost uses this convention to pass around the &ldquo;state&rdquo; of the macro (analogous to how the <code>this</code> pointer is the implicit first parameter to any method call), the iteration value, and any extraneous data. For our case, we don&rsquo;t need to pass any data into the macro, so we use the conventional placeholder <code>~</code> to denote &ldquo;void&rdquo;.  On each call of our defined macro, <code>N</code> is updated with the iteration count, and we can concatenate that to the letters <code>A</code> and <code>a</code> to form our type and value.</p>

<p>But what about the commas? Boost has us covered here as well with <code>BOOST_PP_COMMA</code>:</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
#define PARAMETERS(Z, N, D) BOOST_PP_CAT(A,N) BOOST_PP_CAT(a,N) BOOST_PP_COMMA()
BOOST_PP_REPEAT(3, PARAMETERS, ~)
</code></pre>

<p>Outputs:</p>

<pre><code>A0 a0 , A1 a1 , A2 a2 ,
</code></pre>

<p>Hmm, not quite. There is a trailing comma that we need to get rid of. I&rsquo;ll admit that at this point I was pretty confused, until I learned the trick; Boost also provides <code>BOOST_PP_COMMA_IF</code>, which takes a condition argument and will only expand to a comma if the condition is not 0.</p>

<p>Here is the trick: Instead of trying to eliminate the trailing comma, <em>prepend</em> the comma!</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
#define PARAMETERS(Z, N, D) BOOST_PP_COMMA_IF(N) BOOST_PP_CAT(A,N) BOOST_PP_CAT(a,N)
BOOST_PP_REPEAT(3, PARAMETERS, ~)
</code></pre>

<p>Outputs:</p>

<pre><code>A0 a0 , A1 a1 , A2 a2
</code></pre>

<p>Perfect!</p>

<p>The final pattern is very similar to the second one:</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
#define FORWARD(Z, N, D) BOOST_PP_COMMA_IF(N) boost::forward&lt;BOOST_PP_CAT(A,N)&gt;(BOOST_PP_CAT(a,N))
BOOST_PP_REPEAT(3, FORWARD, ~)
</code></pre>

<p>Outputs:</p>

<pre><code>boost::forward&lt;A0&gt;(a0) , boost::forward&lt;A1&gt;(a1) , boost::forward&lt;A2&gt;(a2)
</code></pre>

<p>Armed with these tools, we can now simplify the factory:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">NUM_PARAMETERS</span> <span class="mi">3</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">PARAMETERS</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span> <span class="n">BOOST_PP_COMMA_IF</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="n">BOOST_FWD_REF</span><span class="p">(</span> <span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">))</span> <span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">FORWARD</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>    <span class="n">BOOST_PP_COMMA_IF</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
</span><span class='line'>  
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">EXPAND</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>                                            \
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="n">BOOST_PP_ENUM_PARAMS</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="k">typename</span> <span class="n">A</span><span class="p">)</span><span class="o">&gt;</span>                \
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">BOOST_PP_REPEAT</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">PARAMETERS</span><span class="p">,</span> <span class="o">~</span><span class="p">))</span> <span class="k">const</span>      \
</span><span class='line'>   <span class="p">{</span>                                                            \
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">BOOST_PP_REPEAT</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">FORWARD</span><span class="p">,</span> <span class="o">~</span><span class="p">)));</span> \
</span><span class='line'>   <span class="p">}</span>                                                            \
</span><span class='line'>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">EXPAND</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">FORWARD</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">PARAMETERS</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">NUM_PARAMETERS</span>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is always a good idea to undefine any macros you define after you are finished with them, since macros pollute the global namespace and you never know how they will interact with complex baselines.</p>

<p>There is one thing left to do; expand out the macro. Unsurprisingly, Boost also provides a way to do this. This method involves setting up a loop and iteratively calling <code>#include</code> on the result, which will cause the preprocessor to literally paste the results inline with the code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">NUM_PARAMETERS</span> <span class="mi">3</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">PARAMETERS</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span> <span class="n">BOOST_PP_COMMA_IF</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="n">BOOST_FWD_REF</span><span class="p">(</span> <span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">))</span> <span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">FORWARD</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>    <span class="n">BOOST_PP_COMMA_IF</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
</span><span class='line'>  
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">EXPAND</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>                                            \
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="n">BOOST_PP_ENUM_PARAMS</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="k">typename</span> <span class="n">A</span><span class="p">)</span><span class="o">&gt;</span>                \
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">BOOST_PP_REPEAT</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">PARAMETERS</span><span class="p">,</span> <span class="o">~</span><span class="p">))</span> <span class="k">const</span>      \
</span><span class='line'>   <span class="p">{</span>                                                            \
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">BOOST_PP_REPEAT</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">FORWARD</span><span class="p">,</span> <span class="o">~</span><span class="p">)));</span> \
</span><span class='line'>   <span class="p">}</span>                                                            \
</span><span class='line'>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span>  <span class="n">BOOST_PP_LOCAL_MACRO</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="n">EXPAND</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span>  <span class="n">BOOST_PP_LOCAL_LIMITS</span>   <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NUM_PARAMETERS</span><span class="p">)</span>
</span><span class='line'>   <span class="err">#</span><span class="n">include</span> <span class="n">BOOST_PP_LOCAL_ITERATE</span><span class="p">()</span>
</span><span class='line'>  
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">BOOST_PP_LOCAL_MACRO</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">BOOST_PP_LOCAL_LIMITS</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">EXPAND</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">FORWARD</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">PARAMETERS</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">NUM_PARAMETERS</span>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that the loop iterates from 1 to N, instead of starting at 0. This is because putting 0 in the template parameter expansion will result in <code>template&lt;&gt;</code>, and the compiler will interpret this as template specialization. To get around this, the &ldquo;base case&rdquo; for a default constructor is coded outside of the macro.</p>

<p>The preprocessor generates the following code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">A0</span><span class="o">&gt;</span> <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span> <span class="k">const</span> <span class="n">A0</span> <span class="o">&amp;</span> <span class="n">a0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a0</span><span class="p">)));</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">A0</span> <span class="p">,</span> <span class="k">typename</span> <span class="n">A1</span><span class="o">&gt;</span> <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span> <span class="k">const</span> <span class="n">A0</span> <span class="o">&amp;</span> <span class="n">a0</span> <span class="p">,</span> <span class="k">const</span> <span class="n">A1</span> <span class="o">&amp;</span> <span class="n">a1</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span> <span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a1</span><span class="p">)));</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">A0</span> <span class="p">,</span> <span class="k">typename</span> <span class="n">A1</span> <span class="p">,</span> <span class="k">typename</span> <span class="n">A2</span><span class="o">&gt;</span> <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span> <span class="k">const</span> <span class="n">A0</span> <span class="o">&amp;</span> <span class="n">a0</span> <span class="p">,</span> <span class="k">const</span> <span class="n">A1</span> <span class="o">&amp;</span> <span class="n">a1</span> <span class="p">,</span> <span class="k">const</span> <span class="n">A2</span> <span class="o">&amp;</span> <span class="n">a2</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span> <span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a2</span><span class="p">)));</span> <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The final step is to increase <code>NUM_PARAMETERS</code> to 10 (or whatever max number you want to support).</p>

<p>The preprocessor is often disregarded in coding standards, however it is a powerful feature of C++ that should not be ignored.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/21/boost-fusion-json-serializer/">Boost Fusion Json Serializer</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-05-21T19:21:50-04:00" pubdate data-updated="true">May 21<span>st</span>, 2015</time>
        
           | <a href="/blog/2015/05/21/boost-fusion-json-serializer/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/05/21/boost-fusion-json-serializer/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post, I am going to walkthrough the creation of a C++ mixin that will allow any structure to serialize itself to Json, using the magical power of Boost::Fusion.</p>

<p>To do this, you will need the following installed:</p>

<ul>
<li>libboost-dev</li>
</ul>


<p>The Json serializer will support any structure composed of the following:</p>

<ul>
<li>Primitives</li>
<li>Arrays</li>
<li>Containers</li>
<li>Nested Structures</li>
</ul>


<p>First, we need a test structure that we want to serialize to Json. It needs to include some arrays, containers, and nested structures to test all the abilities of the serializer:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">struct</span> <span class="n">inner</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'>       <span class="kt">double</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>       <span class="kt">bool</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vec_t</span><span class="p">;</span>
</span><span class='line'>       <span class="n">vec_t</span> <span class="n">d</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">struct</span> <span class="n">outer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="kt">int</span> <span class="n">one</span><span class="p">;</span>
</span><span class='line'>       <span class="kt">double</span> <span class="n">two</span><span class="p">;</span>
</span><span class='line'>       <span class="kt">bool</span> <span class="n">three</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">inner</span> <span class="n">array_t</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>       <span class="n">array_t</span> <span class="n">array</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">set_t</span><span class="p">;</span>
</span><span class='line'>       <span class="n">set_t</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">map_t</span><span class="p">;</span>
</span><span class='line'>       <span class="n">map_t</span> <span class="n">m</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Boost::Fusion is a library that enables reflection in C++ with only a small amount of boilerplate. Pay careful attention to the use of <code>()</code> instead of <code>{}</code>, and the placement of the <code>,</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>       <span class="n">inner</span><span class="p">,</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">double</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="n">inner</span><span class="o">::</span><span class="n">vec_t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>       <span class="n">outer</span><span class="p">,</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">one</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">double</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="n">three</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">array_t</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">set_t</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">map_t</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we define a serializer for each meta-type that needs to be supported. Each serializer will take a reference to an output stream that will be appended to, a type to serialize, and the current recursion depth. The depth is useful for pretty-printing with the proper indentation. All four will start off following the same pattern before we complete the implementation:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">primitive_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">array_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">array_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">container_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>primitive_serializer</code> is the simplest one to implement, so lets start with that one. It will enclose the value in quotation marks and append it to the stream:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">primitive_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, lets implement the <code>array_serializer</code>. We need to get the size of the array, and iterate over it while serializing each element. Notice the use of newlines and tabs, and the increase in the recursion depth; we want the Json output to be pretty, as opposed to compressed (Switching to a compressed version is as simple as removing the newlines, tabs, and whitespace). Finally, we want to insert commas between each element, but we don&rsquo;t want a comma trailing after the final element:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Helper method for generating a tab as 3 spaces</span>
</span><span class='line'>    <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tab</span><span class="p">(</span><span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span><span class="n">retval</span> <span class="o">+=</span> <span class="s">&quot;   &quot;</span><span class="p">;}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">array_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">array_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// If T is an array type then removes the top level array qualifier from T, otherwise leaves T unchanged. </span>
</span><span class='line'>       <span class="c1">// For example &quot;int[2][3]&quot; becomes &quot;int[3]&quot;.</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_bounds</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">slice_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Determine the size of the array by dividing out the size of its elements</span>
</span><span class='line'>       <span class="k">static</span> <span class="k">const</span> <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slice_t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Indent the stream</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// For each element in the array</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="c1">// Serialize the element</span>
</span><span class='line'>             <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">slice_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>             <span class="c1">// As long as we are not after the last element</span>
</span><span class='line'>             <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Add a comma separator</span>
</span><span class='line'>                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>             <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Close the array representation</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The container serializer is very similar; we use <code>BOOST_FOREACH</code> to do the iteration, and pull the <code>value_type</code> out of the container, but everything else is the same:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">container_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Use the container&#39;s size method</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// STL containers all have a &quot;value_type&quot; typedef</span>
</span><span class='line'>          <span class="n">BOOST_FOREACH</span><span class="p">(</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="c1">// Serialize each value</span>
</span><span class='line'>             <span class="n">json_serializer</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>             <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="p">{</span>
</span><span class='line'>                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>             <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>             <span class="c1">// Keep track of the count so we can tell when a comma separator is needed</span>
</span><span class='line'>             <span class="o">++</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last serializer is the <code>struct_serializer</code>. This one is trickier. Structures are adapted as <code>Boost::Fusion</code> sequences by the boilerplate we defined above. A sequence is basically a vector, except each element can have a different type. In this case, the type/value pairs correspond directly with the members of the structure, and we can iterate over these members. We will accomplish this through recursion.</p>

<p>Before we get to the serializer, lets define some wrappers for interacting with the sequences in a friendlier way. We can get properties of the sequence as a whole, or we can get properties of a certain element in the sequence by using it&rsquo;s index. You can even get an element&rsquo;s member name and member type as a string (which is very handy when writing an XML serializer):</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sequence</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="c1">// Point to the first element</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">begin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Point to the element after the last element in the sequence</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">end</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Point to the first element</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">first</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Point to the second element (for pairs)</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">second</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Point to the last element in the sequence</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">end</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">last</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Number of elements in the sequence</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>             <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">element_at</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="c1">// Type of the element at this index</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">value_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Previous element</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">previous</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Next element</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">next</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Member name of the element at this index</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">extension</span><span class="o">::</span><span class="n">struct_member_name</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;::</span><span class="n">call</span><span class="p">();</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Type name of the element at this index</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type_name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">units</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="n">type</span><span class="p">).</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Access the element</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">S</span> <span class="k">const</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">get</span><span class="p">(</span><span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we define the recursive struct serializer. The layout is similar to our other serializers, except this time there are two template parameters: the sequence and the element index.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer_recursive</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the above sequence helpers, we can obtain the type of the current element, and the index of the next element. We can also get the name of the element being serialized, it&rsquo;s type, and it&rsquo;s value:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Current element</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Next element</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">next</span> <span class="n">next_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Name of current element</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Value of current element</span>
</span><span class='line'>    <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Structures will be represented as key/value pairs separated by commas. Each value might be an array, container, or nested structure; therefore we need to call the <code>json_serializer</code> on each element. The final step is to recurse to the next element of the sequence. So a complete implementation would look like this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer_recursive</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="c1">// Get the current and next elements</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">next</span> <span class="n">next_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// The name of the element is the key</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// The element itself is the value</span>
</span><span class='line'>          <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Output the key</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="n">name</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> : &quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Recursively output the value</span>
</span><span class='line'>          <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">current_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Add a separator for the next element</span>
</span><span class='line'>          <span class="c1">// (Pay attention to this, we will revisit it later)</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Perform a recursive call to the next element</span>
</span><span class='line'>          <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">next_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need to define the base case to stop the recursion. To do this, we use template specialization for the last element of the sequence. Then, we initiate the recursion by calling into the first element of the sequence:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Specialize on the last element in the sequence</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">end</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// No output</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Initiate the recursion by calling into the first element</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer_initiate</span> <span class="o">:</span> <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">begin</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the help of these pieces, we can implement the <code>struct_serializer</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Begin recursing into the structure sequence</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
</span><span class='line'>          <span class="n">struct_serializer_initiate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that all four serializers are implemented, we need a way to determine which one to use. To do this, we will utilize Boost&rsquo;s <code>type traits</code> to determine the properties of each type. Boost provides type traits for arrays and classes (which we have adapted into sequences), as well as a hidden one that identifies containers. Anything left over is treated as a primitive. This can be accomplished with some metaprogramming magic and a series of if-then-else statements:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">choose_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="c1">// Very large typedef, indented to show the different nested levels</span>
</span><span class='line'>       <span class="k">typedef</span>
</span><span class='line'>       <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">is_array</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>                                                                                      <span class="c1">// If the type is an array,</span>
</span><span class='line'>                                    <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">array_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>                                                              <span class="c1">// use the array serializer</span>
</span><span class='line'>                                    <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">spirit</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">is_container</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>                                     <span class="c1">// Otherwise, check to see if it is a container (using the hidden type-trait)</span>
</span><span class='line'>                                                                 <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>                             <span class="c1">// If so, use the container serializer</span>
</span><span class='line'>                                                                 <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">is_class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>                            <span class="c1">// Otherwise, check to see if it is a structure</span>
</span><span class='line'>                                                                                              <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>   <span class="c1">// If so, use the structure serializer</span>
</span><span class='line'>                                                                                              <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="c1">// If all else fails, treat it as a primitive.</span>
</span><span class='line'>                                                                                             <span class="o">&gt;</span>
</span><span class='line'>                                                                <span class="o">&gt;</span>
</span><span class='line'>                                   <span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>       <span class="n">type</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last piece is to wrap all this code up into a <code>json_serializer</code> and utilize it with a mixin. The mixin uses <code>CRTP</code> in which a structure inherits from the mixin and passes itself in as the template parameter. The mixin can then cast itself to the class type and begin iterating over itself:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// The json serializer adapts itself to the top level type</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">json_serializer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">choose_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// This is the mixin to inherit from</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">json</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="c1">// Returns the json representation of this class</span>
</span><span class='line'>       <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_json</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Serialize to a stringstream, convert booleans to strings. Start at a depth of 0.</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
</span><span class='line'>          <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">boolalpha</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Cast ourselves to the template parameter since this is a mixin via CRTP</span>
</span><span class='line'>       <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">self</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span> <span class="k">const</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Time to test it out! Instantiate the structure and populate it. Remember to apply the mixin via inheritance (<code>struct outer : public json&lt;outer&gt;</code>):</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="n">outer</span> <span class="n">o</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">two</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">three</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="mf">4.4</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">c</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="mf">6.6</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">c</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">33</span><span class="p">);</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">44</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">55</span><span class="p">);</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">66</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">77</span><span class="p">]</span> <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">99</span><span class="p">]</span> <span class="o">=</span> <span class="mi">111</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">.</span><span class="n">to_json</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The resulting Json printed out looks like this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>       <span class="nt">&quot;one&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;two&quot;</span> <span class="p">:</span> <span class="s2">&quot;2.2&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;three&quot;</span> <span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;array&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;a&quot;</span> <span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;b&quot;</span> <span class="p">:</span> <span class="s2">&quot;4.4&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;c&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;d&quot;</span> <span class="p">:</span>
</span><span class='line'>             <span class="p">[</span><span class="s2">&quot;11&quot;</span><span class="p">,</span> <span class="s2">&quot;22&quot;</span>
</span><span class='line'>             <span class="p">],</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;a&quot;</span> <span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;b&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.6&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;c&quot;</span> <span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;d&quot;</span> <span class="p">:</span>
</span><span class='line'>             <span class="p">[</span><span class="s2">&quot;33&quot;</span><span class="p">,</span> <span class="s2">&quot;44&quot;</span>
</span><span class='line'>             <span class="p">],</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">],</span>
</span><span class='line'>       <span class="nt">&quot;s&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">[</span><span class="s2">&quot;55&quot;</span><span class="p">,</span> <span class="s2">&quot;66&quot;</span>
</span><span class='line'>       <span class="p">],</span>
</span><span class='line'>       <span class="nt">&quot;m&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;first&quot;</span> <span class="p">:</span> <span class="s2">&quot;77&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;second&quot;</span> <span class="p">:</span> <span class="s2">&quot;88&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;first&quot;</span> <span class="p">:</span> <span class="s2">&quot;99&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;second&quot;</span> <span class="p">:</span> <span class="s2">&quot;111&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">],</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Close, but not quite. There are multiple issues:</p>

<ul>
<li>Arrays are formatted goofy (lines 12, 20, 25)</li>
<li>Trailing commas (lines 21, 37)</li>
<li>The map is represented as an array of pairs (lines 29-36)</li>
</ul>


<p>Fortunately, these issues are easily fixed.</p>

<p>The first issue is caused by the <code>primitive_serializer</code> not adding newlines for array values. This can be fixed with an extra boolean parameter that gets set when calling it from the <code>array_serializer</code>. You will find that you also want to set this extra parameter to true when calling from the <code>container_serializer</code>, since the containers are formatted as arrays. Note that all the serializer signatures need to be updated so they match, as well as each call to the serializer.:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">primitive_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Put in tabs if this is a value from an array (called from an array serializer)</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">array_value</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>                <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>                <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>                <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>                <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Fixing the second issue (trailing commas) involves a little more template magic. The problem is caused by the comma being added inside <code>struct_serializer_recursive</code>. A comma is added just before the recursion hits the base case and stops. Instead, we should conditionally add this comma, but skip that step on the last element. To do this, we outsource the comma-insertion to a functor and specialize it for the last element:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Return a proper comma separator for any element in the sequence.</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>             <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">separator</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">comma</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>           <span class="k">return</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Specialize on the last element and prevent a comma from being returned.</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">separator</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">last</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">comma</span><span class="p">()</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now <code>os &lt;&lt; ", ";</code> can be replaced with <code>os &lt;&lt; separator&lt;S, N&gt;::comma();</code>.</p>

<p>The third issue is caused by the map container&rsquo;s value_type being a pair. Boost is kind enough to adapt pairs into structures for us, but the output isn&rsquo;t quite the way we want it. Instead, we want <code>first</code> to be treated as the key, and <code>second</code> to be treated as the value. To fix this, we make a modified copy of <code>struct_serializer_recursive</code> for pairs that doesn&rsquo;t access the member name&hellip;</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">pair_serializer_recursive</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">next</span> <span class="n">next_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// For pairs, the member name will be &quot;first&quot; or &quot;second&quot;.</span>
</span><span class='line'>          <span class="c1">// Instead, treat the value of &quot;first&quot; as the key</span>
</span><span class='line'>          <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> : &quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Then recurse and treat the value of &quot;second&quot; as the value</span>
</span><span class='line'>          <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">next_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Specialize on the second element of the pair to stop the recursion</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Mimic the primitive serializer</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Initiate the recursion</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">pair_serializer_initiate</span> <span class="o">:</span> <span class="k">public</span> <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">begin</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;specialize the <code>container_serializer</code> for <code>std::map</code> to change the boolean flags being set on the serializer&hellip;</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// Specialize the container serializer on std::map</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">C</span><span class="p">,</span> <span class="k">typename</span> <span class="n">A</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">;</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">BOOST_FOREACH</span><span class="p">(</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="c1">// This will end up calling the structure serializer, but we set the &quot;pair&quot; flag to true</span>
</span><span class='line'>             <span class="n">json_serializer</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>             <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="p">{</span>
</span><span class='line'>                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>             <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>             <span class="o">++</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;and conditonally use the <code>pair_serializer</code> inside the <code>struct_serializer</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// If being called from the std::map specialization of the container serializer,</span>
</span><span class='line'>          <span class="c1">// we should treat the values as pairs, so forward to the appropriate serializer</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="n">pair_serializer_initiate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
</span><span class='line'>             <span class="n">struct_serializer_initiate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>             <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, this means we needed to add another boolean parameter for our serialize function (and all serializers must do this so the signatures all match). After all that, we get the following Json output:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>       <span class="nt">&quot;one&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;two&quot;</span> <span class="p">:</span> <span class="s2">&quot;2.2&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;three&quot;</span> <span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;array&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;a&quot;</span> <span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;b&quot;</span> <span class="p">:</span> <span class="s2">&quot;4.4&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;c&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;d&quot;</span> <span class="p">:</span>
</span><span class='line'>             <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;11&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;22&quot;</span>
</span><span class='line'>             <span class="p">]</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;a&quot;</span> <span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;b&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.6&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;c&quot;</span> <span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;d&quot;</span> <span class="p">:</span>
</span><span class='line'>             <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;33&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;44&quot;</span>
</span><span class='line'>             <span class="p">]</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">],</span>
</span><span class='line'>       <span class="nt">&quot;s&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">[</span>
</span><span class='line'>          <span class="s2">&quot;55&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;66&quot;</span>
</span><span class='line'>       <span class="p">],</span>
</span><span class='line'>       <span class="nt">&quot;m&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;77&quot;</span> <span class="p">:</span> <span class="s2">&quot;88&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;99&quot;</span> <span class="p">:</span> <span class="s2">&quot;111&quot;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It validates! Below is the final form of the code. While it is quite a bit, the nice thing is that all a user needs to do is perform the fusion adaption of their structure and inherit from the mixin; the rest is hidden behind the scenes.</p>

<figure class='code'><figcaption><span> (json.cpp)</span><a href='/downloads/code/json.cpp' title='Download code'> download</a></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// json.cpp</span>
</span><span class='line'><span class="c1">// Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c1">// it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c1">// the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c1">// (at your option) any later version.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c1">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c1">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c1">// GNU General Public License for more details.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c1">// along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;boost/foreach.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/adapted.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/at.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/size.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/value_at.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/mpl.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/sequence/intrinsic/at.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/sequence/intrinsic/size.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/sequence/intrinsic/value_at.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/eval_if.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/identity.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/next_prior.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/spirit/home/support/container.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/type_traits.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/units/detail/utility.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;map&gt;</span>
</span><span class='line'><span class="cp">#include &lt;set&gt;</span>
</span><span class='line'><span class="cp">#include &lt;vector&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">sequence</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Point to the first element</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">begin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Point to the element after the last element in the sequence</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">end</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Point to the first element</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">first</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Point to the second element (for pairs)</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">second</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Point to the last element in the sequence</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">end</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">last</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Number of elements in the sequence</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>          <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">element_at</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Type of the element at this index</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">value_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Previous element</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">previous</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Next element</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">next</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Member name of the element at this index</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">extension</span><span class="o">::</span><span class="n">struct_member_name</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;::</span><span class="n">call</span><span class="p">();</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Type name of the element at this index</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type_name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">units</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="n">type</span><span class="p">).</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Access the element</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">S</span> <span class="k">const</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">get</span><span class="p">(</span><span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Insert a comma into the stream</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">separator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">comma</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">return</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Specialize for the last element in the sequence</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">separator</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">last</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">comma</span><span class="p">()</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Forward</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">json_serializer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tab</span><span class="p">(</span><span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span><span class="n">retval</span> <span class="o">+=</span> <span class="s">&quot;   &quot;</span><span class="p">;}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Occurs at every element of the sequence</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">struct_serializer_recursive</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">next</span> <span class="n">next_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>      <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="n">name</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> : &quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">current_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">separator</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">comma</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">next_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">end</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// No output</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">struct_serializer_initiate</span> <span class="o">:</span> <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">begin</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pair_serializer_recursive</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">next</span> <span class="n">next_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> : &quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">next_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pair_serializer_initiate</span> <span class="o">:</span> <span class="k">public</span> <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">begin</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">array_serializer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">array_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_bounds</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">slice_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="k">const</span> <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slice_t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">slice_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">container_serializer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">BOOST_FOREACH</span><span class="p">(</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">json_serializer</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="o">++</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">C</span><span class="p">,</span> <span class="k">typename</span> <span class="n">A</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">BOOST_FOREACH</span><span class="p">(</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">json_serializer</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="o">++</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">struct_serializer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">pair_serializer_initiate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
</span><span class='line'>         <span class="n">struct_serializer_initiate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>         <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">primitive_serializer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">array_value</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>            <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>            <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">choose_serializer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span>
</span><span class='line'>   <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">is_array</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">array_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">spirit</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">is_container</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                                             <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                                             <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">is_class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                                                                          <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                                                                          <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span><span class='line'>                                                                                         <span class="o">&gt;</span>
</span><span class='line'>                                                            <span class="o">&gt;</span>
</span><span class='line'>                               <span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>   <span class="n">type</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">json_serializer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">choose_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">json</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_json</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
</span><span class='line'>      <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">boolalpha</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">self</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span> <span class="k">const</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">////////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">inner</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">double</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">bool</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vec_t</span><span class="p">;</span>
</span><span class='line'>   <span class="n">vec_t</span> <span class="n">d</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">outer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">json</span><span class="o">&lt;</span><span class="n">outer</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">one</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">double</span> <span class="n">two</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">bool</span> <span class="n">three</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">inner</span> <span class="n">array_t</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>   <span class="n">array_t</span> <span class="n">array</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">set_t</span><span class="p">;</span>
</span><span class='line'>   <span class="n">set_t</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">map_t</span><span class="p">;</span>
</span><span class='line'>   <span class="n">map_t</span> <span class="n">m</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="n">inner</span><span class="p">,</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">double</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="n">inner</span><span class="o">::</span><span class="n">vec_t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="n">outer</span><span class="p">,</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">one</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">double</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="n">three</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">array_t</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">set_t</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">map_t</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">outer</span> <span class="n">o</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">two</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">three</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="mf">4.4</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">c</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="mf">6.6</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">c</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">33</span><span class="p">);</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">44</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">55</span><span class="p">);</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">66</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">77</span><span class="p">]</span> <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">99</span><span class="p">]</span> <span class="o">=</span> <span class="mi">111</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">.</span><span class="n">to_json</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hopefully you learned some cool C++ tricks from this.</p>

<hr />

<p>This post was inspired by <a href="http://andres.senac.es/2011/04/generic-json-serializer.html">Andres Senac</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/02/temporary-security-mirror/">Temporary Security Mirror</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-05-02T15:31:12-04:00" pubdate data-updated="true">May 2<span>nd</span>, 2015</time>
        
           | <a href="/blog/2015/05/02/temporary-security-mirror/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/05/02/temporary-security-mirror/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes you need to perform a task in a secure way that leaves no trace on your computer. The traditional way of accomplishing this is to boot from a live CD like <a href="https://tails.boum.org/">Tails</a>. The problem with this is that you might need the software, drivers, or setup you have on your main operating system to accomplish the task. An example of this might be creating a Bitcoin Paper Wallet with a proprietary printer; it might be too difficult to set up the printer on a live CD for a one-off task.</p>

<p>Below is a script that help for these specialized cases. It creates a secure mirror of your system that never touches the disk; anything you do is wiped away on shutdown. Best part is, you can use this from an already running system.</p>

<p>This script will:</p>

<ul>
<li>Disable swap</li>
<li>Do a read only bind mount of root</li>
<li>Apply a tmpfs aufs layer over the read only root view</li>
<li>Start an X server and chroot into the root view</li>
</ul>


<p>The end result is a temporary secure mirror of your running system.<br/>
You need the following installed for this to work:</p>

<ul>
<li>aufs-tools</li>
<li>Xephyr</li>
<li>fluxbox</li>
</ul>


<p>Simply run <code>tsm.sh</code> and you will get a window of your running system, where anything you do is forgotten when closed. You will have access to all your files and devices. For more security, close any applications and disconnect your internet before running this script. When finished, close the window and restart your computer.</p>

<figure class='code'><figcaption><span> (tsm.sh)</span><a href='/downloads/code/tsm.sh' title='Download code'> download</a></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># tsm.sh</span>
</span><span class='line'><span class="c"># Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c"># (at your option) any later version.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Stop on any error</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="c"># Declare an array of tasks to perform on exit</span>
</span><span class='line'><span class="nb">declare</span> -a on_exit_items
</span><span class='line'>
</span><span class='line'><span class="c"># This function is run on exit</span>
</span><span class='line'><span class="k">function </span>on_exit<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="k">for </span>i in <span class="s2">&quot;${on_exit_items[@]}&quot;</span>
</span><span class='line'>    <span class="k">do</span>
</span><span class='line'><span class="k">        </span><span class="nb">eval</span> <span class="nv">$i</span>
</span><span class='line'>    <span class="k">done</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Add to the list of tasks to run on exit</span>
</span><span class='line'><span class="k">function </span>add_on_exit_reverse<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="nv">on_exit_items</span><span class="o">=(</span><span class="s2">&quot;$*&quot;</span> <span class="s2">&quot;${on_exit_items[@]}&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$n</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nb">trap </span>on_exit EXIT
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Check to make sure we are running as root</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -ne 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;This script must be run as root&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Define variables</span>
</span><span class='line'><span class="nv">insecure_root</span><span class="o">=</span>insecure_root
</span><span class='line'><span class="nv">tmpfs_redirect</span><span class="o">=</span>tmpfs_redirect
</span><span class='line'><span class="nv">secure_root</span><span class="o">=</span>secure_root
</span><span class='line'>
</span><span class='line'><span class="c"># Disable Swap</span>
</span><span class='line'>swapoff -a
</span><span class='line'>
</span><span class='line'><span class="c"># Create the mount points</span>
</span><span class='line'>mkdir -p <span class="nv">$insecure_root</span>
</span><span class='line'>mkdir -p <span class="nv">$tmpfs_redirect</span>
</span><span class='line'>mkdir -p <span class="nv">$secure_root</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Clean up the mount points</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$insecure_root</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$tmpfs_redirect</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$secure_root</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Bind mount the root directory</span>
</span><span class='line'>mount --bind / <span class="nv">$insecure_root</span>
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$insecure_root</span> <span class="o">||</span> umount -lf <span class="nv">$insecure_root</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Remount the root directory as read only</span>
</span><span class='line'>mount -o remount,ro,bind <span class="nv">$insecure_root</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Create a tmpfs filesystem</span>
</span><span class='line'>mount -t tmpfs tmpfs <span class="nv">$tmpfs_redirect</span>
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$tmpfs_redirect</span> <span class="o">||</span> umount -lf <span class="nv">$tmpfs_redirect</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Aufs mount to redirect all </span>
</span><span class='line'>mount -t aufs -o <span class="nv">br</span><span class="o">=</span><span class="nv">$tmpfs_redirect</span><span class="o">=</span>rw:<span class="nv">$insecure_root</span><span class="o">=</span>ro none <span class="nv">$secure_root</span>
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$secure_root</span> <span class="o">||</span> umount -lf <span class="nv">$secure_root</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Mount the necessary filesystems in the chroot</span>
</span><span class='line'>mount --bind /dev <span class="nv">$secure_root</span>/dev
</span><span class='line'>mount -t proc none <span class="nv">$secure_root</span>/proc
</span><span class='line'>mount -t sysfs none <span class="nv">$secure_root</span>/sys
</span><span class='line'>mount -t devpts none <span class="nv">$secure_root</span>/dev/pts
</span><span class='line'>
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$secure_root</span>/dev <span class="o">||</span> umount -lf <span class="nv">$secure_root</span>/dev
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$secure_root</span>/proc <span class="o">||</span> umount -lf <span class="nv">$secure_root</span>/proc
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$secure_root</span>/sys <span class="o">||</span> umount -lf <span class="nv">$secure_root</span>/sys
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$secure_root</span>/dev/pts <span class="o">||</span> umount -lf <span class="nv">$secure_root</span>/dev/pts
</span><span class='line'>
</span><span class='line'><span class="c"># Everything is set up, enter the chroot</span>
</span><span class='line'><span class="nb">set</span> +e
</span><span class='line'>
</span><span class='line'><span class="c"># Start the nested X server</span>
</span><span class='line'>Xephyr -screen 1024x768 -name <span class="s2">&quot;Temporary Security Mirror&quot;</span> -title <span class="s2">&quot;Temporary Security Mirror&quot;</span> :1 &amp;
</span><span class='line'>
</span><span class='line'><span class="c"># Wait for the X server to start</span>
</span><span class='line'>sleep 5
</span><span class='line'>
</span><span class='line'><span class="c"># Chroot in and startx</span>
</span><span class='line'>chroot <span class="nv">$secure_root</span> env <span class="nv">DISPLAY</span><span class="o">=</span>localhost:1 /usr/bin/fluxbox
</span><span class='line'>
</span><span class='line'><span class="c"># Wait for things to settle down</span>
</span><span class='line'>sleep 5
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/26/bitcoin-analogy/">A Simple Bitcoin Analogy</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-26T12:59:49-04:00" pubdate data-updated="true">Apr 26<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/04/26/bitcoin-analogy/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/04/26/bitcoin-analogy/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Imagine there are a group of lockers in a public place. Each locker has the following:</p>

<ul>
<li>A lock that requires a key</li>
<li>A window to see inside</li>
<li>A slot that money can be put in</li>
<li>An identifying number</li>
</ul>


<p>A group of these lockers might look like this:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/26/bitcoin-analogy/01.jpg"><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>These lockers are secure. The windows are unbreakable, the locks cannot be picked, the metal cannot be cut, and the entire group is bolted to the ground. Furthermore, there is only one copy of the key, and it is in possession of that locker&rsquo;s owner; Nobody else is able to get inside without that key.</p>

<p>Each locker is free of charge. A person may claim any unused locker, upon which they get the only copy of the key. A person may have as many lockers as they choose; there is no shortage of lockers. People use &ldquo;wallets&rdquo; (which are more like keychains in this case) to keep track of all the lockers they own and their associated keys. If anyone loses their wallet, they lose the ability to open any of their lockers, and that money is inaccessible forever.</p>

<p>Because the group of lockers is in a public place, and each locker has a window, anyone is able to see how much money is in each locker. They can see the identifying numbers on the locker, but they do not know who the owner of the locker is.</p>

<p>This group of lockers represents the Blockchain, and the contents of each locker represent Bitcoins.</p>

<p>Alice is selling a chair that Bob wants to buy. Bob calls up Alice to make a deal:</p>

<blockquote><p>Bob: I&rsquo;d like to buy the chair you are selling. How much do you want for it?<br/>
Alice: I&rsquo;ll give it to you for 0.2 Bitcoins<br/>
Bob: Sounds great! Which locker number is yours?</p></blockquote>

<p>Alice goes to the group of lockers, sees that #412 is unclaimed, and claims it. She heads home with the key.</p>

<blockquote><p>Alice: Put the money in locker 412 please!</p></blockquote>

<p>Bob goes to the lockers, finds #412 and peeks inside. He can see that it is empty. Bob goes to his locker (#387), pulls out some money, and sticks it in the slot on locker #412. He then goes back home.</p>

<blockquote><p>Bob: I put the money in your locker!</p></blockquote>

<p>Alice goes to the lockers and checks the contents of locker #412 through the window. She sees the 0.2 Bitcoins sitting there. Since Bob is the only person she told about #412, the money must have come from him.</p>

<blockquote><p>Alice: I just checked, and I see the money in my locker. Here is your chair!</p></blockquote>

<p>The entire transaction was done without Alice and Bob ever needing to meet in person. No banks were involved in the transaction, there were no processing delays, there were no fees. Bob is unable to issue a &ldquo;chargeback&rdquo; to void his transaction; the money is already in Alice&rsquo;s locker, and only she can get it back out. Furthermore, anyone checking the contents of the lockers by peeking through the windows could only tell that a transaction was made; they are unable to discover who was involved.</p>

<p>This is the basic premise of Bitcoin. Learn more about Bitcoin <a href="http://www.coindesk.com/information/what-is-bitcoin/">here</a>.</p>

<p><em>This analogy was not my idea, I am paraphrasing <a href="http://thebitcoincatalog.com/safe-analogy/">Henry Romp</a>.</em></p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>http://www.storageaspects.co.uk/shop/archive-mobile-shelving-archive-roller-racking/visitor-centre-lockers-with-see-through-doors/<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/23/bitcoin-paper-wallets/">Bitcoin Paper Wallets</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-23T19:18:12-04:00" pubdate data-updated="true">Apr 23<span>rd</span>, 2015</time>
        
           | <a href="/blog/2015/04/23/bitcoin-paper-wallets/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Paper wallets are a form of <em>cold storage</em>, meaning that the private key has never touched a computer with internet access. This is one of the most secure ways to store Bitcoins when done properly. You should never use a paper wallet you did not create yourself. For that reason, this is a tutorial to create a paper wallet in a secure fashion.</p>

<p>A repository of paper wallet generators can be found <a href="https://github.com/jrruethe/paper_wallet">here</a>. You can choose to use my repository directly if you wish, but I recommend going straight to the source.
There are many options with different formats and templates, however I highly recommend bitcoinpaperwallet.com.</p>

<p><em>I am in no way affiliated with bitcoinpaperwallet.com, just a satisfied customer.</em></p>

<hr />

<h3><a href="https://bitcoinpaperwallet.com/">BitcoinPaperWallet.com</a> (<a href="https://github.com/cantonbecker/bitcoinpaperwallet">Github</a>)</h3>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/01.jpg"></p>

<p>This is the most secure and well thought out design I have seen. The author has done a great job addressing the various attack vectors. His website is easy to use and provides all the relevant information needed. Furthermore, the generator is based on the popular and trusted <a href="https://www.bitaddress.org">bitaddress.org</a>. This paper wallet is perfect for cold storage and archival, but it takes a little extra work and materials to secure it properly. Fortunately, everything required can be bought right from the website, and you can pay in Bitcoin!</p>

<p>Features:</p>

<ul>
<li>&ldquo;Butterfly&rdquo; design secures the private key</li>
<li>Resistant to candling</li>
<li>Supports <a href="https://github.com/bitcoin/bips/blob/master/bip-0038.mediawiki">BIP38</a> encryption</li>
<li>Private key encoded in <a href="https://en.bitcoin.it/wiki/Wallet_import_format">Wallet Import Format</a></li>
<li>Designed to be printed in landscape mode, but works in portrait mode as well</li>
<li>Double sided</li>
<li>2x wallets per sheet</li>
<li>Notes section on the back</li>
<li>Public key visible when closed</li>
</ul>


<p>Additional Options:</p>

<ul>
<li><a href="https://bitcoinpaperwallet.com/">Security Stickers</a> 2in x .5in (<a href="http://www.amazon.com/gp/product/B00MWCCN7C">Alternative</a>)*</li>
<li><a href="https://bitcoinpaperwallet.com/">Waterproof Bag</a> 6in x 3in (<a href="http://www.amazon.com/Clear-Lock-Bags-Case-1000/dp/B0040003E4">Alternative</a>)</li>
<li><a href="http://www.amazon.com/dp/B004PX7ZTC">Teslin Paper</a> (Inkjet Printers)</li>
<li><a href="http://www.amazon.com/gp/product/B004UI335W/">Revlar Paper</a> (Laser Printers)</li>
<li><a href="http://www.amazon.com/gp/product/B00ENI0NI4">Scratch Off Stickers</a> 1in x 1in</li>
<li><a href="http://www.amazon.com/gp/product/B00BWU3HNY">Laminating Pouches</a> 8.9in x 11.4in</li>
<li><a href="http://www.amazon.com/gp/product/B0010JEJPC">Laminator</a></li>
</ul>


<blockquote><p>*The official security stickers from bitcoinpaperwallet.com are serialized in pairs, meaning you get two of each number. This is best because each paper wallet requires two stickers, so the numbers match. The alternative link only provides one sticker for each number.</p></blockquote>

<p>Dimensions:</p>

<ul>
<li>Landscape: 5.5in x 2.5in (Slightly smaller than a dollar bill)</li>
<li>Portrait: 4in x 2in (Slightly bigger than a standard business card)</li>
<li>QR Codes: 1in x 1in (About the size of a quarter)</li>
</ul>


<p>For additional artworks, check out <a href="http://libertywallet.liberty.me/2015/03/18/liberty-wallet/">Liberty Paper Wallet</a> (<a href="https://github.com/SimonBelmond/libertypaperwallet">Github</a>).</p>

<hr />

<h3>Protecting your paper wallet</h3>

<p>Paper wallets are extremely vulnerable to water.
Consider laminating your paper wallet for extra protection. An alternative could be to vaccuum seal it using a Foodsaver Vaccuum Sealer. At the very least, you should keep the paper wallet in a ziplock bag.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/03.jpg"></p>

<p>Paper wallets are also extremely vulnerable to fire.
However, there is not much you can do about this other than keeping multiple backups in different physical locations, such as a safety deposit box.</p>

<blockquote><p>Remember, if you lose your paper wallet, or it is damaged, you lose all the coins stored at that address!</p></blockquote>

<hr />

<h3>How to properly create a paper wallet</h3>

<p>Paper wallets need to be created offline on a secure machine. For this tutorial, I will be using a <a href="https://tails.boum.org/">Tails</a> Live CD. Grab the ISO and burn it to a disk.</p>

<p>Save a <a href="https://github.com/cantonbecker/bitcoinpaperwallet/archive/master.zip">copy of bitcoinpaperwallet</a> onto a USB drive.</p>

<ol>
<li>Shutdown your computer and boot from the CD.</li>
<li>When the Tails welcome box appears, select &ldquo;More Options&rdquo;.</li>
<li>Enter an administrator password of your choice and login.</li>
<li>Wait for tor to become ready.</li>
</ol>


<blockquote><p>For this tutorial, in order to get screenshots I am using a virtual machine. Do not use a virtual machine when doing this for real!</p></blockquote>

<p>Before creating the paper wallet, you will want to ensure that your printer works correctly. You need a printer that is directly connected to your machine; don&rsquo;t use a network printer (you shouldn&rsquo;t be connected to any network). If possible, use a dumb printer, and try to ensure that your printer does not save a copy of printouts to internal memory. Use this time to get any drivers you need from the internet.</p>

<p>From the <code>Applications</code> menu, select <code>System Tools -&gt; Administration -&gt; Printing</code>.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/04.png"></p>

<p>Add your printer. Open up Tor Browser and ensure that you can print a webpage.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/05.png"></p>

<p>Time to disconnect from the internet. Unplug the ethernet cord, turn off any wireless cards or routers as necessary. Verify that you are not online.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/06.png"></p>

<ol>
<li>Insert your usb drive</li>
<li>Copy the github zip file to the <code>Tor Browser</code> folder on the filesystem</li>
<li>Remove the usb drive</li>
<li>Unpack the zip file</li>
</ol>


<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/07.png"></p>

<p>Open up the html file in Tor Browser. Follow the instructions to generate your paper wallet. You have the option of using the built-in random number generator, or supplying your own random numbers using dice or cards. For maximum security, you should use dice or cards. I found that taking a deck of cards, shuffling it seven times, and picking the first 32 cards off the top worked well. Remember to shuffle the cards again after you are done! &ldquo;Brain wallets&rdquo; may seem convenient, however you need to have a very strong passphrase for this to be secure; it is better to use random numbers.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/08.png"></p>

<blockquote><p><strong>BIP38 Encryption?</strong><br/>
There are pros and cons to encrypting your paper wallet. Encryption adds an extra layer of security by requiring a passphrase before being able to import the private key again, which is great if the paper wallet ever gets stolen. However if the passphrase is forgotten, the coins are lost forever. The passphrase is one more thing to remember / write down, which means it is one more thing to secure. In addition, some wallet software does not support BIP38, which may make reimporting difficult. Finally, it is important to realize that BIP38 encryption will NOT help if you chose an insecure passphrase for a brain wallet. In general, BIP38 encryption is recommended.</p></blockquote>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/09.png"></p>

<p>You will want to print two wallets by spinning the paper after each print. You will end up running the sheet of paper through the printer a total of 4 times.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/10.jpg" width="400" height="600"></p>

<p>Now is your chance to verify the paper wallets. Make sure you can scan the QR codes, make sure the private key and public key match, etc.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/11.png"></p>

<p>Shutdown your Tails environment. It will wipe your ram for you.</p>

<p>Cut out each design by following the lines on the front. Fold the wallets and apply the stickers.</p>

<blockquote><p>If you have a laser printer, you will want to include a small 1in x 1in square of paper between the private key and the candling pattern when folding the paper. Later on, we will be laminating the paper wallet, and the heat can cause the toner on each side of the fold to fuse together.</p></blockquote>

<p>Sign the back and write the sticker numbers. This prevents someone from simply replacing the stickers or entire wallet without your knowledge.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/12.jpg" width="400" height="600"></p>

<p>Put both paper wallets into a laminating pouch and run it through the laminator. Cut out each wallet, and store them in physically separate, secure locations.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/13.jpg" width="400" height="600"></p>

<hr />

<h3>How to properly use a paper wallet</h3>

<p>You can scan the public key into Electrum or Mycelium as a watch-only wallet to keep track of your funds. Eventually you will want to spend the funds.</p>

<p>First, you need to delaminate the wallet. Cut a line along the edge closest to the paper where there is a tiny line of air, and peel away the laminate. A technique that worked for me was to cut along the &ldquo;Private Key / Withdraw&rdquo; line, then slide my knife underneath each sticker. Unfold the flap to access the private key. As you can see, it is still safe and legible, even after the lamination process.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/14.jpg"></p>

<p>Now comes the important part. The funds must be &ldquo;swept&rdquo; into an electronic wallet. You must take all the funds in one shot; do not attempt to partially spend the funds in a paper wallet. This is due to how Bitcoin Change works.</p>

<blockquote><p><strong>Change?</strong><br/>
When spending Bitcoins, <em>ALL</em> coins from that address are moved to new addresses.
The destination address will get the desired amount, and any remaining amount will be sent to a &ldquo;change&rdquo; address. If no &ldquo;change&rdquo; address is specified, the remaining amount will go to the miner that solves the block. Normally, an electronic wallet manages this for you behind the scenes, however when using a paper wallet directly, you will not have this control. This is why the entire balance of a paper wallet should be &ldquo;swept&rdquo; into an electronic wallet before spending.<br/>
Read more about change <a href="https://en.bitcoin.it/wiki/Change">here</a></p></blockquote>

<p>Once the paper wallet has been swept into the electronic wallet, it should be destroyed and never used again. Shred it or burn it.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/15.jpg"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/19/generate-hashes/">Generate Hashes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-19T14:51:57-04:00" pubdate data-updated="true">Apr 19<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/04/19/generate-hashes/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/04/19/generate-hashes/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a handy script to recursively generate hashes for a folder tree, in a format that the standard unix tools can use for checking.</p>

<figure class='code'><figcaption><span> (generate_hashes.sh)</span><a href='/downloads/code/generate_hashes.sh' title='Download code'> download</a></figcaption><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="c"># generate_hashes.rb</span>
</span><span class='line'><span class="c"># Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c"># (at your option) any later version.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Usage: ./generate_hashes.sh [directory] [hash]</span>
</span><span class='line'><span class="c"># Check the result with sha256sum -c &lt;result&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># See if a directory was defined</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nv">DIRECTORY</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="p">%/</span><span class="k">}</span>
</span><span class='line'>   <span class="nv">REPLACE</span><span class="o">=</span><span class="k">${</span><span class="nv">DIRECTORY</span><span class="k">}</span>/
</span><span class='line'>
</span><span class='line'>   <span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$DIRECTORY</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;Directory does not exist: $DIRECTORY&quot;</span>
</span><span class='line'>      <span class="nb">exit </span>1
</span><span class='line'>   <span class="k">fi</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>   <span class="c"># Use the current directory</span>
</span><span class='line'>   <span class="nv">DIRECTORY</span><span class="o">=</span><span class="s1">&#39;.&#39;</span>
</span><span class='line'>   <span class="nv">REPLACE</span><span class="o">=</span><span class="s1">&#39;\./&#39;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Hash type to use</span>
</span><span class='line'><span class="nv">HASH</span><span class="o">=</span><span class="k">${</span><span class="nv">2</span><span class="k">:-</span><span class="nv">sha256</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Generate the output filename</span>
</span><span class='line'><span class="nv">OUTPUT</span><span class="o">=</span>hashes.<span class="nv">$HASH</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Determine which program to use</span>
</span><span class='line'><span class="nv">HASHER</span><span class="o">=</span><span class="k">${</span><span class="nv">HASH</span><span class="k">}</span>sum
</span><span class='line'>
</span><span class='line'><span class="c"># Remove any existing hash file</span>
</span><span class='line'>rm -f <span class="nv">$DIRECTORY</span>/<span class="nv">$OUTPUT</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Find all files in the directory</span>
</span><span class='line'><span class="c"># that do not have the output filename</span>
</span><span class='line'><span class="c"># and hash them. Store the output in the target directory</span>
</span><span class='line'>find <span class="nv">$DIRECTORY</span> -type f ! -name <span class="s2">&quot;$OUTPUT&quot;</span> -exec <span class="nv">$HASHER</span> <span class="o">{}</span> <span class="se">\;</span> &gt;&gt; <span class="nv">$DIRECTORY</span>/<span class="nv">$OUTPUT</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Sort the output on the filename column</span>
</span><span class='line'>sort -u -k2 -o <span class="nv">$DIRECTORY</span>/<span class="nv">$OUTPUT</span> <span class="nv">$DIRECTORY</span>/<span class="nv">$OUTPUT</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Remove the directory from the listings</span>
</span><span class='line'>sed -i <span class="s2">&quot;s@ $REPLACE@@g&quot;</span> <span class="nv">$DIRECTORY</span>/<span class="nv">$OUTPUT</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following will show how to use it. First, we need some files:</p>

<pre><code>$ ls
generate_hashes.sh

$ dd if=/dev/urandom bs=1024k count=1 &gt; 1.txt
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0787343 s, 13.3 MB/s

$ dd if=/dev/urandom bs=1024k count=1 &gt; 2.txt
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0862146 s, 12.2 MB/s

$ mkdir -p three/four

$ dd if=/dev/urandom bs=1024k count=1 &gt; three/3.txt
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0854334 s, 12.3 MB/s

$ dd if=/dev/urandom bs=1024k count=1 &gt; three/four/4.txt
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0783046 s, 13.4 MB/s

$ ls *
1.txt  2.txt  generate_hashes.sh

three:
3.txt  four
</code></pre>

<p>Calling the script without any arguments will generate the hashes in the current directory. The file is stored as hashes.hashtype, where hashtype defaults to sha256.</p>

<pre><code>$ ./generate_hashes.sh 
$ ls
1.txt  2.txt  generate_hashes.sh  hashes.sha256  three

$ cat hashes.sha256 
3f27f253e357143105f9a29193141db5ad833b56299a4c4e4a30a2d19f4732a8 1.txt
9dee9ed8f2c7a8533e764bc6963615537524d54292875e9fd858e9e0cd9b93b1 2.txt
20a1cbbf5a21773d673c79d4d8e58e31c3766f87c0299aa5a8c669015504c9f0 generate_hashes.sh
a43be65323f68fc6354f34f8fc97efeb28f01b256d9918cecf9981a93eb59aca three/3.txt
bc767948f782a92ebae7d217e04a160c74669dac838b2ccc33cc697e3ebd1ea2 three/four/4.txt

$ sha256sum -c hashes.sha256 
1.txt: OK
2.txt: OK
generate_hashes.sh: OK
three/3.txt: OK
three/four/4.txt: OK
</code></pre>

<p>The first optional argument is the directory to hash. <code>.</code> is allowed.</p>

<pre><code>$ rm hashes.sha256
$ ls
1.txt  2.txt  generate_hashes.sh  three
$ ls three/
3.txt  four

$ ./generate_hashes.sh three/
$ ls three/
3.txt  four  hashes.sha256
$ cat three/hashes.sha256 
a43be65323f68fc6354f34f8fc97efeb28f01b256d9918cecf9981a93eb59aca 3.txt
bc767948f782a92ebae7d217e04a160c74669dac838b2ccc33cc697e3ebd1ea2 four/4.txt
</code></pre>

<p>The second optional argument is the hash type to use:</p>

<ul>
<li>sha1</li>
<li>sha224</li>
<li>sha256 (default)</li>
<li>sha384</li>
<li>sha512</li>
<li>md5</li>
</ul>


<p>Example:</p>

<pre><code>$ ./generate_hashes.sh three/ sha1
$ ls three/
3.txt  four  hashes.sha1  hashes.sha256
$ cat three/hashes.sha1
fffdc438939ae0afa1f19569939dd3996a2d67bb 3.txt
cec823c326525c23bba925d5d85b35a5ebbed62d four/4.txt
deea8794a7aada412518d06df516c804389ef212 hashes.sha256

$ cd three/
$ sha1sum -c hashes.sha1
3.txt: OK
four/4.txt: OK
hashes.sha256: OK
</code></pre>

<p>When distributing a large set of files or directory tree, it is best to generate the hashes in the root of the tree and sign the hashes.sha256 file with GPG.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Contact</h1>
  <p>
  <a href="mailto:jrruethe@gmail.com">jrruethe@gmail.com</a><br>
  <a href="https://onename.io/jrruethe">onename.io/jrruethe</a><br>
  <a href="https://keybase.io/jrruethe">keybase.io/jrruethe</a><br>
  <br>Public Key:<br>
  <a href="http://jrruethe.github.io/downloads/code/jrruethe-public.asc">4F40 99F8 276B DBA5 475A<br>8446 4630 BEDC 40B9 35FE</a>
  </p>
</section>
<section>
<a href="https://twitter.com/jrruethe" class="twitter-follow-button" data-show-count="true">Follow @jrruethe</a>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jrruethe.github.io/index.html" data-via="jrruethe" data-counturl="http://jrruethe.github.io/index.html" >Tweet</a>
</section>
<section>
<h1>Link to this page</h1>
<a href="http://jrruethe.github.io/index.html"><img src="http://chart.apis.google.com/chart?chs=150x150&cht=qr&chld=|0&chco=000000&chl=http://jrruethe.github.io/index.html" alt="post-qrcode"></a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/08/23/placement-new/">Placement New, Memory Dumps, and Alignment</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/17/yaml-de-slash-serialization-with-boost-fusion/">Yaml De/Serialization With Boost Fusion</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/08/02/singletons/">Singletons</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/07/01/object-counter/">Object Counter</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/06/30/parameter-forwarding/">Parameter Forwarding</a>
      </li>
    
  </ul>
</section>
<section>
   <h1>Related Posts</h1>
   <ul class="posts">
   
   </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jrruethe">@jrruethe</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jrruethe',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
	<h1>Bitcoin Donations</h1>
	<a href="bitcoin:1A1dsHXAaDcfLzEbiA99u3uBq9PDzw4Hkg"><img src="http://blockchain.info/qr?data=1A1dsHXAaDcfLzEbiA99u3uBq9PDzw4Hkg&size=150" alt="Bitcoin"></a>
	<font size=2>
	<a href="bitcoin:1A1dsHXAaDcfLzEbiA99u3uBq9PDzw4Hkg">1A1dsHXAaDcfLzEbiA99u3uBq9PDzw4Hkg</a>
	</font>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  <span class="license">
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
   - Copyright &copy; 2015 - Joe Ruether - All rights reserved with the following exceptions:
  <br>
   - All embedded code on this page licensed under
    <a href="/blog/downloads/code/gpl-3.0.txt">GPLv3</a>
    or a later version unless otherwise noted
  <br>
   - All non-code text content on this page licensed under
    <a href="/blog/downloads/code/cc-by-nc-sa-4.0.txt">CC BY-NC-SA 4.0</a>
    or a later version unless otherwise noted
  </span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jrruethe';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
