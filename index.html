
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Morning Musings</title>
  <meta name="author" content="Joe Ruether">

  
  <meta name="description" content="C++11 introduced the possibility of &ldquo;perfect forwarding&rdquo; and &ldquo;variadic templates&rdquo;. This allows a function to pass all of its &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jrruethe.github.io">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/atom.xml" rel="alternate" title="Morning Musings" type="application/atom+xml">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
  <script>!window.jQuery && document.write(unescape('%3Cscript src="./javascripts/libs/jquery.min.js"%3E%3C/script%3E'))</script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript">
  jQuery.noConflict();
  var rootUrl = "";
</script>
<script src="/javascripts/openlayers/OpenLayers.js" type="text/javascript"></script>
<script src="/javascripts/maps.js" type="text/javascript"></script>

  

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Morning Musings</a></h1>
  
    <h2>I'm not ready to wake up yet...</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="https://www.google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:jrruethe.github.io" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/blog/about">About</a></li>
  <li><a href="/blog/license">License</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/06/30/parameter-forwarding/">Parameter Forwarding</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-06-30T17:41:55-04:00" pubdate data-updated="true">Jun 30<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/06/30/parameter-forwarding/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/06/30/parameter-forwarding/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>C++11 introduced the possibility of &ldquo;perfect forwarding&rdquo; and &ldquo;variadic templates&rdquo;. This allows a function to pass all of its parameters to another function seamlessly. Such abilities are very useful for wrapper classes and factories.</p>

<p>Fortunately, this ability can be emulated in C++03 with the power of Boost and the preprocessor. This post is a guide on how to do parameter forwarding. This concept will be used as a tool in a future post about creating a generic factory class.</p>

<p>For this walkthrough, you will need the following installed:</p>

<ul>
<li>libboost-dev</li>
</ul>


<p>To start, let&rsquo;s define a simplistic factory class as an example. Our factory for this example will not do much, except return the built object as a smart pointer.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/smart_ptr.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The problem with this is that it only supports building objects with the default constructor. Hence, we want to use parameter forwarding to pass parameters from the <code>create</code> method to the constructor of the object.</p>

<p>We can make a manual attempt at this first:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/smart_ptr.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">A0</span> <span class="n">a0</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">a0</span><span class="p">));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typename</span> <span class="n">A1</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">A0</span> <span class="n">a0</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">A1</span> <span class="n">a1</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">a1</span><span class="p">));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can see how this gets repetitive for constructors with many parameters. Likewise, you should also be able to see the pattern. Patterns mean we can let the machine do the work for us!</p>

<p>Before that, lets test what we have so far:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/smart_ptr.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">A0</span> <span class="n">a0</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">a0</span><span class="p">));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typename</span> <span class="n">A1</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">A0</span> <span class="n">a0</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">A1</span> <span class="n">a1</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">a0</span><span class="p">,</span>
</span><span class='line'>                              <span class="n">a1</span><span class="p">));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Default constructor</span>
</span><span class='line'><span class="k">struct</span> <span class="n">A</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">A</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;A Constructor&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">APtr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Non-default constructor</span>
</span><span class='line'><span class="k">struct</span> <span class="n">B</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">B</span><span class="p">(</span><span class="kt">int</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">)</span> <span class="o">:</span>
</span><span class='line'>      <span class="n">_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;B Constructor: &quot;</span> <span class="o">&lt;&lt;</span> <span class="n">_value</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="kt">int</span> <span class="n">value</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">_value</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">protected</span><span class="o">:</span>
</span><span class='line'>   <span class="kt">int</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">_value</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">BPtr</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span><span class="o">*</span> <span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Factory</span><span class="o">&lt;</span><span class="n">A</span><span class="o">&gt;</span> <span class="n">factory_a</span><span class="p">;</span>
</span><span class='line'>   <span class="n">Factory</span><span class="o">&lt;</span><span class="n">B</span><span class="o">&gt;</span> <span class="n">factory_b</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">APtr</span> <span class="n">a_ptr</span> <span class="o">=</span> <span class="n">factory_a</span><span class="p">.</span><span class="n">create</span><span class="p">();</span>
</span><span class='line'>   <span class="n">BPtr</span> <span class="n">b_ptr</span> <span class="o">=</span> <span class="n">factory_b</span><span class="p">.</span><span class="n">create</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">value</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">b_ptr</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This outputs:</p>

<pre><code>A Constructor
B Constructor: 3
3
0
</code></pre>

<p>Notice how the reference to <code>value</code> wasn&rsquo;t maintained. Boost addresses this issue in the <a href="http://www.boost.org/doc/libs/1_58_0/doc/html/move/construct_forwarding.html">Boost::Move</a> library by using <code>BOOST_FWD_REF</code> and <code>boost::forward</code>. Lets incorporate these utilities:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="cp">#include &lt;boost/smart_ptr.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/move/utility.hpp&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">BOOST_FWD_REF</span><span class="p">(</span><span class="n">A0</span><span class="p">)</span> <span class="n">a0</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a0</span><span class="p">)));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">A0</span><span class="p">,</span>
</span><span class='line'>            <span class="k">typename</span> <span class="n">A1</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">BOOST_FWD_REF</span><span class="p">(</span><span class="n">A0</span><span class="p">)</span> <span class="n">a0</span><span class="p">,</span>
</span><span class='line'>                  <span class="n">BOOST_FWD_REF</span><span class="p">(</span><span class="n">A1</span><span class="p">)</span> <span class="n">a1</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a0</span><span class="p">),</span>
</span><span class='line'>                              <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a1</span><span class="p">)));</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we get the output:</p>

<pre><code>A Constructor
B Constructor: 3
3
5
</code></pre>

<p>Thats better! Now that we know our code works, we can start to condense the pattern and let the preprocessor expand it out for us.</p>

<p><a href="http://www.boost.org/doc/libs/1_58_0/libs/preprocessor/doc/index.html">Boost::Preprocessor</a> is a handy library that makes interacting with the preprocessor much easier. It introduces a bunch of macros and conventions that we can build upon to emulate features like variadic templates. And despite how it sounds, the final result is rather compact and readable.</p>

<p>First, lets identify the patterns we want to condense. The first is the template parameter list:</p>

<pre><code>template&lt;typename A0, typename A1&gt;
</code></pre>

<p>Boost has a macro specifically designed for this purpose: <code>BOOST_PP_ENUM_PARAMS</code>. It takes in a number and some text, and replicates the text by appending increasing numbers. For example:</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
BOOST_PP_ENUM_PARAMS(3, typename A)
</code></pre>

<p>Outputs (using the preprocessor <code>cpp main.cpp</code>):</p>

<pre><code>typename A0 , typename A1 , typename A2
</code></pre>

<p>Simply wrap the template brackets around this to achieve our first piece:</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
template&lt;BOOST_PP_ENUM_PARAMS(3, typename A)&gt;
</code></pre>

<p>Outputs:</p>

<pre><code>template&lt; typename A0 , typename A1 , typename A2&gt;
</code></pre>

<p>Remember that C++ does not care about whitespace. The preprocessor macros will tend to insert whitespace in odd places. Likewise, the preprocessor will output everything on one line without line breaks.</p>

<p>The second pattern we see is the function parameters:</p>

<pre><code>BOOST_FWD_REF(A0) a0, BOOST_FWD_REF(A1) a1
</code></pre>

<p>This one is slightly trickier, because it doesn&rsquo;t fit the above enumeration pattern. For this case, we will use a different macro: <code>BOOST_PP_REPEAT</code>. This macro operates by convention; it will repeat a specified macro N times as long as that macro takes arguments in a certain way. In addition, we will use <code>BOOST_PP_CAT</code> to concatenate strings together. By treating N as one of the strings, we can create an enumeration with the freedom of controlling the output format.</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
#define PARAMETERS(Z, N, D) BOOST_PP_CAT(A,N) BOOST_PP_CAT(a,N)
BOOST_PP_REPEAT(3, PARAMETERS, ~)
</code></pre>

<p>Outputs:</p>

<pre><code>A0 a0 A1 a1 A2 a2
</code></pre>

<p>What is going on here? The <code>(Z, N, D)</code> represents state, number, and data, respectively. Boost uses this convention to pass around the &ldquo;state&rdquo; of the macro (analogous to how the <code>this</code> pointer is the implicit first parameter to any method call), the iteration value, and any extraneous data. For our case, we don&rsquo;t need to pass any data into the macro, so we use the conventional placeholder <code>~</code> to denote &ldquo;void&rdquo;.  On each call of our defined macro, <code>N</code> is updated with the iteration count, and we can concatenate that to the letters <code>A</code> and <code>a</code> to form our type and value.</p>

<p>But what about the commas? Boost has us covered here as well with <code>BOOST_PP_COMMA</code>:</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
#define PARAMETERS(Z, N, D) BOOST_PP_CAT(A,N) BOOST_PP_CAT(a,N) BOOST_PP_COMMA()
BOOST_PP_REPEAT(3, PARAMETERS, ~)
</code></pre>

<p>Outputs:</p>

<pre><code>A0 a0 , A1 a1 , A2 a2 ,
</code></pre>

<p>Hmm, not quite. There is a trailing comma that we need to get rid of. I&rsquo;ll admit that at this point I was pretty confused, until I learned the trick; Boost also provides <code>BOOST_PP_COMMA_IF</code>, which takes a condition argument and will only expand to a comma if the condition is not 0.</p>

<p>Here is the trick: Instead of trying to eliminate the trailing comma, <em>prepend</em> the comma!</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
#define PARAMETERS(Z, N, D) BOOST_PP_COMMA_IF(N) BOOST_PP_CAT(A,N) BOOST_PP_CAT(a,N)
BOOST_PP_REPEAT(3, PARAMETERS, ~)
</code></pre>

<p>Outputs:</p>

<pre><code>A0 a0 , A1 a1 , A2 a2
</code></pre>

<p>Perfect!</p>

<p>The final pattern is very similar to the second one:</p>

<pre><code>#include &lt;boost/preprocessor.hpp&gt;
#define FORWARD(Z, N, D) BOOST_PP_COMMA_IF(N) boost::forward&lt;BOOST_PP_CAT(A,N)&gt;(BOOST_PP_CAT(a,N))
BOOST_PP_REPEAT(3, FORWARD, ~)
</code></pre>

<p>Outputs:</p>

<pre><code>boost::forward&lt;A0&gt;(a0) , boost::forward&lt;A1&gt;(a1) , boost::forward&lt;A2&gt;(a2)
</code></pre>

<p>Armed with these tools, we can now simplify the factory:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">NUM_PARAMETERS</span> <span class="mi">3</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">PARAMETERS</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span> <span class="n">BOOST_PP_COMMA_IF</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="n">BOOST_FWD_REF</span><span class="p">(</span> <span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">))</span> <span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">FORWARD</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>    <span class="n">BOOST_PP_COMMA_IF</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
</span><span class='line'>  
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">EXPAND</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>                                            \
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="n">BOOST_PP_ENUM_PARAMS</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="k">typename</span> <span class="n">A</span><span class="p">)</span><span class="o">&gt;</span>                \
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">BOOST_PP_REPEAT</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">PARAMETERS</span><span class="p">,</span> <span class="o">~</span><span class="p">))</span> <span class="k">const</span>      \
</span><span class='line'>   <span class="p">{</span>                                                            \
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">BOOST_PP_REPEAT</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">FORWARD</span><span class="p">,</span> <span class="o">~</span><span class="p">)));</span> \
</span><span class='line'>   <span class="p">}</span>                                                            \
</span><span class='line'>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">EXPAND</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">FORWARD</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">PARAMETERS</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">NUM_PARAMETERS</span>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>It is always a good idea to undefine any macros you define after you are finished with them, since macros pollute the global namespace and you never know how they will interact with complex baselines.</p>

<p>There is one thing left to do; expand out the macro. Unsurprisingly, Boost also provides a way to do this. This method involves setting up a loop and iteratively calling <code>#include</code> on the result, which will cause the preprocessor to literally paste the results inline with the code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">NUM_PARAMETERS</span> <span class="mi">3</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">PARAMETERS</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span> <span class="n">BOOST_PP_COMMA_IF</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="n">BOOST_FWD_REF</span><span class="p">(</span> <span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">))</span> <span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">N</span><span class="p">)</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">FORWARD</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">D</span><span class="p">)</span>    <span class="n">BOOST_PP_COMMA_IF</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">A</span><span class="p">,</span><span class="n">N</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="n">BOOST_PP_CAT</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">N</span><span class="p">))</span>
</span><span class='line'>  
</span><span class='line'>   <span class="err">#</span><span class="n">define</span> <span class="n">EXPAND</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>                                            \
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="n">BOOST_PP_ENUM_PARAMS</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="k">typename</span> <span class="n">A</span><span class="p">)</span><span class="o">&gt;</span>                \
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="n">BOOST_PP_REPEAT</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">PARAMETERS</span><span class="p">,</span> <span class="o">~</span><span class="p">))</span> <span class="k">const</span>      \
</span><span class='line'>   <span class="p">{</span>                                                            \
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span><span class="n">BOOST_PP_REPEAT</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">FORWARD</span><span class="p">,</span> <span class="o">~</span><span class="p">)));</span> \
</span><span class='line'>   <span class="p">}</span>                                                            \
</span><span class='line'>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span>  <span class="n">BOOST_PP_LOCAL_MACRO</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="n">EXPAND</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
</span><span class='line'>   <span class="err">#</span><span class="n">define</span>  <span class="n">BOOST_PP_LOCAL_LIMITS</span>   <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">NUM_PARAMETERS</span><span class="p">)</span>
</span><span class='line'>   <span class="err">#</span><span class="n">include</span> <span class="n">BOOST_PP_LOCAL_ITERATE</span><span class="p">()</span>
</span><span class='line'>  
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">BOOST_PP_LOCAL_MACRO</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">BOOST_PP_LOCAL_LIMITS</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">EXPAND</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">FORWARD</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">PARAMETERS</span>
</span><span class='line'>   <span class="err">#</span><span class="n">undef</span> <span class="n">NUM_PARAMETERS</span>
</span><span class='line'>   <span class="c1">/////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Notice that the loop iterates from 1 to N, instead of starting at 0. This is because putting 0 in the template parameter expansion will result in <code>template&lt;&gt;</code>, and the compiler will interpret this as template specialization. To get around this, the &ldquo;base case&rdquo; for a default constructor is coded outside of the macro.</p>

<p>The preprocessor generates the following code:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">Factory</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">T</span> <span class="n">Type</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Pointer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">A0</span><span class="o">&gt;</span> <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span> <span class="k">const</span> <span class="n">A0</span> <span class="o">&amp;</span> <span class="n">a0</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a0</span><span class="p">)));</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">A0</span> <span class="p">,</span> <span class="k">typename</span> <span class="n">A1</span><span class="o">&gt;</span> <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span> <span class="k">const</span> <span class="n">A0</span> <span class="o">&amp;</span> <span class="n">a0</span> <span class="p">,</span> <span class="k">const</span> <span class="n">A1</span> <span class="o">&amp;</span> <span class="n">a1</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span> <span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a1</span><span class="p">)));</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span> <span class="k">typename</span> <span class="n">A0</span> <span class="p">,</span> <span class="k">typename</span> <span class="n">A1</span> <span class="p">,</span> <span class="k">typename</span> <span class="n">A2</span><span class="o">&gt;</span> <span class="n">Pointer</span> <span class="n">create</span><span class="p">(</span> <span class="k">const</span> <span class="n">A0</span> <span class="o">&amp;</span> <span class="n">a0</span> <span class="p">,</span> <span class="k">const</span> <span class="n">A1</span> <span class="o">&amp;</span> <span class="n">a1</span> <span class="p">,</span> <span class="k">const</span> <span class="n">A2</span> <span class="o">&amp;</span> <span class="n">a2</span><span class="p">)</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">Pointer</span><span class="p">(</span><span class="k">new</span> <span class="n">Type</span><span class="p">(</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A0</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a0</span><span class="p">)</span> <span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A1</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="p">,</span> <span class="n">boost</span><span class="o">::</span><span class="n">forward</span><span class="o">&lt;</span><span class="n">A2</span><span class="o">&gt;</span><span class="p">(</span><span class="n">a2</span><span class="p">)));</span> <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The final step is to increase <code>NUM_PARAMETERS</code> to 10 (or whatever max number you want to support).</p>

<p>The preprocessor is often disregarded in coding standards, however it is a powerful feature of C++ that should not be ignored.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/21/boost-fusion-json-serializer/">Boost Fusion Json Serializer</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-05-21T19:21:50-04:00" pubdate data-updated="true">May 21<span>st</span>, 2015</time>
        
           | <a href="/blog/2015/05/21/boost-fusion-json-serializer/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/05/21/boost-fusion-json-serializer/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In this post, I am going to walkthrough the creation of a C++ mixin that will allow any structure to serialize itself to Json, using the magical power of Boost::Fusion.</p>

<p>To do this, you will need the following installed:</p>

<ul>
<li>libboost-dev</li>
</ul>


<p>The Json serializer will support any structure composed of the following:</p>

<ul>
<li>Primitives</li>
<li>Arrays</li>
<li>Containers</li>
<li>Nested Structures</li>
</ul>


<p>First, we need a test structure that we want to serialize to Json. It needs to include some arrays, containers, and nested structures to test all the abilities of the serializer:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">struct</span> <span class="n">inner</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'>       <span class="kt">double</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>       <span class="kt">bool</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vec_t</span><span class="p">;</span>
</span><span class='line'>       <span class="n">vec_t</span> <span class="n">d</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">struct</span> <span class="n">outer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="kt">int</span> <span class="n">one</span><span class="p">;</span>
</span><span class='line'>       <span class="kt">double</span> <span class="n">two</span><span class="p">;</span>
</span><span class='line'>       <span class="kt">bool</span> <span class="n">three</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">inner</span> <span class="n">array_t</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>       <span class="n">array_t</span> <span class="n">array</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">set_t</span><span class="p">;</span>
</span><span class='line'>       <span class="n">set_t</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">map_t</span><span class="p">;</span>
</span><span class='line'>       <span class="n">map_t</span> <span class="n">m</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span></code></pre></td></tr></table></div></figure>


<p>Boost::Fusion is a library that enables reflection in C++ with only a small amount of boilerplate. Pay careful attention to the use of <code>()</code> instead of <code>{}</code>, and the placement of the <code>,</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>       <span class="n">inner</span><span class="p">,</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">double</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="n">inner</span><span class="o">::</span><span class="n">vec_t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'>    <span class="p">(</span>
</span><span class='line'>       <span class="n">outer</span><span class="p">,</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">one</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">double</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="n">three</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">array_t</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">set_t</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>       <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">map_t</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</span><span class='line'>    <span class="p">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, we define a serializer for each meta-type that needs to be supported. Each serializer will take a reference to an output stream that will be appended to, a type to serialize, and the current recursion depth. The depth is useful for pretty-printing with the proper indentation. All four will start off following the same pattern before we complete the implementation:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">primitive_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">array_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">array_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">container_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The <code>primitive_serializer</code> is the simplest one to implement, so lets start with that one. It will enclose the value in quotation marks and append it to the stream:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">primitive_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next, lets implement the <code>array_serializer</code>. We need to get the size of the array, and iterate over it while serializing each element. Notice the use of newlines and tabs, and the increase in the recursion depth; we want the Json output to be pretty, as opposed to compressed (Switching to a compressed version is as simple as removing the newlines, tabs, and whitespace). Finally, we want to insert commas between each element, but we don&rsquo;t want a comma trailing after the final element:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="c1">// Helper method for generating a tab as 3 spaces</span>
</span><span class='line'>    <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tab</span><span class="p">(</span><span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span><span class="n">retval</span> <span class="o">+=</span> <span class="s">&quot;   &quot;</span><span class="p">;}</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">array_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">array_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// If T is an array type then removes the top level array qualifier from T, otherwise leaves T unchanged. </span>
</span><span class='line'>       <span class="c1">// For example &quot;int[2][3]&quot; becomes &quot;int[3]&quot;.</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_bounds</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">slice_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Determine the size of the array by dividing out the size of its elements</span>
</span><span class='line'>       <span class="k">static</span> <span class="k">const</span> <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slice_t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Indent the stream</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// For each element in the array</span>
</span><span class='line'>          <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="c1">// Serialize the element</span>
</span><span class='line'>             <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">slice_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>             <span class="c1">// As long as we are not after the last element</span>
</span><span class='line'>             <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="p">{</span>
</span><span class='line'>                <span class="c1">// Add a comma separator</span>
</span><span class='line'>                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>             <span class="p">}</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Close the array representation</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The container serializer is very similar; we use <code>BOOST_FOREACH</code> to do the iteration, and pull the <code>value_type</code> out of the container, but everything else is the same:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">container_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Use the container&#39;s size method</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// STL containers all have a &quot;value_type&quot; typedef</span>
</span><span class='line'>          <span class="n">BOOST_FOREACH</span><span class="p">(</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="c1">// Serialize each value</span>
</span><span class='line'>             <span class="n">json_serializer</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>             <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="p">{</span>
</span><span class='line'>                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>             <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>             <span class="c1">// Keep track of the count so we can tell when a comma separator is needed</span>
</span><span class='line'>             <span class="o">++</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last serializer is the <code>struct_serializer</code>. This one is trickier. Structures are adapted as <code>Boost::Fusion</code> sequences by the boilerplate we defined above. A sequence is basically a vector, except each element can have a different type. In this case, the type/value pairs correspond directly with the members of the structure, and we can iterate over these members. We will accomplish this through recursion.</p>

<p>Before we get to the serializer, lets define some wrappers for interacting with the sequences in a friendlier way. We can get properties of the sequence as a whole, or we can get properties of a certain element in the sequence by using it&rsquo;s index. You can even get an element&rsquo;s member name and member type as a string (which is very handy when writing an XML serializer):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">sequence</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="c1">// Point to the first element</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">begin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Point to the element after the last element in the sequence</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">end</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Point to the first element</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">first</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Point to the second element (for pairs)</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">second</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Point to the last element in the sequence</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">end</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">last</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Number of elements in the sequence</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>             <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">element_at</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="c1">// Type of the element at this index</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">value_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Previous element</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">previous</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Next element</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">next</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Member name of the element at this index</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">extension</span><span class="o">::</span><span class="n">struct_member_name</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;::</span><span class="n">call</span><span class="p">();</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Type name of the element at this index</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type_name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">units</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="n">type</span><span class="p">).</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Access the element</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">S</span> <span class="k">const</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">get</span><span class="p">(</span><span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Next we define the recursive struct serializer. The layout is similar to our other serializers, except this time there are two template parameters: the sequence and the element index.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer_recursive</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the above sequence helpers, we can obtain the type of the current element, and the index of the next element. We can also get the name of the element being serialized, it&rsquo;s type, and it&rsquo;s value:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="c1">// Current element</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Next element</span>
</span><span class='line'>    <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">next</span> <span class="n">next_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Name of current element</span>
</span><span class='line'>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Value of current element</span>
</span><span class='line'>    <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span></code></pre></td></tr></table></div></figure>


<p>Structures will be represented as key/value pairs separated by commas. Each value might be an array, container, or nested structure; therefore we need to call the <code>json_serializer</code> on each element. The final step is to recurse to the next element of the sequence. So a complete implementation would look like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer_recursive</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="c1">// Get the current and next elements</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">next</span> <span class="n">next_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// The name of the element is the key</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// The element itself is the value</span>
</span><span class='line'>          <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Output the key</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="n">name</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> : &quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Recursively output the value</span>
</span><span class='line'>          <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">current_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Add a separator for the next element</span>
</span><span class='line'>          <span class="c1">// (Pay attention to this, we will revisit it later)</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Perform a recursive call to the next element</span>
</span><span class='line'>          <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">next_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">depth</span><span class="p">);</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>We need to define the base case to stop the recursion. To do this, we use template specialization for the last element of the sequence. Then, we initiate the recursion by calling into the first element of the sequence:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="c1">// Specialize on the last element in the sequence</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">end</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// No output</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Initiate the recursion by calling into the first element</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer_initiate</span> <span class="o">:</span> <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">begin</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>With the help of these pieces, we can implement the <code>struct_serializer</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Begin recursing into the structure sequence</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
</span><span class='line'>          <span class="n">struct_serializer_initiate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now that all four serializers are implemented, we need a way to determine which one to use. To do this, we will utilize Boost&rsquo;s <code>type traits</code> to determine the properties of each type. Boost provides type traits for arrays and classes (which we have adapted into sequences), as well as a hidden one that identifies containers. Anything left over is treated as a primitive. This can be accomplished with some metaprogramming magic and a series of if-then-else statements:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">choose_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="c1">// Very large typedef, indented to show the different nested levels</span>
</span><span class='line'>       <span class="k">typedef</span>
</span><span class='line'>       <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">is_array</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>                                                                                      <span class="c1">// If the type is an array,</span>
</span><span class='line'>                                    <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">array_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>                                                              <span class="c1">// use the array serializer</span>
</span><span class='line'>                                    <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">spirit</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">is_container</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>                                     <span class="c1">// Otherwise, check to see if it is a container (using the hidden type-trait)</span>
</span><span class='line'>                                                                 <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>                             <span class="c1">// If so, use the container serializer</span>
</span><span class='line'>                                                                 <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">is_class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>                            <span class="c1">// Otherwise, check to see if it is a structure</span>
</span><span class='line'>                                                                                              <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>   <span class="c1">// If so, use the structure serializer</span>
</span><span class='line'>                                                                                              <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span> <span class="c1">// If all else fails, treat it as a primitive.</span>
</span><span class='line'>                                                                                             <span class="o">&gt;</span>
</span><span class='line'>                                                                <span class="o">&gt;</span>
</span><span class='line'>                                   <span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>       <span class="n">type</span><span class="p">;</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>The last piece is to wrap all this code up into a <code>json_serializer</code> and utilize it with a mixin. The mixin uses <code>CRTP</code> in which a structure inherits from the mixin and passes itself in as the template parameter. The mixin can then cast itself to the class type and begin iterating over itself:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="c1">// The json serializer adapts itself to the top level type</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">json_serializer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">choose_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// This is the mixin to inherit from</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">json</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="c1">// Returns the json representation of this class</span>
</span><span class='line'>       <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_json</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Serialize to a stringstream, convert booleans to strings. Start at a depth of 0.</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
</span><span class='line'>          <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">boolalpha</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
</span><span class='line'>          <span class="k">return</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>       <span class="c1">// Cast ourselves to the template parameter since this is a mixin via CRTP</span>
</span><span class='line'>       <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">self</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span> <span class="k">const</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Time to test it out! Instantiate the structure and populate it. Remember to apply the mixin via inheritance (<code>struct outer : public json&lt;outer&gt;</code>):</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="n">outer</span> <span class="n">o</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">two</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">three</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="mf">4.4</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">c</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="mf">6.6</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">c</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">33</span><span class="p">);</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">44</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">55</span><span class="p">);</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">66</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">77</span><span class="p">]</span> <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
</span><span class='line'>       <span class="n">o</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">99</span><span class="p">]</span> <span class="o">=</span> <span class="mi">111</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">.</span><span class="n">to_json</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>       <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>The resulting Json printed out looks like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="nt">&quot;one&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;two&quot;</span> <span class="p">:</span> <span class="s2">&quot;2.2&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;three&quot;</span> <span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;array&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;a&quot;</span> <span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;b&quot;</span> <span class="p">:</span> <span class="s2">&quot;4.4&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;c&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;d&quot;</span> <span class="p">:</span>
</span><span class='line'>             <span class="p">[</span><span class="s2">&quot;11&quot;</span><span class="p">,</span> <span class="s2">&quot;22&quot;</span>
</span><span class='line'>             <span class="p">],</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;a&quot;</span> <span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;b&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.6&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;c&quot;</span> <span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;d&quot;</span> <span class="p">:</span>
</span><span class='line'>             <span class="p">[</span><span class="s2">&quot;33&quot;</span><span class="p">,</span> <span class="s2">&quot;44&quot;</span>
</span><span class='line'>             <span class="p">],</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">],</span>
</span><span class='line'>       <span class="nt">&quot;s&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">[</span><span class="s2">&quot;55&quot;</span><span class="p">,</span> <span class="s2">&quot;66&quot;</span>
</span><span class='line'>       <span class="p">],</span>
</span><span class='line'>       <span class="nt">&quot;m&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;first&quot;</span> <span class="p">:</span> <span class="s2">&quot;77&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;second&quot;</span> <span class="p">:</span> <span class="s2">&quot;88&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;first&quot;</span> <span class="p">:</span> <span class="s2">&quot;99&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;second&quot;</span> <span class="p">:</span> <span class="s2">&quot;111&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">],</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Close, but not quite. There are multiple issues:</p>

<ul>
<li>Arrays are formatted goofy (lines 12, 20, 25)</li>
<li>Trailing commas (lines 21, 37)</li>
<li>The map is represented as an array of pairs (lines 29-36)</li>
</ul>


<p>Fortunately, these issues are easily fixed.</p>

<p>The first issue is caused by the <code>primitive_serializer</code> not adding newlines for array values. This can be fixed with an extra boolean parameter that gets set when calling it from the <code>array_serializer</code>. You will find that you also want to set this extra parameter to true when calling from the <code>container_serializer</code>, since the containers are formatted as arrays. Note that all the serializer signatures need to be updated so they match, as well as each call to the serializer.:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">primitive_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// Put in tabs if this is a value from an array (called from an array serializer)</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">array_value</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>                <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>                <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>                <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>                <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Fixing the second issue (trailing commas) involves a little more template magic. The problem is caused by the comma being added inside <code>struct_serializer_recursive</code>. A comma is added just before the recursion hits the base case and stops. Instead, we should conditionally add this comma, but skip that step on the last element. To do this, we outsource the comma-insertion to a functor and specialize it for the last element:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="c1">// Return a proper comma separator for any element in the sequence.</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>             <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">separator</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>        <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">comma</span><span class="p">()</span>
</span><span class='line'>        <span class="p">{</span>
</span><span class='line'>           <span class="k">return</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
</span><span class='line'>        <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Specialize on the last element and prevent a comma from being returned.</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">separator</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">last</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">comma</span><span class="p">()</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now <code>os &lt;&lt; ", ";</code> can be replaced with <code>os &lt;&lt; separator&lt;S, N&gt;::comma();</code>.</p>

<p>The third issue is caused by the map container&rsquo;s value_type being a pair. Boost is kind enough to adapt pairs into structures for us, but the output isn&rsquo;t quite the way we want it. Instead, we want <code>first</code> to be treated as the key, and <code>second</code> to be treated as the value. To fix this, we make a modified copy of <code>struct_serializer_recursive</code> for pairs that doesn&rsquo;t access the member name&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">pair_serializer_recursive</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">next</span> <span class="n">next_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// For pairs, the member name will be &quot;first&quot; or &quot;second&quot;.</span>
</span><span class='line'>          <span class="c1">// Instead, treat the value of &quot;first&quot; as the key</span>
</span><span class='line'>          <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> : &quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Then recurse and treat the value of &quot;second&quot; as the value</span>
</span><span class='line'>          <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">next_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Specialize on the second element of the pair to stop the recursion</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>          <span class="c1">// Mimic the primitive serializer</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>             <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Initiate the recursion</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">pair_serializer_initiate</span> <span class="o">:</span> <span class="k">public</span> <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">begin</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;specialize the <code>container_serializer</code> for <code>std::map</code> to change the boolean flags being set on the serializer&hellip;</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="c1">// Specialize the container serializer on std::map</span>
</span><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">C</span><span class="p">,</span> <span class="k">typename</span> <span class="n">A</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">;</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>          <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">BOOST_FOREACH</span><span class="p">(</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="c1">// This will end up calling the structure serializer, but we set the &quot;pair&quot; flag to true</span>
</span><span class='line'>             <span class="n">json_serializer</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>             <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>             <span class="p">{</span>
</span><span class='line'>                <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>             <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>             <span class="o">++</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>&hellip;and conditonally use the <code>pair_serializer</code> inside the <code>struct_serializer</code>:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'>    <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'>    <span class="k">struct</span> <span class="n">struct_serializer</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">typedef</span> <span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>       <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>       <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="c1">// If being called from the std::map specialization of the container serializer,</span>
</span><span class='line'>          <span class="c1">// we should treat the values as pairs, so forward to the appropriate serializer</span>
</span><span class='line'>          <span class="k">if</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="n">pair_serializer_initiate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
</span><span class='line'>             <span class="n">struct_serializer_initiate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>             <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">};</span>
</span></code></pre></td></tr></table></div></figure>


<p>Unfortunately, this means we needed to add another boolean parameter for our serialize function (and all serializers must do this so the signatures all match). After all that, we get the following Json output:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="nt">&quot;one&quot;</span> <span class="p">:</span> <span class="s2">&quot;1&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;two&quot;</span> <span class="p">:</span> <span class="s2">&quot;2.2&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;three&quot;</span> <span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span class='line'>       <span class="nt">&quot;array&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">[</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;a&quot;</span> <span class="p">:</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;b&quot;</span> <span class="p">:</span> <span class="s2">&quot;4.4&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;c&quot;</span> <span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;d&quot;</span> <span class="p">:</span>
</span><span class='line'>             <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;11&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;22&quot;</span>
</span><span class='line'>             <span class="p">]</span>
</span><span class='line'>          <span class="p">},</span>
</span><span class='line'>          <span class="p">{</span>
</span><span class='line'>             <span class="nt">&quot;a&quot;</span> <span class="p">:</span> <span class="s2">&quot;5&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;b&quot;</span> <span class="p">:</span> <span class="s2">&quot;6.6&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;c&quot;</span> <span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span class='line'>             <span class="nt">&quot;d&quot;</span> <span class="p">:</span>
</span><span class='line'>             <span class="p">[</span>
</span><span class='line'>                <span class="s2">&quot;33&quot;</span><span class="p">,</span>
</span><span class='line'>                <span class="s2">&quot;44&quot;</span>
</span><span class='line'>             <span class="p">]</span>
</span><span class='line'>          <span class="p">}</span>
</span><span class='line'>       <span class="p">],</span>
</span><span class='line'>       <span class="nt">&quot;s&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">[</span>
</span><span class='line'>          <span class="s2">&quot;55&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="s2">&quot;66&quot;</span>
</span><span class='line'>       <span class="p">],</span>
</span><span class='line'>       <span class="nt">&quot;m&quot;</span> <span class="p">:</span>
</span><span class='line'>       <span class="p">{</span>
</span><span class='line'>          <span class="nt">&quot;77&quot;</span> <span class="p">:</span> <span class="s2">&quot;88&quot;</span><span class="p">,</span>
</span><span class='line'>          <span class="nt">&quot;99&quot;</span> <span class="p">:</span> <span class="s2">&quot;111&quot;</span>
</span><span class='line'>       <span class="p">}</span>
</span><span class='line'>    <span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It validates! Below is the final form of the code. While it is quite a bit, the nice thing is that all a user needs to do is perform the fusion adaption of their structure and inherit from the mixin; the rest is hidden behind the scenes.</p>

<figure class='code'><figcaption><span> (json.cpp)</span> <a href='/downloads/code/json.cpp'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
<span class='line-number'>173</span>
<span class='line-number'>174</span>
<span class='line-number'>175</span>
<span class='line-number'>176</span>
<span class='line-number'>177</span>
<span class='line-number'>178</span>
<span class='line-number'>179</span>
<span class='line-number'>180</span>
<span class='line-number'>181</span>
<span class='line-number'>182</span>
<span class='line-number'>183</span>
<span class='line-number'>184</span>
<span class='line-number'>185</span>
<span class='line-number'>186</span>
<span class='line-number'>187</span>
<span class='line-number'>188</span>
<span class='line-number'>189</span>
<span class='line-number'>190</span>
<span class='line-number'>191</span>
<span class='line-number'>192</span>
<span class='line-number'>193</span>
<span class='line-number'>194</span>
<span class='line-number'>195</span>
<span class='line-number'>196</span>
<span class='line-number'>197</span>
<span class='line-number'>198</span>
<span class='line-number'>199</span>
<span class='line-number'>200</span>
<span class='line-number'>201</span>
<span class='line-number'>202</span>
<span class='line-number'>203</span>
<span class='line-number'>204</span>
<span class='line-number'>205</span>
<span class='line-number'>206</span>
<span class='line-number'>207</span>
<span class='line-number'>208</span>
<span class='line-number'>209</span>
<span class='line-number'>210</span>
<span class='line-number'>211</span>
<span class='line-number'>212</span>
<span class='line-number'>213</span>
<span class='line-number'>214</span>
<span class='line-number'>215</span>
<span class='line-number'>216</span>
<span class='line-number'>217</span>
<span class='line-number'>218</span>
<span class='line-number'>219</span>
<span class='line-number'>220</span>
<span class='line-number'>221</span>
<span class='line-number'>222</span>
<span class='line-number'>223</span>
<span class='line-number'>224</span>
<span class='line-number'>225</span>
<span class='line-number'>226</span>
<span class='line-number'>227</span>
<span class='line-number'>228</span>
<span class='line-number'>229</span>
<span class='line-number'>230</span>
<span class='line-number'>231</span>
<span class='line-number'>232</span>
<span class='line-number'>233</span>
<span class='line-number'>234</span>
<span class='line-number'>235</span>
<span class='line-number'>236</span>
<span class='line-number'>237</span>
<span class='line-number'>238</span>
<span class='line-number'>239</span>
<span class='line-number'>240</span>
<span class='line-number'>241</span>
<span class='line-number'>242</span>
<span class='line-number'>243</span>
<span class='line-number'>244</span>
<span class='line-number'>245</span>
<span class='line-number'>246</span>
<span class='line-number'>247</span>
<span class='line-number'>248</span>
<span class='line-number'>249</span>
<span class='line-number'>250</span>
<span class='line-number'>251</span>
<span class='line-number'>252</span>
<span class='line-number'>253</span>
<span class='line-number'>254</span>
<span class='line-number'>255</span>
<span class='line-number'>256</span>
<span class='line-number'>257</span>
<span class='line-number'>258</span>
<span class='line-number'>259</span>
<span class='line-number'>260</span>
<span class='line-number'>261</span>
<span class='line-number'>262</span>
<span class='line-number'>263</span>
<span class='line-number'>264</span>
<span class='line-number'>265</span>
<span class='line-number'>266</span>
<span class='line-number'>267</span>
<span class='line-number'>268</span>
<span class='line-number'>269</span>
<span class='line-number'>270</span>
<span class='line-number'>271</span>
<span class='line-number'>272</span>
<span class='line-number'>273</span>
<span class='line-number'>274</span>
<span class='line-number'>275</span>
<span class='line-number'>276</span>
<span class='line-number'>277</span>
<span class='line-number'>278</span>
<span class='line-number'>279</span>
<span class='line-number'>280</span>
<span class='line-number'>281</span>
<span class='line-number'>282</span>
<span class='line-number'>283</span>
<span class='line-number'>284</span>
<span class='line-number'>285</span>
<span class='line-number'>286</span>
<span class='line-number'>287</span>
<span class='line-number'>288</span>
<span class='line-number'>289</span>
<span class='line-number'>290</span>
<span class='line-number'>291</span>
<span class='line-number'>292</span>
<span class='line-number'>293</span>
<span class='line-number'>294</span>
<span class='line-number'>295</span>
<span class='line-number'>296</span>
<span class='line-number'>297</span>
<span class='line-number'>298</span>
<span class='line-number'>299</span>
<span class='line-number'>300</span>
<span class='line-number'>301</span>
<span class='line-number'>302</span>
<span class='line-number'>303</span>
<span class='line-number'>304</span>
<span class='line-number'>305</span>
<span class='line-number'>306</span>
<span class='line-number'>307</span>
<span class='line-number'>308</span>
<span class='line-number'>309</span>
<span class='line-number'>310</span>
<span class='line-number'>311</span>
<span class='line-number'>312</span>
<span class='line-number'>313</span>
<span class='line-number'>314</span>
<span class='line-number'>315</span>
<span class='line-number'>316</span>
<span class='line-number'>317</span>
<span class='line-number'>318</span>
<span class='line-number'>319</span>
<span class='line-number'>320</span>
<span class='line-number'>321</span>
<span class='line-number'>322</span>
<span class='line-number'>323</span>
<span class='line-number'>324</span>
<span class='line-number'>325</span>
<span class='line-number'>326</span>
<span class='line-number'>327</span>
<span class='line-number'>328</span>
<span class='line-number'>329</span>
<span class='line-number'>330</span>
<span class='line-number'>331</span>
<span class='line-number'>332</span>
<span class='line-number'>333</span>
<span class='line-number'>334</span>
<span class='line-number'>335</span>
<span class='line-number'>336</span>
<span class='line-number'>337</span>
<span class='line-number'>338</span>
<span class='line-number'>339</span>
<span class='line-number'>340</span>
<span class='line-number'>341</span>
<span class='line-number'>342</span>
<span class='line-number'>343</span>
<span class='line-number'>344</span>
<span class='line-number'>345</span>
<span class='line-number'>346</span>
<span class='line-number'>347</span>
<span class='line-number'>348</span>
<span class='line-number'>349</span>
<span class='line-number'>350</span>
<span class='line-number'>351</span>
<span class='line-number'>352</span>
<span class='line-number'>353</span>
<span class='line-number'>354</span>
<span class='line-number'>355</span>
<span class='line-number'>356</span>
<span class='line-number'>357</span>
<span class='line-number'>358</span>
<span class='line-number'>359</span>
<span class='line-number'>360</span>
<span class='line-number'>361</span>
<span class='line-number'>362</span>
<span class='line-number'>363</span>
<span class='line-number'>364</span>
<span class='line-number'>365</span>
<span class='line-number'>366</span>
<span class='line-number'>367</span>
<span class='line-number'>368</span>
<span class='line-number'>369</span>
<span class='line-number'>370</span>
<span class='line-number'>371</span>
<span class='line-number'>372</span>
<span class='line-number'>373</span>
<span class='line-number'>374</span>
<span class='line-number'>375</span>
<span class='line-number'>376</span>
<span class='line-number'>377</span>
<span class='line-number'>378</span>
<span class='line-number'>379</span>
<span class='line-number'>380</span>
<span class='line-number'>381</span>
<span class='line-number'>382</span>
<span class='line-number'>383</span>
<span class='line-number'>384</span>
<span class='line-number'>385</span>
<span class='line-number'>386</span>
<span class='line-number'>387</span>
<span class='line-number'>388</span>
<span class='line-number'>389</span>
<span class='line-number'>390</span>
<span class='line-number'>391</span>
<span class='line-number'>392</span>
<span class='line-number'>393</span>
<span class='line-number'>394</span>
<span class='line-number'>395</span>
<span class='line-number'>396</span>
<span class='line-number'>397</span>
<span class='line-number'>398</span>
<span class='line-number'>399</span>
<span class='line-number'>400</span>
<span class='line-number'>401</span>
<span class='line-number'>402</span>
<span class='line-number'>403</span>
<span class='line-number'>404</span>
<span class='line-number'>405</span>
<span class='line-number'>406</span>
<span class='line-number'>407</span>
<span class='line-number'>408</span>
<span class='line-number'>409</span>
<span class='line-number'>410</span>
<span class='line-number'>411</span>
<span class='line-number'>412</span>
<span class='line-number'>413</span>
<span class='line-number'>414</span>
<span class='line-number'>415</span>
<span class='line-number'>416</span>
<span class='line-number'>417</span>
<span class='line-number'>418</span>
<span class='line-number'>419</span>
<span class='line-number'>420</span>
<span class='line-number'>421</span>
<span class='line-number'>422</span>
<span class='line-number'>423</span>
<span class='line-number'>424</span>
<span class='line-number'>425</span>
<span class='line-number'>426</span>
<span class='line-number'>427</span>
<span class='line-number'>428</span>
<span class='line-number'>429</span>
<span class='line-number'>430</span>
<span class='line-number'>431</span>
<span class='line-number'>432</span>
<span class='line-number'>433</span>
<span class='line-number'>434</span>
<span class='line-number'>435</span>
<span class='line-number'>436</span>
<span class='line-number'>437</span>
<span class='line-number'>438</span>
<span class='line-number'>439</span>
<span class='line-number'>440</span>
<span class='line-number'>441</span>
<span class='line-number'>442</span>
<span class='line-number'>443</span>
<span class='line-number'>444</span>
<span class='line-number'>445</span>
<span class='line-number'>446</span>
<span class='line-number'>447</span>
<span class='line-number'>448</span>
<span class='line-number'>449</span>
<span class='line-number'>450</span>
<span class='line-number'>451</span>
<span class='line-number'>452</span>
<span class='line-number'>453</span>
<span class='line-number'>454</span>
<span class='line-number'>455</span>
<span class='line-number'>456</span>
</pre></td><td class='code'><pre><code class='c++'><span class='line'><span class="c1">// json.cpp</span>
</span><span class='line'><span class="c1">// Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c1">// it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c1">// the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c1">// (at your option) any later version.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c1">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c1">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c1">// GNU General Public License for more details.</span>
</span><span class='line'><span class="c1">//</span>
</span><span class='line'><span class="c1">// You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c1">// along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="cp">#include &lt;boost/foreach.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/adapted.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/at.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/size.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/include/value_at.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/mpl.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/sequence/intrinsic/at.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/sequence/intrinsic/size.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/fusion/sequence/intrinsic/value_at.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/eval_if.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/identity.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/mpl/next_prior.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/spirit/home/support/container.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/type_traits.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;boost/units/detail/utility.hpp&gt;</span>
</span><span class='line'><span class="cp">#include &lt;iostream&gt;</span>
</span><span class='line'><span class="cp">#include &lt;map&gt;</span>
</span><span class='line'><span class="cp">#include &lt;set&gt;</span>
</span><span class='line'><span class="cp">#include &lt;vector&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">sequence</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Point to the first element</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">begin</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Point to the element after the last element in the sequence</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">end</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Point to the first element</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">first</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Point to the second element (for pairs)</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">int_</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span> <span class="n">second</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Point to the last element in the sequence</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">end</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">last</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Number of elements in the sequence</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">size</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">size</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>          <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">element_at</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="c1">// Type of the element at this index</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">value_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Previous element</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">prior</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">previous</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Next element</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">next</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">next</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Member name of the element at this index</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">extension</span><span class="o">::</span><span class="n">struct_member_name</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">::</span><span class="n">value</span><span class="o">&gt;::</span><span class="n">call</span><span class="p">();</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Type name of the element at this index</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">type_name</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">units</span><span class="o">::</span><span class="n">detail</span><span class="o">::</span><span class="n">demangle</span><span class="p">(</span><span class="k">typeid</span><span class="p">(</span><span class="n">type</span><span class="p">).</span><span class="n">name</span><span class="p">());</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// Access the element</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">result_of</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">S</span> <span class="k">const</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">get</span><span class="p">(</span><span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>     <span class="k">return</span> <span class="n">boost</span><span class="o">::</span><span class="n">fusion</span><span class="o">::</span><span class="n">at</span><span class="o">&lt;</span><span class="n">N</span><span class="o">&gt;</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Insert a comma into the stream</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span>
</span><span class='line'>         <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">separator</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>    <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">comma</span><span class="p">()</span>
</span><span class='line'>    <span class="p">{</span>
</span><span class='line'>       <span class="k">return</span> <span class="s">&quot;,&quot;</span><span class="p">;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Specialize for the last element in the sequence</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">separator</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">last</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">comma</span><span class="p">()</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Forward</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">json_serializer</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'><span class="k">static</span> <span class="kr">inline</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">tab</span><span class="p">(</span><span class="kt">int</span> <span class="n">depth</span><span class="p">)</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'>  <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">depth</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">){</span><span class="n">retval</span> <span class="o">+=</span> <span class="s">&quot;   &quot;</span><span class="p">;}</span>
</span><span class='line'>  <span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Occurs at every element of the sequence</span>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">struct_serializer_recursive</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">next</span> <span class="n">next_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">name</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">name</span><span class="p">();</span>
</span><span class='line'>      <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="n">name</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> : &quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">current_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="n">separator</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">comma</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">next_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">end</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="c1">// No output</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">struct_serializer_initiate</span> <span class="o">:</span> <span class="n">struct_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">begin</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">N</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pair_serializer_recursive</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">next</span> <span class="n">next_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">N</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s"> : &quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="n">next_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">S</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">current_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">S</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">s</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">current_t</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">element_at</span><span class="o">&lt;</span><span class="n">S</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">S</span><span class="o">&gt;::</span><span class="n">second</span><span class="o">&gt;::</span><span class="n">get</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>         <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">pair_serializer_initiate</span> <span class="o">:</span> <span class="k">public</span> <span class="n">pair_serializer_recursive</span><span class="o">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="k">typename</span> <span class="n">sequence</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">begin</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">array_serializer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">array_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">remove_bounds</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span> <span class="n">slice_t</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">static</span> <span class="k">const</span> <span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">slice_t</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">for</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">slice_t</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">container_serializer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;[&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">BOOST_FOREACH</span><span class="p">(</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">json_serializer</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="o">++</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">C</span><span class="p">,</span> <span class="k">typename</span> <span class="n">A</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">A</span><span class="o">&gt;</span> <span class="n">T</span><span class="p">;</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">t</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">BOOST_FOREACH</span><span class="p">(</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span> <span class="n">v</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">json_serializer</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">::</span><span class="n">value_type</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">true</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>         <span class="k">if</span><span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</span><span class='line'>         <span class="p">{</span>
</span><span class='line'>            <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;, &quot;</span><span class="p">;</span>
</span><span class='line'>         <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>         <span class="o">++</span><span class="n">count</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">struct_serializer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">pair_serializer_initiate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;{&quot;</span><span class="p">;</span>
</span><span class='line'>         <span class="n">struct_serializer_initiate</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>         <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;}&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">primitive_serializer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">type</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">Ostream</span><span class="o">&gt;</span>
</span><span class='line'>   <span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">serialize</span><span class="p">(</span><span class="n">Ostream</span><span class="o">&amp;</span> <span class="n">os</span><span class="p">,</span> <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">t</span><span class="p">,</span> <span class="kt">int</span> <span class="n">depth</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">array_value</span><span class="p">,</span> <span class="kt">bool</span> <span class="n">pair</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">if</span><span class="p">(</span><span class="n">array_value</span><span class="p">)</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">tab</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>            <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>      <span class="p">{</span>
</span><span class='line'>         <span class="n">os</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span>
</span><span class='line'>            <span class="o">&lt;&lt;</span> <span class="n">t</span>
</span><span class='line'>            <span class="o">&lt;&lt;</span> <span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">;</span>
</span><span class='line'>      <span class="p">}</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">choose_serializer</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="k">typedef</span>
</span><span class='line'>   <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">is_array</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">array_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">spirit</span><span class="o">::</span><span class="n">traits</span><span class="o">::</span><span class="n">is_container</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                                             <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">container_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                                             <span class="k">typename</span> <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">eval_if</span><span class="o">&lt;</span><span class="n">boost</span><span class="o">::</span><span class="n">is_class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                                                                          <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">struct_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">,</span>
</span><span class='line'>                                                                                          <span class="n">boost</span><span class="o">::</span><span class="n">mpl</span><span class="o">::</span><span class="n">identity</span><span class="o">&lt;</span><span class="n">primitive_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="o">&gt;</span>
</span><span class='line'>                                                                                         <span class="o">&gt;</span>
</span><span class='line'>                                                            <span class="o">&gt;</span>
</span><span class='line'>                               <span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'>   <span class="n">type</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">json_serializer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">choose_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">type</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
</span><span class='line'><span class="k">struct</span> <span class="n">json</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">to_json</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">ss</span><span class="p">;</span>
</span><span class='line'>      <span class="n">json_serializer</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;::</span><span class="n">serialize</span><span class="p">(</span><span class="n">ss</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">boolalpha</span><span class="p">,</span> <span class="n">self</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
</span><span class='line'>      <span class="k">return</span> <span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">private</span><span class="o">:</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">T</span> <span class="k">const</span><span class="o">&amp;</span> <span class="n">self</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="k">const</span>
</span><span class='line'>   <span class="p">{</span>
</span><span class='line'>      <span class="k">return</span> <span class="o">*</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">T</span> <span class="k">const</span><span class="o">*&gt;</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>
</span><span class='line'>   <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="c1">////////////////////////////////////////////////////////////////////////////////</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">inner</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">a</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">double</span> <span class="n">b</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">bool</span> <span class="n">c</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">vec_t</span><span class="p">;</span>
</span><span class='line'>   <span class="n">vec_t</span> <span class="n">d</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'><span class="k">struct</span> <span class="n">outer</span> <span class="o">:</span> <span class="k">public</span> <span class="n">json</span><span class="o">&lt;</span><span class="n">outer</span><span class="o">&gt;</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="kt">int</span> <span class="n">one</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">double</span> <span class="n">two</span><span class="p">;</span>
</span><span class='line'>   <span class="kt">bool</span> <span class="n">three</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">inner</span> <span class="n">array_t</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span class='line'>   <span class="n">array_t</span> <span class="n">array</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span> <span class="n">set_t</span><span class="p">;</span>
</span><span class='line'>   <span class="n">set_t</span> <span class="n">s</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="o">&gt;</span> <span class="n">map_t</span><span class="p">;</span>
</span><span class='line'>   <span class="n">map_t</span> <span class="n">m</span><span class="p">;</span>
</span><span class='line'><span class="p">};</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="n">inner</span><span class="p">,</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">double</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="n">inner</span><span class="o">::</span><span class="n">vec_t</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">BOOST_FUSION_ADAPT_STRUCT</span>
</span><span class='line'><span class="p">(</span>
</span><span class='line'>  <span class="n">outer</span><span class="p">,</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">one</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">double</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="n">three</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">array_t</span><span class="p">,</span> <span class="n">array</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">set_t</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
</span><span class='line'>  <span class="p">(</span><span class="n">outer</span><span class="o">::</span><span class="n">map_t</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span>
</span><span class='line'><span class="p">)</span>
</span><span class='line'>
</span><span class='line'><span class="kt">int</span> <span class="n">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>   <span class="n">outer</span> <span class="n">o</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">one</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">two</span> <span class="o">=</span> <span class="mf">2.2</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">three</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">a</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="mf">4.4</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">c</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">11</span><span class="p">);</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">22</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">a</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">b</span> <span class="o">=</span> <span class="mf">6.6</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">c</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">33</span><span class="p">);</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">array</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">d</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="mi">44</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">55</span><span class="p">);</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">66</span><span class="p">);</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">77</span><span class="p">]</span> <span class="o">=</span> <span class="mi">88</span><span class="p">;</span>
</span><span class='line'>   <span class="n">o</span><span class="p">.</span><span class="n">m</span><span class="p">[</span><span class="mi">99</span><span class="p">]</span> <span class="o">=</span> <span class="mi">111</span><span class="p">;</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">o</span><span class="p">.</span><span class="n">to_json</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">std</span><span class="o">::</span><span class="n">cout</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hopefully you learned some cool C++ tricks from this.</p>

<hr />

<p>This post was inspired by <a href="http://andres.senac.es/2011/04/generic-json-serializer.html">Andres Senac</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/05/02/temporary-security-mirror/">Temporary Security Mirror</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-05-02T15:31:12-04:00" pubdate data-updated="true">May 2<span>nd</span>, 2015</time>
        
           | <a href="/blog/2015/05/02/temporary-security-mirror/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/05/02/temporary-security-mirror/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Sometimes you need to perform a task in a secure way that leaves no trace on your computer. The traditional way of accomplishing this is to boot from a live CD like <a href="https://tails.boum.org/">Tails</a>. The problem with this is that you might need the software, drivers, or setup you have on your main operating system to accomplish the task. An example of this might be creating a Bitcoin Paper Wallet with a proprietary printer; it might be too difficult to set up the printer on a live CD for a one-off task.</p>

<p>Below is a script that help for these specialized cases. It creates a secure mirror of your system that never touches the disk; anything you do is wiped away on shutdown. Best part is, you can use this from an already running system.</p>

<p>This script will:</p>

<ul>
<li>Disable swap</li>
<li>Do a read only bind mount of root</li>
<li>Apply a tmpfs aufs layer over the read only root view</li>
<li>Start an X server and chroot into the root view</li>
</ul>


<p>The end result is a temporary secure mirror of your running system.<br/>
You need the following installed for this to work:</p>

<ul>
<li>aufs-tools</li>
<li>Xephyr</li>
<li>fluxbox</li>
</ul>


<p>Simply run <code>tsm.sh</code> and you will get a window of your running system, where anything you do is forgotten when closed. You will have access to all your files and devices. For more security, close any applications and disconnect your internet before running this script. When finished, close the window and restart your computer.</p>

<figure class='code'><figcaption><span> (tsm.sh)</span> <a href='/downloads/code/tsm.sh'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># tsm.sh</span>
</span><span class='line'><span class="c"># Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c"># (at your option) any later version.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Stop on any error</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="c"># Declare an array of tasks to perform on exit</span>
</span><span class='line'><span class="nb">declare</span> -a on_exit_items
</span><span class='line'>
</span><span class='line'><span class="c"># This function is run on exit</span>
</span><span class='line'><span class="k">function </span>on_exit<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="k">for </span>i in <span class="s2">&quot;${on_exit_items[@]}&quot;</span>
</span><span class='line'>    <span class="k">do</span>
</span><span class='line'><span class="k">        </span><span class="nb">eval</span> <span class="nv">$i</span>
</span><span class='line'>    <span class="k">done</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Add to the list of tasks to run on exit</span>
</span><span class='line'><span class="k">function </span>add_on_exit_reverse<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="nv">on_exit_items</span><span class="o">=(</span><span class="s2">&quot;$*&quot;</span> <span class="s2">&quot;${on_exit_items[@]}&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$n</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nb">trap </span>on_exit EXIT
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Check to make sure we are running as root</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$EUID</span> -ne 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;This script must be run as root&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Define variables</span>
</span><span class='line'><span class="nv">insecure_root</span><span class="o">=</span>insecure_root
</span><span class='line'><span class="nv">tmpfs_redirect</span><span class="o">=</span>tmpfs_redirect
</span><span class='line'><span class="nv">secure_root</span><span class="o">=</span>secure_root
</span><span class='line'>
</span><span class='line'><span class="c"># Disable Swap</span>
</span><span class='line'>swapoff -a
</span><span class='line'>
</span><span class='line'><span class="c"># Create the mount points</span>
</span><span class='line'>mkdir -p <span class="nv">$insecure_root</span>
</span><span class='line'>mkdir -p <span class="nv">$tmpfs_redirect</span>
</span><span class='line'>mkdir -p <span class="nv">$secure_root</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Clean up the mount points</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$insecure_root</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$tmpfs_redirect</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$secure_root</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Bind mount the root directory</span>
</span><span class='line'>mount --bind / <span class="nv">$insecure_root</span>
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$insecure_root</span> <span class="o">||</span> umount -lf <span class="nv">$insecure_root</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Remount the root directory as read only</span>
</span><span class='line'>mount -o remount,ro,bind <span class="nv">$insecure_root</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Create a tmpfs filesystem</span>
</span><span class='line'>mount -t tmpfs tmpfs <span class="nv">$tmpfs_redirect</span>
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$tmpfs_redirect</span> <span class="o">||</span> umount -lf <span class="nv">$tmpfs_redirect</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Aufs mount to redirect all </span>
</span><span class='line'>mount -t aufs -o <span class="nv">br</span><span class="o">=</span><span class="nv">$tmpfs_redirect</span><span class="o">=</span>rw:<span class="nv">$insecure_root</span><span class="o">=</span>ro none <span class="nv">$secure_root</span>
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$secure_root</span> <span class="o">||</span> umount -lf <span class="nv">$secure_root</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Mount the necessary filesystems in the chroot</span>
</span><span class='line'>mount --bind /dev <span class="nv">$secure_root</span>/dev
</span><span class='line'>mount -t proc none <span class="nv">$secure_root</span>/proc
</span><span class='line'>mount -t sysfs none <span class="nv">$secure_root</span>/sys
</span><span class='line'>mount -t devpts none <span class="nv">$secure_root</span>/dev/pts
</span><span class='line'>
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$secure_root</span>/dev <span class="o">||</span> umount -lf <span class="nv">$secure_root</span>/dev
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$secure_root</span>/proc <span class="o">||</span> umount -lf <span class="nv">$secure_root</span>/proc
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$secure_root</span>/sys <span class="o">||</span> umount -lf <span class="nv">$secure_root</span>/sys
</span><span class='line'>add_on_exit_reverse umount <span class="nv">$secure_root</span>/dev/pts <span class="o">||</span> umount -lf <span class="nv">$secure_root</span>/dev/pts
</span><span class='line'>
</span><span class='line'><span class="c"># Everything is set up, enter the chroot</span>
</span><span class='line'><span class="nb">set</span> +e
</span><span class='line'>
</span><span class='line'><span class="c"># Start the nested X server</span>
</span><span class='line'>Xephyr -screen 1024x768 -name <span class="s2">&quot;Temporary Security Mirror&quot;</span> -title <span class="s2">&quot;Temporary Security Mirror&quot;</span> :1 &amp;
</span><span class='line'>
</span><span class='line'><span class="c"># Wait for the X server to start</span>
</span><span class='line'>sleep 5
</span><span class='line'>
</span><span class='line'><span class="c"># Chroot in and startx</span>
</span><span class='line'>chroot <span class="nv">$secure_root</span> env <span class="nv">DISPLAY</span><span class="o">=</span>localhost:1 /usr/bin/fluxbox
</span><span class='line'>
</span><span class='line'><span class="c"># Wait for things to settle down</span>
</span><span class='line'>sleep 5
</span></code></pre></td></tr></table></div></figure>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/26/bitcoin-analogy/">A Simple Bitcoin Analogy</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-26T12:59:49-04:00" pubdate data-updated="true">Apr 26<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/04/26/bitcoin-analogy/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/04/26/bitcoin-analogy/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Imagine there are a group of lockers in a public place. Each locker has the following:</p>

<ul>
<li>A lock that requires a key</li>
<li>A window to see inside</li>
<li>A slot that money can be put in</li>
<li>An identifying number</li>
</ul>


<p>A group of these lockers might look like this:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/26/bitcoin-analogy/01.jpg"><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>These lockers are secure. The windows are unbreakable, the locks cannot be picked, the metal cannot be cut, and the entire group is bolted to the ground. Furthermore, there is only one copy of the key, and it is in possession of that locker&rsquo;s owner; Nobody else is able to get inside without that key.</p>

<p>Each locker is free of charge. A person may claim any unused locker, upon which they get the only copy of the key. A person may have as many lockers as they choose; there is no shortage of lockers. People use &ldquo;wallets&rdquo; (which are more like keychains in this case) to keep track of all the lockers they own and their associated keys. If anyone loses their wallet, they lose the ability to open any of their lockers, and that money is inaccessible forever.</p>

<p>Because the group of lockers is in a public place, and each locker has a window, anyone is able to see how much money is in each locker. They can see the identifying numbers on the locker, but they do not know who the owner of the locker is.</p>

<p>This group of lockers represents the Blockchain, and the contents of each locker represent Bitcoins.</p>

<p>Alice is selling a chair that Bob wants to buy. Bob calls up Alice to make a deal:</p>

<blockquote><p>Bob: I&rsquo;d like to buy the chair you are selling. How much do you want for it?<br/>
Alice: I&rsquo;ll give it to you for 0.2 Bitcoins<br/>
Bob: Sounds great! Which locker number is yours?</p></blockquote>

<p>Alice goes to the group of lockers, sees that #412 is unclaimed, and claims it. She heads home with the key.</p>

<blockquote><p>Alice: Put the money in locker 412 please!</p></blockquote>

<p>Bob goes to the lockers, finds #412 and peeks inside. He can see that it is empty. Bob goes to his locker (#387), pulls out some money, and sticks it in the slot on locker #412. He then goes back home.</p>

<blockquote><p>Bob: I put the money in your locker!</p></blockquote>

<p>Alice goes to the lockers and checks the contents of locker #412 through the window. She sees the 0.2 Bitcoins sitting there. Since Bob is the only person she told about #412, the money must have come from him.</p>

<blockquote><p>Alice: I just checked, and I see the money in my locker. Here is your chair!</p></blockquote>

<p>The entire transaction was done without Alice and Bob ever needing to meet in person. No banks were involved in the transaction, there were no processing delays, there were no fees. Bob is unable to issue a &ldquo;chargeback&rdquo; to void his transaction; the money is already in Alice&rsquo;s locker, and only she can get it back out. Furthermore, anyone checking the contents of the lockers by peeking through the windows could only tell that a transaction was made; they are unable to discover who was involved.</p>

<p>This is the basic premise of Bitcoin. Learn more about Bitcoin <a href="http://www.coindesk.com/information/what-is-bitcoin/">here</a>.</p>

<p><em>This analogy was not my idea, I am paraphrasing <a href="http://thebitcoincatalog.com/safe-analogy/">Henry Romp</a>.</em></p>
<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p>http://www.storageaspects.co.uk/shop/archive-mobile-shelving-archive-roller-racking/visitor-centre-lockers-with-see-through-doors/<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/23/bitcoin-paper-wallets/">Bitcoin Paper Wallets</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-23T19:18:12-04:00" pubdate data-updated="true">Apr 23<span>rd</span>, 2015</time>
        
           | <a href="/blog/2015/04/23/bitcoin-paper-wallets/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Paper wallets are a form of <em>cold storage</em>, meaning that the private key has never touched a computer with internet access. This is one of the most secure ways to store Bitcoins when done properly. You should never use a paper wallet you did not create yourself. For that reason, this is a tutorial to create a paper wallet in a secure fashion.</p>

<p>A repository of paper wallet generators can be found <a href="https://github.com/jrruethe/paper_wallet">here</a>. You can choose to use my repository directly if you wish, but I recommend going straight to the source.
There are many options with different formats and templates, however I highly recommend bitcoinpaperwallet.com.</p>

<p><em>I am in no way affiliated with bitcoinpaperwallet.com, just a satisfied customer.</em></p>

<hr />

<h3><a href="https://bitcoinpaperwallet.com/">BitcoinPaperWallet.com</a> (<a href="https://github.com/cantonbecker/bitcoinpaperwallet">Github</a>)</h3>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/01.jpg"></p>

<p>This is the most secure and well thought out design I have seen. The author has done a great job addressing the various attack vectors. His website is easy to use and provides all the relevant information needed. Furthermore, the generator is based on the popular and trusted <a href="https://www.bitaddress.org">bitaddress.org</a>. This paper wallet is perfect for cold storage and archival, but it takes a little extra work and materials to secure it properly. Fortunately, everything required can be bought right from the website, and you can pay in Bitcoin!</p>

<p>Features:</p>

<ul>
<li>&ldquo;Butterfly&rdquo; design secures the private key</li>
<li>Resistant to candling</li>
<li>Supports <a href="https://github.com/bitcoin/bips/blob/master/bip-0038.mediawiki">BIP38</a> encryption</li>
<li>Private key encoded in <a href="https://en.bitcoin.it/wiki/Wallet_import_format">Wallet Import Format</a></li>
<li>Designed to be printed in landscape mode, but works in portrait mode as well</li>
<li>Double sided</li>
<li>2x wallets per sheet</li>
<li>Notes section on the back</li>
<li>Public key visible when closed</li>
</ul>


<p>Additional Options:</p>

<ul>
<li><a href="https://bitcoinpaperwallet.com/">Security Stickers</a> 2in x .5in (<a href="http://www.amazon.com/gp/product/B00MWCCN7C">Alternative</a>)*</li>
<li><a href="https://bitcoinpaperwallet.com/">Waterproof Bag</a> 6in x 3in (<a href="http://www.amazon.com/Clear-Lock-Bags-Case-1000/dp/B0040003E4">Alternative</a>)</li>
<li><a href="http://www.amazon.com/dp/B004PX7ZTC">Teslin Paper</a> (Inkjet Printers)</li>
<li><a href="http://www.amazon.com/gp/product/B004UI335W/">Revlar Paper</a> (Laser Printers)</li>
<li><a href="http://www.amazon.com/gp/product/B00ENI0NI4">Scratch Off Stickers</a> 1in x 1in</li>
<li><a href="http://www.amazon.com/gp/product/B00BWU3HNY">Laminating Pouches</a> 8.9in x 11.4in</li>
<li><a href="http://www.amazon.com/gp/product/B0010JEJPC">Laminator</a></li>
</ul>


<blockquote><p>*The official security stickers from bitcoinpaperwallet.com are serialized in pairs, meaning you get two of each number. This is best because each paper wallet requires two stickers, so the numbers match. The alternative link only provides one sticker for each number.</p></blockquote>

<p>Dimensions:</p>

<ul>
<li>Landscape: 5.5in x 2.5in (Slightly smaller than a dollar bill)</li>
<li>Portrait: 4in x 2in (Slightly bigger than a standard business card)</li>
<li>QR Codes: 1in x 1in (About the size of a quarter)</li>
</ul>


<p>For additional artworks, check out <a href="http://libertywallet.liberty.me/2015/03/18/liberty-wallet/">Liberty Paper Wallet</a> (<a href="https://github.com/SimonBelmond/libertypaperwallet">Github</a>).</p>

<hr />

<h3>Protecting your paper wallet</h3>

<p>Paper wallets are extremely vulnerable to water.
Consider laminating your paper wallet for extra protection. An alternative could be to vaccuum seal it using a Foodsaver Vaccuum Sealer. At the very least, you should keep the paper wallet in a ziplock bag.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/03.jpg"></p>

<p>Paper wallets are also extremely vulnerable to fire.
However, there is not much you can do about this other than keeping multiple backups in different physical locations, such as a safety deposit box.</p>

<blockquote><p>Remember, if you lose your paper wallet, or it is damaged, you lose all the coins stored at that address!</p></blockquote>

<hr />

<h3>How to properly create a paper wallet</h3>

<p>Paper wallets need to be created offline on a secure machine. For this tutorial, I will be using a <a href="https://tails.boum.org/">Tails</a> Live CD. Grab the ISO and burn it to a disk.</p>

<p>Save a <a href="https://github.com/cantonbecker/bitcoinpaperwallet/archive/master.zip">copy of bitcoinpaperwallet</a> onto a USB drive.</p>

<ol>
<li>Shutdown your computer and boot from the CD.</li>
<li>When the Tails welcome box appears, select &ldquo;More Options&rdquo;.</li>
<li>Enter an administrator password of your choice and login.</li>
<li>Wait for tor to become ready.</li>
</ol>


<blockquote><p>For this tutorial, in order to get screenshots I am using a virtual machine. Do not use a virtual machine when doing this for real!</p></blockquote>

<p>Before creating the paper wallet, you will want to ensure that your printer works correctly. You need a printer that is directly connected to your machine; don&rsquo;t use a network printer (you shouldn&rsquo;t be connected to any network). If possible, use a dumb printer, and try to ensure that your printer does not save a copy of printouts to internal memory. Use this time to get any drivers you need from the internet.</p>

<p>From the <code>Applications</code> menu, select <code>System Tools -&gt; Administration -&gt; Printing</code>.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/04.png"></p>

<p>Add your printer. Open up Tor Browser and ensure that you can print a webpage.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/05.png"></p>

<p>Time to disconnect from the internet. Unplug the ethernet cord, turn off any wireless cards or routers as necessary. Verify that you are not online.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/06.png"></p>

<ol>
<li>Insert your usb drive</li>
<li>Copy the github zip file to the <code>Tor Browser</code> folder on the filesystem</li>
<li>Remove the usb drive</li>
<li>Unpack the zip file</li>
</ol>


<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/07.png"></p>

<p>Open up the html file in Tor Browser. Follow the instructions to generate your paper wallet. You have the option of using the built-in random number generator, or supplying your own random numbers using dice or cards. For maximum security, you should use dice or cards. I found that taking a deck of cards, shuffling it seven times, and picking the first 32 cards off the top worked well. Remember to shuffle the cards again after you are done! &ldquo;Brain wallets&rdquo; may seem convenient, however you need to have a very strong passphrase for this to be secure; it is better to use random numbers.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/08.png"></p>

<blockquote><p><strong>BIP38 Encryption?</strong><br/>
There are pros and cons to encrypting your paper wallet. Encryption adds an extra layer of security by requiring a passphrase before being able to import the private key again, which is great if the paper wallet ever gets stolen. However if the passphrase is forgotten, the coins are lost forever. The passphrase is one more thing to remember / write down, which means it is one more thing to secure. In addition, some wallet software does not support BIP38, which may make reimporting difficult. Finally, it is important to realize that BIP38 encryption will NOT help if you chose an insecure passphrase for a brain wallet. In general, BIP38 encryption is recommended.</p></blockquote>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/09.png"></p>

<p>You will want to print two wallets by spinning the paper after each print. You will end up running the sheet of paper through the printer a total of 4 times.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/10.jpg" width="400" height="600"></p>

<p>Now is your chance to verify the paper wallets. Make sure you can scan the QR codes, make sure the private key and public key match, etc.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/11.png"></p>

<p>Shutdown your Tails environment. It will wipe your ram for you.</p>

<p>Cut out each design by following the lines on the front. Fold the wallets and apply the stickers.</p>

<blockquote><p>If you have a laser printer, you will want to include a small 1in x 1in square of paper between the private key and the candling pattern when folding the paper. Later on, we will be laminating the paper wallet, and the heat can cause the toner on each side of the fold to fuse together.</p></blockquote>

<p>Sign the back and write the sticker numbers. This prevents someone from simply replacing the stickers or entire wallet without your knowledge.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/12.jpg" width="400" height="600"></p>

<p>Put both paper wallets into a laminating pouch and run it through the laminator. Cut out each wallet, and store them in physically separate, secure locations.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/13.jpg" width="400" height="600"></p>

<hr />

<h3>How to properly use a paper wallet</h3>

<p>You can scan the public key into Electrum or Mycelium as a watch-only wallet to keep track of your funds. Eventually you will want to spend the funds.</p>

<p>First, you need to delaminate the wallet. Cut a line along the edge closest to the paper where there is a tiny line of air, and peel away the laminate. A technique that worked for me was to cut along the &ldquo;Private Key / Withdraw&rdquo; line, then slide my knife underneath each sticker. Unfold the flap to access the private key. As you can see, it is still safe and legible, even after the lamination process.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/14.jpg"></p>

<p>Now comes the important part. The funds must be &ldquo;swept&rdquo; into an electronic wallet. You must take all the funds in one shot; do not attempt to partially spend the funds in a paper wallet. This is due to how Bitcoin Change works.</p>

<blockquote><p><strong>Change?</strong><br/>
When spending Bitcoins, <em>ALL</em> coins from that address are moved to new addresses.
The destination address will get the desired amount, and any remaining amount will be sent to a &ldquo;change&rdquo; address. If no &ldquo;change&rdquo; address is specified, the remaining amount will go to the miner that solves the block. Normally, an electronic wallet manages this for you behind the scenes, however when using a paper wallet directly, you will not have this control. This is why the entire balance of a paper wallet should be &ldquo;swept&rdquo; into an electronic wallet before spending.<br/>
Read more about change <a href="https://en.bitcoin.it/wiki/Change">here</a></p></blockquote>

<p>Once the paper wallet has been swept into the electronic wallet, it should be destroyed and never used again. Shred it or burn it.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/04/23/bitcoin-paper-wallets/15.jpg"></p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/19/generate-hashes/">Generate Hashes</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-19T14:51:57-04:00" pubdate data-updated="true">Apr 19<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/04/19/generate-hashes/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/04/19/generate-hashes/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a handy script to recursively generate hashes for a folder tree, in a format that the standard unix tools can use for checking.</p>

<figure class='code'><figcaption><span> (generate_hashes.sh)</span> <a href='/downloads/code/generate_hashes.sh'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/sh</span>
</span><span class='line'>
</span><span class='line'><span class="c"># generate_hashes.rb</span>
</span><span class='line'><span class="c"># Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c"># (at your option) any later version.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Usage: ./generate_hashes.sh [directory] [hash]</span>
</span><span class='line'><span class="c"># Check the result with sha256sum -c &lt;result&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c"># See if a directory was defined</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nv">DIRECTORY</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="p">%/</span><span class="k">}</span>
</span><span class='line'>   <span class="nv">REPLACE</span><span class="o">=</span><span class="k">${</span><span class="nv">DIRECTORY</span><span class="k">}</span>/
</span><span class='line'>
</span><span class='line'>   <span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$DIRECTORY</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nb">echo</span> <span class="s2">&quot;Directory does not exist: $DIRECTORY&quot;</span>
</span><span class='line'>      <span class="nb">exit </span>1
</span><span class='line'>   <span class="k">fi</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'>   <span class="c"># Use the current directory</span>
</span><span class='line'>   <span class="nv">DIRECTORY</span><span class="o">=</span><span class="s1">&#39;.&#39;</span>
</span><span class='line'>   <span class="nv">REPLACE</span><span class="o">=</span><span class="s1">&#39;\./&#39;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Hash type to use</span>
</span><span class='line'><span class="nv">HASH</span><span class="o">=</span><span class="k">${</span><span class="nv">2</span><span class="k">:-</span><span class="nv">sha256</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Generate the output filename</span>
</span><span class='line'><span class="nv">OUTPUT</span><span class="o">=</span>hashes.<span class="nv">$HASH</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Determine which program to use</span>
</span><span class='line'><span class="nv">HASHER</span><span class="o">=</span><span class="k">${</span><span class="nv">HASH</span><span class="k">}</span>sum
</span><span class='line'>
</span><span class='line'><span class="c"># Remove any existing hash file</span>
</span><span class='line'>rm -f <span class="nv">$DIRECTORY</span>/<span class="nv">$OUTPUT</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Find all files in the directory</span>
</span><span class='line'><span class="c"># that do not have the output filename</span>
</span><span class='line'><span class="c"># and hash them. Store the output in the target directory</span>
</span><span class='line'>find <span class="nv">$DIRECTORY</span> -type f ! -name <span class="s2">&quot;$OUTPUT&quot;</span> -exec <span class="nv">$HASHER</span> <span class="o">{}</span> <span class="se">\;</span> &gt;&gt; <span class="nv">$DIRECTORY</span>/<span class="nv">$OUTPUT</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Sort the output on the filename column</span>
</span><span class='line'>sort -u -k2 -o <span class="nv">$DIRECTORY</span>/<span class="nv">$OUTPUT</span> <span class="nv">$DIRECTORY</span>/<span class="nv">$OUTPUT</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Remove the directory from the listings</span>
</span><span class='line'>sed -i <span class="s2">&quot;s@ $REPLACE@@g&quot;</span> <span class="nv">$DIRECTORY</span>/<span class="nv">$OUTPUT</span>
</span></code></pre></td></tr></table></div></figure>


<p>The following will show how to use it. First, we need some files:</p>

<pre><code>$ ls
generate_hashes.sh

$ dd if=/dev/urandom bs=1024k count=1 &gt; 1.txt
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0787343 s, 13.3 MB/s

$ dd if=/dev/urandom bs=1024k count=1 &gt; 2.txt
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0862146 s, 12.2 MB/s

$ mkdir -p three/four

$ dd if=/dev/urandom bs=1024k count=1 &gt; three/3.txt
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0854334 s, 12.3 MB/s

$ dd if=/dev/urandom bs=1024k count=1 &gt; three/four/4.txt
1+0 records in
1+0 records out
1048576 bytes (1.0 MB) copied, 0.0783046 s, 13.4 MB/s

$ ls *
1.txt  2.txt  generate_hashes.sh

three:
3.txt  four
</code></pre>

<p>Calling the script without any arguments will generate the hashes in the current directory. The file is stored as hashes.hashtype, where hashtype defaults to sha256.</p>

<pre><code>$ ./generate_hashes.sh 
$ ls
1.txt  2.txt  generate_hashes.sh  hashes.sha256  three

$ cat hashes.sha256 
3f27f253e357143105f9a29193141db5ad833b56299a4c4e4a30a2d19f4732a8 1.txt
9dee9ed8f2c7a8533e764bc6963615537524d54292875e9fd858e9e0cd9b93b1 2.txt
20a1cbbf5a21773d673c79d4d8e58e31c3766f87c0299aa5a8c669015504c9f0 generate_hashes.sh
a43be65323f68fc6354f34f8fc97efeb28f01b256d9918cecf9981a93eb59aca three/3.txt
bc767948f782a92ebae7d217e04a160c74669dac838b2ccc33cc697e3ebd1ea2 three/four/4.txt

$ sha256sum -c hashes.sha256 
1.txt: OK
2.txt: OK
generate_hashes.sh: OK
three/3.txt: OK
three/four/4.txt: OK
</code></pre>

<p>The first optional argument is the directory to hash. <code>.</code> is allowed.</p>

<pre><code>$ rm hashes.sha256
$ ls
1.txt  2.txt  generate_hashes.sh  three
$ ls three/
3.txt  four

$ ./generate_hashes.sh three/
$ ls three/
3.txt  four  hashes.sha256
$ cat three/hashes.sha256 
a43be65323f68fc6354f34f8fc97efeb28f01b256d9918cecf9981a93eb59aca 3.txt
bc767948f782a92ebae7d217e04a160c74669dac838b2ccc33cc697e3ebd1ea2 four/4.txt
</code></pre>

<p>The second optional argument is the hash type to use:</p>

<ul>
<li>sha1</li>
<li>sha224</li>
<li>sha256 (default)</li>
<li>sha384</li>
<li>sha512</li>
<li>md5</li>
</ul>


<p>Example:</p>

<pre><code>$ ./generate_hashes.sh three/ sha1
$ ls three/
3.txt  four  hashes.sha1  hashes.sha256
$ cat three/hashes.sha1
fffdc438939ae0afa1f19569939dd3996a2d67bb 3.txt
cec823c326525c23bba925d5d85b35a5ebbed62d four/4.txt
deea8794a7aada412518d06df516c804389ef212 hashes.sha256

$ cd three/
$ sha1sum -c hashes.sha1
3.txt: OK
four/4.txt: OK
hashes.sha256: OK
</code></pre>

<p>When distributing a large set of files or directory tree, it is best to generate the hashes in the root of the tree and sign the hashes.sha256 file with GPG.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/04/11/verified-addresses/">Verified Addresses</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-11T18:48:27-04:00" pubdate data-updated="true">Apr 11<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/04/11/verified-addresses/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/04/11/verified-addresses/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a curated list of important websites and services with verified certificates and onion addresses:</p>

<figure class='code'><figcaption><span> (verified_addresses.txt.asc)</span> <a href='/downloads/code/verified_addresses.txt.asc'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
<span class='line-number'>130</span>
<span class='line-number'>131</span>
<span class='line-number'>132</span>
<span class='line-number'>133</span>
<span class='line-number'>134</span>
<span class='line-number'>135</span>
<span class='line-number'>136</span>
<span class='line-number'>137</span>
<span class='line-number'>138</span>
<span class='line-number'>139</span>
<span class='line-number'>140</span>
<span class='line-number'>141</span>
<span class='line-number'>142</span>
<span class='line-number'>143</span>
<span class='line-number'>144</span>
<span class='line-number'>145</span>
<span class='line-number'>146</span>
<span class='line-number'>147</span>
<span class='line-number'>148</span>
<span class='line-number'>149</span>
<span class='line-number'>150</span>
<span class='line-number'>151</span>
<span class='line-number'>152</span>
<span class='line-number'>153</span>
<span class='line-number'>154</span>
<span class='line-number'>155</span>
<span class='line-number'>156</span>
<span class='line-number'>157</span>
<span class='line-number'>158</span>
<span class='line-number'>159</span>
<span class='line-number'>160</span>
<span class='line-number'>161</span>
<span class='line-number'>162</span>
<span class='line-number'>163</span>
<span class='line-number'>164</span>
<span class='line-number'>165</span>
<span class='line-number'>166</span>
<span class='line-number'>167</span>
<span class='line-number'>168</span>
<span class='line-number'>169</span>
<span class='line-number'>170</span>
<span class='line-number'>171</span>
<span class='line-number'>172</span>
</pre></td><td class='code'><pre><code class='yaml'><span class='line'><span class="l-Scalar-Plain">-----BEGIN PGP SIGNED MESSAGE-----</span>
</span><span class='line'><span class="l-Scalar-Plain">Hash</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">SHA1</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'> <span class="l-Scalar-Plain">- Name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Blockchain.info</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://blockchain.info</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">blockchain.info</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">cert-002.blockchain.info</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">94:10:81:EB:E4:62:B5:BD:7B:03:DE:79:C7:A6:4D:91:30:13:7B:E0</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Onion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://blockchainbdgpzk.onion/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Proof</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">https://blockchain.info/wallet/anonymity</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">https://blog.blockchain.com/tag/digicert/</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">https://lists.torproject.org/pipermail/tor-talk/2014-December/035841.html</span>
</span><span class='line'><span class="-Error">   </span><span class="l-Scalar-Plain">Email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">support@blockchain.zendesk.com</span>
</span><span class='line'>
</span><span class='line'><span class="-Error"> </span><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Duck Duck Go</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://duckduckgo.com/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">duckduckgo.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="err">*</span><span class="l-Scalar-Plain">.duckduckgo.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">AF:81:DA:50:2D:E7:B8:4E:92:F5:A9:36:1F:A5:89:6F:FE:AC:0F:6F</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Onion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://3g2upl4pq6kufc4m.onion</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Proof</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://duck.co/forum/thread/1762/is-the-duckduckgo-hidden-service-legitimate</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Twitter</span><span class="p-Indicator">:</span> <span class="err">@</span><span class="l-Scalar-Plain">duckduckgo</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Electronic Frontier Foundation</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://www.eff.org/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">www.eff.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">www.eff.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1E:F9:6F:18:02:22:26:F6:63:3C:C3:E8:75:FB:8E:7C:31:67:91:DE</span>
</span><span class='line'>   <span class="l-Scalar-Plain">GPG Fingerprint</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">F2F2 1BB8 531E 9DC3 0D40  F68B 11A1 A9C8 4B18 732F</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">info@eff.org</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Freedom of the Press Foundation</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://freedom.press/</span>
</span><span class='line'>   <span class="c1"># Domain: freedom.press</span>
</span><span class='line'>   <span class="c1"># Certificate: ssl7272.cloudflare.com</span>
</span><span class='line'>   <span class="c1"># SHA1: 2A:92:0A:71:AE:66:13:4A:D6:E7:FD:40:A8:54:3C:67:82:D7:E1:EB</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Onion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">freepress3xxs3hk.onion</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Proof</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://freedom.press/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">GPG Fingerprint</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">B89A 29DB 2128 160B 8E4B  1B4C BADD E0C7 FC9F 6818</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">734F 6E70 7434 ECA6 C007  E1AE 82BD 6C96 16DA BB79</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">info@freedom.press</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Twitter</span><span class="p-Indicator">:</span> <span class="err">@</span><span class="l-Scalar-Plain">FreedomofPress</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Gibson Research Corporation</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://www.grc.com/fingerprints.htm</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">www.grc.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">grc.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">01:56:D3:AC:CF:5A:3F:B8:8F:0F:B4:30:88:2D:F6:72:4E:8C:F2:E0</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Twitter</span><span class="p-Indicator">:</span> <span class="err">@</span><span class="l-Scalar-Plain">GibsonResearch</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">The Original Hidden Wiki</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://www.kpvz7ki2v5agwt35.onion/wiki/index.php/Main_Page</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Onion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">kpvz7ki2v5agwt35.onion</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Proof</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://web.archive.org/web/20090923122959/http://www.reddit.com/r/onions</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">The New Hidden Wiki</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://zqktlwi4fecvo6ri.onion/wiki/Main_Page</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Onion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">zqktlwi4fecvo6ri.onion</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Proof</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">http://www.reddit.com/r/onions/comments/24uq96/zqktlw_hidden_wiki_admin_here_trying_to_clear_up/</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">https://bitcointalk.org/index.php?topic=511139.0</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">The Intercept Secure Drop</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://firstlook.org/theintercept/securedrop/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">firstlook.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="err">*</span><span class="l-Scalar-Plain">.firstlook.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">FA:34:AB:6D:D5:68:0A:CC:38:4F:4E:28:B6:6B:43:9F:D3:0E:C4:3D</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Onion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://y6xjgkgwj47us5ca.onion/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Proof</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">https://firstlook.org/theintercept/securedrop/</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">https://firstlook.org/theintercept/2015/04/08/securedrop-tor-hidden-service-now-uses-https/</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">https://firstlook.org/theintercept/2015/01/28/how-to-leak-to-the-intercept/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">GPG Fingerprint</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">0B14 9192 9806 5962 5470  0155 FD72 0AD9 EBA3 4B1C</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tips@theintercept.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Twitter</span><span class="p-Indicator">:</span> <span class="err">@</span><span class="l-Scalar-Plain">the_intercept</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Internet Archive</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://archive.org/index.php</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">archive.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="err">*</span><span class="l-Scalar-Plain">.archive.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">98:8C:12:12:BB:E5:4A:3A:8A:CE:3C:E6:2C:C2:0C:CC:D5:1A:C5:C5</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">info@archive.org</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">Keybase.io</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://keybase.io/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">keybase.io</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">keybase.io</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">15:03:31:EA:85:6B:C9:76:8D:98:82:AD:01:16:D4:62:85:5F:47:7E</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Onion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">http://fncuwbiisyh6ak3i.onion</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Proof</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://keybase.io/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">GPG Fingerprint</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">222B 85B0 F90B E2D2 4CFE  B93F 4748 4E50 656D 16C7</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">03E1 46CD AF81 3668 0AD5  6691 2A32 340C EC8C 9492</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">8EFB E2E4 DD56 B352 7363  4E8F 6052 B2AD 31A6 631C</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">94AA 3A5B DBD4 0EA5 49CA  BAF9 FBC0 7D6A 9701 6CB3</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Twitter</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="err">@</span><span class="l-Scalar-Plain">maxtaco</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="err">@</span><span class="l-Scalar-Plain">malgorithms</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">OneName</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://onename.com/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">onename.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="err">*</span><span class="l-Scalar-Plain">.onename.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">E2:C7:66:9A:A7:69:0E:F3:57:22:EA:E5:5D:23:0A:C4:55:41:89:67</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Twitter</span><span class="p-Indicator">:</span> <span class="err">@</span><span class="l-Scalar-Plain">onename</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Reddit</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://www.reddit.com/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">www.reddit.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="err">*</span><span class="l-Scalar-Plain">.reddit.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">DB:90:0C:4A:F5:A2:1C:85:CB:DD:3B:2E:11:8C:93:CD:4C:DA:5C:CA</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">contact@reddit.com</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Riseup</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://help.riseup.net/en</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">help.riseup.net</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">riseup.net</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">F4:6A:41:B5:0D:59:3E:57:2C:5A:E2:9B:17:6A:54:93:10:8A:26:90</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Onion</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">nzh3fv6jc6jskki3.onion</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">https://5jp7xtmox6jyoqd5.onion/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Proof</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://help.riseup.net/en/security/network-security/tor</span>
</span><span class='line'>   <span class="l-Scalar-Plain">GPG Fingerprint</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">4E07 9126 8F7C 67EA BE88  F1B0 3043 E2B7 139A 768E</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">collective@riseup.net</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Twitter</span><span class="p-Indicator">:</span> <span class="err">@</span><span class="l-Scalar-Plain">riseupnet</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Tails</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://tails.boum.org/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tails.boum.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="err">*</span><span class="l-Scalar-Plain">.boum.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2E:0F:60:F9:68:9B:B5:CE:D1:5C:82:A0:9D:D9:55:A0:8F:41:EC:70</span>
</span><span class='line'>   <span class="l-Scalar-Plain">GPG Fingerprint</span><span class="p-Indicator">:</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">A490 D0F4 D311 A415 3E2B  B7CA DBB8 02B2 58AC D84F</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">0D24 B36A A9A2 A651 7878  7645 1202 821C BE2C D9C1</span>
</span><span class='line'>    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1F56 EDD3 0741 0480 35DA  C1C5 EC57 B56E F0C4 3132</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">tails-support-private@boum.org</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">TorBox Email</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Onion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">torbox3uiot6wchz.onion</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">Tor Check</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://check.torproject.org/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">check.torproject.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="err">*</span><span class="l-Scalar-Plain">.torproject.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">84:24:56:56:8E:D7:90:43:47:AA:89:AB:77:7D:A4:94:3B:A1:A7:D5</span>
</span><span class='line'>   <span class="l-Scalar-Plain">GPG Fingerprint</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">EF6E 286D DA85 EA2A 4BA7  DE68 4E2C 6E87 9329 8290</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">help@rt.torproject.org</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Twitter</span><span class="p-Indicator">:</span> <span class="err">@</span><span class="l-Scalar-Plain">TorProject</span>
</span><span class='line'>
</span><span class='line'> <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">WTFIsMyIP Jabber</span>
</span><span class='line'>   <span class="l-Scalar-Plain">URL</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://wtfismyip.com/jabber/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Domain</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">wtfismyip.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Certificate</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">www.wtfismyip.com</span>
</span><span class='line'>   <span class="l-Scalar-Plain">SHA1</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">C2:C5:C1:7F:30:0E:C9:C8:72:1D:9D:ED:D0:CB:52:A1:F2:12:DB:15</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Onion</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">ofkztxcohimx34la.onion</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Proof</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">https://wtfismyip.com/jabber/</span>
</span><span class='line'>   <span class="l-Scalar-Plain">Email</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">support@wtfismyip.com</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">-----BEGIN PGP SIGNATURE-----</span>
</span><span class='line'><span class="l-Scalar-Plain">Version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">GnuPG v1</span>
</span><span class='line'>
</span><span class='line'><span class="l-Scalar-Plain">iQEcBAEBAgAGBQJVMYVGAAoJEB7MsgHDevApw48IAJizJrldGsywiy2tqKl4D4LN</span>
</span><span class='line'><span class="l-Scalar-Plain">j24gLbcW0psTIpDdkM5HX1CNIOmdQHUTIKEm4F6G/VpqAK8zIs25Q6W9vcfzIAhH</span>
</span><span class='line'><span class="l-Scalar-Plain">8I+IpECUuKNYpDy/ECuWAp0gDiQaJOkpUklTV/cRfPPho4POX9k2QP5CnNiB+nRd</span>
</span><span class='line'><span class="l-Scalar-Plain">SMmNQUT8YLDAf+lClDTavGPxpRZZ8MuvV0It875hThfsjKSWIHOqwhDAaTtRfyd2</span>
</span><span class='line'><span class="l-Scalar-Plain">UPlj5oyBABT8b7rmKVB1twsq2O4ZuiAOs0DYN3cIF5bXIiJ2tzvkvtrtZnfyQ/GP</span>
</span><span class='line'><span class="l-Scalar-Plain">JKFUhOOU0AMXThFP8tMZiIeOe8TaV0PXpjyhIlNpWlvt0EQWr22JLXVQnd7/QFM=</span>
</span><span class='line'><span class="l-Scalar-Plain">=6Mba</span>
</span><span class='line'><span class="l-Scalar-Plain">-----END PGP SIGNATURE-----</span>
</span></code></pre></td></tr></table></div></figure>


<p>To extract all the GPG keys and import them:</p>

<pre><code>for i in `egrep -o '([0-F]{4} ){5} ([0-F]{4} ){4}[0-F]{4}' verified_addresses.txt.asc | tr -d ' '`;  
do
   gpg --keyserver pool.sks-keyservers.net --recv-keys $i;

   # Sleep needed to prevent spamming the server, it will respond with "connection refused" otherwise       
   sleep 30;
done;
</code></pre>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/30/squashed-truecrypt-archive/">Squashed Truecrypt Archive</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-30T20:32:22-04:00" pubdate data-updated="true">Mar 30<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/03/30/squashed-truecrypt-archive/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/03/30/squashed-truecrypt-archive/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This post presents a script that can create a squashfs filesystem inside of a truecrypt container.<br/>
This has many benefits over encrypted zip files as well as normal truecrypt containers:</p>

<ul>
<li>Resulting file can be mounted and accessed directly

<ul>
<li>No need to &ldquo;unzip&rdquo; to the hard drive</li>
<li>No chance for leaking unencrypted data to the hard drive</li>
</ul>
</li>
<li>Achieve both good compression as well as strong encryption

<ul>
<li>Better compression ratio than NTFS, BTRFS, GZIP, BZIP2</li>
</ul>
</li>
<li>Truecrypt container is only as large as it needs to be

<ul>
<li>No need to guess the approximate size of the compressed result before compressing</li>
</ul>
</li>
<li>Resulting file is immutable

<ul>
<li>Making changes is still possible with an easy workaround, described below</li>
</ul>
</li>
</ul>


<p>First, the script. It is named <code>star</code>, for &ldquo;<strong>S</strong>quashed <strong>T</strong>ruecrypt <strong>AR</strong>chive&rdquo;. You will need the following to run it:</p>

<ul>
<li>squashfs-tools</li>
<li>truecrypt</li>
<li>aufs-tools</li>
</ul>


<figure class='code'><figcaption><span> (star)</span> <a href='/downloads/code/star'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># star</span>
</span><span class='line'><span class="c"># Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c"># (at your option) any later version.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Creates a squashed truecrypt archive (star)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># $1 = Directory to star</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Stop on any error</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="c"># Declare an array of tasks to perform on exit</span>
</span><span class='line'><span class="nb">declare</span> -a on_exit_items
</span><span class='line'>
</span><span class='line'><span class="c"># This function is run on exit</span>
</span><span class='line'><span class="k">function </span>on_exit<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="k">for </span>i in <span class="s2">&quot;${on_exit_items[@]}&quot;</span>
</span><span class='line'>    <span class="k">do</span>
</span><span class='line'><span class="k">        </span><span class="nb">eval</span> <span class="nv">$i</span>
</span><span class='line'>    <span class="k">done</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Add to the list of tasks to run on exit</span>
</span><span class='line'><span class="k">function </span>add_on_exit<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="nb">local </span><span class="nv">n</span><span class="o">=</span><span class="k">${#</span><span class="nv">on_exit_items</span><span class="p">[*]</span><span class="k">}</span>
</span><span class='line'>    on_exit_items<span class="o">[</span><span class="nv">$n</span><span class="o">]=</span><span class="s2">&quot;$*&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$n</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nb">trap </span>on_exit EXIT
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Make sure enough arguments were specified</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -z <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Usage: $0 &lt;directory&gt; [name]&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Make sure the first argument is an existing directory</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -d <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Directory does not exist: $1&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Save some variables</span>
</span><span class='line'><span class="nv">directory</span><span class="o">=</span><span class="k">${</span><span class="nv">1</span><span class="p">%/</span><span class="k">}</span>
</span><span class='line'><span class="nv">name</span><span class="o">=</span><span class="k">${</span><span class="nv">2</span><span class="p">-</span><span class="nv">$directory</span><span class="k">}</span>
</span><span class='line'><span class="nv">sfs</span><span class="o">=</span><span class="nv">$name</span>.sfs
</span><span class='line'><span class="nv">star</span><span class="o">=</span><span class="nv">$name</span>.star
</span><span class='line'>
</span><span class='line'><span class="c"># Get the password</span>
</span><span class='line'><span class="nb">echo</span> -n <span class="s1">&#39;Enter the password to use:&#39;</span>
</span><span class='line'><span class="nb">read</span> -s password
</span><span class='line'><span class="nb">echo</span>
</span><span class='line'><span class="nb">echo</span> -n <span class="s1">&#39;Repeat the password:&#39;</span>
</span><span class='line'><span class="nb">read</span> -s password_repeat
</span><span class='line'><span class="nb">echo</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Check that the passwords match</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$password&quot;</span> !<span class="o">=</span> <span class="s2">&quot;$password_repeat&quot;</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s1">&#39;Passwords do not match&#39;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Squash the directory</span>
</span><span class='line'>mksquashfs <span class="nv">$directory</span> <span class="nv">$sfs</span> -noappend -b 1048576 &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>
</span><span class='line'><span class="c"># Clean this file up on exit</span>
</span><span class='line'>add_on_exit shred -f <span class="nv">$sfs</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Get the size of the squashfs, add 512 blocks of size 512</span>
</span><span class='line'><span class="nv">sfssize</span><span class="o">=</span><span class="sb">`</span>stat --printf<span class="o">=</span><span class="s2">&quot;%s&quot;</span> <span class="nv">$sfs</span><span class="sb">`</span>
</span><span class='line'><span class="nv">starsize</span><span class="o">=</span><span class="sb">`</span>expr <span class="nv">$sfssize</span> + 262144<span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Make a truecrypt volume</span>
</span><span class='line'>sudo truecrypt -t --non-interactive -c <span class="nv">$star</span> --size<span class="o">=</span><span class="nv">$starsize</span> --filesystem<span class="o">=</span>none --encryption<span class="o">=</span>AES --hash<span class="o">=</span>SHA-512 --password<span class="o">=</span><span class="nv">$password</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>
</span><span class='line'><span class="c"># Mount the truecrypt volume</span>
</span><span class='line'>sudo truecrypt -t --non-interactive --filesystem<span class="o">=</span>none --password<span class="o">=</span><span class="nv">$password</span> <span class="nv">$star</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>
</span><span class='line'><span class="c"># Get the truecrypt device name</span>
</span><span class='line'><span class="nv">starloc</span><span class="o">=</span><span class="sb">`</span>readlink -f <span class="nv">$star</span><span class="sb">`</span>
</span><span class='line'><span class="nv">devname</span><span class="o">=</span><span class="sb">`</span>truecrypt -t --non-interactive -l | grep <span class="nv">$starloc</span> | awk <span class="s1">&#39;{print $3}&#39;</span><span class="sb">`</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Unmount the volume on exit</span>
</span><span class='line'>add_on_exit sudo truecrypt -t --non-interactive -d <span class="nv">$starloc</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>
</span><span class='line'><span class="c"># Copy the squashfs into the truecrypt volume</span>
</span><span class='line'>sudo dd <span class="k">if</span><span class="o">=</span><span class="nv">$sfs</span> <span class="nv">of</span><span class="o">=</span><span class="nv">$devname</span> <span class="nv">bs</span><span class="o">=</span>64K &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>
</span><span class='line'><span class="c"># Set permissions</span>
</span><span class='line'>sudo chmod 755 <span class="nv">$star</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Synchronize the filesystem</span>
</span><span class='line'>sync
</span><span class='line'>
</span><span class='line'><span class="nb">echo</span> <span class="s1">&#39;Success&#39;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is an example of how to use it:</p>

<pre><code>$ mkdir secret_stuff
$ dd if=/dev/urandom bs=1MB count=10 &gt; secret_stuff/secret_data.bin
10+0 records in
10+0 records out
10000000 bytes (10 MB) copied, 0.741577 s, 13.5 MB/s

$ ls
secret_stuff  star

$ ./star 
Usage: ./star &lt;directory&gt; [name]

$ ./star secret_stuff
Enter the password to use:
Repeat the password:
Success

$ ls
secret_stuff  secret_stuff.star  star

$ mkdir mnt
$ sudo truecrypt -t secret_stuff.star 
Enter mount directory [default]: mnt
Enter password for /home/joe/Downloads/temp/secret_stuff.star: 
Enter keyfile [none]: 
Protect hidden volume (if any)? (y=Yes/n=No) [No]: 

$ ls mnt/
secret_data.bin

$ sha256sum secret_stuff/secret_data.bin 
5342d4e85a221df35c5beda80e7b93b609fca732b908b6fd43febfcc89c324ea  secret_stuff/secret_data.bin
$ sha256sum mnt/secret_data.bin 
5342d4e85a221df35c5beda80e7b93b609fca732b908b6fd43febfcc89c324ea  mnt/secret_data.bin
</code></pre>

<p>The resulting file is immutable. This may seem like a downside at first, but it can be beneficial. For example, it can be mounted by multiple users simultaneously when shared via Dropbox or Bittorrent Sync, and it is easy to version control.</p>

<p>Making secure modifications to the archive is possible because the archive allows direct access via mounting. This is something that cannot be easily done with a normal zip file or tarball. By using a tmpfs filesystem as a writable aufs layer on top of the archive, edits can be made in memory that never touch the hard drive, so your encrypted data stays secure. Then, a new archive can be created from that tmpfs layer.</p>

<p>Layers can be kept separate and treated as diffs (similar to how Docker containers operate), or they can be &ldquo;resquashed&rdquo; together for maximum compression. It all depends on the user&rsquo;s needs.</p>

<p>Here is a script that mounts a tmpfs aufs layer on top of the archive to allow edits.</p>

<figure class='code'><figcaption><span> (mount_star.sh)</span> <a href='/downloads/code/mount_star.sh'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># mount_star.sh</span>
</span><span class='line'><span class="c"># Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c"># (at your option) any later version.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Mounts a squashed truecrypt archive</span>
</span><span class='line'>
</span><span class='line'><span class="c"># $1 = Star to mount</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Stop on any error</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="c"># Declare an array of tasks to perform on exit</span>
</span><span class='line'><span class="nb">declare</span> -a on_exit_items
</span><span class='line'>
</span><span class='line'><span class="c"># This function is run on exit</span>
</span><span class='line'><span class="k">function </span>on_exit<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="k">for </span>i in <span class="s2">&quot;${on_exit_items[@]}&quot;</span>
</span><span class='line'>    <span class="k">do</span>
</span><span class='line'><span class="k">        </span><span class="nb">eval</span> <span class="nv">$i</span>
</span><span class='line'>    <span class="k">done</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Add to the list of tasks to run on exit</span>
</span><span class='line'><span class="k">function </span>add_on_exit_reverse<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="nv">on_exit_items</span><span class="o">=(</span><span class="s2">&quot;$*&quot;</span> <span class="s2">&quot;${on_exit_items[@]}&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$n</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nb">trap </span>on_exit EXIT
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Make sure enough arguments were specified</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -z <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Usage: $0 &lt;*.star&gt;&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Make sure the first argument is an existing file</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;File does not exist: $1&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Save some variables</span>
</span><span class='line'><span class="nv">star_file</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">star_name</span><span class="o">=</span><span class="k">${</span><span class="nv">star_file</span><span class="p">%.star</span><span class="k">}</span>
</span><span class='line'><span class="nv">star_old</span><span class="o">=</span><span class="k">${</span><span class="nv">star_name</span><span class="k">}</span>_old
</span><span class='line'><span class="nv">star_changes</span><span class="o">=</span><span class="k">${</span><span class="nv">star_name</span><span class="k">}</span>_changes
</span><span class='line'><span class="nv">star_new</span><span class="o">=</span><span class="k">${</span><span class="nv">star_name</span><span class="k">}</span>_new
</span><span class='line'>
</span><span class='line'><span class="c"># Get the password</span>
</span><span class='line'><span class="nb">echo</span> -n <span class="s1">&#39;Enter the password:&#39;</span>
</span><span class='line'><span class="nb">read</span> -s password
</span><span class='line'><span class="nb">echo</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Make the directories</span>
</span><span class='line'>mkdir -p <span class="nv">$star_old</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$star_old</span>
</span><span class='line'>
</span><span class='line'>mkdir -p <span class="nv">$star_changes</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$star_changes</span>
</span><span class='line'>
</span><span class='line'>mkdir -p <span class="nv">$star_new</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$star_new</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Mount the star file</span>
</span><span class='line'>sudo truecrypt -t --non-interactive --password<span class="o">=</span><span class="nv">$password</span> <span class="nv">$star_file</span> <span class="nv">$star_old</span>
</span><span class='line'>add_on_exit_reverse sudo truecrypt -t --non-interactive -d <span class="nv">$star_old</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>
</span><span class='line'><span class="c"># Mount the tmpfs</span>
</span><span class='line'>sudo mount -t tmpfs tmpfs <span class="nv">$star_changes</span>
</span><span class='line'>add_on_exit_reverse sudo umount -lf <span class="nv">$star_changes</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Mount the aufs</span>
</span><span class='line'>sudo mount -t aufs -o <span class="nb">dirs</span><span class="o">=</span><span class="nv">$star_changes</span><span class="o">=</span>rw:<span class="nv">$star_old</span><span class="o">=</span>ro aufs <span class="nv">$star_new</span>
</span><span class='line'>add_on_exit_reverse sudo umount -lf <span class="nv">$star_new</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Wait for user to continue</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Star is now mounted. Press Enter to unmount and exit&quot;</span>
</span><span class='line'><span class="nb">read</span>
</span></code></pre></td></tr></table></div></figure>


<p>Use it like so:</p>

<pre><code>$ ./mount_star.sh 
Usage: ./mount_star.sh &lt;*.star&gt;

$ ./mount_star.sh ./secret_stuff.star 
Enter the password:
Star is now mounted. Press Enter to unmount and exit
</code></pre>

<p>Now in another terminal, you can interact with the mounted volumes:</p>

<pre><code>$ ls
mount_star.sh  secret_stuff_changes  secret_stuff_old  starsecret_stuff_new  secret_stuff.star

$ touch secret_stuff_old/lala
touch: cannot touch secret_stuff_old/lala: Read-only file system

$ touch secret_stuff_new/lala

$ ls secret_stuff_new
lala  secret_data.bin

$ ls secret_stuff_changes/
lala
</code></pre>

<p>Creating a new archive is as simple as star&#8217;ing the name_new branch. Creating a &ldquo;patch&rdquo; is as simple as star&#8217;ing the name_changes branch:</p>

<pre><code>$ dd if=/dev/urandom bs=1MB count=10 &gt; secret_stuff_new/new_secret_data.bin10+0 records in
10+0 records out
10000000 bytes (10 MB) copied, 0.756202 s, 13.2 MB/s
$ ls secret_stuff*
secret_stuff.star

secret_stuff_changes:
lala  new_secret_data.bin

secret_stuff_new:
lala  new_secret_data.bin  secret_data.bin

secret_stuff_old:
secret_data.bin

$ ./star secret_stuff_changes/
Enter the password to use:
Repeat the password:
Success

$ ls
mount_star.sh  secret_stuff_changes.star  secret_stuff.star  star
</code></pre>

<p>Patch archives can be applied using aufs layers with the following script:</p>

<figure class='code'><figcaption><span> (patch_star.sh)</span> <a href='/downloads/code/patch_star.sh'>download</a></figcaption>
<div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c">#!/bin/bash</span>
</span><span class='line'>
</span><span class='line'><span class="c"># patch_star.sh</span>
</span><span class='line'><span class="c"># Copyright (C) 2015 Joe Ruether jrruethe@gmail.com</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is free software: you can redistribute it and/or modify</span>
</span><span class='line'><span class="c"># it under the terms of the GNU General Public License as published by</span>
</span><span class='line'><span class="c"># the Free Software Foundation, either version 3 of the License, or</span>
</span><span class='line'><span class="c"># (at your option) any later version.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># This program is distributed in the hope that it will be useful,</span>
</span><span class='line'><span class="c"># but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
</span><span class='line'><span class="c"># MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
</span><span class='line'><span class="c"># GNU General Public License for more details.</span>
</span><span class='line'><span class="c">#</span>
</span><span class='line'><span class="c"># You should have received a copy of the GNU General Public License</span>
</span><span class='line'><span class="c"># along with this program. If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Mounts a squashed truecrypt archive</span>
</span><span class='line'>
</span><span class='line'><span class="c"># $1 = Star to mount</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Stop on any error</span>
</span><span class='line'><span class="nb">set</span> -e
</span><span class='line'>
</span><span class='line'><span class="c"># Declare an array of tasks to perform on exit</span>
</span><span class='line'><span class="nb">declare</span> -a on_exit_items
</span><span class='line'>
</span><span class='line'><span class="c"># This function is run on exit</span>
</span><span class='line'><span class="k">function </span>on_exit<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="k">for </span>i in <span class="s2">&quot;${on_exit_items[@]}&quot;</span>
</span><span class='line'>    <span class="k">do</span>
</span><span class='line'><span class="k">        </span><span class="nb">eval</span> <span class="nv">$i</span>
</span><span class='line'>    <span class="k">done</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Add to the list of tasks to run on exit</span>
</span><span class='line'><span class="k">function </span>add_on_exit_reverse<span class="o">()</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>    <span class="nv">on_exit_items</span><span class="o">=(</span><span class="s2">&quot;$*&quot;</span> <span class="s2">&quot;${on_exit_items[@]}&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[[</span> <span class="nv">$n</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nb">trap </span>on_exit EXIT
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Make sure enough arguments were specified</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> -z <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;Usage: $0 &lt;base *.star&gt; &lt;patch *.star&gt;&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Make sure the first argument is an existing file</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$1</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;File does not exist: $1&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Make sure the second argument is an existing file</span>
</span><span class='line'><span class="k">if</span> <span class="o">[</span> ! -f <span class="nv">$2</span> <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">   </span><span class="nb">echo</span> <span class="s2">&quot;File does not exist: $2&quot;</span>
</span><span class='line'>   <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Save some variables</span>
</span><span class='line'><span class="nv">base_star</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">base_name</span><span class="o">=</span><span class="k">${</span><span class="nv">base_star</span><span class="p">%.star</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Patch directory will be hidden</span>
</span><span class='line'><span class="nv">patch_star</span><span class="o">=</span><span class="nv">$2</span>
</span><span class='line'><span class="nv">patch_name</span><span class="o">=</span>.<span class="k">${</span><span class="nv">patch_star</span><span class="p">%.star</span><span class="k">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Get the passwords</span>
</span><span class='line'><span class="nb">echo</span> -n <span class="s2">&quot;Enter the password for $1 :&quot;</span>
</span><span class='line'><span class="nb">read</span> -s base_password
</span><span class='line'><span class="nb">echo</span>
</span><span class='line'><span class="nb">echo</span> -n <span class="s2">&quot;Enter the password for $2 :&quot;</span>
</span><span class='line'><span class="nb">read</span> -s patch_password
</span><span class='line'><span class="nb">echo</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Make the directories</span>
</span><span class='line'>mkdir -p <span class="nv">$base_name</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$base_name</span>
</span><span class='line'>
</span><span class='line'>mkdir -p <span class="nv">$patch_name</span>
</span><span class='line'>add_on_exit_reverse rmdir <span class="nv">$patch_name</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Mount the base</span>
</span><span class='line'>sudo truecrypt -t --non-interactive --password<span class="o">=</span><span class="nv">$base_password</span> <span class="nv">$base_star</span> <span class="nv">$base_name</span>
</span><span class='line'>add_on_exit_reverse sudo truecrypt -t --non-interactive -d <span class="nv">$base_name</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>
</span><span class='line'><span class="c"># Mount the patch</span>
</span><span class='line'>sudo truecrypt -t --non-interactive --password<span class="o">=</span><span class="nv">$patch_password</span> <span class="nv">$patch_star</span> <span class="nv">$patch_name</span>
</span><span class='line'>add_on_exit_reverse sudo truecrypt -t --non-interactive -d <span class="nv">$patch_name</span> &gt; /dev/null 2&gt;&amp;1
</span><span class='line'>
</span><span class='line'><span class="c"># Apply the patch</span>
</span><span class='line'>sudo mount -t aufs -o <span class="nb">dirs</span><span class="o">=</span><span class="nv">$patch_name</span><span class="o">=</span>ro:<span class="nv">$base_name</span><span class="o">=</span>ro aufs <span class="nv">$base_name</span>
</span><span class='line'>add_on_exit_reverse sudo umount -lf <span class="nv">$base_name</span>
</span><span class='line'>
</span><span class='line'><span class="c"># Wait for user to continue</span>
</span><span class='line'><span class="nb">echo</span> <span class="s2">&quot;Star is now mounted and patched. Press Enter to unmount and exit&quot;</span>
</span><span class='line'><span class="nb">read</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is how it works:</p>

<pre><code>$ ./patch_star.sh 
Usage: ./patch_star.sh &lt;base *.star&gt; &lt;patch *.star&gt;

$ ./patch_star.sh secret_stuff.star secret_stuff_changes.star 
Enter the password for secret_stuff.star :
Enter the password for secret_stuff_changes.star :
Star is now mounted and patched. Press Enter to unmount and exit

ls
mount_star.sh  patch_star.sh  secret_stuff  secret_stuff_changes.star  secret_stuff.star  star
$ ls secret_stuff
lala  new_secret_data.bin  secret_data.bin
</code></pre>

<p>This can be very handy for transferring small edits to a large archive across the network in a secure manner, without needing to retransfer the whole archive. The layering effect also acts as a poor man&rsquo;s version control. In the future, I would like to expand on this idea and write a script to manage the layers more convieniently and effectively, perhaps in a manner similar to Git or Docker.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/29/protect-yourself-online/">Protect Yourself Online</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-29T11:33:58-04:00" pubdate data-updated="true">Mar 29<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/03/29/protect-yourself-online/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/03/29/protect-yourself-online/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>This is a quick guide to staying secure on the internet.</p>

<h2>Hashes and Signatures</h2>

<p>Hashes and signatures are your primary tool for verifying data and detecting any form of tampering. You need to understand how hashes work and why they are important. Know how to generate hashes and checksums:</p>

<pre><code>$ echo Hello1 &gt; test.txt
$ cat test.txt 
Hello1
$ sha256sum test.txt 
e616a6e0657eb277d4acad697f19d066aaa62cdde2862d0be591f3de8357de4b  test.txt

$ echo Hello2 &gt; test.txt
$ cat test.txt 
Hello2
$ sha256sum test.txt 
f660df71283ecaf2c469cde588dd19e498c61eb1b5f1bcc664b8d9f338c67331  test.txt
</code></pre>

<p>Changing the file by a single character created a completely different hash. Hashes are like fingerprints; they are unique to a particular file, and cannot be spoofed.</p>

<p>Know how to verify hashes:</p>

<pre><code>$ cat test.txt 
Hello2
$ sha256sum test.txt &gt; hashes.sha256sum
$ cat hashes.sha256sum 
f660df71283ecaf2c469cde588dd19e498c61eb1b5f1bcc664b8d9f338c67331  test.txt
$ sha256sum -c hashes.sha256sum 
test.txt: OK
$ echo Hello1 &gt; test.txt 
$ sha256sum -c hashes.sha256sum 
test.txt: FAILED
sha256sum: WARNING: 1 computed checksum did NOT match
</code></pre>

<p>Become familiar with GPG. Know how to verify signatures:</p>

<pre><code>$ ls
test.txt  test.txt.sig
$ cat test.txt
Hello1
$ gpg --verify test.txt.sig 
gpg: assuming signed data in `test.txt'
gpg: Signature made Sun 29 Mar 2015 11:56:47 AM EDT using RSA key ID C37AF029
gpg: Good signature from "Joseph Ruether &lt;jrruethe@gmail.com&gt;"
$ echo Hello2 &gt; test.txt
$ gpg --verify test.txt.sig 
gpg: assuming signed data in `test.txt'
gpg: Signature made Sun 29 Mar 2015 11:56:47 AM EDT using RSA key ID C37AF029
gpg: BAD signature from "Joseph Ruether &lt;jrruethe@gmail.com&gt;"
</code></pre>

<h2>Passwords and Encryption</h2>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/03/29/protect-yourself-online/01.png"><sup id="fnref:1"><a href="#fn:1" rel="footnote">1</a></sup></p>

<p>With passwords, the longer the better. Complexity does not beat length.<br/>
Use <a href="http://world.std.com/~reinhold/diceware.html">Diceware</a> to generate a 4 or 5 word passphrase and memorize it.</p>

<p>You can also generate random data from the command line:</p>

<pre><code>dd if=/dev/urandom bs=1 count=64 | sha256sum
</code></pre>

<p>Use the mnemonic.py script from <a href="http://jrruethe.github.io/blog/2015/03/27/hex-to-mnemonics/">this</a> post to generate a string of words from the hex.</p>

<p>Get a <a href="https://www.yubico.com/products/yubikey-hardware/yubikey-neo/">Yubikey Neo</a>.<br/>
Use it&rsquo;s static password mode to store your passphrase.<br/>
Follow <a href="http://blog.josefsson.org/2014/06/23/offline-gnupg-master-key-and-subkeys-on-yubikey-neo-smartcard/">these</a> instructions to load your GPG encryption and signing keys.<br/>
Use its NFC capabilities with the <a href="https://play.google.com/store/apps/details?id=com.yubico.yubiclip&amp;hl=en">YubiClip</a> and <a href="https://play.google.com/store/apps/details?id=org.sufficientlysecure.keychain&amp;hl=en">OpenKeychain</a> Android apps to access your static password and GPG keys from the Yubikey on your smartphone.</p>

<p>Use a password manager like <a href="https://www.keepassx.org/">KeepassX</a>. It is open souce and cross platform.<br/>
Use a keyfile along with your master password.<br/>
Use KeepassX to generate long random passwords for all other needs.</p>

<p>Use <a href="https://github.com/jrruethe/truecrypt">Truecrypt</a>. It is open source and cross platform.<br/>
Use a keyfile along with a strong password generated by KeepassX.</p>

<p>Treat the keyfiles as access tokens.<br/>
Do not let them touch the network. Do not upload them to any online service.<br/>
Instead, manually load them onto your various devices using USB.<br/>
Back them up by printing them to paper in Base64 format, and keep the backups in a safe place.</p>

<pre><code>dd if=/dev/urandom bs=1 count=64 | base64 &gt; keyfile.base64
</code></pre>

<p>By keeping a strong password on a hardware token you posess, coupled with a software token that only exists on the devices of your choosing, you have achieved two factor authentication without any third party.<br/>
Both pieces are needed to unlock either your password database or your truecrypt container.</p>

<p>This means you can use a 3rd party synchronization service without being required to trust them; they couldn&rsquo;t access your passwords or data even if they wanted to.<br/>
Bittorrent Sync or Dropbox both work well to keep your passwords and data synced between your devices.</p>

<h2>Browsing</h2>

<p>Always use HTTPS, and be aware of the certificate being used.<br/>
Learn how to check the certificate fingerprints:</p>

<ul>
<li>Chrome: Lock icon &ndash;> Connection tab &ndash;> Certificate information</li>
<li>Firefox: Lock icon &ndash;> More information &ndash;> View Certificate</li>
</ul>


<p>The truely paranoid will want to verify these fingerprints against another channel.<br/>
<a href="https://www.grc.com/fingerprints.htm">This</a> site is a great way to verify the fingerprints.<br/>
GRC&rsquo;s fingerprint is 01:56:D3:AC:CF:5A:3F:B8:8F:0F:B4:30:88:2D:F6:72:4E:8C:F2:E0, write it down somewhere.</p>

<p>Use <a href="https://duckduckgo.com/">Duck Duck Go</a> instead of Google.<br/>
Use Firefox instead of Chrome.<br/>
Consider the following extensions:</p>

<ul>
<li><a href="https://addons.mozilla.org/en-US/firefox/addon/adblock-plus/">Adblock Plus</a></li>
<li><a href="https://addons.mozilla.org/en-US/firefox/addon/betterprivacy/">BetterPrivacy</a></li>
<li><a href="https://addons.mozilla.org/en-US/firefox/addon/donottrackplus/">Blur</a></li>
<li><a href="https://addons.mozilla.org/en-US/firefox/addon/disconnect/">Disconnect</a></li>
<li><a href="https://addons.mozilla.org/en-US/firefox/addon/http-nowhere/">HTTP Nowhere</a></li>
<li><a href="https://www.eff.org/HTTPS-EVERYWHERE">HTTPS Everywhere</a></li>
<li><a href="https://addons.mozilla.org/en-US/firefox/addon/noscript/">NoScript</a></li>
<li><a href="https://www.eff.org/privacybadger">Privacy Badger</a></li>
<li><a href="https://addons.mozilla.org/en-US/firefox/addon/requestpolicy/">RequestPolicy</a></li>
</ul>


<h2>Operating System</h2>

<p>Don&rsquo;t use Windows. <a href="https://www.debian.org/">Debian</a> is a stable and secure Linux distribution.<br/>
Alternatively, use <a href="https://tails.boum.org/">Tails</a> or <a href="https://www.whonix.org/">Whonix</a> (Both are based on Debian).<br/>
In addition, Debian supports full disk encryption using LUKS.</p>

<p>For your smartphone, use Android and <a href="http://www.cyanogenmod.org/">CyanogenMod</a> if possible.<br/>
Android also supports full disk encryption with LUKS.</p>

<p>Debian can also be installed to a USB drive and act as a &ldquo;cold boot&rdquo; system.<br/>
Cold boot means that it is never allowed to touch the network; all data transfer to the cold boot system is done with a second USB drive.<br/>
This practice is good for storing GPG private keys and Bitcoin wallets securely.</p>

<h2>More Information</h2>

<p>I highly recommend you read the following pages for more information:</p>

<ul>
<li><a href="https://freedom.press/encryption-works">Encryption Works</a></li>
<li><a href="https://prism-break.org/en/">Prism Break</a></li>
<li><a href="https://www.privacytools.io/">Privacy Tools</a></li>
<li><a href="https://pack.resetthenet.org/">Reset the Net</a></li>
<li><a href="https://ssd.eff.org/">Surveillance Self-Defense</a></li>
<li><a href="https://www.bestvpn.com/the-ultimate-privacy-guide/">Ultimate Privacy Guide</a></li>
</ul>

<div class="footnotes">
<hr/>
<ol>
<li id="fn:1">
<p><a href="http://xkcd.com/">Randall Munrow, XKCD</a> licensed under CC-BY-NA 2.5<a href="#fnref:1" rev="footnote">&#8617;</a></p></li>
</ol>
</div>

</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2015/03/27/physical-blockchain-identity-card/">Physical Blockchain Identity Card</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-03-27T18:28:47-04:00" pubdate data-updated="true">Mar 27<span>th</span>, 2015</time>
        
           | <a href="/blog/2015/03/27/physical-blockchain-identity-card/#disqus_thread"
             data-disqus-identifier="http://jrruethe.github.io/blog/2015/03/27/physical-blockchain-identity-card/">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In a <a href="http://jrruethe.github.io/blog/2015/02/28/blockchain-identity/">previous post</a>, I walked through the steps to create a digitial Blockchain Identity. Now, it is time to turn that into an physical identity card.</p>

<p>You will need the following:</p>

<ul>
<li><a href="http://www.amazon.com/gp/product/B0010JEJPC/ref=od_aui_detailpages00?ie=UTF8&amp;psc=1">Laminator</a></li>
<li><a href="http://www.amazon.com/gp/product/B004XJC1UQ/ref=od_aui_detailpages00?ie=UTF8&amp;psc=1">10 mil Teslin Paper</a></li>
<li><a href="http://www.amazon.com/gp/product/B004UJC730/ref=ox_sc_act_title_2?ie=UTF8&amp;psc=1&amp;smid=A1GYMVIZIMSYWM">10 mil Butterfly Pouch Laminates</a></li>
<li>A color inkjet printer</li>
</ul>


<p>You will also need the following software:</p>

<ul>
<li>Inkscape</li>
<li>QtQr</li>
<li>gLabels</li>
</ul>


<p>There is no standard template for your ID card; you can design it however you wish. The general idea is that it displays the necessary information to be a link between your government issued identification document and your GPG key. It is also a convienient place to put some contact information.</p>

<p>The most important item it must contain is the QR code containing your key.json.asc information. Remember, only the hash of this file is stored in the blockchain, so you need to make the data available for verification. For this reason, it is also recommended to include the hash and the Bitcoin transaction ID on your card. Finally, a link to your Keybase.io account is recommended.</p>

<p>To prove your identity, one would scan the QR code containing your key.json.asc information to obtain the ASCII text, and use your Keybase.io account to verify it&rsquo;s authenticity. Then, the hash of that data can be calculated and compared against the Bitcoin transaction. All the information needed (besides keybase.io and blockchain.info) are stored on your physical card; no need for your personal computer. Furthermore, the information can be validated with a smart phone; no full PC is needed.</p>

<p>Below you will find the template I designed using Inkscape. It isn&rsquo;t very flashy, but it does it&rsquo;s job well.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/03/27/physical-blockchain-identity-card/01.png"></p>

<p>Do note that I let the edges overlap a little bit to ensure the color covers the entire border.<br/>
Here is the back, and containing the most important part of the document:</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/03/27/physical-blockchain-identity-card/02.png"></p>

<p>Scanning that will reveal the key.json.asc data.</p>

<p>Next, this card needs to be layed out on the Teslin paper properly. For this, I used gLabels and created a custom template. It took some trial and error to get everything lined up correctly, but here are the settings I ended up using:</p>

<ol>
<li>Width: 87.6 mm</li>
<li>Height: 56.0 mm</li>
<li>Round: 3.0 mm</li>
<li>Horizontal Waste: 1.0 mm</li>
<li>Vertical Waste: 1.0 mm</li>
<li>Margin: 1.0 mm</li>
</ol>


<p>and:</p>

<ul>
<li>nx: 2</li>
<li>ny: 4</li>
<li>x0: 15.9 mm</li>
<li>y0: 15.9 mm</li>
<li>dx: 97.0 mm</li>
<li>dy: 64.0 mm</li>
</ul>


<p>Here are the steps:</p>

<ol>
<li>Once you create your card in Inkscape, export it to a png.</li>
<li>Open gLabels and use your png to create a card.</li>
<li>Print it onto the Teslin paper at the highest quality your printer allows.</li>
<li>Let it dry, then pop the card out and place it inside of a butterfly pouch.

<ul>
<li>Do note that the glossy side goes out, the matte side is glue that should be up against the Teslin paper.</li>
<li>Also, the folded edge should be at the bottom of the card.</li>
<li>Be careful not to get fingerprints on the inside of the pouch.</li>
</ul>
</li>
<li>Warm up the laminator and feed the butterfly pouch containing the card folded edge first into the laminator.</li>
<li>When it comes out, flip it over and run it through again (on the other side).

<ul>
<li>You may need to run it through each side twice, for a total of four times.</li>
</ul>
</li>
<li>Let it cool, and enjoy your finished product!</li>
</ol>


<p>The result will look and feel like a real ID card. Below is an image of mine, with some stuff blurred out.</p>

<p><img class="center" src="http://jrruethe.github.io/blog/2015/03/27/physical-blockchain-identity-card/03.jpg"></p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/2/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Contact</h1>
  <p>
  <a href="mailto:jrruethe@gmail.com">jrruethe@gmail.com</a><br>
  <a href="https://onename.io/jrruethe">onename.io/jrruethe</a><br>
  <a href="https://keybase.io/jrruethe">keybase.io/jrruethe</a><br>
  <br>Public Key:<br>
  <a href="http://jrruethe.github.io/downloads/code/jrruethe-public.asc">4F40 99F8 276B DBA5 475A<br>8446 4630 BEDC 40B9 35FE</a>
  </p>
</section>
<section>
<a href="https://twitter.com/jrruethe" class="twitter-follow-button" data-show-count="true">Follow @jrruethe</a>
<a href="https://twitter.com/share" class="twitter-share-button" data-url="http://jrruethe.github.io/index.html" data-via="jrruethe" data-counturl="http://jrruethe.github.io/index.html" >Tweet</a>
</section>
<section>
<h1>Link to this page</h1>
<a href="http://jrruethe.github.io/index.html"><img src="http://chart.apis.google.com/chart?chs=150x150&cht=qr&chld=|0&chco=000000&chl=http://jrruethe.github.io/index.html" alt="post-qrcode"></a>
</section>
<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2015/06/30/parameter-forwarding/">Parameter Forwarding</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/21/boost-fusion-json-serializer/">Boost Fusion Json Serializer</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/05/02/temporary-security-mirror/">Temporary Security Mirror</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/26/bitcoin-analogy/">A Simple Bitcoin Analogy</a>
      </li>
    
      <li class="post">
        <a href="/blog/2015/04/23/bitcoin-paper-wallets/">Bitcoin Paper Wallets</a>
      </li>
    
  </ul>
</section>
<section>
   <h1>Related Posts</h1>
   <ul class="posts">
   
   </ul>
</section>

<section>
  <h1>GitHub Repos</h1>
  <ul id="gh_repos">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a href="https://github.com/jrruethe">@jrruethe</a> on GitHub
  
  <script type="text/javascript">
    $(document).ready(function(){
        if (!window.jXHR){
            var jxhr = document.createElement('script');
            jxhr.type = 'text/javascript';
            jxhr.src = '/javascripts/libs/jXHR.js';
            var s = document.getElementsByTagName('script')[0];
            s.parentNode.insertBefore(jxhr, s);
        }

        github.showRepos({
            user: 'jrruethe',
            count: 5,
            skip_forks: true,
            target: '#gh_repos'
        });
    });
  </script>
  <script src="/javascripts/github.js" type="text/javascript"> </script>
</section>

<section>
	<h1>Bitcoin Donations</h1>
	<a href="bitcoin:1A1dsHXAaDcfLzEbiA99u3uBq9PDzw4Hkg"><img src="http://blockchain.info/qr?data=1A1dsHXAaDcfLzEbiA99u3uBq9PDzw4Hkg&size=150" alt="Bitcoin"></a>
	<font size=2>
	<a href="bitcoin:1A1dsHXAaDcfLzEbiA99u3uBq9PDzw4Hkg">1A1dsHXAaDcfLzEbiA99u3uBq9PDzw4Hkg</a>
	</font>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
  <span class="license">
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
   - Copyright &copy; 2015 - Joe Ruether - All rights reserved with the following exceptions:
  <br>
   - All embedded code on this page licensed under
    <a href="/blog/downloads/code/gpl-3.0.txt">GPLv3</a>
    or a later version unless otherwise noted
  <br>
   - All non-code text content on this page licensed under
    <a href="/blog/downloads/code/cc-by-nc-sa-4.0.txt">CC BY-NC-SA 4.0</a>
    or a later version unless otherwise noted
  </span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jrruethe';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = '//' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>







  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = '//platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
